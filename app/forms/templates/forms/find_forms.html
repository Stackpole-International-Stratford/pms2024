{% extends "parent.html" %}
{% load static %}

{% block title %}Forms for {{ form_type.name }}{% endblock %}

{% block extra_head %}
<style>
    /* Make filters sticky */
    .sticky-filters {
        top: 0;
        z-index: 1000;
        padding: 10px;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
    }
    /* Hide the "Hello" button by default */
    #helloButton {
        display: none;
    }
</style>
{% endblock %}

{% block content %}
<!-- Navbar with Back Button -->
<nav class="navbar navbar-expand-lg navbar-light bg-light shadow-sm mb-3">
    <div class="container">
        <a class="navbar-brand" href="{% url 'forms_index' %}">
            <button type="button" class="btn btn-outline-dark">Back</button>
        </a>
    </div>
</nav>

<div class="container mt-5">
    <!-- Logo centered above the title -->
    <div class="text-center mb-3">
        <img src="{% static 'images/JE_Logo_PNG.png' %}" alt="JE Logo" style="height: 50px;">
    </div>

    <h1>Forms for {{ form_type.name }}</h1>
    <hr>

    <!-- Sticky Filters for Part Number and Operation -->
    <div class="sticky-filters mb-3" id="dynamicFilters">
        <div class="row">
            <div class="col-md-6">
                <div class="form-group">
                    <label for="part_numberFilter" class="form-label">Part Number</label>
                    <select id="part_numberFilter" class="form-select">
                        <option value="">All Part Numbers</option>
                    </select>
                </div>
            </div>
            <div class="col-md-6">
                <div class="form-group">
                    <label for="operationFilter" class="form-label">Operation</label>
                    <select id="operationFilter" class="form-select">
                        <option value="">All Operations</option>
                    </select>
                </div>
            </div>
        </div>
    </div>

    <!-- Buttons visible only to LPA Managers -->
    {% if is_lpa_manager %}
        <a href="{% url 'form_create' %}?form_type={{ form_type.id }}" class="btn btn-dark mb-3">
            Create a new form for {{ form_type.name }}
        </a>
        <button id="helloButton" class="btn btn-secondary mb-3">Add Question to Selected Forms</button>
    {% endif %}

    <!-- Forms Table -->
    {% if forms %}
    <table class="table table-striped" id="formsTable">
        <thead>
            <tr>
                {% if is_lpa_manager %}
                <th scope="col">
                    <input type="checkbox" id="selectAllCheckbox">
                    Select
                </th>
                {% endif %}
                <th scope="col">Form Name</th>
                <th scope="col">Creation Date</th>
                <th scope="col">Metadata</th>
                <th scope="col">Actions</th>
            </tr>
        </thead>
        <tbody>
            {% for form in forms %}
            <tr class="form-row"
                data-part_number="{{ form.metadata.part_number }}"
                data-operation="{{ form.metadata.operation }}"
            >
                {% if is_lpa_manager %}
                <td>
                    <input type="checkbox" class="form-checkbox" value="{{ form.id }}">
                </td>
                {% endif %}
                <td class="form-name">{{ form.name }}</td>
                <td>{{ form.created_at|date:"Y-m-d H:i" }}</td>
                <td>
                    <ul class="form-metadata">
                        {% for key, value in form.metadata.items %}
                            <li><strong>{{ key|capfirst }}:</strong> {{ value }}</li>
                        {% endfor %}
                    </ul>
                </td>
                <td>
                    {% if is_lpa_manager or is_quality_engineer %}
                        <a href="{% url 'form_edit' form.id %}" class="btn btn-warning">Manage Form</a>
                    {% endif %}
                    {% if user.is_authenticated %}
                        <a href="{% url 'unified_form' form.id %}" class="btn btn-dark ml-2">Go to Form</a>
                    {% else %}
                        <a href="{% url 'login' %}?next={% url 'unified_form' form.id %}" class="btn btn-dark ml-2">Go to Form</a>
                    {% endif %}
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    {% else %}
    <p>No forms available for this type.</p>
    {% endif %}
</div>
{% endblock %}

{% block extra_scripts %}
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

<!-- CSRF helper for AJAX POST in Django -->
<script>
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.startsWith(name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
    const csrftoken = getCookie('csrftoken');
    $.ajaxSetup({
        beforeSend: function (xhr, settings) {
            if (!/^((GET|HEAD|OPTIONS|TRACE)$)/i.test(settings.type) && !this.crossDomain) {
                xhr.setRequestHeader("X-CSRFToken", csrftoken);
            }
        }
    });
</script>

<script>
    $(document).ready(function () {
        const rows = $('#formsTable tbody .form-row');

        // Update the "Select All" checkbox state
        function updateSelectAllCheckbox() {
            const visibleCheckboxes = $('.form-checkbox:visible');
            const selectAll = $('#selectAllCheckbox');
            if (visibleCheckboxes.length === 0) {
                selectAll.prop('checked', false);
                selectAll.prop('disabled', true);
                return;
            }
            selectAll.prop('disabled', false);
            const allChecked = visibleCheckboxes.filter(':checked').length === visibleCheckboxes.length;
            selectAll.prop('checked', allChecked);
        }

        // Show/hide the "Hello" button based on checkbox selection
        function toggleHelloButton() {
            const checkedCount = $('.form-checkbox:checked').length;
            $('#helloButton').toggle(checkedCount > 0);
        }

        // Update dropdowns and filter rows based on the selections
        function applyFiltersAndUpdateDropdowns() {
            const allRows = rows;
            const selectedPart = $('#part_numberFilter').val();
            const selectedOp = $('#operationFilter').val();

            // Available operations based on selected part number
            let availableOperations = new Set();
            if (selectedPart) {
                allRows.each(function () {
                    if ($(this).data('part_number') === selectedPart) {
                        availableOperations.add($(this).data('operation'));
                    }
                });
            } else {
                allRows.each(function () {
                    availableOperations.add($(this).data('operation'));
                });
            }

            // Available part numbers based on selected operation
            let availablePartNumbers = new Set();
            if (selectedOp) {
                allRows.each(function () {
                    if ($(this).data('operation') === selectedOp) {
                        availablePartNumbers.add($(this).data('part_number'));
                    }
                });
            } else {
                allRows.each(function () {
                    availablePartNumbers.add($(this).data('part_number'));
                });
            }

            // Update the operation filter options.
            let currentOp = selectedOp;
            let opOptionsHtml = `<option value="">All Operations</option>`;
            Array.from(availableOperations).sort().forEach(function (value) {
                opOptionsHtml += `<option value="${value}" ${value === currentOp ? 'selected' : ''}>${value}</option>`;
            });
            $('#operationFilter').html(opOptionsHtml);

            // Update the part number filter options.
            let currentPart = selectedPart;
            let partOptionsHtml = `<option value="">All Part Numbers</option>`;
            Array.from(availablePartNumbers).sort().forEach(function (value) {
                partOptionsHtml += `<option value="${value}" ${value === currentPart ? 'selected' : ''}>${value}</option>`;
            });
            $('#part_numberFilter').html(partOptionsHtml);

            // Filter the table rows based on the selected filters.
            allRows.each(function () {
                let row = $(this);
                let match = true;
                if (selectedPart && row.data('part_number') !== selectedPart) {
                    match = false;
                }
                if (selectedOp && row.data('operation') !== selectedOp) {
                    match = false;
                }
                row.toggle(match);
            });

            updateSelectAllCheckbox();
        }

        // Bind change events to the filters.
        $('#part_numberFilter, #operationFilter').on('change', applyFiltersAndUpdateDropdowns);

        // Initial call to setup the filters.
        applyFiltersAndUpdateDropdowns();

        // Checkbox event handlers.
        $('.form-checkbox').on('change', function () {
            updateSelectAllCheckbox();
            toggleHelloButton();
        });
        $('#selectAllCheckbox').on('change', function () {
            const visibleCheckboxes = $('.form-checkbox:visible');
            visibleCheckboxes.prop('checked', this.checked);
            toggleHelloButton();
        });

        {% if is_lpa_manager %}
        // Load the form into the modal when the "Hello" button is clicked.
        $('#helloButton').on('click', function () {
            const selectedFormIDs = $('.form-checkbox:checked').map(function () {
                return $(this).val();
            }).get();

            if (selectedFormIDs.length === 0) {
                alert('Please select at least one form.');
                return;
            }

            $.ajax({
                url: "{% url 'process_selected_forms' %}",
                method: "GET",
                data: { form_type: "{{ form_type.name }}" },
                success: function (response) {
                    $('#questionFormContainer').html(response.form_html);
                    $('#questionModal').modal('show');
                },
                error: function () {
                    alert('Failed to load the form. Please try again.');
                }
            });            
        });

        // Handle the question form submission.
        $('#saveQuestionButton').on('click', function () {
            const selectedFormIDs = $('.form-checkbox:checked').map(function () {
                return $(this).val();
            }).get();
        
            // Serialize the form data
            const formData = $('#questionForm').serializeArray();
            // Add selected form IDs and the form type to the form data
            formData.push({ name: 'form_ids[]', value: selectedFormIDs });
            formData.push({ name: 'form_type', value: "{{ form_type.name }}" });
        
            $.ajax({
                url: "{% url 'process_selected_forms' %}",
                method: "POST",
                data: formData,
                success: function (response) {
                    alert(response.message);
                    $('#questionModal').modal('hide');
                },
                error: function (xhr) {
                    alert('Error: ' + (xhr.responseJSON?.error || 'Failed to save the question.'));
                }
            });
        });
        

        // Append a Delete button for each form row.
        $('#formsTable tbody .form-row').each(function () {
            const formId = $(this).find('.form-checkbox').val();
            const actionsCell = $(this).find('td:last-child');

            const deleteButton = $('<button>')
                .addClass('btn btn-danger ml-2')
                .text('Delete')
                .attr('data-form-id', formId)
                .on('click', function () {
                    if (confirm('Are you sure you want to delete this form?')) {
                        $.ajax({
                            url: "{% url 'process_form_deletion' %}",
                            method: "POST",
                            data: { form_id: formId },
                            headers: { "X-CSRFToken": getCookie('csrftoken') },
                            success: function (response) {
                                alert('Form marked as deleted successfully!');
                            },
                            error: function (xhr) {
                                alert('Error: ' + (xhr.responseJSON?.error || 'Failed to delete the form.'));
                            }
                        });
                    }
                });

            actionsCell.append(deleteButton);
        });
        {% endif %}
    });
</script>

<!-- Bootstrap Modal for Adding Questions -->
<div class="modal fade" id="questionModal" tabindex="-1" aria-labelledby="questionModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="questionModalLabel">Add a New Question for Selected Forms</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" id="questionFormContainer">
                <!-- The question form content will be injected here via AJAX -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-dark" id="saveQuestionButton">Save Question</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}
