{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <!-- Meta Tags and Title -->
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Create a New {{ form_type.name }} Form</title>

    <!-- Bootstrap Integration -->
    <link href="{% static 'bootstrap/css/bootstrap.min.css' %}" rel="stylesheet">
    <script src="{% static 'bootstrap/js/bootstrap.bundle.min.js' %}"></script>

    <!-- Custom CSS -->
    <style>
        .question-form {
            background-color: #f8f9fa;
            position: relative;
        }
        .question-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        .question-header .question-number {
            margin-right: 15px;
        }
        .move-buttons {
            display: flex;
            align-items: center;
        }
        .move-buttons button {
            margin-right: 5px;
        }
        .text-end {
            margin-top: 10px;
        }
    </style>
</head>
<body>
<!-- Navigation Bar -->
<nav class="navbar navbar-expand-lg navbar-light bg-light">
    <div class="container-fluid">
        <a href="{% url 'find_forms' %}?form_type={{ form_type.id }}" class="btn btn-outline-dark">Back</a>
        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" 
                aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarNav"></div>
    </div>
</nav>


    <!-- Main Content -->
    <div class="container mt-5">
        <!-- Page Heading -->
        <div class="text-center mb-5">
            <h1 class="display-4">Create a New {{ form_type.name }} Form</h1>
            <p class="lead">Design your form and add questions below</p>
        </div>

        <!-- Form Start -->
        <form method="POST">
            {% csrf_token %}

            <!-- Form Details Section -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="card-title mb-0">Form Details</h5>
                </div>
                <div class="card-body">
                    {{ form.as_p }}
                </div>
            </div>

            <!-- Buttons -->
            <div class="d-flex justify-content-end align-items-center mb-4">
                <button type="submit" class="btn btn-warning">Save Form</button>
            </div>

            <!-- Questions Section -->
            <h3 class="mb-3">Questions</h3>

            <div id="question-formset" class="mb-4">
                {{ question_formset.management_form }}
                {% for form in question_formset %}
                    <div class="question-form mb-3 p-3 border rounded shadow-sm">
                        <!-- Question Header with flex layout -->
                        <div class="question-header">
                            <h5 class="question-number">Question {{ forloop.counter }}</h5>
                            <!-- Move Up and Move Down Buttons with Icons -->
                            <div class="move-buttons">
                                <button type="button" class="btn btn-secondary move-up">
                                    <!-- Inline SVG for "Move Up" icon -->
                                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-arrow-up-short" viewBox="0 0 16 16">
                                        <path fill-rule="evenodd" d="M8 12a.5.5 0 0 1-.5-.5V5.707L5.354 7.854a.5.5 0 1 1-.708-.708l3-3a.5.5 0 0 1 .708 0l3 3a.5.5 0 0 1-.708.708L8.5 5.707V11.5A.5.5 0 0 1 8 12z"/>
                                    </svg>
                                </button>
                                <button type="button" class="btn btn-secondary move-down">
                                    <!-- Inline SVG for "Move Down" icon -->
                                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-arrow-down-short" viewBox="0 0 16 16">
                                        <path fill-rule="evenodd" d="M8 4a.5.5 0 0 1 .5.5v5.793l2.146-2.147a.5.5 0 1 1 .708.708l-3 3a.5.5 0 0 1-.708 0l-3-3a.5.5 0 1 1 .708-.708L7.5 10.293V4.5A.5.5 0 0 1 8 4z"/>
                                    </svg>
                                </button>
                            </div>
                        </div>
                        {{ form.non_field_errors }}
                        {% for hidden in form.hidden_fields %}
                            {{ hidden }}
                        {% endfor %}
                        {{ form.as_p }}
                    </div>
                {% endfor %}
            </div>

            <!-- Hidden Empty Form Template -->
            <div id="empty-form-template" style="display: none;">
                <div class="question-form mb-3 p-3 border rounded shadow-sm">
                    <!-- Question Header with flex layout -->
                    <div class="question-header">
                        <h5 class="question-number">Question</h5>
                        <!-- Move Up and Move Down Buttons with Icons -->
                        <div class="move-buttons">
                            <button type="button" class="btn btn-secondary move-up">
                                <!-- Inline SVG for "Move Up" icon -->
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-arrow-up-short" viewBox="0 0 16 16">
                                    <path fill-rule="evenodd" d="M8 12a.5.5 0 0 1-.5-.5V5.707L5.354 7.854a.5.5 0 1 1-.708-.708l3-3a.5.5 0 0 1 .708 0l3 3a.5.5 0 0 1-.708.708L8.5 5.707V11.5A.5.5 0 0 1 8 12z"/>
                                </svg>
                            </button>
                            <button type="button" class="btn btn-secondary move-down">
                                <!-- Inline SVG for "Move Down" icon -->
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-arrow-down-short" viewBox="0 0 16 16">
                                    <path fill-rule="evenodd" d="M8 4a.5.5 0 0 1 .5.5v5.793l2.146-2.147a.5.5 0 1 1 .708.708l-3 3a.5.5 0 0 1-.708 0l-3-3a.5.5 0 1 1 .708-.708L7.5 10.293V4.5A.5.5 0 0 1 8 4z"/>
                                </svg>
                            </button>
                        </div>
                    </div>
                    {{ question_formset.empty_form.non_field_errors }}
                    {% for hidden in question_formset.empty_form.hidden_fields %}
                        {{ hidden }}
                    {% endfor %}
                    {{ question_formset.empty_form.as_p }}
                </div>
            </div>

            <!-- Buttons -->
            <div class="d-flex justify-content-between align-items-center mb-4">
                <button type="button" id="add-question" class="btn btn-dark">Add Question</button>
                <button type="submit" class="btn btn-warning">Save Form</button>
            </div>
        </form>
    </div>

    <!-- JavaScript Code -->
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Get the TOTAL_FORMS input to track the number of forms
            let totalForms = document.querySelector('[name="{{ question_formset.prefix }}-TOTAL_FORMS"]');
            let formCount = parseInt(totalForms.value);  // Current form count

            // Function to reindex forms and update question numbers and order fields
            function reindexForms() {
                const allForms = document.querySelectorAll('#question-formset .question-form');
                const visibleForms = [];

                allForms.forEach(function(form, index) {
                    // Update names and IDs
                    form.querySelectorAll('input, select, textarea, label').forEach(function(element) {
                        if (element.name) {
                            element.name = element.name.replace(/-(\d+)-/, `-${index}-`);
                        }
                        if (element.id) {
                            element.id = element.id.replace(/-(\d+)-/, `-${index}-`);
                        }
                        if (element.htmlFor) {
                            element.htmlFor = element.htmlFor.replace(/-(\d+)-/, `-${index}-`);
                        }
                    });

                    // Update question number display
                    const questionNumberElement = form.querySelector('.question-number');
                    if (questionNumberElement) {
                        questionNumberElement.textContent = `Question ${index + 1}`;
                    }

                    // Collect visible forms
                    if (form.style.display !== 'none') {
                        visibleForms.push(form);
                    }
                });

                visibleForms.forEach(function(form, visibleIndex) {
                    // Update 'order' field value
                    let orderInput = form.querySelector('input[name$="-order"]');
                    if (orderInput) {
                        orderInput.value = visibleIndex + 1;
                    }

                    // Enable or disable move buttons based on position among visible forms
                    const moveUpButton = form.querySelector('.move-up');
                    const moveDownButton = form.querySelector('.move-down');

                    if (moveUpButton) {
                        moveUpButton.disabled = visibleIndex === 0;
                    }
                    if (moveDownButton) {
                        moveDownButton.disabled = visibleForms.length === 1 || visibleIndex === visibleForms.length - 1;
                    }
                });

                // Update TOTAL_FORMS value
                totalForms.value = allForms.length;
            }

            // Add event listeners to the delete checkboxes to hide the form when checked
            function attachDeleteCheckboxListener(form) {
                let deleteCheckbox = form.querySelector('input[type="checkbox"][name$="-DELETE"]');
                if (deleteCheckbox) {
                    deleteCheckbox.addEventListener('change', function() {
                        if (this.checked) {
                            form.style.display = 'none';  // Hide the form when the checkbox is checked
                        } else {
                            form.style.display = '';  // Show the form if checkbox is unchecked
                        }
                        reindexForms();  // Reindex forms after deletion or undeletion
                    });
                }
            }

            // Add a new question form when the "Add Question" button is clicked
            document.getElementById('add-question').addEventListener('click', function() {
                // Clone the empty form template
                let formClone = document.querySelector('#empty-form-template .question-form').cloneNode(true);
                formClone.style.display = ''; // Ensure the cloned form is visible

                // Update names and IDs with the new index
                formClone.querySelectorAll('input, select, textarea, label').forEach(function(element) {
                    if (element.name) {
                        element.name = element.name.replace(/__prefix__/, formCount);
                    }
                    if (element.id) {
                        element.id = element.id.replace(/__prefix__/, formCount);
                    }
                    if (element.htmlFor) {
                        element.htmlFor = element.htmlFor.replace(/__prefix__/, formCount);
                    }

                    // Reset values
                    if (element.type === 'checkbox' || element.type === 'radio') {
                        element.checked = false;
                    } else if (element.tagName === 'INPUT' || element.tagName === 'TEXTAREA' || element.tagName === 'SELECT') {
                        element.value = '';
                    }
                });

                // Append the cloned form to the formset container
                document.getElementById('question-formset').appendChild(formClone);

                // Attach event listeners to the cloned form's buttons
                attachEventListeners(formClone);
                attachDeleteCheckboxListener(formClone);

                // Increment form count and update TOTAL_FORMS
                formCount++;
                totalForms.value = formCount;

                // Reindex forms and update question numbers
                reindexForms();
            });

            // Function to attach event listeners to form buttons
            function attachEventListeners(form) {
                // Move Up button
                let moveUpButton = form.querySelector('.move-up');
                if (moveUpButton) {
                    moveUpButton.addEventListener('click', function() {
                        let visibleForms = Array.from(document.querySelectorAll('#question-formset .question-form')).filter(f => f.style.display !== 'none');
                        let currentIndex = visibleForms.indexOf(form);
                        if (currentIndex > 0) {
                            let previousForm = visibleForms[currentIndex - 1];
                            form.parentNode.insertBefore(form, previousForm);
                            reindexForms();
                        }
                    });
                }

                // Move Down button
                let moveDownButton = form.querySelector('.move-down');
                if (moveDownButton) {
                    moveDownButton.addEventListener('click', function() {
                        let visibleForms = Array.from(document.querySelectorAll('#question-formset .question-form')).filter(f => f.style.display !== 'none');
                        let currentIndex = visibleForms.indexOf(form);
                        if (currentIndex < visibleForms.length - 1) {
                            let nextForm = visibleForms[currentIndex + 1];
                            form.parentNode.insertBefore(nextForm, form);
                            reindexForms();
                        }
                    });
                }
            }

            // Attach event listeners to all initial forms
            document.querySelectorAll('#question-formset .question-form').forEach(form => {
                attachEventListeners(form);
                attachDeleteCheckboxListener(form);
            });

            // Initial reindexing to set correct move button visibility and question numbers
            reindexForms();
        });
    </script>

</body>
</html>
