<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EPV Table</title>
    <style>
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        th, td {
            border: 1px solid black;
            padding: 8px;
            text-align: left;
        }
        th {
            background-color: #f2f2f2;
            position: sticky;
            top: 0;
            z-index: 2;
        }
        input {
            width: 100%;
            box-sizing: border-box;
            padding: 5px;
        }
    </style>
</head>
<body>

    <h2>EPV Data Table</h2>
    
    <table id="epvTable">
        <thead>
            <tr>
                <th>Id</th>
                <th>QC1</th>
                <th>OP1</th>
                <th>Check1</th>
                <th>Desc1</th>
                <th>Method1</th>
                <th>Interval1</th>
                <th>Person</th>
                <th>Asset</th>
            </tr>
            <tr>
                <th><input type="text" onkeyup="filterTable(0)" placeholder="Search Id"></th>
                <th><input type="text" onkeyup="filterTable(1)" placeholder="Search QC1"></th>
                <th><input type="text" onkeyup="filterTable(2)" placeholder="Search OP1"></th>
                <th><input type="text" onkeyup="filterTable(3)" placeholder="Search Check1"></th>
                <th><input type="text" onkeyup="filterTable(4)" placeholder="Search Desc1"></th>
                <th><input type="text" onkeyup="filterTable(5)" placeholder="Search Method1"></th>
                <th><input type="text" onkeyup="filterTable(6)" placeholder="Search Interval1"></th>
                <th><input type="text" onkeyup="filterTable(7)" placeholder="Search Person"></th>
                <th><input type="text" onkeyup="filterTable(8)" placeholder="Search Asset"></th>
            </tr>
        </thead>
        <tbody>
            {% for row in table_data %}
                <tr>
                    <td>{{ row.id }}</td>
                    <td>
                        <span class="qc1-value">{{ row.QC1 }}</span>
                        <button class="qc1-add-btn" onclick="showAssetInput(this)">‚ûï</button>
                        <div class="asset-input-container" style="display: none;">
                            <input type="text" class="new-asset-input" placeholder="Enter New Asset">
                            <button class="submit-asset-btn" onclick="sendQC1AndAsset(this)">‚úÖ</button>
                        </div>
                    </td>                                    
                    <td>
                        <span class="op1-value">{{ row.OP1 }}</span>
                        <button class="edit-op1-btn" onclick="enableOp1Edit(this)">‚úèÔ∏è</button>
                    </td>                    
                    <td>{{ row.Check1 }}</td>
                    <td>{{ row.Desc1 }}</td>
                    <td>{{ row.Method1 }}</td>
                    <td>{{ row.Interval1 }}</td>
                    <td>
                        <span class="person-value">{{ row.Person }}</span>
                        <button class="edit-person-btn" onclick="enablePersonEdit(this)">‚úèÔ∏è</button>
                    </td>
                    <td>
                        <span class="asset-value">{{ row.Asset }}</span>
                        <button class="edit-asset-btn" onclick="enableAssetEdit(this)">‚úèÔ∏è</button>
                    </td>
                </tr>
            {% endfor %}
        </tbody>
    </table>

    <script>
        let edit_event_is_live = false; // Initially false
    
        function filterTable(columnIndex) {
            let input = document.querySelectorAll("thead input")[columnIndex];
            let filter = input.value.toLowerCase();
            let table = document.getElementById("epvTable");
            let rows = table.getElementsByTagName("tr");
    
            for (let i = 2; i < rows.length; i++) { // Start from index 2 to skip header & input row
                let cells = rows[i].getElementsByTagName("td");
                if (cells[columnIndex]) {
                    let cellValue = cells[columnIndex].innerText || cells[columnIndex].textContent;
                    rows[i].style.display = cellValue.toLowerCase().includes(filter) ? "" : "none";
                }
            }
    
            checkSearchState(); // Check and update the global state
        }
    
        function checkSearchState() {
            let inputs = document.querySelectorAll("thead input");
            let hasText = Array.from(inputs).some(input => input.value.trim() !== ""); // Check if any input is filled
            
            if (edit_event_is_live !== hasText) { // Only log when the value changes
                edit_event_is_live = hasText;
                console.log(`edit_event_is_live changed to: ${edit_event_is_live}`);
            }
        }
    </script>
    
    <script>

        document.addEventListener("DOMContentLoaded", function () {
            addDeleteButtons(); // Add delete buttons on page load
        });

        function addDeleteButtons() {
            let table = document.getElementById("epvTable");
            let rows = table.getElementsByTagName("tbody")[0].getElementsByTagName("tr");
    
            for (let row of rows) {
                if (!row.querySelector(".delete-btn")) { // Avoid duplicate buttons
                    let deleteCell = document.createElement("td");
                    let deleteBtn = document.createElement("button");
                    deleteBtn.innerText = "Delete";
                    deleteBtn.classList.add("delete-btn");
    
                    deleteBtn.addEventListener("click", function () {
                        let epvId = row.cells[0].innerText; // Get ID from first column
                        confirmDeletion(epvId, row);
                    });
    
                    deleteCell.appendChild(deleteBtn);
                    row.appendChild(deleteCell);
                }
            }
        }
    
        function confirmDeletion(epvId, row) {
            let confirmDelete = confirm(`Are you sure you want to delete EPV ID: ${epvId}?`);
            if (confirmDelete) {
                deleteEPV(epvId, row);
            }
        }
    
        function deleteEPV(epvId, row) {
            fetch("/quality/delete_epv/", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                    "X-CSRFToken": getCSRFToken() // Ensure CSRF token is included
                },
                body: JSON.stringify({ id: epvId })
            })
            .then(response => response.json())
            .then(data => {
                if (data.message) {
                    alert("EPV deleted successfully!");
                    row.remove(); // Remove row from table
                } else {
                    alert("Error deleting EPV: " + data.error);
                }
            })
            .catch(error => {
                console.error("Error:", error);
                alert("An unexpected error occurred.");
            });
        }
    
        function getCSRFToken() {
            let csrfToken = document.cookie.match(/csrftoken=([\w-]+)/);
            return csrfToken ? csrfToken[1] : "";
        }
    
        // Watch for edit_event_is_live and add delete buttons dynamically
        let observer = new MutationObserver(() => {
            if (edit_event_is_live) {
                addDeleteButtons();
            }
        });
    
        observer.observe(document.body, { childList: true, subtree: true });
    </script>
    

    <script>
        function enableAssetEdit(button) {
            let row = button.closest("tr");
            let assetCell = row.querySelector(".asset-value");
    
            // Create an input field with the current asset value
            let input = document.createElement("input");
            input.type = "text";
            input.value = assetCell.innerText;
            input.classList.add("asset-input");
    
            // Replace the text with an input field
            assetCell.replaceWith(input);
            button.innerText = "üíæ"; // Change icon to save
            button.onclick = function () { saveAssetChange(row, input, button); };
    
            input.focus();
        }
    
        function saveAssetChange(row, input, button) {
            let epvId = row.cells[0].innerText; // Get ID from first column
            let newAssetValue = input.value.trim();
    
            if (newAssetValue === "") {
                alert("Asset cannot be empty.");
                return;
            }
    
            fetch("/quality/update_asset/", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                    "X-CSRFToken": getCSRFToken() // Ensure CSRF token is included
                },
                body: JSON.stringify({ id: epvId, asset: newAssetValue })
            })
            .then(response => response.json())
            .then(data => {
                if (data.message) {
                    alert("Asset updated successfully!");
    
                    // Replace input field with updated text
                    let assetSpan = document.createElement("span");
                    assetSpan.classList.add("asset-value");
                    assetSpan.innerText = newAssetValue;
    
                    input.replaceWith(assetSpan);
                    button.innerText = "‚úèÔ∏è"; // Change icon back to edit
                    button.onclick = function () { enableAssetEdit(button); };
                } else {
                    alert("Error updating asset: " + data.error);
                }
            })
            .catch(error => {
                console.error("Error:", error);
                alert("An unexpected error occurred.");
            });
        }
    
        function getCSRFToken() {
            let csrfToken = document.cookie.match(/csrftoken=([\w-]+)/);
            return csrfToken ? csrfToken[1] : "";
        }
    </script>
    
    
    <script>
        function enablePersonEdit(button) {
            let row = button.closest("tr");
            let personCell = row.querySelector(".person-value");
    
            // Create an input field with the current person value
            let input = document.createElement("input");
            input.type = "text";
            input.value = personCell.innerText;
            input.classList.add("person-input");
    
            // Replace the text with an input field
            personCell.replaceWith(input);
            button.innerText = "üíæ"; // Change icon to save
            button.onclick = function () { savePersonChange(row, input, button); };
    
            input.focus();
        }
    
        function savePersonChange(row, input, button) {
            let epvId = row.cells[0].innerText; // Get ID from first column
            let newPersonValue = input.value.trim();
            let qc1Value = row.cells[1].innerText; // Get QC1 value from second column
    
            if (newPersonValue === "") {
                alert("Person field cannot be empty.");
                return;
            }
    
            fetch("/quality/update_person/", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                    "X-CSRFToken": getCSRFToken() // Ensure CSRF token is included
                },
                body: JSON.stringify({ id: epvId, person: newPersonValue })
            })
            .then(response => response.json())
            .then(data => {
                if (data.message) {
                    alert("Person updated successfully!");
    
                    // Update all related rows in the table instantly
                    updateRelatedRows(qc1Value, newPersonValue);
    
                    // Restore the input field back to text
                    resetPersonField(row, input, button, newPersonValue);
                } else {
                    alert("Error updating person: " + data.error);
                }
            })
            .catch(error => {
                console.error("Error:", error);
                alert("An unexpected error occurred.");
            });
        }
    
        function updateRelatedRows(qc1Value, newPersonValue) {
            let table = document.getElementById("epvTable");
            let rows = table.getElementsByTagName("tr");
    
            for (let i = 2; i < rows.length; i++) { // Start from index 2 to skip headers
                let cells = rows[i].getElementsByTagName("td");
                if (cells.length > 1 && cells[1].innerText === qc1Value) { // Match QC1 value
                    let personCell = cells[7].querySelector(".person-value"); // Get the Person cell
                    if (personCell) {
                        personCell.innerText = newPersonValue; // Update the displayed name
                    }
                }
            }
        }
    
        function resetPersonField(row, input, button, newPersonValue) {
            // Restore the input field back to a span with new text
            let personSpan = document.createElement("span");
            personSpan.classList.add("person-value");
            personSpan.innerText = newPersonValue;
    
            input.replaceWith(personSpan);
            button.innerText = "‚úèÔ∏è"; // Change icon back to edit
            button.onclick = function () { enablePersonEdit(button); };
        }
    
        function getCSRFToken() {
            let csrfToken = document.cookie.match(/csrftoken=([\w-]+)/);
            return csrfToken ? csrfToken[1] : "";
        }
    </script>
    
    
    <script>
        function showAssetInput(button) {
            let row = button.closest("tr");
            let assetInputContainer = row.querySelector(".asset-input-container");
    
            // Show the input field for the asset
            assetInputContainer.style.display = "block";
            let inputField = assetInputContainer.querySelector(".new-asset-input");
            inputField.focus();
        }
    
        function sendQC1AndAsset(button) {
            let row = button.closest("tr");
            let epvId = row.cells[0].innerText; // Get ID from the first column
            let inputField = row.querySelector(".new-asset-input");
            let newAssetValue = inputField.value.trim();
    
            if (newAssetValue === "") {
                alert("Asset field cannot be empty.");
                return;
            }
    
            fetch("/quality/send_qc1_asset/", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                    "X-CSRFToken": getCSRFToken() // CSRF token for security
                },
                body: JSON.stringify({ id: epvId, asset: newAssetValue })
            })
            .then(response => response.json())
            .then(data => {
                if (data.message && data.new_entry) {
                    alert("QC1 ID and Asset sent successfully!");
    
                    // Hide input field and reset its value
                    inputField.value = "";
                    row.querySelector(".asset-input-container").style.display = "none";
    
                    // Add new entry to the table dynamically
                    addNewRowToTable(data.new_entry);
                } else {
                    alert("Error sending data: " + (data.error || "Unknown error"));
                }
            })
            .catch(error => {
                console.error("Error:", error);
                alert("An unexpected error occurred.");
            });
        }
    
        function addNewRowToTable(entry) {
            let table = document.getElementById("epvTable").getElementsByTagName('tbody')[0];
    
            let newRow = table.insertRow(); // Insert new row
    
            // Insert cells with new row data
            newRow.innerHTML = `
                <td>${entry.id}</td>
                <td>${entry.QC1}</td>
                <td>${entry.OP1}</td>
                <td>${entry.Check1}</td>
                <td>${entry.Desc1}</td>
                <td>${entry.Method1}</td>
                <td>${entry.Interval1}</td>
                <td>
                    <span class="person-value">${entry.Person}</span>
                    <button class="edit-person-btn" onclick="enablePersonEdit(this)">‚úèÔ∏è</button>
                </td>
                <td>
                    <span class="asset-value">${entry.Asset}</span>
                    <button class="edit-asset-btn" onclick="enableAssetEdit(this)">‚úèÔ∏è</button>
                </td>
            `;
        }
    
        function getCSRFToken() {
            let csrfToken = document.cookie.match(/csrftoken=([\w-]+)/);
            return csrfToken ? csrfToken[1] : "";
        }
    </script>
    
    <script>
        function enableOp1Edit(button) {
            let row = button.closest("tr");
            let op1Cell = row.querySelector(".op1-value");
    
            // Store old value
            let oldOp1 = op1Cell.innerText;
    
            // Create an input field with the current OP1 value
            let input = document.createElement("input");
            input.type = "text";
            input.value = oldOp1;
            input.classList.add("op1-input");
    
            // Replace the text with an input field
            op1Cell.replaceWith(input);
            button.innerText = "üíæ"; // Change icon to save
            button.onclick = function () { saveOp1Change(row, input, button, oldOp1); };
    
            input.focus();
        }
    
        function saveOp1Change(row, input, button, oldOp1) {
            let epvId = row.cells[0].innerText; // Get ID from first column
            let newOp1 = input.value.trim();
            let qc1Value = row.cells[1].innerText; // Get QC1 value from second column
    
            if (newOp1 === "") {
                alert("OP1 field cannot be empty.");
                return;
            }
    
            fetch("/quality/edit_op1/", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                    "X-CSRFToken": getCSRFToken() // Ensure CSRF token is included
                },
                body: JSON.stringify({ id: epvId, old_op1: oldOp1, new_op1: newOp1 })
            })
            .then(response => response.json())
            .then(data => {
                if (data.message) {
                    alert("OP1 updated successfully!");
    
                    // Update all related OP1 values in the table instantly
                    updateRelatedOp1Rows(qc1Value, newOp1);
    
                    // Restore the input field back to a span with the new text
                    resetOp1Field(row, input, button, newOp1);
                } else {
                    alert("Error updating OP1: " + data.error);
                }
            })
            .catch(error => {
                console.error("Error:", error);
                alert("An unexpected error occurred.");
            });
        }
    
        function updateRelatedOp1Rows(qc1Value, newOp1) {
            let table = document.getElementById("epvTable");
            let rows = table.getElementsByTagName("tr");
    
            for (let i = 2; i < rows.length; i++) { // Skip headers
                let cells = rows[i].getElementsByTagName("td");
                if (cells.length > 1 && cells[1].innerText === qc1Value) { // Match QC1 value
                    let op1Cell = cells[2].querySelector(".op1-value"); // Get OP1 cell
                    if (op1Cell) {
                        op1Cell.innerText = newOp1; // Update the displayed OP1 value
                    }
                }
            }
        }
    
        function resetOp1Field(row, input, button, newOp1) {
            // Restore the input field back to a span with new text
            let op1Span = document.createElement("span");
            op1Span.classList.add("op1-value");
            op1Span.innerText = newOp1;
    
            input.replaceWith(op1Span);
            button.innerText = "‚úèÔ∏è"; // Change icon back to edit
            button.onclick = function () { enableOp1Edit(button); };
        }
    
        function getCSRFToken() {
            let csrfToken = document.cookie.match(/csrftoken=([\w-]+)/);
            return csrfToken ? csrfToken[1] : "";
        }
    </script>
    
    


</body>
</html>
