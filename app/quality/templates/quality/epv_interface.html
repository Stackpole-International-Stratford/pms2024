<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EPV Table</title>
    <style>
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        th, td {
            border: 1px solid black;
            padding: 8px;
            text-align: left;
        }
        th {
            background-color: #f2f2f2;
            position: sticky;
            top: 0;
            z-index: 2;
        }
        input {
            width: 100%;
            box-sizing: border-box;
            padding: 5px;
        }
    </style>
</head>
<body>

    <h2>EPV Data Table</h2>
    
    <table id="epvTable">
        <thead>
            <tr>
                <th>Id</th>
                <th>QC1</th>
                <th>OP1</th>
                <th>Check1</th>
                <th>Desc1</th>
                <th>Method1</th>
                <th>Interval1</th>
                <th>Person</th>
                <th>Asset</th>
            </tr>
            <tr>
                <th><input type="text" onkeyup="filterTable(0)" placeholder="Search Id"></th>
                <th><input type="text" onkeyup="filterTable(1)" placeholder="Search QC1"></th>
                <th><input type="text" onkeyup="filterTable(2)" placeholder="Search OP1"></th>
                <th><input type="text" onkeyup="filterTable(3)" placeholder="Search Check1"></th>
                <th><input type="text" onkeyup="filterTable(4)" placeholder="Search Desc1"></th>
                <th><input type="text" onkeyup="filterTable(5)" placeholder="Search Method1"></th>
                <th><input type="text" onkeyup="filterTable(6)" placeholder="Search Interval1"></th>
                <th><input type="text" onkeyup="filterTable(7)" placeholder="Search Person"></th>
                <th><input type="text" onkeyup="filterTable(8)" placeholder="Search Asset"></th>
            </tr>
        </thead>
        <tbody>
            {% for row in table_data %}
                <tr>
                    <td>{{ row.id }}</td>
                    <td>{{ row.QC1 }}</td>
                    <td>{{ row.OP1 }}</td>
                    <td>{{ row.Check1 }}</td>
                    <td>{{ row.Desc1 }}</td>
                    <td>{{ row.Method1 }}</td>
                    <td>{{ row.Interval1 }}</td>
                    <td>{{ row.Person }}</td>
                    <td>{{ row.Asset }}</td>
                </tr>
            {% endfor %}
        </tbody>
    </table>

    <script>
        let edit_event_is_live = false; // Initially false
    
        function filterTable(columnIndex) {
            let input = document.querySelectorAll("thead input")[columnIndex];
            let filter = input.value.toLowerCase();
            let table = document.getElementById("epvTable");
            let rows = table.getElementsByTagName("tr");
    
            for (let i = 2; i < rows.length; i++) { // Start from index 2 to skip header & input row
                let cells = rows[i].getElementsByTagName("td");
                if (cells[columnIndex]) {
                    let cellValue = cells[columnIndex].innerText || cells[columnIndex].textContent;
                    rows[i].style.display = cellValue.toLowerCase().includes(filter) ? "" : "none";
                }
            }
    
            checkSearchState(); // Check and update the global state
        }
    
        function checkSearchState() {
            let inputs = document.querySelectorAll("thead input");
            let hasText = Array.from(inputs).some(input => input.value.trim() !== ""); // Check if any input is filled
            
            if (edit_event_is_live !== hasText) { // Only log when the value changes
                edit_event_is_live = hasText;
                console.log(`edit_event_is_live changed to: ${edit_event_is_live}`);
            }
        }
    </script>
    
    <script>

        document.addEventListener("DOMContentLoaded", function () {
            addDeleteButtons(); // Add delete buttons on page load
        });

        function addDeleteButtons() {
            let table = document.getElementById("epvTable");
            let rows = table.getElementsByTagName("tbody")[0].getElementsByTagName("tr");
    
            for (let row of rows) {
                if (!row.querySelector(".delete-btn")) { // Avoid duplicate buttons
                    let deleteCell = document.createElement("td");
                    let deleteBtn = document.createElement("button");
                    deleteBtn.innerText = "Delete";
                    deleteBtn.classList.add("delete-btn");
    
                    deleteBtn.addEventListener("click", function () {
                        let epvId = row.cells[0].innerText; // Get ID from first column
                        confirmDeletion(epvId, row);
                    });
    
                    deleteCell.appendChild(deleteBtn);
                    row.appendChild(deleteCell);
                }
            }
        }
    
        function confirmDeletion(epvId, row) {
            let confirmDelete = confirm(`Are you sure you want to delete EPV ID: ${epvId}?`);
            if (confirmDelete) {
                deleteEPV(epvId, row);
            }
        }
    
        function deleteEPV(epvId, row) {
            fetch("/quality/delete_epv/", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                    "X-CSRFToken": getCSRFToken() // Ensure CSRF token is included
                },
                body: JSON.stringify({ id: epvId })
            })
            .then(response => response.json())
            .then(data => {
                if (data.message) {
                    alert("EPV deleted successfully!");
                    row.remove(); // Remove row from table
                } else {
                    alert("Error deleting EPV: " + data.error);
                }
            })
            .catch(error => {
                console.error("Error:", error);
                alert("An unexpected error occurred.");
            });
        }
    
        function getCSRFToken() {
            let csrfToken = document.cookie.match(/csrftoken=([\w-]+)/);
            return csrfToken ? csrfToken[1] : "";
        }
    
        // Watch for edit_event_is_live and add delete buttons dynamically
        let observer = new MutationObserver(() => {
            if (edit_event_is_live) {
                addDeleteButtons();
            }
        });
    
        observer.observe(document.body, { childList: true, subtree: true });
    </script>
    

    
</body>
</html>
