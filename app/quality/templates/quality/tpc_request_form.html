{% extends "parent.html" %}

{% block content %}
<div class="container mt-5">
  <h2 class="mb-4">New TPC Request</h2>

  <form id="tpcForm" method="post" novalidate>
    {% csrf_token %}

    <div class="row g-3">
      <!-- Issuer -->
      <div class="col-md-6">
        <label class="form-label fw-bold">Issuer Name</label>
        <input type="text" name="issuer_name" value="{{ issuer_default }}" class="form-control" required>
      </div>

      <!-- Reason -->
      <div class="col-md-6">
        <label class="form-label fw-bold">Reason</label>
        <input type="text" name="reason" class="form-control" required>
      </div>

      <!-- Process -->
      <div class="col-md-12">
        <label class="form-label fw-bold">Process</label>
        <input type="text" name="process" class="form-control" required>
      </div>

      <!-- Parts -->
      <div class="col-md-6">
        <label class="form-label fw-bold">Parts</label>
        <div class="border p-2" style="height: 200px; overflow-y: auto;">
          {% for p in parts_qs %}
            <div class="form-check">
              <input type="checkbox" name="parts" value="{{ p.part_number }}" class="form-check-input">
              <label class="form-check-label">{{ p.part_number }} – {{ p.part_name }}</label>
            </div>
          {% endfor %}
        </div>
        <div class="mt-2">
          <a href="{% url 'display_parts' %}">(manage <u>parts</u>)</a>
        </div>
      </div>

      <!-- Machines -->
      <div class="col-md-6">
        <label class="form-label fw-bold">Machines</label>
        <div class="border p-2" style="height: 200px; overflow-y: auto;">
          {% for m in machines_qs %}
            <div class="form-check">
              <input type="checkbox" name="machines" value="{{ m.asset_number }}" class="form-check-input">
              <label class="form-check-label">{{ m.asset_number }} – {{ m.asset_name }}</label>
            </div>
          {% endfor %}
        </div>
        <div class="mt-2">
          <a href="{% url 'display_assets' %}">(manage <u>machines</u>)</a>
        </div>
      </div>

      <!-- Supplier issue -->
      <div class="col-md-6">
        <div class="form-check mt-4">
          <input type="checkbox" name="supplier_issue" class="form-check-input">
          <label class="form-check-label fw-bold">Supplier Issue?</label>
        </div>
      </div>

      <!-- Reason note -->
      <div class="col-md-6">
        <label class="form-label fw-bold">Reason Note</label>
        <textarea name="reason_note" class="form-control" rows="3" required></textarea>
      </div>

      <!-- Feature -->
      <div class="col-md-6">
        <label class="form-label fw-bold">Feature</label>
        <input type="text" name="feature" class="form-control" required>
      </div>

      <!-- Expiration date -->
      <div class="col-md-6">
        <label class="form-label fw-bold">Expiration Date</label>
        <input type="datetime-local" name="expiration_date" class="form-control" required>
      </div>

      <!-- Current process -->
      <div class="col-md-6">
        <label class="form-label fw-bold">Current Process</label>
        <textarea name="current_process" class="form-control" rows="3" required></textarea>
      </div>

      <!-- Changed to -->
      <div class="col-md-6">
        <label class="form-label fw-bold">Changed To</label>
        <textarea name="changed_to" class="form-control" rows="3" required></textarea>
      </div>

      <!-- QE Risk Assessment (optional) -->
      <div class="col-md-12">
        <label class="form-label fw-bold">QE Risk Assessment</label>
        <textarea
          name="qe_risk_assessment"
          class="form-control"
          rows="4"
          placeholder="Notes from Quality Engineer, risk level (e.g., Low/Med/High), mitigations, special instructions..."
        ></textarea>
      </div>

    </div>

    <!-- Actions -->
    <div class="mt-4 d-flex gap-2">
      <button class="btn btn-warning px-4" type="submit">Create TPC</button>
      <a href="{% url 'tpc_request_list' %}" class="btn btn-outline-dark">Cancel</a>
    </div>
  </form>
</div>

<script>
document.getElementById('tpcForm').addEventListener('submit', function(e) {
  const requiredFields = this.querySelectorAll('[required]');
  for (let field of requiredFields) {
    if ((field.type === 'checkbox' || field.type === 'radio') && !field.checked) {
      if (field.name === 'supplier_issue') {
        alert('Please check Supplier Issue.');
        e.preventDefault();
        return;
      }
    } else if (field.value.trim() === '') {
      alert('Please fill all fields.');
      e.preventDefault();
      return;
    }
  }

  // Check at least one part selected
  if (!this.querySelectorAll('input[name="parts"]:checked').length) {
    alert('Please select at least one Part.');
    e.preventDefault();
    return;
  }
  // Check at least one machine selected
  if (!this.querySelectorAll('input[name="machines"]:checked').length) {
    alert('Please select at least one Machine.');
    e.preventDefault();
    return;
  }
});
</script>
{% endblock %}
