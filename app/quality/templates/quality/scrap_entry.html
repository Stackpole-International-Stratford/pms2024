{# templates/quality/scrap_entry.html #}
{% extends "parent.html" %}
{% load static %}

{% block content %}
<div class="container mt-4">
  <h2>Scrap Entry</h2>

  {% if is_quality_engineer %}
      <div class="mb-3">
        <a href="{% url 'admin:quality_scrapsystemoperation_changelist' %}"
          class="btn btn-info">
          Add to or Edit these lists
        </a>
      </div>
    {% endif %}

  {% if messages %}
    {% for msg in messages %}
      <div class="alert alert-{{ msg.tags }} alert-dismissible fade show" role="alert">
        {{ msg }}
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
      </div>
    {% endfor %}
  {% endif %}

  <div class="card mb-4">
    <div class="card-body">
      <form method="post" id="scrap-form">
        {% csrf_token %}

        <div class="d-flex justify-content-between align-items-center mb-3">
          <div class="d-flex align-items-center gap-2">
            <label for="select_program" class="form-label mb-0">Program</label>
            <select id="select_program" class="form-select form-select-sm bigger-dropdown">
              <option value="">Select program…</option>
              {# provide a list of program names from the view as `programs` #}
              {% for prog in programs %}
                <option value="{{ prog }}">{{ prog }}</option>
              {% endfor %}
            </select>
            <input type="hidden" id="input_program" name="program" value="{{ selected_program }}">
          </div>

            <button type="submit" id="submit-top" class="btn btn-dark" disabled>Submit All</button>
        </div>


        <div class="row gx-3">
          {# Part Number #}
          <div class="col-6 col-md-2 d-flex flex-column">
            <label class="form-label">Part Number</label>
            <input type="hidden" name="part_number" id="input_part" value="{{ selected_part_number }}">
            <div class="text-center mb-1">
              <button type="button" class="btn btn-light scroll-btn scroll-up" data-target="list_part">
                <!-- up caret SVG -->
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor"
                     class="bi bi-caret-up-fill" viewBox="0 0 16 16">
                  <path d="m7.247 4.86-4.796 5.481c-.566.647-.106 1.659.753 
                   1.659h9.592a1 1 0 0 0 .753-1.659l-4.796-5.48a1 1 0 0 0-1.506 0z"/>
                </svg>
              </button>
            </div>
            <div id="list_part" class="list-group flex-grow-1" style="overflow:auto; max-height:200px;">
              {% for pn in part_numbers %}
                <a href="#"
                   class="list-group-item list-group-item-action {% if pn == selected_part_number %}active{% endif %}"
                   data-value="{{ pn }}">{{ pn }}</a>
              {% endfor %}
            </div>
            <div class="text-center mt-1">
              <button type="button" class="btn btn-light scroll-btn scroll-down" data-target="list_part">
                <!-- down caret SVG -->
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor"
                     class="bi bi-caret-down-fill" viewBox="0 0 16 16">
                  <path d="M7.247 11.14 2.451 5.658C1.885 5.013 
                   2.345 4 3.204 4h9.592a1 1 0 0 1 .753 1.659l-4.796 
                   5.48a1 1 0 0 1-1.506 0z"/>
                </svg>
              </button>
            </div>
          </div>

          {# Operation #}
          <div class="col-6 col-md-2 d-flex flex-column">
            <label class="form-label">Operation</label>
            <input type="hidden" name="operation" id="input_op" value="{{ selected_operation }}">
            <div class="text-center mb-1">
              <button type="button" class="btn btn-light scroll-btn scroll-up" data-target="list_op">
                <!-- up caret SVG -->
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor"
                     class="bi bi-caret-up-fill" viewBox="0 0 16 16">
                  <path d="m7.247 4.86-4.796 5.481c-.566.647-.106 
                   1.659.753 1.659h9.592a1 1 0 0 0 .753-1.659l-4.796-5.48a1 1 
                   0 0 0-1.506 0z"/>
                </svg>
              </button>
            </div>
            <div id="list_op" class="list-group flex-grow-1" style="overflow:auto; max-height:200px;">
              {% for op in operations %}
                <a href="#"
                   class="list-group-item list-group-item-action {% if op == selected_operation %}active{% endif %}"
                   data-value="{{ op }}">{{ op }}</a>
              {% endfor %}
            </div>
            <div class="text-center mt-1">
              <button type="button" class="btn btn-light scroll-btn scroll-down" data-target="list_op">
                <!-- down caret SVG -->
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor"
                     class="bi bi-caret-down-fill" viewBox="0 0 16 16">
                  <path d="M7.247 11.14 2.451 5.658C1.885 5.013 
                   2.345 4 3.204 4h9.592a1 1 0 0 1 .753 1.659l-4.796 
                   5.48a1 1 0 0 1-1.506 0z"/>
                </svg>
              </button>
            </div>
          </div>

          {# Machine #}
          <div class="col-6 col-md-2 d-flex flex-column">
            <label class="form-label">Machine</label>
            <input type="hidden" name="machine" id="input_machine" value="{{ selected_machine }}">
            <div class="text-center mb-1">
              <button type="button" class="btn btn-light scroll-btn scroll-up" data-target="list_machine">
                <!-- up caret SVG -->
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor"
                     class="bi bi-caret-up-fill" viewBox="0 0 16 16">
                  <path d="m7.247 4.86-4.796 5.481c-.566.647-.106 
                   1.659.753 1.659h9.592a1 1 0 0 0 .753-1.659l-4.796-5.48a1 
                   1 0 0 0-1.506 0z"/>
                </svg>
              </button>
            </div>
            <div id="list_machine" class="list-group flex-grow-1" style="overflow:auto; max-height:200px;">
              {% for m in machines %}
                <a href="#"
                   class="list-group-item list-group-item-action {% if m == selected_machine %}active{% endif %}"
                   data-value="{{ m }}">{{ m }}</a>
              {% endfor %}
            </div>
            <div class="text-center mt-1">
              <button type="button" class="btn btn-light scroll-btn scroll-down" data-target="list_machine">
                <!-- down caret SVG -->
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor"
                     class="bi bi-caret-down-fill" viewBox="0 0 16 16">
                  <path d="M7.247 11.14 2.451 5.658C1.885 5.013 
                   2.345 4 3.204 4h9.592a1 1 0 0 1 .753 1.659l-4.796 
                   5.48a1 1 0 0 1-1.506 0z"/>
                </svg>
              </button>
            </div>
          </div>

          {# Category #}
          <div class="col-6 col-md-6 d-flex flex-column">
            <label class="form-label">Category</label>
            <input type="hidden" name="category" id="input_cat" value="{{ selected_category }}">
            <div class="text-center mb-1">
              <button type="button" class="btn btn-light scroll-btn scroll-up" data-target="list_cat">
                <!-- up caret SVG -->
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor"
                     class="bi bi-caret-up-fill" viewBox="0 0 16 16">
                  <path d="m7.247 4.86-4.796 5.481c-.566.647-.106 
                   1.659.753 1.659h9.592a1 1 0 0 0 .753-1.659l-4.796-5.48a1 1 
                   0 0 0-1.506 0z"/>
                </svg>
              </button>
            </div>
            <div id="list_cat" class="list-group flex-grow-1" style="overflow:auto; max-height:300px;">
              {% for cat in categories %}
                <a href="#"
                   class="list-group-item list-group-item-action {% if cat == selected_category %}active{% endif %}"
                   data-value="{{ cat }}">{{ cat }}</a>
              {% endfor %}
            </div>
            <div class="text-center mt-1">
              <button type="button" class="btn btn-light scroll-btn scroll-down" data-target="list_cat">
                <!-- down caret SVG -->
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor"
                     class="bi bi-caret-down-fill" viewBox="0 0 16 16">
                  <path d="M7.247 11.14 2.451 5.658C1.885 5.013 
                   2.345 4 3.204 4h9.592a1 1 0 0 1 .753 1.659l-4.796 
                   5.48a1 1 0 0 1-1.506 0z"/>
                </svg>
              </button>
            </div>
          </div>
        </div>

          {# Operator #}
          <div class="col-12 col-md-4 d-flex flex-column">
          <label for="id_operator" class="form-label">Operator #</label>
          <input type="number" id="id_operator" name="operator"
                  class="form-control" value="{{ selected_operator }}"
                  placeholder="Operator ID">
          </div>

          {# Quantity + Add button #}
          <div class="col-12 col-md-4 d-flex flex-column">
            <label for="id_quantity" class="form-label">Quantity</label>
            <div class="d-flex">
              <input type="number" min="1" id="id_quantity" name="quantity"
                     class="form-control me-2" placeholder="Qty">
              <button type="button" id="add-entry" class="btn btn-warning">Add</button>
            </div>
          </div>

        {# Entries table #}
        <div class="mt-4">
          <h5>Entries to Submit</h5>
          <input type="hidden" name="entries" id="entries-json" value="[]">
          <table class="table table-sm" id="entries-table">
            <thead>
              <tr>
                <th>Part</th><th>Machine</th><th>Operation</th>
                <th>Category</th><th>Qty</th><th>Remove</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>

        <div class="d-flex justify-content-end mt-3">
            <button type="submit" id="submit-bottom" class="btn btn-dark" disabled>Submit All</button>
        </div>
      </form>

      {# your CSS #}
      <style>

        .scroll-btn { width:100%; }
        .list-group-item.active {
          background-color:#000 !important;
          border-color:#000 !important;
          color:#fff !important;
        }
        .list-group-item-action:hover,
        .list-group-item-action:focus {
          background-color:#000 !important;
          border-color:#000 !important;
          color:#fff !important;
        }

        .bigger-dropdown {
            min-width: 250px;   /* control width */
            font-size: 1rem;    /* default Bootstrap ~14px, try 1.1rem (≈17px) or 1.25rem (≈20px) */
            padding: 0.5rem 1rem; /* gives a bit more clickable area */
          }


      </style>
    </div>
  </div>
</div>
{% endblock content %}

{% block extra_scripts %}
<script>
  "use strict";

  // -------------------------------
  // Config & URL helpers
  // -------------------------------
  const GET_PARTS_URL      = "{% url 'get_parts' %}";
  const GET_MACHINES_URL   = "{% url 'get_machines' %}";
  const GET_OPERATIONS_URL = "{% url 'get_operations' %}";
  const GET_CATEGORIES_URL = "{% url 'get_categories' %}";

  // Global params that should ride along with every AJAX request (e.g., selected program)
  const GLOBAL_PARAMS = {};

  // Build URL with merged params (drop empty/nulls)
  function buildUrl(base, paramsObj = {}) {
    const merged = { ...GLOBAL_PARAMS, ...paramsObj };
    const clean = Object.fromEntries(
      Object.entries(merged).filter(([_, v]) => v !== "" && v != null)
    );
    const qs = new URLSearchParams(clean).toString();
    return qs ? `${base}?${qs}` : base;
  }

  // Keep the current program reflected in the URL (bookmarkable/shareable)
  function updateQueryParam(key, value) {
    const url = new URL(window.location.href);
    if (value === "" || value == null) {
      url.searchParams.delete(key);
    } else {
      url.searchParams.set(key, value);
    }
    window.history.replaceState({}, "", url.toString());
  }

  // Small sanitizer for table cells
  function safeText(s) {
    const div = document.createElement('div');
    div.textContent = String(s ?? "");
    return div.innerHTML;
  }

  // -------------------------------
  // Scroll helpers
  // -------------------------------
  const SCROLL_AMOUNT = 35, SCROLL_INTERVAL = 60;
  document.querySelectorAll('.scroll-btn').forEach(btn => {
    let timer;
    const container = document.getElementById(btn.dataset.target);
    const start = dir => {
      if (timer) clearInterval(timer);
      timer = setInterval(() => { container.scrollTop += dir * SCROLL_AMOUNT; }, SCROLL_INTERVAL);
    };
    const stop = () => { clearInterval(timer); timer = null; };

    btn.addEventListener('mousedown', () => start(btn.classList.contains('scroll-down') ? 1 : -1));
    ['mouseup','mouseleave','touchend'].forEach(evt => btn.addEventListener(evt, stop));
    btn.addEventListener('touchstart', e => { e.preventDefault(); start(btn.classList.contains('scroll-down') ? 1 : -1); });
  });

  // -------------------------------
  // DOM helpers
  // -------------------------------
  function clearList(listId, inputId) {
    const list = document.getElementById(listId);
    const hidden = document.getElementById(inputId);
    list.innerHTML = '';
    hidden.value = '';
  }

  function ajaxList(url, params, listId, inputId) {
    const fullUrl = buildUrl(url, params);

    fetch(fullUrl, { credentials: 'same-origin' })
      .then(r => r.json())
      .then(json => {
        const list = document.getElementById(listId);
        const hidden = document.getElementById(inputId);

        list.innerHTML = '';
        hidden.value = '';

        (json.results || []).forEach(val => {
          const a = document.createElement('a');
          a.href = '#';
          a.className = 'list-group-item list-group-item-action';
          a.dataset.value = val;
          a.textContent = val;
          list.appendChild(a);
        });
      })
      .catch(() => {
        const list = document.getElementById(listId);
        const hidden = document.getElementById(inputId);
        list.innerHTML = '';
        hidden.value = '';
      });
  }

  function wireListClicks(listId, inputId, onPick) {
    const list = document.getElementById(listId);
    const hidden = document.getElementById(inputId);

    list.addEventListener('click', e => {
      const target = e.target.closest('.list-group-item');
      if (!target) return;
      e.preventDefault();

      list.querySelectorAll('.active').forEach(el => el.classList.remove('active'));
      target.classList.add('active');
      hidden.value = target.dataset.value || '';
      onPick && onPick(hidden.value);
    });
  }

  // -------------------------------
  // Program → Part → Op → Machine → Category
  // -------------------------------
  const programSelect = document.getElementById('select_program');
  const programHidden = document.getElementById('input_program');

  // initialize current program from hidden, then URL (?program=), then blank
  let currentProgram =
    (programHidden?.value || "").trim() ||
    (new URLSearchParams(window.location.search)).get('program') ||
    "";

  function setProgram(prog) {
    currentProgram = prog || "";
    if (programSelect) programSelect.value = currentProgram;
    if (programHidden) programHidden.value = currentProgram;
    if (currentProgram) {
      GLOBAL_PARAMS.program = currentProgram;
    } else {
      delete GLOBAL_PARAMS.program;
    }
    updateQueryParam('program', currentProgram);
  }

  function onProgramChange() {
    setProgram(programSelect.value);

    // clear everything downstream
    clearList('list_part',    'input_part');
    clearList('list_op',      'input_op');
    clearList('list_machine', 'input_machine');
    clearList('list_cat',     'input_cat');

    // clear entries too (and update submit state)
    resetEntries();

    if (currentProgram) {
      ajaxList(GET_PARTS_URL, { program: currentProgram }, 'list_part', 'input_part');
    }
  }

  if (programSelect) {
    programSelect.addEventListener('change', onProgramChange);
  }

  // 1) Pick a Part → load Operations
  wireListClicks('list_part', 'input_part', pn => {
    clearList('list_op',      'input_op');
    clearList('list_machine', 'input_machine');
    clearList('list_cat',     'input_cat');

    if (!currentProgram) {
      alert('Select a Program first.');
      return;
    }

    ajaxList(GET_OPERATIONS_URL,
      { part_number: pn },
      'list_op', 'input_op'
    );
  });

  // 2) Pick an Operation → load Machines
  wireListClicks('list_op', 'input_op', op => {
    clearList('list_machine', 'input_machine');
    clearList('list_cat',     'input_cat');

    ajaxList(GET_MACHINES_URL,
      {
        part_number: document.getElementById('input_part').value,
        operation:   op
      },
      'list_machine', 'input_machine'
    );
  });

  // 3) Pick a Machine → load Categories
  wireListClicks('list_machine', 'input_machine', mc => {
    clearList('list_cat', 'input_cat');

    ajaxList(GET_CATEGORIES_URL,
      {
        part_number: document.getElementById('input_part').value,
        operation:   document.getElementById('input_op').value,
        machine:     mc
      },
      'list_cat', 'input_cat'
    );
  });

  // 4) Pick a Category → just select it
  wireListClicks('list_cat', 'input_cat', () => {});

  // If page loads with a program (hidden or ?program=), auto-fetch parts
  if (currentProgram) {
    setProgram(currentProgram);
    ajaxList(GET_PARTS_URL, { program: currentProgram }, 'list_part', 'input_part');
  } else {
    clearList('list_part',    'input_part');
    clearList('list_op',      'input_op');
    clearList('list_machine', 'input_machine');
    clearList('list_cat',     'input_cat');
  }

  // -------------------------------
  // Entries accumulation + submit button gating
  // -------------------------------
  const entries       = [];
  const tableBody     = document.querySelector('#entries-table tbody');
  const entriesInput  = document.getElementById('entries-json');
  const qtyField      = document.getElementById('id_quantity');
  const operatorField = document.getElementById('id_operator');
  const formEl        = document.getElementById('scrap-form');
  const submitTop     = document.getElementById('submit-top');
  const submitBottom  = document.getElementById('submit-bottom');

  function updateSubmitState() {
    const hasEntries = entries.length > 0;
    if (submitTop)    submitTop.disabled = !hasEntries;
    if (submitBottom) submitBottom.disabled = !hasEntries;
  }

  function resetEntries() {
    entries.length = 0;
    renderEntries();
    updateSubmitState();
  }

  document.getElementById('add-entry').addEventListener('click', () => {
    const part      = document.getElementById('input_part').value;
    const machine   = document.getElementById('input_machine').value;
    const operation = document.getElementById('input_op').value;
    const category  = document.getElementById('input_cat').value;
    const qty       = qtyField.value;
    const opn       = operatorField.value;

    if (!currentProgram) {
      alert('Select a Program first.');
      return;
    }
    if (!part || !machine || !operation || !category || !qty || !opn) {
      alert('Please fill out all fields (including Operator #) before adding.');
      return;
    }

    entries.push({ part, machine, operation, category, qty, operator: opn });
    renderEntries();
    updateSubmitState();
    qtyField.value = '';
  });

  function renderEntries() {
    tableBody.innerHTML = '';

    entries.forEach((e, i) => {
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${safeText(e.part)}</td>
        <td>${safeText(e.machine)}</td>
        <td>${safeText(e.operation)}</td>
        <td>${safeText(e.category)}</td>
        <td>${safeText(e.qty)}</td>
        <td><button type="button" class="btn btn-sm btn-danger remove-entry" data-index="${i}">&times;</button></td>
      `;
      tableBody.appendChild(tr);
    });

    entriesInput.value = JSON.stringify(entries);

    tableBody.querySelectorAll('.remove-entry').forEach(btn => {
      btn.addEventListener('click', () => {
        const idx = Number(btn.dataset.index);
        if (!Number.isNaN(idx)) {
          entries.splice(idx, 1);
          renderEntries();
          updateSubmitState();
        }
      });
    });
  }

  // Guard: don’t submit with zero entries
  if (formEl) {
    formEl.addEventListener('submit', (e) => {
      if (entries.length === 0) {
        e.preventDefault();
        alert('Add at least one entry before submitting.');
        return;
      }
      // ensure JSON is fresh just before submit
      entriesInput.value = JSON.stringify(entries);
    });
  }

  // Initialize disabled state on load
  updateSubmitState();

  // -------------------------------
  // Alerts auto-dismiss
  // -------------------------------
  setTimeout(() => {
    document.querySelectorAll('.alert').forEach(el => {
      const inst = bootstrap.Alert.getOrCreateInstance(el);
      inst.close();
    });
  }, 3000);
</script>




{% endblock extra_scripts %}
