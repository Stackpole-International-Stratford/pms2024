{# templates/quality/scrap_entry.html #}
{% extends "parent.html" %}
{% load static %}

{% block content %}
<div class="container mt-4">
  <h2>Record Scrap Entry</h2>

  {% if messages %}
    {% for msg in messages %}
      <div class="alert alert-{{ msg.tags }}">{{ msg }}</div>
    {% endfor %}
  {% endif %}

  <div class="card mb-4">
    <div class="card-header">
      Record Scrap Entry
    </div>
    <div class="card-body">
      <form method="post" id="scrap-form">
        {% csrf_token %}
        <div class="row">
          <!-- Part Number -->
          <div class="col-md-3">
            <div class="form-group">
              <label for="id_part_number">Part Number</label>
              <select
                id="id_part_number"
                name="part_number"
                class="form-control"
                size="5"
              >
                {% for pn in part_numbers %}
                  <option value="{{ pn }}"
                    {% if pn == selected_part_number %}selected{% endif %}>
                    {{ pn }}
                  </option>
                {% endfor %}
              </select>
            </div>
          </div>

          <!-- Machine -->
          <div class="col-md-3">
            <div class="form-group">
              <label for="id_machine">Machine</label>
              <select
                id="id_machine"
                name="machine"
                class="form-control"
                size="5"
              >
                {% for m in machines %}
                  <option value="{{ m.asset_number }}"
                    {% if m.asset_number == selected_machine %}selected{% endif %}>
                    {{ m.asset_name|default:m.asset_number }}
                  </option>
                {% endfor %}
              </select>
            </div>
          </div>

          <!-- Operation -->
          <div class="col-md-2">
            <div class="form-group">
              <label for="id_operation">Operation</label>
              <select
                id="id_operation"
                name="operation"
                class="form-control"
                size="5"
              >
                {% for op in operations %}
                  <option value="{{ op }}"
                    {% if op == selected_operation %}selected{% endif %}>
                    {{ op }}
                  </option>
                {% endfor %}
              </select>
            </div>
          </div>

          <!-- Category -->
          <div class="col-md-2">
            <div class="form-group">
              <label for="id_category">Category</label>
              <select
                id="id_category"
                name="category"
                class="form-control"
                size="5"
              >
                {% for cat in categories %}
                  <option value="{{ cat }}"
                    {% if cat == selected_category %}selected{% endif %}>
                    {{ cat }}
                  </option>
                {% endfor %}
              </select>
            </div>
          </div>

          <!-- Quantity -->
          <div class="col-md-2">
            <div class="form-group">
              <label for="id_quantity">Quantity</label>
              <input
                type="number"
                min="1"
                id="id_quantity"
                name="quantity"
                class="form-control"
                value="{{ quantity }}"
              >
            </div>
          </div>
        </div>

        <button type="submit" class="btn btn-warning mt-3">Submit</button>
      </form>
    </div>
  </div>
</div>

<style>
  /* ensure the large selects scroll nicely */
  select[size] {
    overflow-y: auto;
  }
</style>

<script>
  const ajaxPopulate = (url, params, target) => {
    fetch(url + "?" + new URLSearchParams(params), {
      credentials: "same-origin"
    })
      .then(r => r.json())
      .then(json => {
        target.innerHTML = "";
        json.results.forEach(item => {
          const opt = document.createElement("option");
          if (typeof item === "object") {
            opt.value = item.asset_number;
            opt.textContent = item.asset_name || item.asset_number;
          } else {
            opt.value = opt.textContent = item;
          }
          target.appendChild(opt);
        });
      });
  };

  const partSel    = document.getElementById("id_part_number");
  const machineSel = document.getElementById("id_machine");
  const opSel      = document.getElementById("id_operation");
  const catSel     = document.getElementById("id_category");

  partSel.addEventListener("change", () => {
    // clear downstream lists
    machineSel.innerHTML = "";
    opSel.innerHTML      = "";
    catSel.innerHTML     = "";
    if (partSel.value) {
      ajaxPopulate(
        "{% url 'get_machines' %}",
        { part_number: partSel.value },
        machineSel
      );
    }
  });

  machineSel.addEventListener("change", () => {
    opSel.innerHTML  = "";
    catSel.innerHTML = "";
    if (machineSel.value) {
      ajaxPopulate(
        "{% url 'get_operations' %}",
        {
          part_number: partSel.value,
          machine:     machineSel.value
        },
        opSel
      );
    }
  });

  opSel.addEventListener("change", () => {
    catSel.innerHTML = "";
    if (opSel.value) {
      ajaxPopulate(
        "{% url 'get_categories' %}",
        {
          part_number: partSel.value,
          machine:     machineSel.value,
          operation:   opSel.value
        },
        catSel
      );
    }
  });
</script>
{% endblock %}
