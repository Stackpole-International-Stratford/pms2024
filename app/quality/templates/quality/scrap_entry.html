{% extends "parent.html" %}

{% block title %}Scrap Submissions{% endblock %}

{% block content %}
<div class="container my-4">
  <h1 class="mb-4">Scrap Entry</h1>
  <div class="table-responsive">
    <table id="scrap-table" class="table table-striped table-bordered">
      <thead class="thead-dark">
        <tr>
          <th>Part Number</th>
          <th>Operation</th>
          <th>Category</th>
          <th>Actions</th>
        </tr>
        <tr>
          <th>
            <input type="text"
                   id="filter-part"
                   class="form-control form-control-sm"
                   placeholder="Filter Part">
          </th>
          <th>
            <input type="text"
                   id="filter-operation"
                   class="form-control form-control-sm"
                   placeholder="Filter Operation">
          </th>
          <th>
            <input type="text"
                   id="filter-category"
                   class="form-control form-control-sm"
                   placeholder="Filter Category">
          </th>
          <th></th>
        </tr>
      </thead>
      <tbody>
        {% for cat in categories %}
        <tr>
          <td class="td-part">{{ cat.part_number }}</td>
          <td class="td-operation">{{ cat.operation }}</td>
          <td class="td-category">{{ cat.category }}</td>
          <td>
            <form class="scrap-entry-form d-flex align-items-center"
                  data-part-number="{{ cat.part_number }}"
                  data-operation="{{ cat.operation }}"
                  data-category="{{ cat.category }}">
              {% csrf_token %}
              <input type="text"
                     name="machine"
                     class="form-control form-control-sm mr-2"
                     placeholder="Machine"
                     required
                     style="max-width: 200px;">
              <input type="number"
                     name="quantity"
                     class="form-control form-control-sm mr-2"
                     placeholder="Qty"
                     min="1"
                     required
                     style="max-width: 100px;">
              <button type="submit" class="btn btn-warning btn-sm">Submit</button>
            </form>
          </td>
        </tr>
        {% empty %}
        <tr>
          <td colspan="4" class="text-center">No categories defined.</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
  const filterPart  = document.getElementById('filter-part');
  const filterOp    = document.getElementById('filter-operation');
  const filterCat   = document.getElementById('filter-category');
  const rows        = document.querySelectorAll('#scrap-table tbody tr');

  function filterTable() {
    const partVal = filterPart.value.trim().toLowerCase();
    const opVal   = filterOp.value.trim().toLowerCase();
    const catVal  = filterCat.value.trim().toLowerCase();

    rows.forEach(row => {
      const partCell = row.querySelector('.td-part');
      // skip the "no categories" row
      if (!partCell) return;

      const tdPart = partCell.textContent.trim().toLowerCase();
      const tdOp   = row.querySelector('.td-operation').textContent.trim().toLowerCase();
      const tdCat  = row.querySelector('.td-category').textContent.trim().toLowerCase();

      const show = tdPart.includes(partVal)
                && tdOp.includes(opVal)
                && tdCat.includes(catVal);

      row.style.display = show ? '' : 'none';
    });
  }

  filterPart.addEventListener('input', filterTable);
  filterOp.addEventListener('input', filterTable);
  filterCat.addEventListener('input', filterTable);

  // AJAX submission
  document.querySelectorAll('.scrap-entry-form').forEach(form => {
    form.addEventListener('submit', function(e) {
      e.preventDefault();
      const data = new FormData(form);
      data.append('part_number', form.dataset.partNumber);
      data.append('operation',   form.dataset.operation);
      data.append('category',    form.dataset.category);

      fetch("{% url 'create_scrap_entry' %}", {
        method: 'POST',
        headers: { 'X-CSRFToken': data.get('csrfmiddlewaretoken') },
        body: data
      })
      .then(r => r.json())
      .then(json => {
        if (json.success) {
          alert('Saved! Thank you');
          form.reset();
        } else {
          alert('Error: ' + json.error);
        }
      })
      .catch(() => {
        alert('An unexpected error occurred.');
      });
    });
  });
});
</script>
{% endblock %}
