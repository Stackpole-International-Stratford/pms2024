{% extends "parent.html" %}

{% block title %}Scrap Entry{% endblock %}

{% block content %}
<style>
  /* target just the filter row inputs */
  #scrap-table thead tr:nth-child(2) .form-control {
    /* adjust min-height to ~2× the normal line-height */
    min-height: 3rem;
  }
  /* make the two filter-row inputs taller */
#scrap-table thead tr:nth-child(2) .form-control {
  min-height: 3rem;
}

/* make the machine & qty inputs taller for fat fingers */
.scrap-entry-form .entry-item input[name="machine"],
.scrap-entry-form .entry-item input[name="quantity"] {
  min-height: 3rem;
}
</style>

<div class="container my-4">
  <h1 class="mb-4">Submit Scrap</h1>
  <div class="table-responsive">
    <table id="scrap-table" class="table table-striped table-bordered">
      <thead class="thead-dark">
        <tr>
          <th>Part Number</th>
          <th>Operation</th>
          <th>Category</th>
          <th>Actions</th>
        </tr>
        <tr>
          <th>
            <input type="text"
                   id="filter-part"
                   class="form-control form-control-sm"
                   placeholder="Filter Part">
          </th>
          <th>
            <input type="text"
                   id="filter-operation"
                   class="form-control form-control-sm"
                   placeholder="Filter Operation">
          </th>
          <th>
            <input type="text"
                   id="filter-category"
                   class="form-control form-control-sm"
                   placeholder="Filter Category">
          </th>
          <th></th>
        </tr>
      </thead>
      <tbody>
        {% for cat in categories %}
        <tr>
          <td class="td-part">{{ cat.part_number }}</td>
          <td class="td-operation">{{ cat.operation }}</td>
          <td class="td-category">{{ cat.category }}</td>
          <td>
            <form class="scrap-entry-form p-2 border rounded"
                  data-part-number="{{ cat.part_number }}"
                  data-operation="{{ cat.operation }}"
                  data-category="{{ cat.category }}">
              {% csrf_token %}
              <div class="entry-list">
                <div class="entry-item row gx-2 gy-1 align-items-center mb-1">
                  <div class="col-auto">
                    <input type="text"
                           name="machine"
                           class="form-control form-control-sm"
                           placeholder="Machine"
                           required>
                  </div>
                  <div class="col-auto">
                    <input type="number"
                           name="quantity"
                           class="form-control form-control-sm"
                           placeholder="Qty"
                           min="1"
                           required>
                  </div>
                  <div class="col-auto">
                    <button type="button"
                            class="btn btn-dark btn-sm btn-add">+</button>
                    <button type="button"
                            class="btn btn-secondary btn-sm btn-remove">−</button>
                  </div>
                  <div class="col-auto">
                    <button type="submit"
                            class="btn btn-warning btn-sm">Submit</button>
                  </div>
                </div>
              </div>
            </form>
          </td>
        </tr>
        {% empty %}
        <tr>
          <td colspan="4" class="text-center">No categories defined.</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
  // FILTERING
  const filterPart = document.getElementById('filter-part');
  const filterOp   = document.getElementById('filter-operation');
  const filterCat  = document.getElementById('filter-category');
  const rows       = document.querySelectorAll('#scrap-table tbody tr');

  function filterTable() {
    const pv = filterPart.value.trim().toLowerCase();
    const ov = filterOp.value.trim().toLowerCase();
    const cv = filterCat.value.trim().toLowerCase();
    rows.forEach(row => {
      const p = row.querySelector('.td-part');
      if (!p) return;
      const t1 = p.textContent.trim().toLowerCase();
      const t2 = row.querySelector('.td-operation').textContent.trim().toLowerCase();
      const t3 = row.querySelector('.td-category').textContent.trim().toLowerCase();
      row.style.display = (t1.includes(pv) && t2.includes(ov) && t3.includes(cv)) ? '' : 'none';
    });
  }
  [filterPart, filterOp, filterCat].forEach(el => el.addEventListener('input', filterTable));

  // DYNAMIC ROWS + AJAX
  document.querySelectorAll('.scrap-entry-form').forEach(form => {
    const list = form.querySelector('.entry-list');

    function updateRemoveBtns() {
      const items = list.querySelectorAll('.entry-item');
      items.forEach(i => {
        i.querySelector('.btn-remove').disabled = (items.length === 1);
      });
    }

    list.addEventListener('click', e => {
      const item = e.target.closest('.entry-item');
      if (!item) return;
      if (e.target.classList.contains('btn-add')) {
        const clone = item.cloneNode(true);
        clone.querySelector('input[name="machine"]').value = '';
        clone.querySelector('input[name="quantity"]').value = '';
        list.insertBefore(clone, item.nextSibling);
        updateRemoveBtns();
      }
      if (e.target.classList.contains('btn-remove') && list.children.length > 1) {
        item.remove();
        updateRemoveBtns();
      }
    });

    updateRemoveBtns();

    form.addEventListener('submit', e => {
      e.preventDefault();
      const token = form.querySelector('[name="csrfmiddlewaretoken"]').value;
      const url   = "{% url 'create_scrap_entry' %}";
      const part  = form.dataset.partNumber;
      const op    = form.dataset.operation;
      const cat   = form.dataset.category;
      const items = form.querySelectorAll('.entry-item');

      Promise.all(Array.from(items).map(item => {
        const data = new FormData();
        data.append('csrfmiddlewaretoken', token);
        data.append('part_number', part);
        data.append('operation',    op);
        data.append('category',     cat);
        data.append('machine',      item.querySelector('[name="machine"]').value.trim());
        data.append('quantity',     item.querySelector('[name="quantity"]').value);

        return fetch(url, {
          method: 'POST',
          headers: { 'X-CSRFToken': token },
          body: data
        }).then(r => r.json());
      }))
      .then(results => {
        const errs = results.filter(r => !r.success).map(r => r.error);
        if (errs.length) {
          alert('Errors:\n' + errs.join('\n'));
        } else {
          alert('All entries recorded!');
          // reset to single blank row
          const first = list.querySelector('.entry-item');
          list.innerHTML = '';
          list.appendChild(first);
          first.querySelector('[name="machine"]').value = '';
          first.querySelector('[name="quantity"]').value = '';
          updateRemoveBtns();
        }
      })
      .catch(() => alert('An unexpected error occurred.'));
    });
  });
});
</script>
{% endblock %}
