{% extends "parent.html" %}

{% block title %}Scrap Submissions{% endblock %}

{% block content %}
<div class="container my-4">
  <h1 class="mb-4">Submit Scrap</h1>
  <div class="table-responsive">
    <table class="table table-striped table-bordered">
      <thead class="thead-dark">
        <tr>
          <th>Part Number</th>
          <th>Operation</th>
          <th>Category</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody>
        {% for cat in categories %}
        <tr>
          <td>{{ cat.part_number }}</td>
          <td>{{ cat.operation }}</td>
          <td>{{ cat.category }}</td>
          <td>
            <form class="scrap-entry-form d-flex align-items-center"
                  data-part-number="{{ cat.part_number }}"
                  data-operation="{{ cat.operation }}"
                  data-category="{{ cat.category }}">
              {% csrf_token %}
              <input type="text"  name="machine"
                     class="form-control form-control-sm mr-2"
                     placeholder="Machine" required>
              <input type="number" name="quantity"
                     class="form-control form-control-sm mr-2"
                     placeholder="Qty" min="1" required>
              <button type="submit" class="btn btn-primary btn-sm">
                Submit
              </button>
            </form>
          </td>
        </tr>
        {% empty %}
        <tr>
          <td colspan="4" class="text-center">No categories defined.</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', () => {
  document.querySelectorAll('.scrap-entry-form').forEach(form => {
    form.addEventListener('submit', e => {
      e.preventDefault();
      let data = new FormData(form);
      data.append('part_number', form.dataset.partNumber);
      data.append('operation',    form.dataset.operation);
      data.append('category',     form.dataset.category);

      fetch("{% url 'create_scrap_entry' %}", {
        method: 'POST',
        headers: { 'X-CSRFToken': data.get('csrfmiddlewaretoken') },
        body: data
      })
      .then(r => r.json())
      .then(json => {
        if (json.success) {
          alert(`Saved! Total cost: $${json.total_cost}`);
          form.reset();
        } else {
          alert('Error: ' + json.error);
        }
      })
      .catch(() => {
        alert('An unexpected error occurred.');
      });
    });
  });
});
</script>
{% endblock %}
