{# templates/quality/tpc_requests.html #}
{% extends "parent.html" %}
{% load static %}

{% block content %}

<div class="container mt-5">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h2 class="mb-0">TPC Requests</h2>
    <a href="{% url 'tpc_request_new' %}" class="btn btn-primary">
      + Add new TPC request
    </a>
  </div>

  <div class="table-responsive">
    <table id="tpc-table" class="table table-bordered table-striped table-hover align-middle">
      <thead class="align-middle">
        <tr class="text-nowrap">
          <th title="Click to sort">ID</th>
          <th title="Click to sort">Date requested</th>
          <th title="Click to sort">Issuer</th>
          <th title="Click to sort">Part</th>
          <th title="Click to sort">Reason</th>
          <th title="Click to sort">Process</th>
          <th title="Click to sort">Supplier Issue</th>
          <th title="Click to sort">Machine #</th>
          <th title="Click to sort">Expiration</th>
          <th title="Click to sort">Approved?</th>
        </tr>
        <tr>
          {% for _ in "0123456789" %}
            <th><input type="text" class="form-control form-control-sm" placeholder="Search…"></th>
          {% endfor %}
        </tr>
      </thead>

      <tbody>
        {% for t in tpcs %}
          {# Full values in data-* so the modal can show untruncated content #}
          <tr
            title="Click to view details"
            data-pk="{{ t.pk }}"
            data-date-requested="{{ t.date_requested }}"
            data-issuer-name="{{ t.issuer_name }}"
            data-part="{{ t.part|default:'—' }}"
            data-reason="{{ t.reason }}"
            data-process="{{ t.process }}"
            data-supplier-issue="{{ t.supplier_issue|yesno:'Yes,No' }}"
            data-machine-number="{{ t.machine_number }}"
            data-expiration-date="{{ t.expiration_date }}"
            data-approved="{{ t.approved|yesno:'Yes,No' }}"
            data-approvals-got="{{ t.approvals.count }}"
            data-approvals-req="{{ t.required_approvals_count }}"
            data-approvers="{% for a in t.approvals.all %}{{ a.user.get_full_name|default:a.user.username }}{% if not forloop.last %}, {% endif %}{% empty %}—{% endfor %}"
          >
            <td>{{ t.pk }}</td>
            <td>{{ t.date_requested }}</td>
            <td title="{{ t.issuer_name }}">{{ t.issuer_name|truncatechars:20 }}</td>
            <td title="{{ t.part }}">{{ t.part|default:"—"|truncatechars:20 }}</td>
            <td title="{{ t.reason }}">{{ t.reason|truncatechars:25 }}</td>
            <td title="{{ t.process }}">{{ t.process|truncatechars:25 }}</td>
            <td>{{ t.supplier_issue|yesno:"Yes,No" }}</td>
            <td>{{ t.machine_number }}</td>
            <td>{{ t.expiration_date }}</td>

            <td>
              {% if t.approved %}
                <span class="text-success">✅ Fully approved</span>
              {% else %}
                {% with got=t.approvals.count req=t.required_approvals_count %}
                  <span class="badge text-bg-secondary">{{ got }}/{{ req }}</span>
                {% endwith %}

                {% if is_tpc_approver %}
                  {% if not t.user_has_approved %}
                    <form action="{% url 'tpc_approve' t.pk %}" method="post" class="d-inline ms-2" data-row-safe-click>
                      {% csrf_token %}
                      <button type="submit" class="btn btn-sm btn-success">Approve</button>
                    </form>
                  {% else %}
                    <span class="text-muted ms-2">You’ve approved</span>
                  {% endif %}
                {% endif %}
              {% endif %}
            </td>
          </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>

{# ---------- Bootstrap Modal ---------- #}
<div class="modal fade" id="tpcModal" tabindex="-1" aria-labelledby="tpcModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-scrollable">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="tpcModalLabel">TPC Request <span id="m-pk" class="fw-semibold"></span></h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>

      <div class="modal-body">
        <div class="row g-3">
          <div class="col-md-6">
            <div class="form-text m-0">Date requested</div>
            <div id="m-date-requested" class="fw-semibold"></div>
          </div>
          <div class="col-md-6">
            <div class="form-text m-0">Expiration</div>
            <div id="m-expiration-date" class="fw-semibold"></div>
          </div>

          <div class="col-md-6">
            <div class="form-text m-0">Issuer</div>
            <div id="m-issuer-name" class="fw-semibold"></div>
          </div>
          <div class="col-md-6">
            <div class="form-text m-0">Part</div>
            <div id="m-part" class="fw-semibold"></div>
          </div>

          <div class="col-12">
            <div class="form-text m-0">Reason</div>
            <pre id="m-reason" class="border rounded p-2 bg-body-secondary mb-0"></pre>
          </div>

          <div class="col-12">
            <div class="form-text m-0">Process</div>
            <pre id="m-process" class="border rounded p-2 bg-body-secondary mb-0"></pre>
          </div>

          <div class="col-md-4">
            <div class="form-text m-0">Supplier Issue</div>
            <div id="m-supplier-issue" class="fw-semibold"></div>
          </div>
          <div class="col-md-4">
            <div class="form-text m-0">Machine #</div>
            <div id="m-machine-number" class="fw-semibold"></div>
          </div>
          <div class="col-md-4">
            <div class="form-text m-0">Approved?</div>
            <div id="m-approved" class="fw-semibold"></div>
          </div>

          <div class="col-12">
            <div class="form-text m-0">Approvals</div>
            <div class="d-flex align-items-center gap-2">
              <span id="m-approvals-pill" class="badge text-bg-secondary"></span>
              <span id="m-approvers" class="text-muted"></span>
            </div>
          </div>
        </div>
      </div>

      <div class="modal-footer">
        <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>

<script>
/* ---------- Vanilla-JS live search + click-to-sort ---------- */
document.addEventListener('DOMContentLoaded', () => {
  const table  = document.getElementById('tpc-table');
  const inputs = table.querySelectorAll('thead tr:nth-child(2) input');
  const tbody  = table.tBodies[0];
  const rows   = Array.from(tbody.rows);

  function filter() {
    rows.forEach(row => {
      const ok = Array.from(inputs).every((inp, idx) => {
        const term = inp.value.trim().toLowerCase();
        return !term || row.cells[idx].textContent.toLowerCase().includes(term);
      });
      row.classList.toggle('d-none', !ok);
    });
  }
  inputs.forEach(inp => inp.addEventListener('input', filter));

  table.querySelectorAll('thead tr:first-child th').forEach((th, idx) => {
    let asc = true;
    th.addEventListener('click', () => {
      rows.sort((a, b) => {
        const A = a.cells[idx].textContent.trim();
        const B = b.cells[idx].textContent.trim();
        const numA = parseFloat(A.replace(/[^0-9.\-]/g, ''));
        const numB = parseFloat(B.replace(/[^0-9.\-]/g, ''));
        const diff = (!isNaN(numA) && !isNaN(numB))
                     ? numA - numB
                     : A.localeCompare(B, undefined, {numeric:true, sensitivity:'base'});
        return asc ? diff : -diff;
      });
      asc = !asc;
      rows.forEach(r => tbody.appendChild(r));
    });
  });

  /* ---------- Row click -> open modal (Bootstrap only) ---------- */
  const modalEl = document.getElementById('tpcModal');
  const bsModal = typeof bootstrap !== 'undefined' ? new bootstrap.Modal(modalEl) : null;

  tbody.addEventListener('click', (ev) => {
    const target = ev.target;
    if (target.closest('a, button, [data-row-safe-click], form')) return;

    const row = target.closest('tr');
    if (!row) return;

    setText('m-pk',               row.dataset.pk);
    setText('m-date-requested',   row.dataset.dateRequested);
    setText('m-expiration-date',  row.dataset.expirationDate);
    setText('m-issuer-name',      row.dataset.issuerName);
    setText('m-part',             row.dataset.part);
    setText('m-reason',           row.dataset.reason);
    setText('m-process',          row.dataset.process);
    setText('m-supplier-issue',   row.dataset.supplierIssue);
    setText('m-machine-number',   row.dataset.machineNumber);
    setText('m-approved',         row.dataset.approved);
    setText('m-approvals-pill',   `${row.dataset.approvalsGot}/${row.dataset.approvalsReq}`);
    setText('m-approvers',        row.dataset.approvers);

    if (bsModal) bsModal.show();
  });

  function setText(id, value) {
    const el = document.getElementById(id);
    if (!el) return;
    el.textContent = value || '—';
  }
});
</script>
{% endblock %}
