{% extends "parent.html" %}
{% load static %}

{% block content %}
<div class="container mt-5">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h2 class="mb-0">TPC Requests</h2>
    <a href="{% url 'tpc_request_new' %}" class="btn btn-warning">+ New TPC request</a>
  </div>

  <div class="table-responsive">
      <table id="tpc-table" class="table table-sm table-bordered table-striped table-hover align-middle">
      <thead class="align-middle">
        <tr class="text-nowrap">
          <th>ID</th>
          <th>Date Requested</th>
          <th>Issuer</th>
          <th>Parts</th>
          <th>Reason</th>
          <th>Process</th>
          <th>Supplier<br>Issue</th>
          <th>Machines</th>
          <th>Expiration Date</th>
          <th>Approved?</th>
          <th>PDF</th>
        </tr>
        <tr>
          {% for _ in "0123456789" %}
            <th><input type="text" class="form-control form-control-sm" placeholder="Search…"></th>
          {% endfor %}
        </tr>
      </thead>

      <tbody id="tpc-tbody">
  {% for t in rows %}
    <tr
      class="tpc-row"
      style="cursor:pointer"
      data-pk="{{ t.pk }}"
      data-date-requested="{{ t.date_requested }}"
      data-expiration-date="{{ t.expiration_date }}"
      data-issuer-name="{{ t.issuer_name }}"
      data-part="{{ t.parts }}"
      data-reason="{{ t.reason }}"
      data-process="{{ t.process }}"
      data-supplier-issue="{{ t.supplier_issue }}"
      data-machine-number="{{ t.machines }}"
      data-approved="{{ t.approved|yesno:'Yes,No' }}"
      data-approvals-got="{{ t.approvals_got }}"
      data-approvals-req="{{ t.approvals_req }}"
      data-approvers="{{ t.approvers }}"
      data-user-has-approved="{{ t.user_has_approved|yesno:'true,false' }}"
      data-href="/quality/tpc-requests/{{ t.pk }}/edit/"
    >
      <td>{{ t.pk }}</td>
      <td title="{{ t.date_requested }}">{{ t.date_requested|slice:":15" }}</td>
      <td title="{{ t.issuer_name }}">{{ t.issuer_name|slice:":15" }}</td>
      <td title="{{ t.parts }}">{{ t.parts|default:"—"|slice:":15" }}</td>
      <td title="{{ t.reason }}">{{ t.reason|slice:":15" }}</td>
      <td title="{{ t.process }}">{{ t.process|slice:":15" }}</td>
      <td>{{ t.supplier_issue }}</td>
      <td title="{{ t.machines }}">{{ t.machines|default:"—"|slice:":15" }}</td>
      <td title="{{ t.expiration_date }}">{{ t.expiration_date|slice:":15" }}</td>
      <td>
        {% if t.approved %}
          <span class="text-success">Fully approved</span>
        {% else %}
          {% if t.has_verbal %}
            <span class="text-warning me-2"><strong>Verbally approved</strong></span>
          {% endif %}
          <span class="badge text-bg-secondary">{{ t.approvals_got }}/{{ t.approvals_req }}</span>

          {% if is_tpc_approver %}
            {% if not t.user_has_approved %}
              <form action="{% url 'tpc_approve' t.pk %}" method="post" class="d-inline ms-2" data-row-safe-click>
                {% csrf_token %}
                <button type="submit" class="btn btn-sm btn-success">Approve</button>
              </form>
            {% else %}
              <span class="text-muted ms-2">You’ve approved</span>
            {% endif %}
            <form action="{% url 'tpc_reject' t.pk %}" method="post"
                  class="d-inline ms-2" data-row-safe-click
                  onsubmit="return confirm('Reject this TPC request?');">
              {% csrf_token %}
              <button type="submit" class="btn btn-outline-danger btn-sm py-0 px-1 lh-1">Reject</button>
            </form>
          {% else %}
            {% if not t.has_verbal %}
              <a href="{% url 'tpc_verbal' t.pk %}"
                 class="btn btn-outline-warning btn-sm py-0 px-1 lh-1 ms-2"
                 data-row-safe-click>Verbal approval</a>
            {% endif %}
          {% endif %}
        {% endif %}
      </td>
      <td>
        {% if t.pdf_url %}
          <a href="{{ t.pdf_url }}" target="_blank" title="View PDF" class="text-dark" data-row-safe-click>
            <!-- same SVG as before -->
            <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32"
                 fill="currentColor" class="bi bi-filetype-pdf" viewBox="0 0 16 16"
                 aria-hidden="true" focusable="false">
              <path fill-rule="evenodd" d="M14 4.5V14a2 2 0 0 1-2 2h-1v-1h1a1 1 0 0 0 1-1V4.5h-2A1.5 1.5 0 0 1 9.5 3V1H4a1 1 0 0 0-1 1v9H2V2a2 2 0 0 1 2-2h5.5zM1.6 11.85H0v3.999h.791v-1.342h.803q.43 0 .732-.173.305-.175.463-.474a1.4 1.4 0 0 0 .161-.677q0-.375-.158-.677a1.2 1.2 0 0 0-.46-.477q-.3-.18-.732-.179m.545 1.333a.8.8 0 0 1-.085.38.57.57 0 0 1-.238.241.8.8 0 0 1-.375.082H.788V12.48h.66q.327 0 .512.181.185.183.185.522m1.217-1.333v3.999h1.46q.602 0 .998-.237a1.45 1.45 0 0 0 .595-.689q.196-.45.196-1.084 0-.63-.196-1.075a1.43 1.43 0 0 0-.589-.68q-.396-.234-1.005-.234zm.791.645h.563q.371 0 .609.152a.9.9 0 0 1 .354.454q.118.302.118.753a2.3 2.3 0 0 1-.068.592 1.1 1.1 0 0 1-.196.422.8.8 0 0 1-.334.252 1.3 1.3 0 0 1-.483.082h-.563zm3.743 1.763v1.591h-.79V11.85h2.548v.653H7.896v1.117h1.606v.638z"/>
            </svg>
          </a>
        {% endif %}
      </td>
    </tr>
  {% endfor %}
</tbody>

    </table>
    <div class="text-center mt-3" id="load-more-container">
      <button id="load-more" class="btn btn-outline-dark">Load more</button>
    </div>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', () => {
  const tbody = document.getElementById('tpc-tbody');
  const loadBtn = document.getElementById('load-more');
  let offset = {{ tpcs|length }};
  const pageSize = {{ tpc_page_size }};
  const isTpcApprover = {{ is_tpc_approver|yesno:"true,false" }};

  // Filtering
  document.querySelectorAll('thead tr:nth-child(2) input').forEach(inp => {
    inp.addEventListener('input', () => {
      const filters = Array.from(document.querySelectorAll('thead tr:nth-child(2) input'));
      tbody.querySelectorAll('tr').forEach(row => {
        const visible = filters.every((input, idx) =>
          !input.value || row.cells[idx].textContent.toLowerCase().includes(input.value.toLowerCase())
        );
        row.classList.toggle('d-none', !visible);
      });
    });
  });

  // Row click => navigate to detail page
  tbody.addEventListener('click', e => {
    if (e.target.closest('a, button, form, [data-row-safe-click]')) return;
    const row = e.target.closest('tr');
    if (!row) return;
    const href = row.dataset.href || `/quality/tpc-requests/${row.dataset.pk}/edit/`;
    window.location.href = href;
  });

  const pdfIconSvg = `
    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20"
         fill="currentColor" class="bi bi-filetype-pdf" viewBox="0 0 16 16"
         aria-hidden="true" focusable="false">
      <path fill-rule="evenodd" d="M14 4.5V14a2 2 0 0 1-2 2h-1v-1h1a1 1 0 0 0 1-1V4.5h-2A1.5 1.5 0 0 1 9.5 3V1H4a1 1 0 0 0-1 1v9H2V2a2 2 0 0 1 2-2h5.5zM1.6 11.85H0v3.999h.791v-1.342h.803q.43 0 .732-.173.305-.175.463-.474a1.4 1.4 0 0 0 .161-.677q0-.375-.158-.677a1.2 1.2 0 0 0-.46-.477q-.3-.18-.732-.179m.545 1.333a.8.8 0 0 1-.085.38.57.57 0 0 1-.238.241.8.8 0 0 1-.375.082H.788V12.48h.66q.327 0 .512.181.185.183.185.522m1.217-1.333v3.999h1.46q.602 0 .998-.237a1.45 1.45 0 0 0 .595-.689q.196-.45.196-1.084 0-.63-.196-1.075a1.43 1.43 0 0 0-.589-.68q-.396-.234-1.005-.234zm.791.645h.563q.371 0 .609.152a.9.9 0 0 1 .354.454q.118.302.118.753a2.3 2.3 0 0 1-.068.592 1.1 1.1 0 0 1-.196.422.8.8 0 0 1-.334.252 1.3 1.3 0 0 1-.483.082h-.563zm3.743 1.763v1.591h-.79V11.85h2.548v.653H7.896v1.117h1.606v.638z"/>
    </svg>`.trim();

  // Load more
  loadBtn.addEventListener('click', () => {
    loadBtn.disabled = true;
    loadBtn.textContent = 'Loading...';
    fetch(`{% url 'tpc_request_load_more' %}?offset=${offset}`)
      .then(res => res.json())
      .then(data => {
        data.rows.forEach(t => {
          const tr = document.createElement('tr');
          tr.className = 'tpc-row';
          tr.style.cursor = 'pointer';
          tr.dataset.pk = t.pk;
          tr.dataset.dateRequested = t.date_requested;
          tr.dataset.expirationDate = t.expiration_date;
          tr.dataset.issuerName = t.issuer_name;
          tr.dataset.part = t.parts;
          tr.dataset.reason = t.reason;
          tr.dataset.process = t.process;
          tr.dataset.supplierIssue = t.supplier_issue;
          tr.dataset.machineNumber = t.machines;
          tr.dataset.approved = t.approved ? 'Yes' : 'No';
          tr.dataset.approvalsGot = t.approvals_got;
          tr.dataset.approvalsReq = t.approvals_req;
          tr.dataset.approvers = t.approvers;
          tr.dataset.userHasApproved = t.user_has_approved;
          tr.dataset.href = `/quality/tpc-requests/${t.pk}/edit/`;

          const statusHtml = t.approved
            ? '<span class="text-success">Fully approved</span>'
            : `
                ${t.has_verbal ? '<span class="text-warning me-2"><strong>Verbally approved</strong></span>' : ''}
                <span class="badge text-bg-secondary">${t.approvals_got}/${t.approvals_req}</span>
                ${
                  isTpcApprover
                    ? (!t.user_has_approved
                        ? `<form action="/quality/tpc-requests/${t.pk}/approve/" method="post" class="d-inline ms-2" data-row-safe-click>
                             {% csrf_token %}
                             <button type="submit" class="btn btn-sm btn-success">Approve</button>
                           </form>`
                        : `<span class="text-muted ms-2">You’ve approved</span>`)
                    : ''
                }
                ${
                  (!isTpcApprover && !t.has_verbal)
                    ? `<a href="/quality/tpc-requests/${t.pk}/verbal/"
                         class="btn btn-outline-warning btn-sm py-0 px-1 lh-1 ms-2"
                         data-row-safe-click>Verbal approval</a>`
                    : ''
                }
                ${
                  (isTpcApprover && !t.approved)
                    ? `<form action="/quality/tpc-requests/${t.pk}/reject/" method="post"
                             class="d-inline ms-2" data-row-safe-click
                             onsubmit="return confirm('Reject this TPC request?');">
                         {% csrf_token %}
                         <button type="submit" class="btn btn-outline-danger btn-sm py-0 px-1 lh-1">Reject</button>
                       </form>`
                    : ''
                }
              `;

          const pdfHtml = t.pdf_url
            ? `<a href="${t.pdf_url}" target="_blank"
                  title="${t.approved ? 'View official PDF' : 'View verbal approval PDF'}"
                  class="text-info"
                  data-row-safe-click>${pdfIconSvg}</a>`
            : '';

          tr.innerHTML = `
            <td>${t.pk}</td>
            <td title="${t.date_requested}">${t.date_requested.substring(0,15)}</td>
            <td title="${t.issuer_name}">${t.issuer_name.substring(0,15)}</td>
            <td title="${t.parts}">${t.parts ? (t.parts.length > 15 ? t.parts.substring(0,15) : t.parts) : '—'}</td>
            <td title="${t.reason}">${t.reason.substring(0,15)}</td>
            <td title="${t.process}">${t.process.substring(0,15)}</td>
            <td>${t.supplier_issue}</td>
            <td title="${t.machines}">${t.machines ? (t.machines.length > 15 ? t.machines.substring(0,15) : t.machines) : '—'}</td>
            <td title="${t.expiration_date}">${t.expiration_date.substring(0,15)}</td>
            <td>${statusHtml}</td>
            <td>${pdfHtml}</td>
          `;
          tbody.appendChild(tr);
        });

        offset += pageSize;
        if (data.has_more) {
          loadBtn.disabled = false;
          loadBtn.textContent = 'Load more';
        } else {
          document.getElementById('load-more-container').remove();
        }
      })
      .catch(err => {
        console.error(err);
        loadBtn.disabled = false;
        loadBtn.textContent = 'Load more';
      });
  });
});
</script>


{% endblock %}
