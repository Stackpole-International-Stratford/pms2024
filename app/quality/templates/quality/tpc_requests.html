{% extends "parent.html" %}
{% load static %}

{% block content %}
<div class="container mt-5">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h2 class="mb-0">TPC Requests</h2>
    <a href="{% url 'tpc_request_new' %}" class="btn btn-warning">+ New TPC request</a>
  </div>

  <div class="table-responsive">
    <table id="tpc-table" class="table table-sm table-bordered table-striped table-hover align-middle">
      <thead class="align-middle">
        <tr class="text-nowrap">
          <th>ID</th>
          <th>Date Requested</th>
          <th>Issuer</th>
          <th>Parts</th>
          <th>Reason</th>
          <th>Process</th>
          <th>Supplier Issue</th>
          <th>Machines</th>
          <th>Expiration</th>
          <th>Approved?</th>
          <th>PDF</th>
        </tr>
        <tr>
          {% for _ in "0123456789" %}
            <th><input type="text" class="form-control form-control-sm" placeholder="Searchâ€¦"></th>
          {% endfor %}
        </tr>
      </thead>
      <tbody id="tpc-tbody">
        {% for t in tpcs %}
        <tr
          data-pk="{{ t.pk }}"
          data-date-requested="{{ t.date_requested }}"
          data-expiration-date="{{ t.expiration_date }}"
          data-issuer-name="{{ t.issuer_name }}"
          data-part="{% if t.parts %}{{ t.parts|join:', ' }}{% else %}â€”{% endif %}"
          data-reason="{{ t.reason }}"
          data-process="{{ t.process }}"
          data-supplier-issue="{{ t.supplier_issue|yesno:'Yes,No' }}"
          data-machine-number="{% if t.machines %}{{ t.machines|join:', ' }}{% else %}â€”{% endif %}"
          data-approved="{{ t.approved|yesno:'Yes,No' }}"
          data-approvals-got="{{ t.approvals.count }}"
          data-approvals-req="{{ t.required_approvals_count }}"
          data-approvers="{% for a in t.approvals.all %}{{ a.user.get_full_name|default:a.user.username }}{% if not forloop.last %}, {% endif %}{% empty %}â€”{% endfor %}"
          data-user-has-approved="{{ t.user_has_approved|yesno:'true,false' }}"
        >
          <td>{{ t.pk }}</td>
          <td title="{{ t.date_requested }}">{{ t.date_requested|truncatechars:15 }}</td>
          <td title="{{ t.issuer_name }}">{{ t.issuer_name|truncatechars:15 }}</td>
          <td title="{% if t.parts %}{{ t.parts|join:', ' }}{% else %}â€”{% endif %}">
            {% if t.parts %}{{ t.parts|join:", "|truncatechars:15 }}{% else %}â€”{% endif %}
          </td>
          <td title="{{ t.reason }}">{{ t.reason|truncatechars:15 }}</td>
          <td title="{{ t.process }}">{{ t.process|truncatechars:15 }}</td>
          <td>{{ t.supplier_issue|yesno:"Yes,No" }}</td>
          <td title="{% if t.machines %}{{ t.machines|join:', ' }}{% else %}â€”{% endif %}">
            {% if t.machines %}{{ t.machines|join:", "|truncatechars:15 }}{% else %}â€”{% endif %}
          </td>
          <td title="{{ t.expiration_date }}">{{ t.expiration_date|truncatechars:15 }}</td>
          <td>
            {% if t.approved %}
              <span class="text-success">âœ… Fully approved</span>
            {% else %}
              <span class="badge text-bg-secondary">{{ t.approvals.count }}/{{ t.required_approvals_count }}</span>
              {% if is_tpc_approver %}
                {% if not t.user_has_approved %}
                  <form action="{% url 'tpc_approve' t.pk %}" method="post" class="d-inline ms-2" data-row-safe-click>
                    {% csrf_token %}
                    <button type="submit" class="btn btn-sm btn-success">Approve</button>
                  </form>
                {% else %}
                  <span class="text-muted ms-2">Youâ€™ve approved</span>
                {% endif %}
              {% endif %}
            {% endif %}
          </td>
          <td>
            {% if t.approved %}
              <a href="{% url 'tpc_request_pdf' t.pk %}" target="_blank" title="View PDF">ðŸ“„</a>
            {% endif %}
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
    <div class="text-center mt-3" id="load-more-container">
      <button id="load-more" class="btn btn-outline-dark">Load more</button>
    </div>
  </div>
</div>

{# ---------- Edit Modal ---------- #}
<div class="modal fade" id="tpcModal" tabindex="-1" aria-labelledby="tpcModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-scrollable">
    <div class="modal-content">
      <form id="tpc-edit-form">
        {% csrf_token %}
        <div class="modal-header">
          <h5 class="modal-title">Edit TPC Request <span id="m-pk" class="fw-semibold"></span></h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <div class="row g-3">
            <div class="col-md-6">
              <label class="form-label">Date Requested</label>
              <input type="text" class="form-control" id="m-date-requested" name="date_requested">
            </div>
            <div class="col-md-6">
              <label class="form-label">Expiration</label>
              <input type="text" class="form-control" id="m-expiration-date" name="expiration_date">
            </div>
            <div class="col-md-6">
              <label class="form-label">Issuer</label>
              <input type="text" class="form-control" id="m-issuer-name" name="issuer_name">
            </div>
            <div class="col-md-6">
              <label class="form-label">Parts</label>
              <input type="text" class="form-control" id="m-part" name="parts">
            </div>
            <div class="col-12">
              <label class="form-label">Reason</label>
              <textarea class="form-control" id="m-reason" name="reason"></textarea>
            </div>
            <div class="col-12">
              <label class="form-label">Process</label>
              <textarea class="form-control" id="m-process" name="process"></textarea>
            </div>
            <div class="col-md-4">
              <label class="form-label">Supplier Issue</label>
              <select class="form-select" id="m-supplier-issue" name="supplier_issue">
                <option value="Yes">Yes</option>
                <option value="No">No</option>
              </select>
            </div>
            <div class="col-md-4">
              <label class="form-label">Machines</label>
              <input type="text" class="form-control" id="m-machine-number" name="machines">
            </div>
            <div class="col-md-4">
              <div id="m-approved" class="form-control-plaintext fw-semibold"></div>
            </div>
            <div class="col-12">
              <label class="form-label">Approvals</label>
              <span id="m-approvals-pill" class="badge text-bg-secondary"></span>
              <span id="m-approvers" class="text-muted"></span>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="submit" class="btn btn-success">Save</button>
          <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Close</button>
        </div>
      </form>
    </div>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', () => {
  const tbody = document.getElementById('tpc-tbody');
  const loadBtn = document.getElementById('load-more');
  let offset = {{ tpcs|length }};
  const pageSize = {{ tpc_page_size }};
  const isTpcApprover = {{ is_tpc_approver|yesno:"true,false" }};
  const modal = new bootstrap.Modal(document.getElementById('tpcModal'));
  const form = document.getElementById('tpc-edit-form');

  // Filtering
  document.querySelectorAll('thead tr:nth-child(2) input').forEach((inp, i) => {
    inp.addEventListener('input', () => {
      tbody.querySelectorAll('tr').forEach(row => {
        const visible = Array.from(document.querySelectorAll('thead tr:nth-child(2) input'))
          .every((input, idx) => !input.value || row.cells[idx].textContent.toLowerCase().includes(input.value.toLowerCase()));
        row.classList.toggle('d-none', !visible);
      });
    });
  });

  // Row click => open modal
  tbody.addEventListener('click', e => {
    if (e.target.closest('a, button, form')) return;
    const row = e.target.closest('tr');
    if (!row) return;
    form.dataset.pk = row.dataset.pk;
    document.getElementById('m-pk').textContent = row.dataset.pk;
    document.getElementById('m-date-requested').value = row.dataset.dateRequested;
    document.getElementById('m-expiration-date').value = row.dataset.expirationDate;
    document.getElementById('m-issuer-name').value = row.dataset.issuerName;
    document.getElementById('m-part').value = row.dataset.part;
    document.getElementById('m-reason').value = row.dataset.reason;
    document.getElementById('m-process').value = row.dataset.process;
    document.getElementById('m-supplier-issue').value = row.dataset.supplierIssue;
    document.getElementById('m-machine-number').value = row.dataset.machineNumber;
    document.getElementById('m-approved').value = row.dataset.approved;
    document.getElementById('m-approvals-pill').textContent = `${row.dataset.approvalsGot}/${row.dataset.approvalsReq}`;
    document.getElementById('m-approvers').textContent = row.dataset.approvers;
    modal.show();
  });

  // Save changes
  form.addEventListener('submit', e => {
    e.preventDefault();
    const pk = form.dataset.pk;
    fetch(`/quality/tpc-requests/${pk}/edit/`, {
      method: 'POST',
      headers: {'X-CSRFToken': form.querySelector('[name=csrfmiddlewaretoken]').value},
      body: new FormData(form)
    })
    .then(res => res.json())
    .then(data => {
      if (data.success) {
        location.reload();
      } else {
        alert('Save failed');
      }
    })
    .catch(err => console.error(err));
  });

  // Load more
  loadBtn.addEventListener('click', () => {
    console.log(`Loading more from offset ${offset}`);
    loadBtn.disabled = true;
    loadBtn.textContent = 'Loading...';
    fetch(`{% url 'tpc_request_load_more' %}?offset=${offset}`)
      .then(res => res.json())
      .then(data => {
        console.log('Load more response:', data);
        data.rows.forEach(t => {
          const tr = document.createElement('tr');
          tr.dataset.pk = t.pk;
          tr.dataset.dateRequested = t.date_requested;
          tr.dataset.expirationDate = t.expiration_date;
          tr.dataset.issuerName = t.issuer_name;
          tr.dataset.part = t.parts;
          tr.dataset.reason = t.reason;
          tr.dataset.process = t.process;
          tr.dataset.supplierIssue = t.supplier_issue;
          tr.dataset.machineNumber = t.machines;
          tr.dataset.approved = t.approved ? 'Yes' : 'No';
          tr.dataset.approvalsGot = t.approvals_got;
          tr.dataset.approvalsReq = t.approvals_req;
          tr.dataset.approvers = t.approvers;
          tr.dataset.userHasApproved = t.user_has_approved;

          tr.innerHTML = `
            <td>${t.pk}</td>
            <td title="${t.date_requested}">${t.date_requested.substring(0,15)}</td>
            <td title="${t.issuer_name}">${t.issuer_name.substring(0,15)}</td>
            <td title="${t.parts}">${t.parts.substring(0,15)}</td>
            <td title="${t.reason}">${t.reason.substring(0,15)}</td>
            <td title="${t.process}">${t.process.substring(0,15)}</td>
            <td>${t.supplier_issue}</td>
            <td title="${t.machines}">${t.machines.substring(0,15)}</td>
            <td title="${t.expiration_date}">${t.expiration_date.substring(0,15)}</td>
            <td>
              ${t.approved
                ? '<span class="text-success">âœ… Fully approved</span>'
                : `<span class="badge text-bg-secondary">${t.approvals_got}/${t.approvals_req}</span>` +
                  (isTpcApprover
                    ? (!t.user_has_approved
                      ? `<form action="/quality/tpc-requests/${t.pk}/approve/" method="post" class="d-inline ms-2" data-row-safe-click>
                           {% csrf_token %}
                           <button type="submit" class="btn btn-sm btn-success">Approve</button>
                         </form>`
                      : `<span class="text-muted ms-2">Youâ€™ve approved</span>`)
                    : '')
              }
            </td>
            <td>${t.pdf_url ? `<a href="${t.pdf_url}" target="_blank" title="View PDF">ðŸ“„</a>` : ''}</td>
          `;
          tbody.appendChild(tr);
        });
        offset += pageSize;
        if (data.has_more) {
          loadBtn.disabled = false;
          loadBtn.textContent = 'Load more';
        } else {
          document.getElementById('load-more-container').remove();
        }
      })
      .catch(err => {
        console.error(err);
        loadBtn.disabled = false;
        loadBtn.textContent = 'Load more';
      });
  });
});
</script>
{% endblock %}
