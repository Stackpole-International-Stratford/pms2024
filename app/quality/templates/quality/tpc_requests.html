{# templates/quality/tpc_requests.html #}
{% extends "parent.html" %}
{% load static %}

{% block content %}
<style>
  /* keep the Bootstrap-like stripes and add basic UX touches */
  #tpc-table                 { width: 100%; }
  #tpc-table thead th        { white-space: nowrap; }
  #tpc-table thead tr:first-child th { cursor: pointer; }   /* click-to-sort hint */
  #tpc-table thead tr:nth-child(2) input { width: 100%; }
  #tpc-table tbody tr:nth-child(even)   { background: #f9f9f9; }
</style>

<div class="container mt-5">
  <h2>TPC Requests</h2>

  <table id="tpc-table" class="table table-bordered">
    <thead>
      <!-- row 0 – headings (clickable for sort) -->
      <tr>
        <th>ID</th>
        <th>Date requested</th>
        <th>Issuer</th>
        <th>Reason</th>
        <th>Process</th>
        <th>Supplier Issue</th>
        <th>Machine #</th>
        <th>Expiration</th>
        <th>Approved?</th>
      </tr>

      <!-- row 1 – per-column live-filter inputs -->
      <tr>
        {% for _ in "012345678" %}
          <th><input type="text" class="form-control form-control-sm" placeholder="Search…"></th>
        {% endfor %}
      </tr>
    </thead>

    <tbody>
      {% for t in tpcs %}
        <tr>
          <td>{{ t.pk }}</td>
          <td>{{ t.date_requested }}</td>
          <td>{{ t.issuer_name }}</td>
          <td>{{ t.reason }}</td>
          <td>{{ t.process }}</td>
          <td>{{ t.supplier_issue|yesno:"Yes,No" }}</td>
          <td>{{ t.machine_number }}</td>
          <td>{{ t.expiration_date }}</td>

          <!-- approval cell -->
          <td>
            {% if t.approved %}
              ✔️
            {% elif is_quality_manager %}
              <form action="{% url 'tpc_approve' t.pk %}" method="post" class="d-inline">
                {% csrf_token %}
                <button type="submit" class="btn btn-sm btn-success">Approve</button>
              </form>
            {% else %}
              —
            {% endif %}
          </td>
        </tr>
      {% endfor %}
    </tbody>
  </table>
</div>

<script>
/* ---------- Vanilla-JS live search & click-to-sort ---------- */
document.addEventListener('DOMContentLoaded', () => {
  const table  = document.getElementById('tpc-table');
  const inputs = table.querySelectorAll('thead tr:nth-child(2) input');
  const rows   = Array.from(table.tBodies[0].rows);

  /* per-column filter */
  function filter() {
    rows.forEach(row => {
      const visible = Array.from(inputs).every((inp, idx) => {
        const term = inp.value.trim().toLowerCase();
        return !term || row.cells[idx].textContent.toLowerCase().includes(term);
      });
      row.style.display = visible ? '' : 'none';
    });
  }
  inputs.forEach(inp => inp.addEventListener('input', filter));

  /* simple click-to-sort */
  table.querySelectorAll('thead tr:first-child th').forEach((th, idx) => {
    let asc = true;
    th.addEventListener('click', () => {
      rows.sort((a, b) => {
        const A = a.cells[idx].textContent.trim();
        const B = b.cells[idx].textContent.trim();
        const numA = parseFloat(A.replace(/[^0-9.\-]/g, ''));
        const numB = parseFloat(B.replace(/[^0-9.\-]/g, ''));
        const diff = (!isNaN(numA) && !isNaN(numB))
                     ? numA - numB
                     : A.localeCompare(B, undefined, {numeric:true, sensitivity:'base'});
        return asc ? diff : -diff;
      });
      asc = !asc;               // toggle next time
      rows.forEach(r => table.tBodies[0].appendChild(r));
    });
  });
});
</script>
{% endblock %}
