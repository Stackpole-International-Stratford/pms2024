{% for t in tpcs %}
<tr
  title="Click to approve"
  data-pk="{{ t.pk }}"
  data-date-requested="{{ t.date_requested }}"
  data-issuer-name="{{ t.issuer_name }}"
  data-part="{{ t.part|default:'—' }}"
  data-reason="{{ t.reason }}"
  data-process="{{ t.process }}"
  data-supplier-issue="{{ t.supplier_issue|yesno:'Yes,No' }}"
  data-machine-number="{{ t.machine_number }}"
  data-expiration-date="{{ t.expiration_date }}"
  data-expiration-notes="{{ t.expiration_notes|default:'—' }}"
  data-approved="{{ t.approved|yesno:'Yes,No' }}"
  data-approvals-got="{{ t.approvals.count }}"
  data-approvals-req="{{ t.required_approvals_count }}"
  data-approvers="{% for a in t.approvals.all %}{{ a.user.get_full_name|default:a.user.username }}{% if not forloop.last %}, {% endif %}{% empty %}—{% endfor %}"
>
  <td>{{ t.pk }}</td>
  <td>{{ t.date_requested }}</td>
  <td title="{{ t.issuer_name }}">{{ t.issuer_name|truncatechars:10 }}</td>
  <td title="{{ t.part }}">{{ t.part|default:"—"|truncatechars:10 }}</td>
  <td title="{{ t.reason }}">{{ t.reason|truncatechars:10 }}</td>
  <td title="{{ t.process }}">{{ t.process|truncatechars:10 }}</td>
  <td>{{ t.supplier_issue|yesno:"Yes,No" }}</td>
  <td>{{ t.machine_number }}</td>
  <td>{{ t.expiration_date }}</td>
  <td>
    {% if t.approved %}
      <span class="text-success">✅ Fully approved</span>
    {% else %}
      {% with got=t.approvals.count req=t.required_approvals_count %}
        <span class="badge text-bg-secondary">{{ got }}/{{ req }}</span>
      {% endwith %}

      {% if is_tpc_approver %}
        {% if not t.user_has_approved %}
          <form action="{% url 'tpc_approve' t.pk %}" method="post" class="d-inline ms-2" data-row-safe-click>
            {% csrf_token %}
            <button type="submit" class="btn btn-sm btn-dark">Approve</button>
          </form>
        {% else %}
          <span class="text-muted ms-2">You’ve approved</span>
        {% endif %}
      {% endif %}
    {% endif %}
  </td>
</tr>
{% endfor %}
