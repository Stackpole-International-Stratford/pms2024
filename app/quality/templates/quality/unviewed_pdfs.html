{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Unviewed PDFs</title>
    <!-- Bootstrap CSS -->
    <link href="{% static 'bootstrap/css/bootstrap.min.css' %}" rel="stylesheet">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script> <!-- jQuery for AJAX -->
</head>
<body>

<div class="container mt-4">
    <h1>Unviewed PDFs for Part {{ part.part_number }}</h1>
    <p>Clock Numbers: {{ clock_numbers|join:", " }}</p>

    {% if unviewed_pdfs %}
        <ul class="list-group">
            {% for pdf in unviewed_pdfs %}
                <li class="list-group-item d-flex justify-content-between align-items-center">
                    <a href="{{ pdf.pdf_file.url }}" target="_blank">{{ pdf.title }}</a>
                    <button class="btn btn-success btn-sm mark-viewed" data-pdf-id="{{ pdf.id }}" data-clock-numbers="{{ clock_numbers|join:',' }}">
                        Mark as Viewed
                    </button>
                </li>
            {% endfor %}
        </ul>
    {% else %}
        <div class="alert alert-info mt-4" role="alert">
            All PDFs have been viewed.
        </div>
    {% endif %}
</div>

<!-- Bootstrap JS Bundle -->
<script src="{% static 'bootstrap/js/bootstrap.bundle.min.js' %}"></script>

<script>
    $(document).ready(function () {
        // Handle the "Mark as Viewed" button click event
        $('.mark-viewed').on('click', function () {
            const pdfId = $(this).data('pdf-id');
            const clockNumbers = $(this).data('clock-numbers');
    
            // Send AJAX request to mark the PDF as viewed
            $.ajax({
                url: "{% url 'mark_pdf_as_viewed' %}", // You'll define this URL
                type: 'POST',
                contentType: 'application/json',  // Specify the correct content type
                data: JSON.stringify({  // Send data as JSON
                    'pdf_id': pdfId,
                    'clock_numbers': clockNumbers.split(','),  // Ensure we send an array
                    'csrfmiddlewaretoken': '{{ csrf_token }}'
                }),
                success: function (response) {
                    if (response.status === 'success') {
                        // On success, remove the PDF from the list
                        alert('Marked as viewed!');
                        location.reload(); // Reload the page to update the list
                    } else {
                        alert('Error: ' + response.message);
                    }
                },
                error: function (error) {
                    alert('An error occurred. Please try again.');
                }
            });
        });
    });    
</script>
</body>
</html>
