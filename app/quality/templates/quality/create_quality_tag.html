{% extends "parent.html" %}
{% load static %}
{% block content %}
<!-- Bootstrap CSS and JS -->
<link href="{% static 'bootstrap/css/bootstrap.min.css' %}" rel="stylesheet">
<script src="{% static 'bootstrap/js/bootstrap.bundle.min.js' %}"></script>

<div class="container mt-4">
  <form method="post" id="my-form">
    {% csrf_token %}
    
    <!-- Quality Tag Type Section -->
    <div class="card mb-3">
      <div class="card-header">
        Quality Tag Type
      </div>
      <div class="card-body">
        <label class="form-label">Select Quality Tag Type(s):</label>
        <div class="mb-3">
          {% for option in dropdown_data.quality_tag_type %}
            <div class="form-check">
              <!-- At least one of these checkboxes must be selected -->
              <input class="form-check-input" type="checkbox" name="quality_tag_type" id="quality_tag_{{ forloop.counter }}" value="{{ option }}">
              <label class="form-check-label" for="quality_tag_{{ forloop.counter }}">{{ option }}</label>
            </div>
          {% endfor %}
        </div>
      </div>
    </div>
    
    <!-- Quality Tag Information Section (Always Shown) -->
    <div class="card mb-3">
      <div class="card-header">
        Quality Tag Information
      </div>
      <div class="card-body">
        <!-- Part Selection -->
        <div class="mb-3">
          <label for="part" class="form-label">Select Part:</label>
          <select class="form-select" name="part" id="part" required>
            <option value="">-- Select Part --</option>
            {% for part in dropdown_data.parts %}
              <option value="{{ part.part_name }}">{{ part.part_name }}</option>
            {% endfor %}
          </select>
        </div>
        
        <!-- Operations (Initially Hidden; required added dynamically) -->
        <div class="mb-3 d-none" id="operations-container">
          <label for="operation" class="form-label">Select Operation:</label>
          <select class="form-select" name="operation" id="operation">
            <option value="">-- Select Operation --</option>
          </select>
        </div>
        
        <!-- Customer -->
        <div class="mb-3">
          <label for="customer" class="form-label">Customer:</label>
          <select class="form-select" name="customer" id="customer" required>
            <option value="">-- Select Customer --</option>
            {% for option in dropdown_data.customer %}
              <option value="{{ option }}">{{ option }}</option>
            {% endfor %}
          </select>
        </div>
        
        <!-- Cell -->
        <div class="mb-3">
          <label for="cell" class="form-label">Cell:</label>
          <select class="form-select" name="cell" id="cell" required>
            <option value="">-- Select Cell --</option>
            {% for option in dropdown_data.cell %}
              <option value="{{ option }}">{{ option }}</option>
            {% endfor %}
          </select>
        </div>
        
        <!-- Quality Engineer -->
        <div class="mb-3">
          <label for="quality_engineer" class="form-label">Quality Engineer:</label>
          <select class="form-select" name="quality_engineer" id="quality_engineer" required>
            <option value="">-- Select Quality Engineer --</option>
            {% for option in dropdown_data.quality_engineer %}
              <option value="{{ option }}">{{ option }}</option>
            {% endfor %}
          </select>
        </div>
        
        <!-- Reason -->
        <div class="mb-3">
          <label for="reason" class="form-label">Reason:</label>
          <textarea class="form-control" name="reason" id="reason" rows="3" required></textarea>
        </div>
        
        <!-- Feature -->
        <div class="mb-3">
          <label for="feature" class="form-label">Feature:</label>
          <textarea class="form-control" name="feature" id="feature" rows="3" required></textarea>
        </div>
        
        <!-- Quality Issue -->
        <div class="mb-3">
          <label for="quality_issue" class="form-label">Quality Issue:</label>
          <textarea class="form-control" name="quality_issue" id="quality_issue" rows="3" required></textarea>
        </div>
        
        <!-- Internal or External -->
        <div class="mb-3">
          <label class="form-label">Is this Internal or External?</label>
          <div>
            <div class="form-check form-check-inline">
              <input class="form-check-input" type="radio" name="internal_external" id="internal" value="Internal" required>
              <label class="form-check-label" for="internal">Internal</label>
            </div>
            <div class="form-check form-check-inline">
              <input class="form-check-input" type="radio" name="internal_external" id="external" value="External">
              <label class="form-check-label" for="external">External</label>
            </div>
          </div>
        </div>
        
        <!-- Compact or Pellet -->
        <div class="mb-3">
          <label class="form-label">Is the part Compact or Pellet?</label>
          <div>
            <div class="form-check form-check-inline">
              <input class="form-check-input" type="radio" name="compact_pellet" id="compact" value="Compact" required>
              <label class="form-check-label" for="compact">Compact</label>
            </div>
            <div class="form-check form-check-inline">
              <input class="form-check-input" type="radio" name="compact_pellet" id="pellet" value="Pellet">
              <label class="form-check-label" for="pellet">Pellet</label>
            </div>
          </div>
        </div>
        
        <!-- Special Labeling Required -->
        <div class="mb-3">
          <label class="form-label">Is special labeling required?</label>
          <div>
            <div class="form-check form-check-inline">
              <input class="form-check-input" type="radio" name="special_labeling" id="labeling_yes" value="Yes" required>
              <label class="form-check-label" for="labeling_yes">Yes</label>
            </div>
            <div class="form-check form-check-inline">
              <input class="form-check-input" type="radio" name="special_labeling" id="labeling_no" value="No">
              <label class="form-check-label" for="labeling_no">No</label>
            </div>
          </div>
        </div>
        
        <!-- Supplier Issue -->
        <div class="mb-3">
          <label class="form-label">Is this a Supplier Issue?</label>
          <div>
            <div class="form-check form-check-inline">
              <input class="form-check-input" type="radio" name="supplier_issue" id="supplier_yes" value="Yes" required>
              <label class="form-check-label" for="supplier_yes">Yes</label>
            </div>
            <div class="form-check form-check-inline">
              <input class="form-check-input" type="radio" name="supplier_issue" id="supplier_no" value="No">
              <label class="form-check-label" for="supplier_no">No</label>
            </div>
          </div>
        </div>
        
        <!-- Machine -->
        <div class="mb-3">
          <label for="machine" class="form-label">Machine:</label>
          <input type="number" class="form-control" name="machine" id="machine" min="0" required>
        </div>
      </div>
    </div>
    
    <!-- Holds Section (Conditionally Shown) -->
    <div class="card mb-3 d-none" id="hold-section">
      <div class="card-header">
        Hold
      </div>
      <div class="card-body">
        <!-- Quantity Input -->
        <div class="mb-3">
          <label for="quantity" class="form-label">Quantity:</label>
          <input type="number" class="form-control" name="quantity" id="quantity" min="0">
        </div>
        <!-- Hold Reason Textarea -->
        <div class="mb-3">
          <label for="hold_reason" class="form-label">Hold Reason:</label>
          <textarea class="form-control" name="hold_reason" id="hold_reason" rows="3"></textarea>
        </div>
      </div>
    </div>
    
    <!-- TPC Section (Conditionally Shown) -->
    <div class="card mb-3 d-none" id="tpc-section">
      <div class="card-header">
        TPC
      </div>
      <div class="card-body">
        <!-- Expiry Date Picker -->
        <div class="mb-3">
          <label for="expiry_date" class="form-label">Expiry:</label>
          <input type="date" class="form-control" name="expiry_date" id="expiry_date">
        </div>
        <!-- Process Bypass Radio Buttons -->
        <div class="mb-3">
          <label class="form-label">Has any part of the process been bypassed?</label>
          <div>
            <div class="form-check form-check-inline">
              <input class="form-check-input" type="radio" name="process_bypassed" id="bypassed_yes" value="Yes">
              <label class="form-check-label" for="bypassed_yes">Yes</label>
            </div>
            <div class="form-check form-check-inline">
              <input class="form-check-input" type="radio" name="process_bypassed" id="bypassed_no" value="No">
              <label class="form-check-label" for="bypassed_no">No</label>
            </div>
          </div>
        </div>
        <!-- TPC Current Process -->
        <div class="mb-3">
          <label for="tpc_current_process" class="form-label">TPC Current Process:</label>
          <textarea class="form-control" name="tpc_current_process" id="tpc_current_process" rows="3"></textarea>
        </div>
        <!-- Changed -->
        <div class="mb-3">
          <label for="changed" class="form-label">Changed:</label>
          <textarea class="form-control" name="changed" id="changed" rows="3"></textarea>
        </div>
        <!-- Risk Analysis -->
        <div class="mb-3">
          <label for="risk_analysis" class="form-label">Risk Analysis:</label>
          <textarea class="form-control" name="risk_analysis" id="risk_analysis" rows="4" placeholder="Will the TPC: Require extra inspection? Require Inspection frequency change? Effect downstream operations? Customer end use?"></textarea>
        </div>
      </div>
    </div>
    
    <!-- Special Instructions Section (Conditionally Shown) -->
    <div class="card mb-3 d-none" id="special-instructions-section">
      <div class="card-header">
        Special Instructions
      </div>
      <div class="card-body">
        <!-- Special Instructions / Quality Memo -->
        <div class="mb-3">
          <label for="special_instructions" class="form-label">Special Instructions / Quality Memo:</label>
          <textarea class="form-control" name="special_instructions" id="special_instructions" rows="4" placeholder="Please be as descriptive as possible"></textarea>
        </div>
      </div>
    </div>
    
    <!-- Approvals Section (Always Shown) -->
    <div class="card mb-3">
      <div class="card-header">
        Approvals
      </div>
      <div class="card-body">
        <!-- Factory Focus Leader -->
        <div class="mb-3">
          <label for="factory_focus_leader" class="form-label">Factory Focus Leader:</label>
          <select class="form-select" name="factory_focus_leader" id="factory_focus_leader" required>
            <option value="">-- Select Factory Focus Leader --</option>
            {% for option in dropdown_data.factory_focus_leader %}
              <option value="{{ option }}">{{ option }}</option>
            {% endfor %}
          </select>
        </div>
        <!-- Quality Manager -->
        <div class="mb-3">
          <label for="quality_manager" class="form-label">Quality Manager:</label>
          <select class="form-select" name="quality_manager" id="quality_manager" required>
            <option value="">-- Select Quality Manager --</option>
            {% for option in dropdown_data.quality_manager %}
              <option value="{{ option }}">{{ option }}</option>
            {% endfor %}
          </select>
        </div>
      </div>
    </div>
    
    <button type="submit" class="btn btn-warning">Submit</button>
  </form>
</div>

<script>
document.addEventListener("DOMContentLoaded", function () {
  // --- PART / OPERATION LOGIC ---
  let partDropdown = document.getElementById("part");
  let operationDropdown = document.getElementById("operation");
  let operationsContainer = document.getElementById("operations-container");
  let partsData = {{ dropdown_data.parts|safe }};

  partDropdown.addEventListener("change", function () {
    let selectedPart = this.value;
    operationDropdown.innerHTML = '<option value="">-- Select Operation --</option>'; // Reset options

    let selectedPartData = partsData.find(part => part.part_name === selectedPart);
    if (selectedPartData) {
      selectedPartData.operations.forEach(function(op) {
        let option = document.createElement("option");
        option.value = op;
        option.textContent = op;
        operationDropdown.appendChild(option);
      });
      operationsContainer.classList.remove("d-none");
      operationDropdown.setAttribute("required", "required");
    } else {
      operationsContainer.classList.add("d-none");
      operationDropdown.removeAttribute("required");
    }
  });

  // --- HELPER FUNCTION TO TOGGLE REQUIRED ATTRIBUTE ---
  function setRequired(section, required) {
    section.querySelectorAll("input, select, textarea").forEach(function(el) {
      if (required) {
        el.setAttribute("required", "required");
      } else {
        el.removeAttribute("required");
      }
    });
  }

  // --- CONDITIONAL SECTIONS BASED ON QUALITY TAG TYPE ---
  let qualityTagTypeCheckboxes = document.querySelectorAll('input[name="quality_tag_type"]');
  let holdSection = document.getElementById("hold-section");
  let tpcSection = document.getElementById("tpc-section");
  let specialInstructionsSection = document.getElementById("special-instructions-section");

  function updateSectionsVisibility() {
    let selectedTypes = Array.from(qualityTagTypeCheckboxes)
      .filter(cb => cb.checked)
      .map(cb => cb.value);

    // Show or hide the Hold section
    if (selectedTypes.includes("Hold Tag")) {
      holdSection.classList.remove("d-none");
      setRequired(holdSection, true);
    } else {
      holdSection.classList.add("d-none");
      setRequired(holdSection, false);
    }

    // Show or hide the TPC section
    if (selectedTypes.includes("TPC")) {
      tpcSection.classList.remove("d-none");
      setRequired(tpcSection, true);
    } else {
      tpcSection.classList.add("d-none");
      setRequired(tpcSection, false);
    }

    // Show or hide the Special Instructions section
    if (selectedTypes.includes("Special Instruction")) {
      specialInstructionsSection.classList.remove("d-none");
      setRequired(specialInstructionsSection, true);
    } else {
      specialInstructionsSection.classList.add("d-none");
      setRequired(specialInstructionsSection, false);
    }
  }

  qualityTagTypeCheckboxes.forEach(function(checkbox) {
    checkbox.addEventListener("change", updateSectionsVisibility);
  });
  updateSectionsVisibility(); // Run on page load in case any checkboxes are pre-selected

  // --- VALIDATE AT LEAST ONE QUALITY TAG TYPE IS SELECTED ON FORM SUBMISSION ---
  document.getElementById("my-form").addEventListener("submit", function(event) {
    let checkboxes = document.querySelectorAll('input[name="quality_tag_type"]');
    let atLeastOneChecked = Array.from(checkboxes).some(cb => cb.checked);
    if (!atLeastOneChecked) {
      event.preventDefault();
      alert("Please select at least one Quality Tag Type.");
    }
  });
});
</script>
{% endblock %}
