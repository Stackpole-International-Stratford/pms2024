{% load static %}
<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Manage Form - {{ part.part_number }}</title>
    <link href="{% static 'bootstrap/css/bootstrap.min.css' %}" rel="stylesheet">
</head>
<body>
    <div class="container mt-5">
        <h1>Manage Form for Part: {{ part.part_number }}</h1>
        
        <h3 class="mt-4">Feats</h3>
        {% if feats %}
            <table class="table table-striped">
                <thead>
                    <tr>
                        <th>Feat Name</th>
                        <th>Order</th>
                        <th>Alarm</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="featTable">
                    {% for feat in feats %}
                        <tr data-id="{{ feat.id }}">
                            <td class="feat-name">{{ feat.name }}</td>
                            <td>{{ feat.order }}</td>
                            <td class="feat-alarm">{{ feat.alarm }}</td>
                            <td>
                                <button class="btn btn-sm btn-outline-primary move-up">↑</button>
                                <button class="btn btn-sm btn-outline-primary move-down">↓</button>
                                <button class="btn btn-sm btn-outline-warning edit-feat">Edit</button>
                            </td>
                        </tr>
                    {% endfor %}
                </tbody>
            </table>
        {% else %}
            <p>No feats associated with this part.</p>
        {% endif %}
        
        <div class="text-end mt-4">
            <a href="{% url 'scrap_form_management' %}" class="btn btn-secondary">Back to Management</a>
        </div>
    </div>

    <script src="{% static 'bootstrap/js/bootstrap.bundle.min.js' %}"></script>
    <script>
        function attachEventListeners() {
            // Reordering functionality
            document.querySelectorAll('.move-up').forEach(button => {
                button.addEventListener('click', function() {
                    let row = this.closest('tr');
                    moveRow(row, 'up');
                    updateOrder();
                });
            });

            document.querySelectorAll('.move-down').forEach(button => {
                button.addEventListener('click', function() {
                    let row = this.closest('tr');
                    moveRow(row, 'down');
                    updateOrder();
                });
            });

            // Edit functionality
            document.querySelectorAll('.edit-feat').forEach(button => {
                button.addEventListener('click', function() {
                    const row = this.closest('tr');

                    if (this.classList.contains('save-feat')) {
                        // Save changes
                        const featId = row.getAttribute('data-id');
                        const newName = row.querySelector('.feat-name input').value;
                        const newAlarm = row.querySelector('.feat-alarm input').value;

                        // Send the updated data to the server via AJAX
                        fetch("{% url 'update_feat' %}", {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'X-CSRFToken': '{{ csrf_token }}'
                            },
                            body: JSON.stringify({
                                id: featId,
                                name: newName,
                                alarm: newAlarm
                            })
                        })
                        .then(response => response.json())
                        .then(data => {
                            if (data.status === 'success') {
                                toggleEditMode(row, false);  // Exit edit mode
                            } else {
                                console.error('Failed to update feat');
                            }
                        });
                    } else {
                        // Enter edit mode
                        toggleEditMode(row, true);
                    }
                });
            });
        }

        // Function to toggle edit mode for a row
        function toggleEditMode(row, isEditMode) {
            const featNameCell = row.querySelector('.feat-name');
            const featAlarmCell = row.querySelector('.feat-alarm');
            const editButton = row.querySelector('.edit-feat');

            if (isEditMode) {
                // Convert cells to input fields
                const featName = featNameCell.textContent.trim();
                const featAlarm = featAlarmCell.textContent.trim();

                featNameCell.innerHTML = `<input type="text" class="form-control" value="${featName}">`;
                featAlarmCell.innerHTML = `<input type="number" class="form-control" value="${featAlarm}">`;

                // Change the edit button to "Save" and add a "Cancel" button
                editButton.textContent = 'Save';
                editButton.classList.remove('btn-outline-warning');
                editButton.classList.add('btn-outline-success');
                editButton.classList.add('save-feat');

                const cancelButton = document.createElement('button');
                cancelButton.textContent = 'Cancel';
                cancelButton.className = 'btn btn-sm btn-outline-danger cancel-edit';
                row.querySelector('td:last-child').appendChild(cancelButton);

            } else {
                // Revert cells back to text
                const featNameInput = featNameCell.querySelector('input').value;
                const featAlarmInput = featAlarmCell.querySelector('input').value;

                featNameCell.textContent = featNameInput;
                featAlarmCell.textContent = featAlarmInput;

                // Change the save button back to "Edit" and remove the "Cancel" button
                editButton.textContent = 'Edit';
                editButton.classList.remove('btn-outline-success');
                editButton.classList.add('btn-outline-warning');
                editButton.classList.remove('save-feat');

                row.querySelector('.cancel-edit').remove();
            }
        }

        // Function to move a row up or down
        function moveRow(row, direction) {
            if (direction === 'up') {
                let prev = row.previousElementSibling;
                if (prev) {
                    row.parentNode.insertBefore(row, prev);
                }
            } else if (direction === 'down') {
                let next = row.nextElementSibling;
                if (next) {
                    row.parentNode.insertBefore(next, row);
                }
            }
        }

        // Update the order of feats after moving
        function updateOrder() {
            let rows = document.querySelectorAll('#featTable tr');
            let orderData = [];
            rows.forEach((row, index) => {
                let id = row.getAttribute('data-id');
                let orderCell = row.querySelector('td:nth-child(2)');
                orderCell.textContent = index + 1;  // Update the order number displayed on the page
                orderData.push({ id: id, order: index + 1 });
            });

            // Send the updated order to the server
            fetch("{% url 'update_feat_order' %}", {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': '{{ csrf_token }}'
                },
                body: JSON.stringify(orderData)
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    console.log('Order updated successfully');
                } else {
                    console.error('Failed to update order');
                }
            });
        }

        // Attach event listeners to all buttons
        attachEventListeners();

        // Attach event listener to cancel buttons (using event delegation)
        document.querySelector('#featTable').addEventListener('click', function(event) {
            if (event.target.classList.contains('cancel-edit')) {
                const row = event.target.closest('tr');
                toggleEditMode(row, false);
            }
        });
    </script>
</body>
</html>
