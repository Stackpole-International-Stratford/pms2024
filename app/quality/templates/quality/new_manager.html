{% load static %}
<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Manage Form - {{ part.part_number }}</title>
    <link href="{% static 'bootstrap/css/bootstrap.min.css' %}" rel="stylesheet">
</head>
<body>
    <div class="container mt-5">
        <h1>Manage Form for Part: {{ part.part_number }}</h1>
         <!-- Add New Feat Form -->
         <h3 class="mt-4">Add New Feat</h3>
         <form id="addFeatForm">
             <div class="mb-3">
                 <label for="newFeatName" class="form-label">Feat Name</label>
                 <input type="text" class="form-control" id="newFeatName" required>
             </div>
             <div class="mb-3">
                 <label for="newFeatAlarm" class="form-label">Alarm</label>
                 <input type="number" class="form-control" id="newFeatAlarm" required>
             </div>
             <button type="submit" class="btn btn-success">Add Feat</button>
         </form>





        <h3 class="mt-4">Feats</h3>
        {% if feats %}
            <table class="table table-striped">
                <thead>
                    <tr>
                        <th>Feat Name</th>
                        <th>Order</th>
                        <th>Alarm</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="featTable">
                    {% for feat in feats %}
                        <tr data-id="{{ feat.id }}">
                            <td class="feat-name">{{ feat.name }}</td>
                            <td>{{ feat.order }}</td>
                            <td class="feat-alarm">{{ feat.alarm }}</td>
                            <td>
                                <button class="btn btn-sm btn-outline-primary move-up">↑</button>
                                <button class="btn btn-sm btn-outline-primary move-down">↓</button>
                                <button class="btn btn-sm btn-outline-warning edit-feat">Edit</button>
                                <button class="btn btn-sm btn-outline-danger delete-feat">Delete</button>
                            </td>
                        </tr>
                    {% endfor %}
                </tbody>
            </table>
        {% else %}
            <p>No feats associated with this part.</p>
        {% endif %}
        
       
    </div>

    <script src="{% static 'bootstrap/js/bootstrap.bundle.min.js' %}"></script>
    <script>
        function attachEventListeners() {
            // Reordering functionality
            document.querySelectorAll('.move-up').forEach(button => {
                button.addEventListener('click', function() {
                    let row = this.closest('tr');
                    moveRow(row, 'up');
                    updateOrder();
                });
            });

            document.querySelectorAll('.move-down').forEach(button => {
                button.addEventListener('click', function() {
                    let row = this.closest('tr');
                    moveRow(row, 'down');
                    updateOrder();
                });
            });

            // Edit functionality
            document.querySelectorAll('.edit-feat').forEach(button => {
                button.addEventListener('click', function() {
                    const row = this.closest('tr');

                    if (this.classList.contains('save-feat')) {
                        // Save changes
                        const featId = row.getAttribute('data-id');
                        const newName = row.querySelector('.feat-name input').value;
                        const newAlarm = row.querySelector('.feat-alarm input').value;

                        // Send the updated data to the server via AJAX
                        fetch("{% url 'update_feat' %}", {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'X-CSRFToken': '{{ csrf_token }}'
                            },
                            body: JSON.stringify({
                                id: featId,
                                name: newName,
                                alarm: newAlarm
                            })
                        })
                        .then(response => response.json())
                        .then(data => {
                            if (data.status === 'success') {
                                toggleEditMode(row, false);  // Exit edit mode
                            } else {
                                console.error('Failed to update feat');
                            }
                        });
                    } else {
                        // Enter edit mode
                        toggleEditMode(row, true);
                    }
                });
            });

            // Delete functionality
            document.querySelectorAll('.delete-feat').forEach(button => {
                button.addEventListener('click', function(event) {
                    event.stopPropagation();  // Prevent other event listeners from being triggered
                    const row = this.closest('tr');
                    const featId = row.getAttribute('data-id');

                    if (confirm('Are you sure you want to delete this feat?')) {
                        // Send delete request via AJAX
                        fetch("{% url 'delete_feat' %}", {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'X-CSRFToken': '{{ csrf_token }}'
                            },
                            body: JSON.stringify({ id: featId })
                        })
                        .then(response => response.json())
                        .then(data => {
                            if (data.status === 'success') {
                                row.remove();  // Remove the row from the table
                                updateOrder(); // Update the order numbers after deletion
                            } else {
                                console.error('Failed to delete feat');
                            }
                        });
                    }
                });
            });

        }

        // Function to toggle edit mode for a row
        function toggleEditMode(row, isEditMode) {
            const featNameCell = row.querySelector('.feat-name');
            const featAlarmCell = row.querySelector('.feat-alarm');
            const editButton = row.querySelector('.edit-feat');
            const deleteButton = row.querySelector('.delete-feat');

            if (isEditMode) {
                // Convert cells to input fields
                const featName = featNameCell.textContent.trim();
                const featAlarm = featAlarmCell.textContent.trim();

                featNameCell.innerHTML = `<input type="text" class="form-control" value="${featName}">`;
                featAlarmCell.innerHTML = `<input type="number" class="form-control" value="${featAlarm}">`;

                // Change the edit button to "Save" and add a "Cancel" button
                editButton.textContent = 'Save';
                editButton.classList.remove('btn-outline-warning');
                editButton.classList.add('btn-outline-success');
                editButton.classList.add('save-feat');

                // Hide the delete button in edit mode
                deleteButton.style.display = 'none';

                const cancelButton = document.createElement('button');
                cancelButton.textContent = 'Cancel';
                cancelButton.className = 'btn btn-sm btn-outline-danger cancel-edit';
                row.querySelector('td:last-child').appendChild(cancelButton);

            } else {
                // Revert cells back to text
                const featNameInput = featNameCell.querySelector('input').value;
                const featAlarmInput = featAlarmCell.querySelector('input').value;

                featNameCell.textContent = featNameInput;
                featAlarmCell.textContent = featAlarmInput;

                // Change the save button back to "Edit" and remove the "Cancel" button
                editButton.textContent = 'Edit';
                editButton.classList.remove('btn-outline-success');
                editButton.classList.add('btn-outline-warning');
                editButton.classList.remove('save-feat');

                row.querySelector('.cancel-edit').remove();

                // Show the delete button again when exiting edit mode
                deleteButton.style.display = 'inline-block';
            }
        }


        // Function to move a row up or down
        function moveRow(row, direction) {
            if (direction === 'up') {
                let prev = row.previousElementSibling;
                if (prev) {
                    // Swap the row with the previous one
                    row.parentNode.insertBefore(row, prev);
                }
            } else if (direction === 'down') {
                let next = row.nextElementSibling;
                if (next) {
                    // Swap the row with the next one
                    row.parentNode.insertBefore(next, row);
                }
            }
        }


        // Update the order of feats after moving
        function updateOrder() {
            let rows = document.querySelectorAll('#featTable tr');
            let orderData = [];
            rows.forEach((row, index) => {
                let id = row.getAttribute('data-id');
                let orderCell = row.querySelector('td:nth-child(2)');
                orderCell.textContent = index + 1;  // Update the order number displayed on the page
                orderData.push({ id: id, order: index + 1 });
            });

            // Send the updated order to the server
            fetch("{% url 'update_feat_order' %}", {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': '{{ csrf_token }}'
                },
                body: JSON.stringify(orderData)
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    console.log('Order updated successfully');
                } else {
                    console.error('Failed to update order');
                }
            });
        }

        // Attach event listeners to all buttons
        attachEventListeners();

        // Attach event listener to cancel buttons (using event delegation)
        document.querySelector('#featTable').addEventListener('click', function(event) {
            if (event.target.classList.contains('cancel-edit')) {
                const row = event.target.closest('tr');
                toggleEditMode(row, false);
            }
        });

        // Add new feat functionality
        document.getElementById('addFeatForm').addEventListener('submit', function(event) {
            event.preventDefault();

            const newName = document.getElementById('newFeatName').value;
            const newAlarm = document.getElementById('newFeatAlarm').value;

            fetch("{% url 'add_feat' %}", {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': '{{ csrf_token }}'
                },
                body: JSON.stringify({
                    part_number: '{{ part.part_number }}',
                    name: newName,
                    alarm: newAlarm
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    // Create a new row for the newly added feat
                    const newRow = document.createElement('tr');
                    newRow.setAttribute('data-id', data.feat_id);
                    newRow.innerHTML = `
                        <td class="feat-name">${newName}</td>
                        <td>${data.new_order}</td>
                        <td class="feat-alarm">${newAlarm}</td>
                        <td>
                            <button class="btn btn-sm btn-outline-primary move-up">↑</button>
                            <button class="btn btn-sm btn-outline-primary move-down">↓</button>
                            <button class="btn btn-sm btn-outline-warning edit-feat">Edit</button>
                            <button class="btn btn-sm btn-outline-danger delete-feat">Delete</button>
                        </td>
                    `;

                    // Insert the new row at the top of the table
                    const featTable = document.getElementById('featTable');
                    featTable.insertBefore(newRow, featTable.firstChild);

                    // Re-attach event listeners for the new row
                    attachEventListeners();

                    // Clear the form fields
                    document.getElementById('newFeatName').value = '';
                    document.getElementById('newFeatAlarm').value = '';
                } else {
                    console.error('Failed to add feat');
                }
            });
        });

    </script>
</body>
</html>
