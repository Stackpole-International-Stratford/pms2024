{# templates/quality/tpc_edit.html #}
{% extends "parent.html" %}

{% block content %}
<div class="container mt-5">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h2 class="mb-0">Edit TPC #{{ tpc.pk }}</h2>
    <a href="{% url 'tpc_request_list' %}" class="btn btn-outline-secondary">← Back to list</a>
  </div>

  {% if form_error %}
    <div class="alert alert-danger">{{ form_error }}</div>
  {% endif %}

  <form id="tpcEditForm" method="post" novalidate>
    {% csrf_token %}

    <div class="row g-3">
      <!-- Issuer -->
      <div class="col-md-6">
        <label class="form-label fw-bold">Issuer Name</label>
        <input type="text" name="issuer_name" value="{{ issuer_default }}" class="form-control" required>
      </div>

      <!-- Reason -->
      <div class="col-md-6">
        <label class="form-label fw-bold">Reason</label>
        <input type="text" name="reason" class="form-control" value="{{ tpc.reason }}" required>
      </div>

      <!-- Process -->
      <div class="col-md-12">
        <label class="form-label fw-bold">Process</label>
        <input type="text" name="process" class="form-control" value="{{ tpc.process }}" required>
      </div>

      {# Parts #}
      <div class="col-md-6">
        <label class="form-label fw-bold">Parts</label>
        <div class="border p-2" style="height: 200px; overflow-y: auto;">
          {% with selected_parts=tpc.parts %}
            {% for p in parts_qs %}
              <div class="form-check">
                <input
                  type="checkbox"
                  name="parts"
                  value="{{ p.part_number }}"
                  class="form-check-input"
                  {% if p.part_number in selected_parts %}checked{% endif %}
                >
                <label class="form-check-label">{{ p.part_number }} – {{ p.part_name }}</label>
              </div>
            {% endfor %}
          {% endwith %}
        </div>
      </div>

      {# Machines #}
      <div class="col-md-6">
        <label class="form-label fw-bold">Machines</label>
        <div class="border p-2" style="height: 200px; overflow-y: auto;">
          {% with selected_machines=tpc.machines %}
            {% for m in machines_qs %}
              <div class="form-check">
                <input
                  type="checkbox"
                  name="machines"
                  value="{{ m.asset_number }}"
                  class="form-check-input"
                  {% if m.asset_number in selected_machines %}checked{% endif %}
                >
                <label class="form-check-label">{{ m.asset_number }} – {{ m.asset_name }}</label>
              </div>
            {% endfor %}
          {% endwith %}
        </div>
      </div>

      <!-- Supplier issue -->
      <div class="col-md-6">
        <div class="form-check mt-4">
          <input type="checkbox" name="supplier_issue" class="form-check-input" {% if tpc.supplier_issue %}checked{% endif %}>
          <label class="form-check-label fw-bold">Supplier Issue?</label>
        </div>
      </div>

      <!-- Reason note -->
      <div class="col-md-6">
        <label class="form-label fw-bold">Reason Note</label>
        <textarea name="reason_note" class="form-control" rows="3" required>{{ tpc.reason_note }}</textarea>
      </div>

      <!-- Feature -->
      <div class="col-md-6">
        <label class="form-label fw-bold">Feature</label>
        <input type="text" name="feature" class="form-control" value="{{ tpc.feature }}" required>
      </div>

      <!-- Expiration date -->
      <div class="col-md-6">
        <label class="form-label fw-bold">Expiration Date</label>
        <input
          type="datetime-local"
          name="expiration_date"
          class="form-control"
          value="{{ tpc.expiration_date|date:'Y-m-d\\TH:i' }}"
          required
        >
      </div>

      <!-- Current process -->
      <div class="col-md-6">
        <label class="form-label fw-bold">Current Process</label>
        <textarea name="current_process" class="form-control" rows="3" required>{{ tpc.current_process }}</textarea>
      </div>

      <!-- Changed to -->
      <div class="col-md-6">
        <label class="form-label fw-bold">Changed To</label>
        <textarea name="changed_to" class="form-control" rows="3" required>{{ tpc.changed_to }}</textarea>
      </div>

      <!-- QE Risk Assessment (optional) -->
      <div class="col-md-12">
        <label class="form-label fw-bold">QE Risk Assessment</label>
        <textarea
          name="qe_risk_assessment"
          class="form-control"
          rows="4"
          placeholder="Notes from Quality Engineer, risk level (e.g., Low/Med/High), mitigations, special instructions..."
        >{{ tpc.qe_risk_assessment }}</textarea>
      </div>
    </div>

    <!-- Actions -->
    <div class="mt-4 d-flex gap-2">
      <button class="btn btn-success px-4" type="submit">Save Changes</button>
      <a href="{% url 'tpc_request_list' %}" class="btn btn-outline-dark">Cancel</a>
    </div>
  </form>
</div>

<script>
document.getElementById('tpcEditForm').addEventListener('submit', function(e) {
  // basic required field check
  const requiredFields = this.querySelectorAll('[required]');
  for (let field of requiredFields) {
    if (field.value.trim() === '') {
      alert('Please fill all required fields.');
      e.preventDefault();
      return;
    }
  }
  // ensure at least one part & machine
  if (!this.querySelectorAll('input[name="parts"]:checked').length) {
    alert('Please select at least one Part.');
    e.preventDefault();
    return;
  }
  if (!this.querySelectorAll('input[name="machines"]:checked').length) {
    alert('Please select at least one Machine.');
    e.preventDefault();
    return;
  }
});
</script>
{% endblock %}
