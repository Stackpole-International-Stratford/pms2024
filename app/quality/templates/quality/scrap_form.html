{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Final Inspection</title>
    <link href="{% static 'bootstrap/css/bootstrap.min.css' %}" rel="stylesheet">
    <style>
        /* Border and padding for bordered sections */
        .bordered {
            border: 1px solid #000;
            padding: 10px;
        }
    
        /* SVG icons sizing */
        .svg-icon {
            width: 1.5em;
            height: 1.5em;
            vertical-align: middle;
        }
        .no-border {
            border: none;
        }
        
    </style>    
</head>
<body>
<div class="container mt-4">
    <!-- Title Row -->
    <div class="row bordered mb-3">
        <div class="col-12 text-center">
            <h1>Final Inspection Defect Tally Sheet</h1>
            <p>Part Number: {{ part.part_number }}</p>
        </div>
    </div>
    
    <!-- Header Row -->
<div class="row bordered mb-3">
    <!-- Column 1 -->
    <div class="col-md-4">
        <div class="row">
            <div class="col-12">
                <label for="date">Date</label>
            </div>
            <div class="col-12">
                <input type="date" class="form-control" id="date">
            </div>
            <div class="col-12">
                <label for="total_defects">Total Defects</label> <!-- Updated Label -->
            </div>
            <div class="col-12">
                <p id="qty_packed" class="form-control-plaintext">0</p>
            </div>
        </div>
    </div>
    <!-- Column 2 -->
    <div class="col-md-4">
        <div class="row">
            <div class="col-12">
                <label for="operators">Operator</label>
            </div>
            <div class="col-12">
                <input type="text" class="form-control" id="operators">
            </div>
            <div class="col-12">
                <label for="qty_packed">Qty Packed</label> <!-- Updated Label -->
            </div>
            <div class="col-12">
                <input type="number" class="form-control" id="total_defects" min="0" oninput="calculateTotalInspected()">
            </div>
        </div>
    </div>

    <!-- Column 3 -->
    <div class="col-md-4">
        <div class="row">
            <div class="col-12">
                <label for="shift">Shift</label>
            </div>
            <div class="col-12">
                <div>
                    <input type="radio" id="shift1" name="shift" value="1">
                    <label for="shift1">1</label>
                    <input type="radio" id="shift2" name="shift" value="2">
                    <label for="shift2">2</label>
                    <input type="radio" id="shift3" name="shift" value="3">
                    <label for="shift3">3</label>
                </div>
            </div>
            <div class="col-12 mt-3">
                <label>Total Inspected</label>
            </div>
            <div class="col-12">
                <p id="total_inspected" class="form-control-plaintext">0</p>
            </div>
        </div>
    </div>
</div>


    <!-- Grid Row -->
    <div class="row bordered mb-3">
        <div class="col-12">
            <div class="row">
                <!-- Header -->
                <div class="col-md-6 text-start">
                    <strong>Feat Name</strong>
                </div>
                <div class="col-md-3">
                    <strong>No. of Defects</strong>
                </div>
                <div class="col-md-3">
                    <strong>Actions</strong>
                </div>
            </div>
            <!-- Feats Loop -->
            {% for feat in feats %}
            {% if forloop.counter0|divisibleby:2 %}
            <div class="row mt-1">
            {% endif %}
                <div class="col-md-6">
                    <div class="row">
                        <div class="col-6">
                            {{ feat.name }} ({{ feat.alarm }})
                        </div>
                        <div class="col-3">
                            <input type="number" class="form-control no-of-defects" min="0" value="0">
                        </div>
                        <div class="col-3 d-flex justify-content-start align-items-start">
                            <button type="button" class="btn btn-outline-secondary btn-sm me-2 px-1" onclick="incrementDefect(this)">
                                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="#20c997" class="bi bi-caret-up-fill" viewBox="0 0 16 16">
                                    <path d="m7.247 4.86-4.796 5.481c-.566.647-.106 1.659.753 1.659h9.592a1 1 0 0 0 .753-1.659l-4.796-5.48a1 1 0 0 0-1.506 0z"/>
                                </svg>
                            </button>
                            <button type="button" class="btn btn-outline-secondary btn-sm px-1" onclick="decrementDefect(this)">
                                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="#ff6f61" class="bi bi-caret-down-fill" viewBox="0 0 16 16">
                                    <path d="M7.247 11.14 2.451 5.658C1.885 5.013 2.345 4 3.204 4h9.592a1 1 0 0 1 .753 1.659l-4.796 5.48a1 1 0 0 1-1.506 0z"/>
                                </svg>
                            </button>
                        </div>
                    </div>
                </div>
            {% if forloop.counter|divisibleby:2 %}
            </div>
            {% endif %}
            {% endfor %}
        </div>
    </div>

    <!-- Additional Row for Comments and Detail for Other -->
    {% if feats|length|divisibleby:2 %}
    <div class="row mt-3 bordered">
    {% else %}
    <div class="row mt-3 no-border">
    {% endif %}
        <div class="col">
            <label for="comments">Comments:</label>
            <textarea id="comments" class="form-control" rows="1"></textarea>
        </div>
        <div class="col">
            <label for="detail_other">Detail for Other:</label>
            <textarea id="detail_other" class="form-control" rows="1"></textarea>
        </div>
        <div class="col">
            <label for="tpc_number">TPC Number: </label>
            <textarea id="tpc_number" class="form-control" rows="1"></textarea>
        </div>
    </div>




    <!-- Modal Buttons Row -->
    <div class="row mt-3">
        <!-- Single Column -->
        <div class="col-12 d-flex justify-content-between p-0">
            <!-- Clear Form Button aligned to start -->
            <button type="button" class="btn btn-dark" data-bs-toggle="modal" data-bs-target="#clearFormModal">
                Clear Form
            </button>

            <!-- JE Logo centered -->
            <img src="{% static 'images/JE_Logo_PNG.png' %}" alt="JE Logo" class="mx-auto" style="height: 38px;">

            <!-- Submit Button aligned to end -->
            <button type="button" class="btn btn-info" onclick="validateForm()">Submit</button>
        </div>
    </div>

    <!-- Clear Form Modal -->
    <div class="modal fade" id="clearFormModal" tabindex="-1" aria-labelledby="clearFormModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="clearFormModalLabel">Clear Form</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    Are you sure you want to clear the form? This action cannot be undone.
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-warning" onclick="clearForm()">Clear Form</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Submit Form Modal -->
    <div class="modal fade" id="submitFormModal" tabindex="-1" aria-labelledby="submitFormModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="submitFormModalLabel">Submit Form</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    Are you sure you want to submit the form? Please confirm the data is correct before submitting.

                    <!-- Spinner added here, initially hidden -->
                    <div id="spinner" class="spinner-border text-info" role="status" style="display: none;">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-info" onclick="submitForm()">Submit</button>
                </div>
            </div>
        </div>
    </div>
</div>
  

    

    

    <script src="{% static 'bootstrap/js/bootstrap.bundle.min.js' %}"></script>
    <script>
        // Initialize an empty object to hold the form data
        let payload = {};
        
        function updatePayload() {
            // Collect data from the form fields and store it in the payload object
            payload = {
                partNumber: '{{ part.part_number }}',  // Part number from the template context
                date: document.getElementById('date').value,  // Date field value
                operator: document.getElementById('operators').value,  // Operator field value
                shift: document.querySelector('input[name="shift"]:checked') ? document.querySelector('input[name="shift"]:checked').value : null,  // Selected shift radio button value
                qtyPacked: document.getElementById('total_defects').value,  // Qty Packed should grab the value from the total_defects input field
                totalDefects: document.getElementById('qty_packed').textContent,  // Total Defects should grab the value from the qty_packed display field
                totalInspected: document.getElementById('total_inspected').textContent,  // Total inspected (auto-calculated)
                feats: Array.from(document.querySelectorAll('.no-of-defects')).map((input, index) => ({
                    // Create an array of feats, each containing the feat name and number of defects
                    featName: document.querySelectorAll('.row .col-6')[index].textContent.trim(),  // Feat name (trimmed to remove extra spaces)
                    defects: input.value  // Defects value for each feat
                })),
                comments: document.getElementById('comments').value,  // Add Comments to payload
                detailOther: document.getElementById('detail_other').value,  // Add Detail for Other to payload
                tpcNumber: document.getElementById('tpc_number').value  // Add TPC Number to payload
            };
        
            // Save the payload object to localStorage to persist data even after page reload
            localStorage.setItem('scrapFormPayload', JSON.stringify(payload));
        
            // Log the updated payload to the console for debugging purposes
            console.log(payload);
        }
        
        
        // Function to increment the number of defects for a feat
        function incrementDefect(button) {
            // Find the input field for defects related to the clicked increment button
            let input = button.closest('.d-flex').previousElementSibling.querySelector('.no-of-defects');
            
            // Increase the defect count by 1
            input.value = parseInt(input.value) + 1;
        
            // Get the associated feat name and alarm value
            let featName = button.closest('.row').querySelector('.col-6').textContent.trim();
            let alarmValue = parseInt(featName.match(/\((\d+)\)/)[1]); // Assuming the alarm is in parentheses
        
            // Check if the defect count has reached the alarm value
            if (parseInt(input.value) === alarmValue) {
                triggerAlarm(featName);
            }
        
            // Update the total quantity packed based on the new defect count
            updateQtyPacked();
        
            // Recalculate the total inspected quantity
            calculateTotalInspected();
        
            // Update the payload to reflect these changes
            updatePayload();
        }
        
        function triggerAlarm(featName) {
            // Set the alarm message in the modal
            document.getElementById('alarmMessage').textContent = `${featName} has reached its alarm. Please contact your supervisor.`;
        
            // Show the supervisor authorization modal
            const supervisorAuthModal = new bootstrap.Modal(document.getElementById('supervisorAuthModal'));
            supervisorAuthModal.show();
        }


        function authorizeSupervisor() {
            // Get the supervisor ID value
            const supervisorId = document.getElementById('supervisorId').value;
        
            // Get the current feat name and part number from the modal and form
            const alarmMessage = document.getElementById('alarmMessage').textContent;
            const featName = alarmMessage.split(' has reached its alarm')[0].trim();
            const partNumber = '{{ part.part_number }}';
        
            // If any input is provided, store the event and close the modal
            if (supervisorId) {
                // Prepare the data to send
                const data = {
                    supervisor_id: supervisorId,
                    part_number: partNumber,
                    feat_name: featName
                };
        
                // Send the data via AJAX to the Django view
                fetch('{% url "store_supervisor_auth" %}', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': '{{ csrf_token }}'
                    },
                    body: JSON.stringify(data)
                })
                .then(response => response.json())
                .then(data => {
                    console.log('Success:', data);
                    const supervisorAuthModal = bootstrap.Modal.getInstance(document.getElementById('supervisorAuthModal'));
                    supervisorAuthModal.hide();
                })
                .catch((error) => {
                    console.error('Error:', error);
                });
            } else {
                alert('Please enter a valid Supervisor ID.');
            }
        }
        
        

        // Function to decrement the number of defects for a feat
        function decrementDefect(button) {
            // Find the input field for defects related to the clicked decrement button
            let input = button.closest('.d-flex').previousElementSibling.querySelector('.no-of-defects');
        
            // Ensure that the defect count cannot go below 0
            if (input.value > 0) {
                // Decrease the defect count by 1
                input.value = parseInt(input.value) - 1;
        
                // Update the total quantity packed based on the new defect count
                updateQtyPacked();
        
                // Recalculate the total inspected quantity
                calculateTotalInspected();
        
                // Update the payload to reflect these changes
                updatePayload();
            }
        }
        
        // Function to calculate and update the total quantity packed
        function updateQtyPacked() {
            // Get all input fields for defect counts
            let defects = document.querySelectorAll('.no-of-defects');
            
            // Initialize the total packed quantity to 0
            let totalPacked = 0;
        
            // Loop through each defect input and add its value to the total
            defects.forEach(function(defect) {
                totalPacked += parseInt(defect.value);
            });
        
            // Update the displayed total packed quantity on the form
            document.getElementById('qty_packed').textContent = totalPacked;
        
            // Update the payload to include the new total packed quantity
            updatePayload();
        }
        
        // Function to calculate and display the total inspected quantity
        function calculateTotalInspected() {
            // Get the current total packed quantity and total defects
            var qtyPacked = document.getElementById('total_defects').value;
            var totalDefects = document.getElementById('qty_packed').textContent;

            // Get the element where the total inspected quantity will be displayed
            var totalInspected = document.getElementById('total_inspected');

            // Calculate the total inspected as the sum of packed and defects
            if (qtyPacked && totalDefects) {
                totalInspected.textContent = parseInt(totalDefects) + parseInt(qtyPacked);
            } else {
                totalInspected.textContent = '';  // Clear the field if inputs are not valid
            }

            // Update the payload to include the new total inspected quantity
            updatePayload();
        }

        
        // Reusable function to clear the form
        function clearForm() {
            // Reset all input fields
            document.getElementById('date').value = '';
            document.getElementById('operators').value = '';
            
            // Clear radio buttons
            const shiftRadios = document.querySelectorAll('input[name="shift"]');
            shiftRadios.forEach(radio => radio.checked = false);
            
            // Reset packed, defects, and inspected fields
            document.getElementById('total_defects').value = '0';
            document.getElementById('qty_packed').textContent = '0';
            document.getElementById('total_inspected').textContent = '0';
            
            // Clear all defect counts
            document.querySelectorAll('.no-of-defects').forEach(input => input.value = '0');
            
            // Clear comments and other text areas
            document.getElementById('comments').value = '';
            document.getElementById('detail_other').value = '';
            
            // Remove the payload stored in localStorage
            localStorage.removeItem('scrapFormPayload');

            // Log the action for debugging purposes
            console.log('Form cleared successfully.');

            // Refresh the page to reset everything
            location.reload();
        }

        function submitForm() {
            // Change the modal message before showing the spinner
            document.querySelector('#submitFormModal .modal-body').innerHTML = `
                Please wait about 10-20 seconds while the form is submitting...
                <!-- Spinner added here, initially hidden -->
                <div id="spinner" class="spinner-border text-info" role="status" style="display: inline-block;">
                    <span class="visually-hidden">Loading...</span>
                </div>
            `;
        
            // Update the payload before sending
            updatePayload();
        
            // Send the payload to the backend
            fetch('{% url "submit_scrap_form" %}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': '{{ csrf_token }}'  // Include the CSRF token for Django
                },
                body: JSON.stringify(payload)
            })
            .then(response => response.json())
            .then(data => {
                console.log('Success:', data);
        
                // Reset the modal message and hide the spinner after success
                document.querySelector('#submitFormModal .modal-body').innerHTML = `
                    Are you sure you want to submit the form? Please confirm the data is correct before submitting.
                    <div id="spinner" class="spinner-border text-info" role="status" style="display: none;">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                `;
        
                // Clear the form after successful submission
                clearForm();
            })
            .catch((error) => {
                console.error('Error:', error);
        
                // Reset the modal message and hide the spinner in case of error
                document.querySelector('#submitFormModal .modal-body').innerHTML = `
                    Are you sure you want to submit the form? Please confirm the data is correct before submitting.
                    <div id="spinner" class="spinner-border text-info" role="status" style="display: none;">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                `;
            });
        }
        
        function validateForm() {
            // Retrieve form values
            const date = document.getElementById('date').value;
            const operator = document.getElementById('operators').value;
            const shift = document.querySelector('input[name="shift"]:checked');
            const qtyPacked = document.getElementById('total_defects').value;
        
            // Check if all required fields have a value
            if (!date || !operator || !shift || !qtyPacked) {
                alert('Please ensure Date, Operator, Shift, and Qty Packed all have values.');
                return false; // Prevent the modal from showing
            }
        
            // If all fields are filled, show the submit modal
            const submitModal = new bootstrap.Modal(document.getElementById('submitFormModal'));
            submitModal.show();
        }
        
        


        
        // Event listener that runs when the DOM content is fully loaded
        document.addEventListener('DOMContentLoaded', function() {
            // Set the date field to today's date by default
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('date').value = today;
        
            // Check if there is saved form data in localStorage and load it
            if (localStorage.getItem('scrapFormPayload')) {
                // Parse the saved JSON string back into an object
                payload = JSON.parse(localStorage.getItem('scrapFormPayload'));
        
                // Restore the form fields with the saved data
                document.getElementById('date').value = payload.date || today;
                document.getElementById('operators').value = payload.operator || '';
                
                // Restore the selected shift radio button if one was saved
                if (payload.shift) {
                    document.querySelector(`input[name="shift"][value="${payload.shift}"]`).checked = true;
                }
        
                // Restore the quantity packed, total defects, and total inspected fields
                document.getElementById('total_defects').value = payload.qtyPacked || '0';
                document.getElementById('qty_packed').textContent = payload.totalDefects || '0';
                document.getElementById('total_inspected').textContent = payload.totalInspected || '0';
        
                // Restore the defect counts for each feat
                const defectInputs = document.querySelectorAll('.no-of-defects');
                payload.feats.forEach((feat, index) => {
                    defectInputs[index].value = feat.defects || '0';
                });
                
                // Restore Comments and Detail for Other fields
                document.getElementById('comments').value = payload.comments || '';
                document.getElementById('detail_other').value = payload.detailOther || '';
            }
        
            // Attach input event listeners to all .no-of-defects fields to update the payload when changed
            const defectInputs = document.querySelectorAll('.no-of-defects');
            defectInputs.forEach(function(input) {
                input.addEventListener('input', function() {
                    updateQtyPacked();
                    calculateTotalInspected();
                    updatePayload();
                });
            });
        
            // Attach change event listeners to shift radio buttons to update the payload when changed
            const shiftRadios = document.querySelectorAll('input[name="shift"]');
            shiftRadios.forEach(function(radio) {
                radio.addEventListener('change', function() {
                    updatePayload();
                });
            });
        
            // Attach input event listeners to operator, total defects, comments, and detail other fields to update the payload when changed
            document.getElementById('operators').addEventListener('input', updatePayload);
            document.getElementById('total_defects').addEventListener('input', calculateTotalInspected);
            document.getElementById('comments').addEventListener('input', updatePayload);
            document.getElementById('detail_other').addEventListener('input', updatePayload);
        });
    </script>
    
    <!-- Supervisor Authorization Modal -->
    <div class="modal fade" id="supervisorAuthModal" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1" aria-labelledby="supervisorAuthModalLabel" aria-hidden="true">
        <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
            <h5 class="modal-title" id="supervisorAuthModalLabel">Supervisor Authorization Required</h5>
            <button type="button" class="btn-close" aria-label="Close" disabled></button>
            </div>
            <div class="modal-body">
            <p id="alarmMessage"></p>
            <div class="mb-3">
                <label for="supervisorId" class="form-label">Supervisor ID</label>
                <input type="text" class="form-control" id="supervisorId" placeholder="Enter Supervisor ID">
            </div>
            </div>
            <div class="modal-footer">
            <button type="button" class="btn btn-warning" onclick="authorizeSupervisor()">Submit</button>
            </div>
        </div>
        </div>
    </div>
  
</body>
</html>