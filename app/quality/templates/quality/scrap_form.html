{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Scrap Form</title>
    <link href="{% static 'bootstrap/css/bootstrap.min.css' %}" rel="stylesheet">
    <style>
        .bordered {
            border: 1px solid #000;
            padding: 10px;
        }
        .svg-icon {
            width: 1.5em;
            height: 1.5em;
            vertical-align: middle;
        }
    </style>
</head>
<body>
<div class="container mt-4">
    <!-- Title Row -->
    <div class="row bordered mb-3">
        <div class="col-12 text-center">
            <h1>Final Inspection Defect Tally Sheet</h1>
            <p>Part Number: {{ part.part_number }}</p>
        </div>
    </div>
    
    <!-- Header Row -->
    <div class="row bordered mb-3">
        <!-- Column 1 -->
        <div class="col-md-4">
            <div class="row">
                <div class="col-12">
                    <label for="date">Date</label>
                </div>
                <div class="col-12">
                    <input type="date" class="form-control" id="date">
                </div>
                <div class="col-12">
                    <label for="qty_inspected">Qty Inspected</label>
                </div>
                <div class="col-12">
                    <p id="qty_inspected" class="form-control-plaintext">0</p>
                </div>
            </div>
        </div>
        <!-- Column 2 -->
        <div class="col-md-4">
            <div class="row">
                <div class="col-12">
                    <label for="operators">Operator</label>
                </div>
                <div class="col-12">
                    <input type="text" class="form-control" id="operators">
                </div>
                <div class="col-12">
                    <label for="total_defects">Total Defects</label>
                </div>
                <div class="col-12">
                    <input type="number" class="form-control" id="total_defects" min="0" oninput="calculateTotalAccepted()">
                </div>
            </div>
        </div>

        <!-- Column 3 -->
        <div class="col-md-4">
            <div class="row">
                <div class="col-12">
                    <label for="shift">Shift</label>
                </div>
                <div class="col-12">
                    <div>
                        <input type="radio" id="shift1" name="shift" value="1">
                        <label for="shift1">1</label>
                        <input type="radio" id="shift2" name="shift" value="2">
                        <label for="shift2">2</label>
                        <input type="radio" id="shift3" name="shift" value="3">
                        <label for="shift3">3</label>
                    </div>
                </div>
                <div class="col-12 mt-3">
                    <label>Total Accepted</label>
                </div>
                <div class="col-12">
                    <p id="total_accepted" class="form-control-plaintext">0</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Grid Row -->
    <div class="row bordered mb-3">
        <div class="col-12">
            <div class="row">
                <!-- Header -->
                <div class="col-md-6 text-start">
                    <strong>Feat Name</strong>
                </div>
                <div class="col-md-3">
                    <strong>No. of Defects</strong>
                </div>
                <div class="col-md-3">
                    <strong>Actions</strong>
                </div>
            </div>
            <!-- Feats Loop -->
            {% for feat in feats %}
            {% if forloop.counter0|divisibleby:2 %}
            <div class="row mt-1">
            {% endif %}
                <div class="col-md-6">
                    <div class="row">
                        <div class="col-6">
                            {{ feat.name }}
                        </div>
                        <div class="col-3">
                            <input type="number" class="form-control no-of-defects" min="0" value="0">
                        </div>
                        <div class="col-3 d-flex justify-content-start align-items-start">
                            <button type="button" class="btn btn-outline-secondary btn-md me-2" onclick="incrementDefect(this)">
                                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="#20c997" class="bi bi-caret-up-fill" viewBox="0 0 16 16">
                                    <path d="m7.247 4.86-4.796 5.481c-.566.647-.106 1.659.753 1.659h9.592a1 1 0 0 0 .753-1.659l-4.796-5.48a1 1 0 0 0-1.506 0z"/>
                                </svg>
                            </button>
                            <button type="button" class="btn btn-outline-secondary btn-md" onclick="decrementDefect(this)">
                                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="#ff6f61" class="bi bi-caret-down-fill" viewBox="0 0 16 16">
                                    <path d="M7.247 11.14 2.451 5.658C1.885 5.013 2.345 4 3.204 4h9.592a1 1 0 0 1 .753 1.659l-4.796 5.48a1 1 0 0 1-1.506 0z"/>
                                </svg>
                            </button>
                        </div>
                    </div>
                </div>
            {% if forloop.counter|divisibleby:2 %}
            </div>
            {% endif %}
            {% endfor %}
        </div>
    </div>
    <script src="{% static 'bootstrap/js/bootstrap.bundle.min.js' %}"></script>
    <script>
        let payload = {};
    
        function updatePayload() {
            payload = {
                date: document.getElementById('date').value,
                operator: document.getElementById('operators').value,
                shift: document.querySelector('input[name="shift"]:checked') ? document.querySelector('input[name="shift"]:checked').value : null,
                qtyInspected: document.getElementById('qty_inspected').textContent,
                totalDefects: document.getElementById('total_defects').value,
                totalAccepted: document.getElementById('total_accepted').textContent,  // Added Total Accepted to payload
                feats: Array.from(document.querySelectorAll('.no-of-defects')).map((input, index) => ({
                    featName: document.querySelectorAll('.row .col-6')[index].textContent.trim(),
                    defects: input.value
                }))
            };
            localStorage.setItem('scrapFormPayload', JSON.stringify(payload));
    
            console.log(payload);  // This will log the updated payload to the console
        }
    
        function incrementDefect(button) {
            let input = button.closest('.d-flex').previousElementSibling.querySelector('.no-of-defects');
            input.value = parseInt(input.value) + 1;
            updateQtyInspected();
            calculateTotalAccepted();
            updatePayload(); // Update payload after increment
        }
    
        function decrementDefect(button) {
            let input = button.closest('.d-flex').previousElementSibling.querySelector('.no-of-defects');
            if (input.value > 0) {
                input.value = parseInt(input.value) - 1;
                updateQtyInspected();
                calculateTotalAccepted();
                updatePayload(); // Update payload after decrement
            }
        }
    
        function updateQtyInspected() {
            let defects = document.querySelectorAll('.no-of-defects');
            let totalInspected = 0;
    
            defects.forEach(function(defect) {
                totalInspected += parseInt(defect.value);
            });
    
            document.getElementById('qty_inspected').textContent = totalInspected;
            updatePayload(); // Update payload after updating inspected quantity
        }
    
        function calculateTotalAccepted() {
            var qtyInspected = document.getElementById('qty_inspected').textContent;
            var totalDefects = document.getElementById('total_defects').value;
            var totalAccepted = document.getElementById('total_accepted');
    
            if (qtyInspected && totalDefects) {
                totalAccepted.textContent = qtyInspected - totalDefects;
            } else {
                totalAccepted.textContent = '';
            }
            updatePayload(); // Update payload after calculating total accepted
        }
    
        document.addEventListener('DOMContentLoaded', function() {
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('date').value = today;
    
            // Load saved payload data if it exists
            if (localStorage.getItem('scrapFormPayload')) {
                payload = JSON.parse(localStorage.getItem('scrapFormPayload'));
                document.getElementById('date').value = payload.date || today;
                document.getElementById('operators').value = payload.operator || '';
                if (payload.shift) {
                    document.querySelector(`input[name="shift"][value="${payload.shift}"]`).checked = true;
                }
                document.getElementById('qty_inspected').textContent = payload.qtyInspected || '0';
                document.getElementById('total_defects').value = payload.totalDefects || '0';
                document.getElementById('total_accepted').textContent = payload.totalAccepted || '0';  // Restore Total Accepted from payload
                const defectInputs = document.querySelectorAll('.no-of-defects');
                payload.feats.forEach((feat, index) => {
                    defectInputs[index].value = feat.defects || '0';
                });
            }
    
            // Attach input event listeners to all .no-of-defects fields
            const defectInputs = document.querySelectorAll('.no-of-defects');
            defectInputs.forEach(function(input) {
                input.addEventListener('input', function() {
                    updateQtyInspected();
                    calculateTotalAccepted();
                    updatePayload(); // Update payload after any input change
                });
            });
    
            // Attach event listeners to shift radio buttons
            const shiftRadios = document.querySelectorAll('input[name="shift"]');
            shiftRadios.forEach(function(radio) {
                radio.addEventListener('change', function() {
                    updatePayload(); // Update payload after shift change
                });
            });
    
            // Attach event listeners to operator and total defects fields
            document.getElementById('operators').addEventListener('input', updatePayload);
            document.getElementById('total_defects').addEventListener('input', calculateTotalAccepted);
        });
    </script>    
</body>
</html>
