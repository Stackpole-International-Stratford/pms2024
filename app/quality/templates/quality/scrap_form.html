{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Scrap Form</title>
    <link href="{% static 'bootstrap/css/bootstrap.min.css' %}" rel="stylesheet">
    <style>
        /* Border and padding for bordered sections */
        .bordered {
            border: 1px solid #000;
            padding: 10px;
        }
    
        /* SVG icons sizing */
        .svg-icon {
            width: 1.5em;
            height: 1.5em;
            vertical-align: middle;
        }
    

    </style>    
</head>
<body>
<div class="container mt-4">
    <!-- Title Row -->
    <div class="row bordered mb-3">
        <div class="col-12 text-center">
            <h1>Final Inspection Defect Tally Sheet</h1>
            <p>Part Number: {{ part.part_number }}</p>
        </div>
    </div>
    
    <!-- Header Row -->
<div class="row bordered mb-3">
    <!-- Column 1 -->
    <div class="col-md-4">
        <div class="row">
            <div class="col-12">
                <label for="date">Date</label>
            </div>
            <div class="col-12">
                <input type="date" class="form-control" id="date">
            </div>
            <div class="col-12">
                <label for="total_defects">Total Defects</label> <!-- Updated Label -->
            </div>
            <div class="col-12">
                <p id="qty_inspected" class="form-control-plaintext">0</p>
            </div>
        </div>
    </div>
    <!-- Column 2 -->
    <div class="col-md-4">
        <div class="row">
            <div class="col-12">
                <label for="operators">Operator</label>
            </div>
            <div class="col-12">
                <input type="text" class="form-control" id="operators">
            </div>
            <div class="col-12">
                <label for="qty_inspected">Qty Inspected</label> <!-- Updated Label -->
            </div>
            <div class="col-12">
                <input type="number" class="form-control" id="total_defects" min="0" oninput="calculateTotalAccepted()">
            </div>
        </div>
    </div>

    <!-- Column 3 -->
    <div class="col-md-4">
        <div class="row">
            <div class="col-12">
                <label for="shift">Shift</label>
            </div>
            <div class="col-12">
                <div>
                    <input type="radio" id="shift1" name="shift" value="1">
                    <label for="shift1">1</label>
                    <input type="radio" id="shift2" name="shift" value="2">
                    <label for="shift2">2</label>
                    <input type="radio" id="shift3" name="shift" value="3">
                    <label for="shift3">3</label>
                </div>
            </div>
            <div class="col-12 mt-3">
                <label>Total Accepted</label>
            </div>
            <div class="col-12">
                <p id="total_accepted" class="form-control-plaintext">0</p>
            </div>
        </div>
    </div>
</div>


    <!-- Grid Row -->
    <div class="row bordered mb-3">
        <div class="col-12">
            <div class="row">
                <!-- Header -->
                <div class="col-md-6 text-start">
                    <strong>Feat Name</strong>
                </div>
                <div class="col-md-3">
                    <strong>No. of Defects</strong>
                </div>
                <div class="col-md-3">
                    <strong>Actions</strong>
                </div>
            </div>
            <!-- Feats Loop -->
            {% for feat in feats %}
            {% if forloop.counter0|divisibleby:2 %}
            <div class="row mt-1">
            {% endif %}
                <div class="col-md-6">
                    <div class="row">
                        <div class="col-6">
                            {{ feat.name }}
                        </div>
                        <div class="col-3">
                            <input type="number" class="form-control no-of-defects" min="0" value="0">
                        </div>
                        <div class="col-3 d-flex justify-content-start align-items-start">
                            <button type="button" class="btn btn-outline-secondary btn-sm me-2 px-1" onclick="incrementDefect(this)">
                                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="#20c997" class="bi bi-caret-up-fill" viewBox="0 0 16 16">
                                    <path d="m7.247 4.86-4.796 5.481c-.566.647-.106 1.659.753 1.659h9.592a1 1 0 0 0 .753-1.659l-4.796-5.48a1 1 0 0 0-1.506 0z"/>
                                </svg>
                            </button>
                            <button type="button" class="btn btn-outline-secondary btn-sm px-1" onclick="decrementDefect(this)">
                                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="#ff6f61" class="bi bi-caret-down-fill" viewBox="0 0 16 16">
                                    <path d="M7.247 11.14 2.451 5.658C1.885 5.013 2.345 4 3.204 4h9.592a1 1 0 0 1 .753 1.659l-4.796 5.48a1 1 0 0 1-1.506 0z"/>
                                </svg>
                            </button>
                        </div>
                    </div>
                </div>
            {% if forloop.counter|divisibleby:2 %}
            </div>
            {% endif %}
            {% endfor %}
        </div>
    </div>
    <!-- Additional Row for Comments and Detail for Other -->
    <div class="row mt-3 bordered">
        <div class="col-md-6">
            <label for="comments">Comments:</label>
            <textarea id="comments" class="form-control" rows="1"></textarea>
        </div>
        <div class="col-md-6">
            <label for="detail_other">Detail for Other:</label>
            <textarea id="detail_other" class="form-control" rows="1"></textarea>
        </div>
    </div>

    <!-- Modal Buttons Row -->
    <div class="row mt-3">
        <!-- Column 1: Clear Form Button -->
        <div class="col-md-6 d-flex justify-content-start p-0">
            <!-- Button trigger modal for clearing the form -->
            <button type="button" class="btn btn-dark" data-bs-toggle="modal" data-bs-target="#clearFormModal">
                Clear Form
            </button>

            <!-- Clear Form Modal -->
            <div class="modal fade" id="clearFormModal" tabindex="-1" aria-labelledby="clearFormModalLabel" aria-hidden="true">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title" id="clearFormModalLabel">Clear Form</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <div class="modal-body">
                            Are you sure you want to clear the form? This action cannot be undone.
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                            <button type="button" class="btn btn-warning" onclick="clearForm()">Clear Form</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Column 2: Submit Button -->
        <div class="col-md-6 d-flex justify-content-end p-0">
            <!-- Button trigger modal for submitting the form -->
            <button type="button" class="btn btn-info" data-bs-toggle="modal" data-bs-target="#submitFormModal">
                Submit
            </button>

            <!-- Submit Form Modal -->
            <div class="modal fade" id="submitFormModal" tabindex="-1" aria-labelledby="submitFormModalLabel" aria-hidden="true">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title" id="submitFormModalLabel">Submit Form</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <div class="modal-body">
                            Are you sure you want to submit the form? Please confirm the data is correct before submitting.
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                            <button type="button" class="btn btn-info" onclick="submitForm()">Submit</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    

    <script src="{% static 'bootstrap/js/bootstrap.bundle.min.js' %}"></script>
    <script>
        // Initialize an empty object to hold the form data
        let payload = {};
        
        // Function to update the payload with the current values from the form
        function updatePayload() {
            // Collect data from the form fields and store it in the payload object
            payload = {
                partNumber: '{{ part.part_number }}',  // Part number from the template context
                date: document.getElementById('date').value,  // Date field value
                operator: document.getElementById('operators').value,  // Operator field value
                shift: document.querySelector('input[name="shift"]:checked') ? document.querySelector('input[name="shift"]:checked').value : null,  // Selected shift radio button value
                qtyInspected: document.getElementById('total_defects').value,  // Qty Inspected should grab the value from the total_defects input field
                totalDefects: document.getElementById('qty_inspected').textContent,  // Total Defects should grab the value from the qty_inspected display field
                totalAccepted: document.getElementById('total_accepted').textContent,  // Total accepted (auto-calculated)
                feats: Array.from(document.querySelectorAll('.no-of-defects')).map((input, index) => ({
                    // Create an array of feats, each containing the feat name and number of defects
                    featName: document.querySelectorAll('.row .col-6')[index].textContent.trim(),  // Feat name (trimmed to remove extra spaces)
                    defects: input.value  // Defects value for each feat
                })),
                comments: document.getElementById('comments').value,  // Add Comments to payload
                detailOther: document.getElementById('detail_other').value  // Add Detail for Other to payload
            };
        
            // Save the payload object to localStorage to persist data even after page reload
            localStorage.setItem('scrapFormPayload', JSON.stringify(payload));
        
            // Log the updated payload to the console for debugging purposes
            console.log(payload);
        }
        
        // Function to increment the number of defects for a feat
        function incrementDefect(button) {
            // Find the input field for defects related to the clicked increment button
            let input = button.closest('.d-flex').previousElementSibling.querySelector('.no-of-defects');
            
            // Increase the defect count by 1
            input.value = parseInt(input.value) + 1;
        
            // Update the total quantity inspected based on the new defect count
            updateQtyInspected();
        
            // Recalculate the total accepted quantity
            calculateTotalAccepted();
        
            // Update the payload to reflect these changes
            updatePayload();
        }
        
        // Function to decrement the number of defects for a feat
        function decrementDefect(button) {
            // Find the input field for defects related to the clicked decrement button
            let input = button.closest('.d-flex').previousElementSibling.querySelector('.no-of-defects');
        
            // Ensure that the defect count cannot go below 0
            if (input.value > 0) {
                // Decrease the defect count by 1
                input.value = parseInt(input.value) - 1;
        
                // Update the total quantity inspected based on the new defect count
                updateQtyInspected();
        
                // Recalculate the total accepted quantity
                calculateTotalAccepted();
        
                // Update the payload to reflect these changes
                updatePayload();
            }
        }
        
        // Function to calculate and update the total quantity inspected
        function updateQtyInspected() {
            // Get all input fields for defect counts
            let defects = document.querySelectorAll('.no-of-defects');
            
            // Initialize the total inspected quantity to 0
            let totalInspected = 0;
        
            // Loop through each defect input and add its value to the total
            defects.forEach(function(defect) {
                totalInspected += parseInt(defect.value);
            });
        
            // Update the displayed total inspected quantity on the form
            document.getElementById('qty_inspected').textContent = totalInspected;
        
            // Update the payload to include the new total inspected quantity
            updatePayload();
        }
        
        // Function to calculate and display the total accepted quantity
        function calculateTotalAccepted() {
            // Get the current total inspected quantity and total defects
            var qtyInspected = document.getElementById('total_defects').value;
            var totalDefects = document.getElementById('qty_inspected').textContent;
        
            // Get the element where the total accepted quantity will be displayed
            var totalAccepted = document.getElementById('total_accepted');
        
            // Calculate the total accepted as the difference between inspected and defects
            if (qtyInspected && totalDefects) {
                totalAccepted.textContent = totalDefects - qtyInspected;
            } else {
                totalAccepted.textContent = '';  // Clear the field if inputs are not valid
            }
        
            // Update the payload to include the new total accepted quantity
            updatePayload();
        }
        
        // Event listener that runs when the DOM content is fully loaded
        document.addEventListener('DOMContentLoaded', function() {
            // Set the date field to today's date by default
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('date').value = today;
        
            // Check if there is saved form data in localStorage and load it
            if (localStorage.getItem('scrapFormPayload')) {
                // Parse the saved JSON string back into an object
                payload = JSON.parse(localStorage.getItem('scrapFormPayload'));
        
                // Restore the form fields with the saved data
                document.getElementById('date').value = payload.date || today;
                document.getElementById('operators').value = payload.operator || '';
                
                // Restore the selected shift radio button if one was saved
                if (payload.shift) {
                    document.querySelector(`input[name="shift"][value="${payload.shift}"]`).checked = true;
                }
        
                // Restore the quantity inspected, total defects, and total accepted fields
                document.getElementById('total_defects').value = payload.qtyInspected || '0';  // Swap logic here
                document.getElementById('qty_inspected').textContent = payload.totalDefects || '0';  // Swap logic here
                document.getElementById('total_accepted').textContent = payload.totalAccepted || '0';
        
                // Restore the defect counts for each feat
                const defectInputs = document.querySelectorAll('.no-of-defects');
                payload.feats.forEach((feat, index) => {
                    defectInputs[index].value = feat.defects || '0';
                });
                
                // Restore Comments and Detail for Other fields
                document.getElementById('comments').value = payload.comments || '';
                document.getElementById('detail_other').value = payload.detailOther || '';
            }
        
            // Attach input event listeners to all .no-of-defects fields to update the payload when changed
            const defectInputs = document.querySelectorAll('.no-of-defects');
            defectInputs.forEach(function(input) {
                input.addEventListener('input', function() {
                    updateQtyInspected();
                    calculateTotalAccepted();
                    updatePayload();
                });
            });
        
            // Attach change event listeners to shift radio buttons to update the payload when changed
            const shiftRadios = document.querySelectorAll('input[name="shift"]');
            shiftRadios.forEach(function(radio) {
                radio.addEventListener('change', function() {
                    updatePayload();
                });
            });
        
            // Attach input event listeners to operator, total defects, comments, and detail other fields to update the payload when changed
            document.getElementById('operators').addEventListener('input', updatePayload);
            document.getElementById('total_defects').addEventListener('input', calculateTotalAccepted);
            document.getElementById('comments').addEventListener('input', updatePayload);
            document.getElementById('detail_other').addEventListener('input', updatePayload);
        });
    </script>
    
</body>
</html>
