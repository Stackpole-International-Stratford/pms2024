{% load static %}
<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>Operational Availability by Line</title>
        <link href="{% static 'bootstrap/css/bootstrap.min.css' %}" rel="stylesheet">
        <script src="{% static 'bootstrap/js/bootstrap.bundle.min.js' %}"></script>
        <script src="https://code.jquery.com/jquery-3.6.4.min.js"></script>
    </head>
<body>
    <style>
        .percentage-down {
            cursor: pointer;
        }
        
    </style>

      <!-- Navbar with Back Button -->
      <nav class="navbar navbar-expand-lg navbar-light bg-light">
        <a class="navbar-brand" href="{% url 'prod_query:prod-query_index' %}">
            <button type="button" class="btn btn-outline-primary mx-3">Back</button>
        </a>
        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
        </button>
    </nav>
    <div class="container mt-5">
        <h1 class="mb-4">Operational Availability by Line</h1>
    
        <div class="d-flex mb-4 gap-3 align-items-end">
            <!-- Date Picker -->
            <div>
                <label for="date-picker" class="form-label">Select Date:</label>
                <input type="date" id="date-picker" class="form-control">
            </div>
    
            <!-- Line Selection Dropdown -->
            <div>
                <label for="line-select" class="form-label">Select Line:</label>
                <select id="line-select" class="form-select">
                    <option value="" selected>-- Select a Line --</option>
                </select>
            </div>
        </div>
    
        <!-- Buttons for Previous and Next Week -->
        <div class="d-flex justify-content-start gap-2 mt-3">
            <button id="previous-week" class="btn btn-secondary">Previous Week</button>
            <button id="next-week" class="btn btn-secondary">Next Week</button>
        </div>
    
        <style>
            .form-control, .form-select {
                height: calc(2.5rem + 2px); /* Standardize heights */
                display: inline-block; /* Prevent layout shifts */
            }
        </style>
    
        <!-- OA Results -->
        <div id="oa-results-section" class="card mt-4 d-none">
            <div class="card-body">
                <div id="oa-results" class="alert alert-info"></div>
            </div>
        </div>
       
        <button id="export-csv" class="btn btn-success mt-3">Export as CSV</button>

        <!-- Results Table -->
        <div id="results-section" class="mb-4 d-none">
            <h2 id="results-title" class="text-center text-dark mb-4"></h2> <!-- Styled title -->
            <div id="results-container"></div>
        </div>


    
        <!-- Spinner -->
        <div id="loading-spinner" class="text-center d-none">
            <div class="spinner-border text-dark" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
            <p>Loading data, please wait...</p>
        </div>
    </div>

    <!-- Modal -->
    <div class="modal fade" id="downtimeDetailsModal" tabindex="-1" aria-labelledby="downtimeDetailsLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="downtimeDetailsLabel">Downtime Details</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <!-- Content will be dynamically updated -->
                    <div id="downtime-details-content"></div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>


    <script>

        // Move the highlightTable function outside of document.ready
        function highlightTable() {
            // Highlight percentage down
            const percentageDownCells = document.querySelectorAll('.percentage-down');
            let maxPercentage = -Infinity, minPercentage = Infinity;
            percentageDownCells.forEach(cell => {
                const percentage = parseInt(cell.dataset.percentage, 10);
                if (!isNaN(percentage)) {
                    if (percentage > maxPercentage) maxPercentage = percentage;
                    if (percentage < minPercentage) minPercentage = percentage;
                }
            });

            percentageDownCells.forEach(cell => {
                const percentage = parseInt(cell.dataset.percentage, 10);
                if (percentage === maxPercentage) {
                    cell.style.color = 'red';
                    cell.style.fontWeight = 'bold';
                } else if (percentage === minPercentage) {
                    cell.style.color = 'green';
                    cell.style.fontWeight = 'bold';
                }
            });

            // Highlight the lowest subtotal P
            const pCells = document.querySelectorAll('.subtotal-p');
            let minP = Infinity;
            pCells.forEach(cell => {
                const pValue = parseFloat(cell.dataset.p);
                if (!isNaN(pValue) && pValue < minP) {
                    minP = pValue;
                }
            });

            pCells.forEach(cell => {
                const pValue = parseFloat(cell.dataset.p);
                if (pValue === minP) {
                    cell.style.color = 'red';
                    cell.style.fontWeight = 'bold';
                }
            });

            // Highlight the lowest subtotal A
            const aCells = document.querySelectorAll('.subtotal-a');
            let minA = Infinity;
            aCells.forEach(cell => {
                const aValue = parseFloat(cell.dataset.a);
                if (!isNaN(aValue) && aValue < minA) {
                    minA = aValue;
                }
            });

            aCells.forEach(cell => {
                const aValue = parseFloat(cell.dataset.a);
                if (aValue === minA) {
                    cell.style.color = 'red';
                    cell.style.fontWeight = 'bold';
                }
            });
        }
    </script>

    <script>
        $(document).on('click', '.percentage-down', function () {
            const percentage = $(this).attr('data-percentage');
            const startDateISO = $(this).attr('data-startdateiso');
            const endOfWeek = $(this).attr('data-endofweek');
            const machine = $(this).attr('data-machine');
        
            // Debugging: Log the retrieved values
            console.log('Retrieved data attributes:', {
                percentage,
                startDateISO,
                endOfWeek,
                machine
            });
        
            // Check if machine is 'Subtotal' or 'Total'
            if (machine === 'Subtotal' || machine === 'Total') {
                alert('Detailed downtime data is not available for subtotals or totals.');
                return;
            }
        
            // Show a loading message
            $('#downtime-details-content').html('<p>Loading downtime details...</p>');
            $('#downtimeDetailsModal').modal('show');
        
            // Send AJAX request to the 'pr-downtime/' view
            $.ajax({
                url: "{% url 'prod_query:pr_downtime' %}",
                type: "GET",
                data: {
                    assetnum: machine,
                    called4helptime: startDateISO,
                    completedtime: endOfWeek,
                    csrfmiddlewaretoken: '{{ csrf_token }}'
                },
                success: function (response) {
                    if (response.error) {
                        $('#downtime-details-content').html(`<p class="text-danger">${response.error}</p>`);
                    } else {
                        // Start building the downtime details HTML
                        let downtimeDetails = `
                            <p><strong>Machine:</strong> ${machine}</p>
                            <p><strong>Start Date:</strong> ${new Date(startDateISO).toLocaleString()}</p>
                            <p><strong>End of Week:</strong> ${new Date(endOfWeek).toLocaleString()}</p>
                            <p><strong>Downtime Percentage:</strong> ${percentage}%</p>
                        `;
                
                        if (response.data.length > 0) {
                            downtimeDetails += `
                                <p><strong>Downtime Entries:</strong></p>
                                <div class="table-responsive">
                                    <table class="table table-bordered table-hover">
                                        <thead class="table-light">
                                            <tr>
                                                <th>Problem</th>
                                                <th>Called for Help Time</th>
                                                <th>Completed Time</th>
                                                <th>Downtime (minutes)</th> <!-- New Column Header -->
                                            </tr>
                                        </thead>
                                        <tbody>
                            `;
                
                            response.data.forEach(entry => {
                                const problem = entry.problem || 'N/A';
                                const calledTime = entry.called4helptime
                                    ? new Date(entry.called4helptime).toLocaleString()
                                    : 'Unknown';
                                const completedTime = entry.completedtime
                                    ? new Date(entry.completedtime).toLocaleString()
                                    : 'Still in progress';
                
                                // Calculate downtime duration in minutes
                                let downtimeMinutes = 'In Progress';
                                if (entry.called4helptime && entry.completedtime) {
                                    const calledDate = new Date(entry.called4helptime);
                                    const completedDate = new Date(entry.completedtime);
                                    const diffMs = completedDate - calledDate; // Difference in milliseconds
                                    const diffMinutes = Math.round(diffMs / 60000); // Convert to minutes
                                    downtimeMinutes = diffMinutes >= 0 ? diffMinutes : 'Invalid Time';
                                }
                
                                downtimeDetails += `
                                    <tr>
                                        <td>${problem}</td>
                                        <td>${calledTime}</td>
                                        <td>${completedTime}</td>
                                        <td>${downtimeMinutes}</td> <!-- New Column Data -->
                                    </tr>
                                `;
                            });
                
                            downtimeDetails += `
                                        </tbody>
                                    </table>
                                </div>
                            `;
                        } else {
                            downtimeDetails += '<p>No downtime entries found for this period.</p>';
                        }
                
                        // Set the content inside the modal
                        $('#downtime-details-content').html(downtimeDetails);
                    }
                },                               
                
                error: function (xhr) {
                    $('#downtime-details-content').html('<p class="text-danger">An error occurred while fetching downtime details.</p>');
                }
            });            
        });
        
        
    </script>
    

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('export-csv').addEventListener('click', async () => {
                const table = document.querySelector('#results-container table');
                if (!table) {
                    alert('No data available to export!');
                    return;
                }
    
                const line = document.getElementById('line-select').value;
                const date = document.getElementById('date-picker').value;
                const filename = `${line}_${date}.csv`;
    
                // Function to generate CSV content
                function generateCSVContent() {
                    const rows = table.querySelectorAll('tr');
                    const expectedColumns = 10; // Total number of columns in your table
    
                    let csvContent = '';
    
                    rows.forEach(row => {
                        const cells = row.querySelectorAll('th, td');
                        let rowData = [];
    
                        cells.forEach((cell, index) => {
                            const cellText = cell.textContent.trim();
    
                            // Check if the row is a "Subtotal" or "Total" row
                            if (index === 0 && (cellText.startsWith('Subtotal') || cellText === 'Total')) {
                                // 'Op' column: cellText (e.g., "Subtotal for Op 10" or "Total")
                                rowData.push(`"${cellText}"`);
                                // 'Machine' column: empty
                                rowData.push(`""`);
                            } else {
                                // Regular cells
                                // Escape any existing double quotes in the cell text
                                const escapedText = cellText.replace(/"/g, '""');
                                rowData.push(`"${escapedText}"`);
                            }
                        });
    
                        // Calculate the number of missing cells and pad with empty strings
                        const missingCells = expectedColumns - rowData.length;
                        for (let i = 0; i < missingCells; i++) {
                            rowData.push(`""`);
                        }
    
                        // Join the row data with commas and add a newline
                        csvContent += rowData.join(',') + '\r\n';
                    });
    
                    return csvContent;
                }
    
                // Generate CSV content
                const csvData = generateCSVContent();
    
                // Create a Blob from the CSV data
                const blob = new Blob([csvData], { type: 'text/csv;charset=utf-8;' });
    
                // Create a temporary link to trigger the download
                const link = document.createElement('a');
                const url = URL.createObjectURL(blob);
                link.setAttribute('href', url);
                link.setAttribute('download', filename);
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            });
        });
    </script>
    
    
    
    


    <script>

        document.addEventListener('DOMContentLoaded', () => {
            const datePicker = document.getElementById('date-picker');

            // Get today's date in the format YYYY-MM-DD
            const today = new Date();
            const year = today.getFullYear();
            const month = String(today.getMonth() + 1).padStart(2, '0'); // Months are zero-based
            const day = String(today.getDate()).padStart(2, '0');
            const formattedDate = `${year}-${month}-${day}`;

            // Set the default value of the date picker to today's date
            datePicker.value = formattedDate;

            // Helper function to adjust date by weeks
            const adjustDateByWeek = (date, weeks) => {
                const newDate = new Date(date);
                newDate.setDate(newDate.getDate() + weeks * 7);
                return newDate.toISOString().split('T')[0]; // Format as YYYY-MM-DD
            };

            // Previous Week Button Click Event
            document.getElementById('previous-week').addEventListener('click', () => {
                const currentDate = new Date(datePicker.value);
                datePicker.value = adjustDateByWeek(currentDate, -1);
                datePicker.dispatchEvent(new Event('change')); // Trigger change event
            });

            // Next Week Button Click Event
            document.getElementById('next-week').addEventListener('click', () => {
                const currentDate = new Date(datePicker.value);
                datePicker.value = adjustDateByWeek(currentDate, 1);
                datePicker.dispatchEvent(new Event('change')); // Trigger change event
            });
        });

    </script>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // Get today's date in the format YYYY-MM-DD
            const today = new Date();
            const year = today.getFullYear();
            const month = String(today.getMonth() + 1).padStart(2, '0'); // Months are zero-based
            const day = String(today.getDate()).padStart(2, '0');
            const formattedDate = `${year}-${month}-${day}`;

            // Set the default value of the date picker to today's date
            const datePicker = document.getElementById('date-picker');
            datePicker.value = formattedDate;
        });
    </script>

    <script>
        $(document).ready(function () {
            const lines = {{ lines|safe }}; // Pass the `lines` object from Django to JavaScript.
            let ajaxRequestCount = 0; // Counter to track ongoing AJAX requests

            // Function to show/hide spinner
            function showSpinner() {
                $('#loading-spinner').removeClass('d-none');
            }

            function hideSpinner() {
                $('#loading-spinner').addClass('d-none');
            }

            function incrementAjaxCount() {
                ajaxRequestCount++;
                if (ajaxRequestCount === 1) {
                    showSpinner(); // Show spinner on first request
                }
            }

            function decrementAjaxCount() {
                ajaxRequestCount--;
                if (ajaxRequestCount <= 0) { // Ensure spinner hides when all requests are done
                    ajaxRequestCount = 0; // Reset the count to prevent negative values
                    hideSpinner();
                }
            }

            // Populate the dropdown
            lines.forEach(line => {
                $('#line-select').append(`<option value="${line.line}">${line.line}</option>`);
            });

            // Handle line or date selection and fetch data
            $('#line-select, #date-picker').change(function () {
                const selectedLine = $('#line-select').val();
                const selectedDate = $('#date-picker').val();

                if (!selectedLine || !selectedDate) {
                    // Do nothing until both selections are made
                    return;
                }

                const selectedDateObj = new Date(selectedDate);
                if (isNaN(selectedDateObj)) {
                    alert('Invalid date selected!');
                    return;
                }

                const lineData = lines.find(line => line.line === selectedLine);
                const scrapLine = lineData.scrap_line;

                const startOfWeek = new Date(selectedDateObj);
                startOfWeek.setDate(selectedDateObj.getDate() - selectedDateObj.getDay());
                startOfWeek.setHours(23, 0, 0, 0);
                const startDateISO = startOfWeek.toISOString();
                console.log(startDateISO);

                // Increment AJAX request count
                incrementAjaxCount();

                // Fetch downtime and production data
                $.ajax({
                    url: "{% url 'prod_query:gfx_downtime_and_produced' %}",
                    type: "POST",
                    data: {
                        machines: JSON.stringify(lineData.operations.flatMap(op => op.machines.map(m => m.number))),
                        line: selectedLine, // Include the selected line in the POST request
                        start_date: startDateISO,
                        csrfmiddlewaretoken: '{{ csrf_token }}'
                    },
                    success: function (data) {
                        if (data.error) {
                            console.error('Error:', data.error);
                            console.debug('Debug Logs:', data.debug);
                            alert(`Error: ${data.error}\nDebug Logs: ${JSON.stringify(data.debug, null, 2)}`);
                        } else {
                            displayMachineResults(data, lineData);
                        }
                    },
                    error: function (xhr) {
                        console.error('Request failed:', xhr);
                        alert(`Error: ${xhr.statusText}. Check console for details.`);
                    },
                    complete: function () {
                        // Decrement AJAX request count
                        decrementAjaxCount();
                    }
                });

                // Increment AJAX request count
                incrementAjaxCount();

                // Fetch scrap data
                $.ajax({
                    url: "{% url 'prod_query:total_scrap' %}",
                    type: "GET",
                    data: {
                        scrap_line: scrapLine,
                        start_date: startDateISO
                    },
                    success: function (data) {
                        if (data.error) {
                            alert(data.error);
                        } else {
                            window.scrapAmount = data.total_scrap_amount;
                        }
                    },
                    error: function () {
                        alert('Error fetching scrap data. Please try again.');
                    },
                    complete: function () {
                        // Decrement AJAX request count
                        decrementAjaxCount();
                    }
                });
            });
    
            function displayMachineResults(data, lineData) {
                const downtimeResults = data.downtime_results || [];
                const producedResults = data.produced_results || [];
                const adjustedMachineTargets = data.machine_targets || {};
                const startDateStr = data.start_date; // Extract start_date
                const endDateStr = data.end_date;     // Extract end_date
            
                // Parse the date strings into Date objects
                const startDate = new Date(startDateStr);
                const endDate = new Date(endDateStr);
            
                // Format the dates for display (e.g., Jan 01, 2024 12:00 PM)
                const options = { year: 'numeric', month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' };
                const formattedStartDate = startDate.toLocaleDateString(undefined, options);
                const formattedEndDate = endDate.toLocaleDateString(undefined, options);
            
                // Convert dates to ISO 8601 format for data attributes and server communication
                const startDateISO = startDate.toISOString();
                const endDateISO = endDate.toISOString();

                // Store in global variables (optional, if needed elsewhere)
                window.startDateISO = startDateStr;
                window.endOfWeek = endDateStr;
                // Set the title
                $('#results-title').text(`Results from ${formattedStartDate} to ${formattedEndDate}`);
            
                // Continue with existing processing
                const machineToOp = getMachineToOpMapping(lineData);
                const selectedDate = getSelectedDate();
                const now = new Date();
            
                const totalPotentialMinutesPerMachine = calculateTotalPotentialMinutesPerMachine(data, selectedDate, now);
                const scalingFactor = totalPotentialMinutesPerMachine / 7200;
            
                const opGroups = initializeOpGroups(lineData);
            
                // Initialize totals
                const totals = {
                    totalDowntime: 0,
                    totalProduced: 0,
                    totalTarget: 0,
                    totalAdjustedTarget: 0,
                    totalPotentialMinutes: 0
                };
            
                processResults(
                    downtimeResults,
                    producedResults,
                    adjustedMachineTargets,
                    machineToOp,
                    totalPotentialMinutesPerMachine,
                    opGroups,
                    totals
                );
            
                const { overallP, overallA } = calculateOverallPAndA(
                    totals.totalAdjustedTarget,
                    totals.totalProduced,
                    totals.totalPotentialMinutes,
                    totals.totalDowntime
                );
            
                const tableHtml = buildTable(opGroups, totals, overallP, overallA, startDateStr, endDateStr);
            
                updateDOM(tableHtml, overallP, overallA, totals.totalProduced);
            }
            
            // Function to get the selected date from the date picker
            function getSelectedDate() {
                return new Date($('#date-picker').val());
            }
            
            // Function to map machines to operations
            function getMachineToOpMapping(lineData) {
                const machineToOp = {};
                lineData.operations.forEach(opData => {
                    const op = opData.op;
                    opData.machines.forEach(machine => {
                        machineToOp[machine.number] = op;
                    });
                });
                return machineToOp;
            }
            
            // Function to calculate the total potential minutes per machine
            function calculateTotalPotentialMinutesPerMachine(data, selectedDate, now) {
                let totalPotentialMinutesPerMachine = parseFloat(data.total_potential_minutes_per_machine) || 7200;
            
                const startOfWeek = new Date(selectedDate);
                startOfWeek.setDate(selectedDate.getDate() - selectedDate.getDay()); // Start of week is Sunday
                startOfWeek.setHours(0, 0, 0, 0); // Reset to midnight
            
                const endOfWeek = new Date(startOfWeek);
                endOfWeek.setDate(startOfWeek.getDate() + 5); // End of week is Saturday
                endOfWeek.setHours(23, 0, 0, 0);
                console.log(endOfWeek);
                
            
                // If the selected date is in this week, adjust totalPotentialMinutesPerMachine
                if (now >= startOfWeek && now <= endOfWeek) {
                    const elapsedTime = now - startOfWeek; // Elapsed time since the start of the week
                    const totalWeekTime = endOfWeek - startOfWeek; // Total time in the week
                    const elapsedPercentage = elapsedTime / totalWeekTime;
            
                    // Scale down potential minutes proportionally to elapsed time
                    totalPotentialMinutesPerMachine = 7200 * elapsedPercentage;
                }
            
                return totalPotentialMinutesPerMachine;
            }
            
            // Function to initialize operation groups
            function initializeOpGroups(lineData) {
                const opGroups = {};
                lineData.operations.forEach(opData => {
                    const op = opData.op;
                    opGroups[op] = {
                        machines: [],
                        subtotal: {
                            downtime: 0,
                            produced: 0,
                            target: 0,
                            adjustedTarget: 0,
                            potentialMinutes: 0
                        }
                    };
                });
                return opGroups;
            }
            
            // Function to process the results and populate opGroups and totals
            function processResults(
                downtimeResults,
                producedResults,
                adjustedMachineTargets,
                machineToOp,
                totalPotentialMinutesPerMachine,
                opGroups,
                totals
            ) {
                downtimeResults.forEach((result) => {
                    const machine = result.machine;
            
                    // Ensure downtime does not exceed total potential minutes
                    let downtime = parseFloat(result.downtime) || 0;
                    downtime = Math.min(downtime, totalPotentialMinutesPerMachine);
                    downtime = Math.round(downtime); // Ensure downtime is an integer
                    
            
                    const produced = parseFloat(producedResults.find(p => p.machine === machine)?.produced) || 0;
            
                    // Get original and adjusted targets from server response
                    const targetInfo = adjustedMachineTargets[machine] || {};
                    const originalTarget = targetInfo.original_target || 0;
                    const adjustedOriginalTarget = targetInfo.adjusted_original_target || 0;
            
                    // Calculate P, A, Percentage Down, and Adjusted Target for this machine
                    const percentageDown = totalPotentialMinutesPerMachine > 0
                        ? Math.round((downtime / totalPotentialMinutesPerMachine) * 100)
                        : 0;
                    const adjustedTarget = Math.max(
                        0,
                        adjustedOriginalTarget * (1 - (downtime / totalPotentialMinutesPerMachine))
                    );
                    const P = (adjustedTarget === 0 && produced === 0) ? 1 :
                        (adjustedTarget > 0 ? (produced / adjustedTarget) : 0);
            
                    const A = totalPotentialMinutesPerMachine > 0
                    ? Math.max(0, (totalPotentialMinutesPerMachine - downtime) / totalPotentialMinutesPerMachine)
                    : 0;
                    
            
                    // Accumulate totals
                    totals.totalDowntime += downtime;
                    totals.totalProduced += produced;
                    totals.totalTarget += adjustedOriginalTarget;
                    totals.totalAdjustedTarget += adjustedTarget;
                    totals.totalPotentialMinutes += totalPotentialMinutesPerMachine;
            
                    // Get the op for this machine
                    const op = machineToOp[machine] || 'Unknown';
            
                    // Add to opGroups
                    if (!opGroups[op]) {
                        opGroups[op] = {
                            machines: [],
                            subtotal: {
                                downtime: 0,
                                produced: 0,
                                target: 0,
                                adjustedTarget: 0,
                                potentialMinutes: 0
                            }
                        };
                    }
            
                    opGroups[op].machines.push({
                        machine: machine,
                        downtime: downtime,
                        produced: produced,
                        target: adjustedOriginalTarget,
                        adjustedTarget: adjustedTarget,
                        potentialMinutes: totalPotentialMinutesPerMachine,
                        P: P,
                        A: A,
                        percentageDown: percentageDown
                    });
            
                    // Update subtotals for the op
                    opGroups[op].subtotal.downtime += downtime;
                    opGroups[op].subtotal.produced += produced;
                    opGroups[op].subtotal.target += adjustedOriginalTarget;
                    opGroups[op].subtotal.adjustedTarget += adjustedTarget;
                    opGroups[op].subtotal.potentialMinutes += totalPotentialMinutesPerMachine;
                });
            }
            
            // Function to calculate overall P and A
            function calculateOverallPAndA(totalAdjustedTarget, totalProduced, totalPotentialMinutes, totalDowntime) {
                const overallP = totalAdjustedTarget > 0 ? (totalProduced / totalAdjustedTarget) : 0;
                const overallA = totalPotentialMinutes > 0
                    ? ((totalPotentialMinutes - totalDowntime) / totalPotentialMinutes)
                    : 0;
                return { overallP, overallA };
            }
            
            // Function to build the HTML table
            function buildTable(opGroups, totals, overallP, overallA, startDateISO, endDateISO) {
                let tableHtml = `
                <table class="table table-striped">
                    <thead>
                        <tr>
                            <th>Op</th>
                            <th>Machine</th>
                            <th>Total Produced</th>
                            <th>Original Target</th>
                            <th>Adjusted Target</th>
                            <th>Downtime (minutes)</th>
                            <th>Total Potential Minutes</th>
                            <th>Percentage Down</th>
                            <th>P</th>
                            <th>A</th>
                        </tr>
                    </thead>
                    <tbody>
                `;
            
                let subtotalPercentages = [];
                let subtotalPs = [];
                let subtotalAs = [];
            
                for (const op of Object.keys(opGroups)) {
                    const opData = opGroups[op];
            
                    // Display op header
                    tableHtml += `
                        <tr>
                            <td colspan="10" class="table-secondary"><strong>Op ${op}</strong></td>
                        </tr>
                    `;
            
                    // Display machines under this op
                    opData.machines.forEach(machineData => {
                        tableHtml += `
                            <tr>
                                <td></td>
                                <td>${machineData.machine}</td>
                                <td>${machineData.produced}</td>
                                <td>${machineData.target.toFixed(0)}</td>
                                <td>${machineData.adjustedTarget.toFixed(0)}</td>
                                <td>${machineData.downtime}</td>
                                <td>${machineData.potentialMinutes.toFixed(0)}</td>
                                <td class="percentage-down" 
                                    data-percentage="${machineData.percentageDown}" 
                                    data-startdateiso="${startDateISO}" 
                                    data-endofweek="${endDateISO}" 
                                    data-machine="${machineData.machine}" 
                                    data-bs-toggle="tooltip" 
                                    title="Click to view details">
                                    ${machineData.percentageDown}%
                                </td>
                                <td>${(machineData.P * 100).toFixed(2)}%</td>
                                <td>${(machineData.A * 100).toFixed(2)}%</td>
                            </tr>
                        `;
                    });
            
                    // Calculate and display subtotal for this op
                    const subtotalP = opData.subtotal.adjustedTarget > 0
                        ? opData.subtotal.produced / opData.subtotal.adjustedTarget
                        : (opData.subtotal.produced === 0 ? 1 : 0);
            
                    const subtotalA = opData.subtotal.potentialMinutes > 0
                        ? ((opData.subtotal.potentialMinutes - opData.subtotal.downtime) / opData.subtotal.potentialMinutes)
                        : 0;
            
                    const percentageDown = opData.subtotal.potentialMinutes > 0
                        ? Math.round((opData.subtotal.downtime / opData.subtotal.potentialMinutes) * 100)
                        : 0;
            
                    subtotalPercentages.push(percentageDown);
                    subtotalPs.push(subtotalP);
                    subtotalAs.push(subtotalA);
            
                    tableHtml += `
                        <tr class="table-warning">
                            <td colspan="2"><strong>Subtotal for Op ${op}</strong></td>
                            <td><strong>${opData.subtotal.produced}</strong></td>
                            <td><strong>${opData.subtotal.target.toFixed(0)}</strong></td>
                            <td><strong>${opData.subtotal.adjustedTarget.toFixed(0)}</strong></td>
                            <td><strong>${opData.subtotal.downtime}</strong></td>
                            <td><strong>${opData.subtotal.potentialMinutes.toFixed(0)}</strong></td>
                            <td class="percentage-down" 
                                data-percentage="${percentageDown}" 
                                data-startdateiso="${startDateISO}" 
                                data-endofweek="${endOfWeek}" 
                                data-machine="Subtotal" 
                                data-bs-toggle="tooltip" 
                                title="Click to view details">
                                <strong>${percentageDown}%</strong>
                            </td>
                            <td class="subtotal-p" data-p="${subtotalP}"><strong>${(subtotalP * 100).toFixed(2)}%</strong></td>
                            <td class="subtotal-a" data-a="${subtotalA}"><strong>${(subtotalA * 100).toFixed(2)}%</strong></td>
                        </tr>
                    `;
                }
            
                // Calculate and display total row
                const totalPercentageDown = totals.totalPotentialMinutes > 0
                    ? Math.round((totals.totalDowntime / totals.totalPotentialMinutes) * 100)
                    : 0;
            
                tableHtml += `
                </tbody>
                <tfoot>
                    <tr class="table-info">
                        <th colspan="2">Total</th>
                        <th>${totals.totalProduced}</th>
                        <th>${totals.totalTarget.toFixed(0)}</th>
                        <th>${totals.totalAdjustedTarget.toFixed(0)}</th>
                        <th>${totals.totalDowntime}</th>
                        <th>${totals.totalPotentialMinutes.toFixed(0)}</th>
                        <th class="percentage-down" 
                            data-percentage="${totalPercentageDown}" 
                            data-startdateiso="${startDateISO}" 
                            data-endofweek="${endOfWeek}" 
                            data-machine="Total" 
                            data-bs-toggle="tooltip" 
                            title="Click to view details">
                            ${totalPercentageDown}%
                        </th>
                        <th>${(overallP * 100).toFixed(2)}%</th>
                        <th>${(overallA * 100).toFixed(2)}%</th>
                    </tr>
                </tfoot>
                </table>`;
            
                return tableHtml;
            }
              


            // Function to update the DOM with the results
            function updateDOM(tableHtml, overallP, overallA, totalProduced) {
                $('#results-section').removeClass('d-none');
                $('#results-container').html(tableHtml);
            
                // Show the overall OA calculation
                calculateOverallOA(overallP, overallA, totalProduced);

                // Call the highlightTable function to apply colorization
                highlightTable();
            }
            
            
            function calculateOverallOA(overallP, overallA, totalProduced) {
                const scrapAmount = window.scrapAmount || 0;
            
                // Dynamically fetch the last operation's subtotal produced value
                const lastOpSubtotalProduced = (() => {
                    const resultsTable = $('#results-container table tbody');
                    const lastOpRow = resultsTable.find('tr.table-warning:last'); // Find the last subtotal row
                    const producedCell = lastOpRow.find('td:nth-child(2)'); // Second cell contains the subtotal produced
                    return parseInt(producedCell.text().trim()) || 0; // Extract and parse the value
                })();
            
                // Calculate Q as a decimal percentage
                const Q = lastOpSubtotalProduced > 0 
                    ? ((lastOpSubtotalProduced / (lastOpSubtotalProduced + scrapAmount)) * 100).toFixed(2)
                    : "0.00";
            
                // Calculate OA and scale it by 100
                const OA = (overallP * overallA * (Q / 100) * 100).toFixed(2);
            
                // Convert P and A to percentages with two decimals for display
                const overallPPercent = (overallP * 100).toFixed(2);
                const overallAPercent = (overallA * 100).toFixed(2);
            
                // Update the OA results section with the calculations
                $('#oa-results-section').removeClass('d-none');
                $('#oa-results').html(`
                <p><strong>Operational Availability:</strong> ${OA}% (P =${overallPPercent}%, A=${overallAPercent}%, Q=${Q}%)</p>
            `);
            
            }
            
            
            
            
            
        });
    </script>

</body>
</html>