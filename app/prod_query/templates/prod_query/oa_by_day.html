{% extends "parent.html" %}
{% load static %}

{% block content %}
<div class="container my-4">
  <!-- Header -->
  <div class="row mb-4">
    <div class="col-12 text-center">
      <h1 class="display-5">
        <span id="selected-date-display">7am {{ previous_day }} to 7am {{ end_date }}</span>
      </h1>
    </div>
  </div>

  <div class="card shadow-sm mb-4">
    <div class="card-body">
      <div class="row">
        <!-- Calendar Column -->
        <div class="col-md-6 mb-3 mb-md-0">
          <div id="calendar"></div>
          <!-- Add the Exclude Weekends checkbox -->
          <div class="form-check mt-3">
            <input class="form-check-input" type="checkbox" value="" id="exclude-weekends">
            <label class="form-check-label" for="exclude-weekends">
              Exclude weekends
            </label>
          </div>
          <button id="submit-dates" class="btn btn-dark mt-3">Submit Dates</button>
        </div>
        
        <!-- OEE Metrics Column -->
        <div class="col-md-6 d-flex flex-column justify-content-center">
          <div class="card text-center">
            <div class="card-body">
              <!-- Main OEE Display -->
              <h2 id="overall-OEE" class="display-3 mb-1">Loading...</h2>
              <p class="lead mb-4">Overall OEE</p>
              <!-- Sub-metrics Row -->
              <div class="row">
                <div class="col">
                  <h5 id="overall-A" class="mb-0">Loading...</h5>
                  <small>Availability (A)</small>
                </div>
                <div class="col">
                  <h5 id="overall-P" class="mb-0">Loading...</h5>
                  <small>Performance (P)</small>
                </div>
                <div class="col">
                  <h5 id="overall-Q" class="mb-0">Loading...</h5>
                  <small>Quality (Q)</small>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- OEE Notes Accordion -->
<div class="accordion mb-4" id="oeeNotesAccordion">
  <div class="accordion-item">
    <h2 class="accordion-header" id="headingOeeNotes">
      <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse"
              data-bs-target="#collapseOeeNotes" aria-expanded="false"
              aria-controls="collapseOeeNotes">
        OEE Calculation Notes
      </button>
    </h2>
    <div id="collapseOeeNotes" class="accordion-collapse collapse"
         aria-labelledby="headingOeeNotes" data-bs-parent="#oeeNotesAccordion">
      <div class="accordion-body">
        <h5>Formula Used for OEE Calculation</h5>
        <p>We use the following formulas based on standard OEE methodology, adapted to our available data:</p>
        <ul>
          <li><strong>Planned Production Time (PPT)</strong> = Total Potential Minutes − Planned Downtime</li>
          <li><strong>Run Time</strong> = PPT − Unplanned Downtime</li>
          <li><strong>Ideal Cycle Time</strong> = PPT / Target Parts</li>
          <li><strong>Availability (A)</strong> = Run Time / PPT</li>
          <li><strong>Performance (P)</strong> = (Ideal Cycle Time × Produced Parts) / Run Time</li>
          <li><strong>Quality (Q)</strong> = (Produced Parts − Scrap) / Produced Parts</li>
          <li><strong>OEE</strong> = A × P × Q</li>
        </ul>
        <p>Source: <a href="https://www.oee.com/calculating-oee/" target="_blank">OEE.com</a></p>

        <h5>Important Notes</h5>
        <ul>
          <li><strong>Planned vs. Unplanned Downtime:</strong> This page distinguishes between planned and unplanned downtime, which improves the accuracy of the underlying Availability and Performance metrics. <strong>Planned downtime is considered</strong> any downtime event over 4 hours that does not overlap with a <code>PR_downtime entry</code></li>
          <li><strong>Ideal Cycle Time</strong> is dynamically calculated using the target part count and available production time</li>
          <li><strong>Downtime</strong> are gaps over 5 minutes between produced parts allowing us to capture both micro and macro stoppages.</li>
          <li><strong>Targets</strong> are adjusted to match the selected time range and are based on a 5-day (7200-minute) baseline week from the database table (<code>prod_query_oamachinetargets</code>).</li>
        </ul>
      </div>
    </div>
  </div>
</div>


  <!-- OEE Metrics by Line -->
  <div id="oee-by-line" class="mb-4"></div>

  <div class="accordion mb-4" id="summarizedDataAccordion">
    <div class="accordion-item">
      <h2 class="accordion-header" id="headingSummarizedData">
        <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseSummarizedData" aria-expanded="false" aria-controls="collapseSummarizedData">
          Summarized Data
        </button>
      </h2>
      <div id="collapseSummarizedData" class="accordion-collapse collapse" aria-labelledby="headingSummarizedData" data-bs-parent="#summarizedDataAccordion">
        <div class="accordion-body">
          <!-- Summary Totals -->
          <div class="card shadow-sm mb-4">
            <div class="card-header bg-light">
              <h2 class="h5 mb-0">Overall Totals</h2>
            </div>
            <div class="card-body">
              <p class="mb-2"><strong>Overall Produced Parts:</strong> <span id="overall-produced">Loading...</span></p>
              <p class="mb-0"><strong>Overall Target:</strong> <span id="overall-target">Loading...</span></p>
            </div>
          </div>
  
          <!-- Overall Downtime Totals -->
          <div class="card shadow-sm mb-4">
            <div class="card-header bg-light">
              <h2 class="h5 mb-0">Overall Downtime</h2>
            </div>
            <div class="card-body">
              <p class="mb-0"><strong>Overall Downtime:</strong> <span id="overall-downtime">Loading...</span></p>
              <p class="mb-0"><strong>Overall Planned Downtime:</strong> <span id="overall-planned-downtime">Loading...</span></p>
              <p class="mb-0"><strong>Overall Unplanned Downtime:</strong> <span id="overall-unplanned-downtime">Loading...</span></p>
            </div>
          </div>
  
          <!-- Overall Potential Minutes Totals -->
          <div class="card shadow-sm mb-4">
            <div class="card-header bg-light">
              <h2 class="h5 mb-0">Overall Potential Minutes</h2>
            </div>
            <div class="card-body">
              <p class="mb-0"><strong>Overall Potential Minutes:</strong> <span id="overall-potential-minutes">Loading...</span></p>
            </div>
          </div>
  
          <!-- Totals by Line for Production -->
          <div id="totals-by-line" class="mb-4"></div>
  
          <!-- Downtime Totals by Line -->
          <div id="downtime-totals-by-line" class="mb-4"></div>
  
          <!-- Planned Downtime Totals by Line -->
          <div id="planned-downtime-by-line" class="mb-4"></div>
  
          <!-- Unplanned Downtime Totals by Line -->
          <div id="unplanned-downtime-by-line" class="mb-4"></div>
  
          <!-- Potential Minutes by Line -->
          <div id="potential-minutes-by-line" class="mb-4"></div>
  
          <!-- Scrap Totals by Line -->
          <div id="scrap-totals-by-line" class="mb-4"></div>
  
          <!-- Overall Scrap Total -->
          <div id="overall-scrap-total" class="mb-4"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- Production Data Cards -->
  <div class="accordion" id="productionData">
    {% for line in lines %}
    <div class="accordion-item">
      <h2 class="accordion-header" id="heading{{ forloop.counter }}">
        <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapse{{ forloop.counter }}" aria-expanded="false" aria-controls="collapse{{ forloop.counter }}">
          {{ line.line }}
        </button>
      </h2>
      <div id="collapse{{ forloop.counter }}" class="accordion-collapse collapse" aria-labelledby="heading{{ forloop.counter }}" data-bs-parent="#productionData">
        <div class="accordion-body">
          {% for operation in line.operations %}
          <h3 class="h6 mt-3">Operation: {{ operation.op }}</h3>
          <div class="row">
            {% for machine in operation.machines %}
            <div class="col-md-4 mb-3">
              <!-- Machine Card Content -->
              <div class="card h-100">
                <div class="card-body">
                  <p class="mb-2"><strong>Machine Number:</strong> {{ machine.number }}</p>
                  <p class="mb-2">
                    <strong>Target:</strong>
                    <span class="target" data-line="{{ line.line }}" data-machine="{{ machine.number }}">
                      {{ machine.target }}
                    </span>
                  </p>
                  {% if machine.part_numbers %}
                  <p class="mb-2"><strong>Part Numbers:</strong> {{ machine.part_numbers|join:", " }}</p>
                  {% endif %}
                  <p class="mb-2">
                    <strong>Parts:</strong>
                    <span class="produced" data-line="{{ line.line }}" data-machine="{{ machine.number }}">
                      Loading...
                    </span>
                  </p>
                  <p class="mb-2">
                    <strong>Downtime:</strong>
                    <span class="downtime" data-line="{{ line.line }}" data-machine="{{ machine.number }}">
                      Loading...
                    </span>
                  </p>
                  <p class="mb-2">
                    <strong>Planned Downtime:</strong>
                    <span class="planned-downtime" data-line="{{ line.line }}" data-machine="{{ machine.number }}">
                      Loading...
                    </span>
                  </p>
                  <p class="mb-2">
                    <strong>Unplanned Downtime:</strong>
                    <span class="unplanned-downtime" data-line="{{ line.line }}" data-machine="{{ machine.number }}">
                      Loading...
                    </span>
                  </p>
                  <p class="mb-2"><strong>Availability:</strong>
                    <span class="availability" data-line="{{ line.line }}" data-machine="{{ machine.number }}">Loading...</span>
                  </p>
                  <p class="mb-2"><strong>Performance:</strong>
                    <span class="performance" data-line="{{ line.line }}" data-machine="{{ machine.number }}">Loading...</span>
                  </p>                  
                  <!-- Detailed Downtime Button -->
                  <button type="button" class="btn btn-warning detailed-downtime-btn" data-line="{{ line.line }}" data-machine="{{ machine.number }}" data-bs-toggle="modal" data-bs-target="#downtimeModal">
                    Detailed Downtime
                  </button>
                </div>
              </div>
            </div>
            {% endfor %}
          </div>
          {% endfor %}
        </div>
      </div>
    </div>
    {% endfor %}
  </div>
</div>

<!-- Downtime Modal -->
<div class="modal fade" id="downtimeModal" tabindex="-1" aria-labelledby="downtimeModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="downtimeModalLabel">Detailed Downtime</h5>
        <button type="button" class="btn btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <!-- PR Downtime Entries -->
        <h6>PR Downtime Entries:</h6>
        <div class="table-responsive">
          <table class="table table-sm pr-downtime-modal-table">
            <thead>
              <tr>
                <th>Id</th>
                <th>Problem</th>
                <th>Called</th>
                <th>Completed</th>
                <th>Minutes Down</th>
              </tr>
            </thead>
            <tbody id="modal-pr-downtime-body">
              <tr>
                <td colspan="5">Loading...</td>
              </tr>
            </tbody>
          </table>
        </div>
        <!-- Downtime Events -->
        <h6 class="mt-3">Downtime Events:</h6>
        <div class="table-responsive">
          <table class="table table-sm downtime-modal-events-table">
            <thead>
              <tr>
                <th>Start</th>
                <th>End</th>
                <th>Minutes Down</th>
                <th>Overlap</th>
                <th>PR Id</th>
              </tr>
            </thead>
            <tbody id="modal-downtime-events-body">
              <tr>
                <td colspan="5">Loading...</td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
      </div>
    </div>
  </div>

  <style>
    @keyframes pulse {
      0% {
        opacity: 1;
      }
      50% {
        opacity: 0.5;
      }
      100% {
        opacity: 1;
      }
    }
    
    .loading {
      animation: pulse 2.5s infinite ease-in-out;
    }    
  </style>
</div>

<script>


    // Function to set loading state for key elements.
    function showLoadingState() {
      // Overall metrics
      const overallIds = [
        'overall-produced', 'overall-target', 'overall-downtime', 
        'overall-planned-downtime', 'overall-unplanned-downtime', 
        'overall-potential-minutes', 'overall-A', 'overall-P', 'overall-Q', 'overall-OEE'
      ];
      overallIds.forEach(function(id) {
        const elem = document.getElementById(id);
        if (elem) {
          elem.innerText = 'Loading...';
          elem.classList.add('loading');
        }
      });
    
      // Reset all machine-related metrics.
      document.querySelectorAll('.produced, .target, .downtime, .planned-downtime, .unplanned-downtime, .availability, .performance')
        .forEach(function(elem) {
          elem.innerText = 'Loading...';
          elem.classList.add('loading');
        });
    
      // Optionally, reset the innerHTML of container divs (e.g., totals, charts) if needed.
      const divIds = [
        'totals-by-line',
        'downtime-totals-by-line',
        'planned-downtime-by-line',
        'unplanned-downtime-by-line',
        'potential-minutes-by-line',
        'scrap-totals-by-line',
        'overall-scrap-total',
        'oee-by-line'
      ];
      divIds.forEach(function(id) {
        const div = document.getElementById(id);
        if (div) {
          div.innerHTML = 'Loading...';
          div.classList.add('loading');
        }
      });
    }
    
    
document.addEventListener("DOMContentLoaded", function() {
  // Initialize flatpickr and store the instance.
  const calendarInstance = flatpickr("#calendar", {
    mode: "range",
    inline: true,
    enableTime: true,         // Enable time picker
    time_24hr: true,          // Use 24-hour time format
    dateFormat: "Y-m-d H:i",  // Include time in the format
    // Default to 11pm for both start and end dates.
    defaultDate: ["{{ start_date }} 7:00", "{{ end_date }} 7:00"],
  });

  // Listen for button clicks.
  document.getElementById("submit-dates").addEventListener("click", function() {
    const selectedDates = calendarInstance.selectedDates;
    if (selectedDates.length === 2) {
      const startDate = calendarInstance.formatDate(selectedDates[0], "Y-m-d H:i");
      const endDate = calendarInstance.formatDate(selectedDates[1], "Y-m-d H:i");
      const startDateObj = new Date(selectedDates[0]);
      const previousDay = calendarInstance.formatDate(startDateObj, "Y-m-d H:i");
      document.getElementById("selected-date-display").innerText = previousDay + " to " + endDate;
  
      // Set the loading state before fetching new data.
      showLoadingState();
  
      // If "Exclude weekends" is checked, redirect to the new view.
      if (document.getElementById("exclude-weekends").checked) {
        const newUrl = "{% url 'prod_query:fetch_exclude_weekends_data' %}?start_date=" 
                       + encodeURIComponent(startDate) + "&end_date=" + encodeURIComponent(endDate);
        fetch(newUrl)
          .then(response => response.json())
          .then(data => {
            updateProductionData(data);  // reuse your existing DOM-update code
          })
          .catch(error => console.error('Error fetching production data:', error));
        return;
      }
      
  
      // Otherwise, fetch the new production data as before.
      fetchProductionData(startDate, endDate);
    } else {
      alert("Please select both a start and an end date.");
    }
  });
  
  // Global variable to store production data.
  window.productionData = {};
  
  // Initial fetch using the default dates passed in from the backend.
  fetchProductionData("{{ start_date }}", "{{ end_date }}");
  
  function fetchProductionData(startDate, endDate) {
    var url = "{% url 'prod_query:fetch_oa_by_day_production_data' %}?start_date=" 
              + encodeURIComponent(startDate) + "&end_date=" + encodeURIComponent(endDate);
    fetch(url)
      .then(response => response.json())
      .then(data => {
        // Store production data globally for modal lookup.
        window.productionData = data.production_data;

        // Update production data for each machine.
        document.querySelectorAll('.produced').forEach(function(elem) {
          var lineName = elem.getAttribute('data-line');
          var machineNumber = elem.getAttribute('data-machine');
          if (data.production_data[lineName] && data.production_data[lineName][machineNumber]) {
            elem.innerText = data.production_data[lineName][machineNumber].produced_parts;
          } else {
            elem.innerText = '0';
          }

          // Remove the loading effect once data is loaded
          elem.classList.remove('loading');
        });

        // Update target values.
        document.querySelectorAll('.target').forEach(function(elem) {
          var lineName = elem.getAttribute('data-line');
          var machineNumber = elem.getAttribute('data-machine');
          if (data.production_data[lineName] && data.production_data[lineName][machineNumber]) {
            elem.innerText = data.production_data[lineName][machineNumber].target;
          }
          // Remove the loading effect after updating content
          elem.classList.remove('loading');
        });

        // Update downtime values.
        document.querySelectorAll('.downtime').forEach(function(elem) {
          var lineName = elem.getAttribute('data-line');
          var machineNumber = elem.getAttribute('data-machine');
          if (data.production_data[lineName] && data.production_data[lineName][machineNumber] &&
              data.production_data[lineName][machineNumber].downtime_minutes !== undefined) {
            elem.innerText = parseFloat(data.production_data[lineName][machineNumber].downtime_minutes) + " min";
          } else {
            elem.innerText = '0 min';
          }
        });

        // Update planned downtime values.
        document.querySelectorAll('.planned-downtime').forEach(function(elem) {
          var lineName = elem.getAttribute('data-line');
          var machineNumber = elem.getAttribute('data-machine');
          if (window.productionData[lineName] && window.productionData[lineName][machineNumber] &&
              window.productionData[lineName][machineNumber].planned_downtime_minutes !== undefined) {
            elem.innerText = window.productionData[lineName][machineNumber].planned_downtime_minutes + " min";
          } else {
            elem.innerText = '0 min';
          }
        });
        
        // Update unplanned downtime values.
        document.querySelectorAll('.unplanned-downtime').forEach(function(elem) {
          var lineName = elem.getAttribute('data-line');
          var machineNumber = elem.getAttribute('data-machine');
          if (window.productionData[lineName] && window.productionData[lineName][machineNumber] &&
              window.productionData[lineName][machineNumber].unplanned_downtime_minutes !== undefined) {
            elem.innerText = window.productionData[lineName][machineNumber].unplanned_downtime_minutes + " min";
          } else {
            elem.innerText = '0 min';
          }
        });

        // Update overall totals.
        if (data.overall_totals) {
          document.getElementById('overall-produced').innerText = data.overall_totals.total_produced;
          document.getElementById('overall-target').innerText = data.overall_totals.total_target;
        }
        if (data.overall_downtime) {
          var overallDowntimeMinutes = parseFloat(data.overall_downtime.downtime_minutes);
          document.getElementById('overall-downtime').innerText = overallDowntimeMinutes + " min";
          var overallPlanned = parseFloat(data.overall_downtime.planned_downtime_minutes);
          document.getElementById('overall-planned-downtime').innerText = overallPlanned + " min";
          var overallUnplanned = parseFloat(data.overall_downtime.unplanned_downtime_minutes);
          document.getElementById('overall-unplanned-downtime').innerText = overallUnplanned + " min";
        }
        if (data.overall_potential_minutes !== undefined) {
          document.getElementById('overall-potential-minutes').innerText = data.overall_potential_minutes;
        }
        // Totals by line.
        if (data.totals_by_line) {
          var totalsByLineDiv = document.getElementById('totals-by-line');
          totalsByLineDiv.innerHTML = '<div class="card shadow-sm mb-4"><div class="card-header bg-light"><h2 class="h5 mb-0">Totals by Line</h2></div><div class="card-body" id="line-totals-content"></div></div>';
          var contentDiv = document.getElementById('line-totals-content');
          for (var line in data.totals_by_line) {
            var lineTotal = data.totals_by_line[line];
            var p = document.createElement('p');
            p.innerHTML = '<strong>Line ' + line + ':</strong> Parts: ' + lineTotal.total_produced + ', Target: ' + lineTotal.total_target;
            contentDiv.appendChild(p);
          }
        }
        // Downtime totals by line.
        if (data.downtime_totals_by_line) {
          var downtimeByLineDiv = document.getElementById('downtime-totals-by-line');
          downtimeByLineDiv.innerHTML = '<div class="card shadow-sm mb-4"><div class="card-header bg-light"><h2 class="h5 mb-0">Downtime Totals by Line</h2></div><div class="card-body" id="downtime-line-totals-content"></div></div>';
          var dtContentDiv = document.getElementById('downtime-line-totals-content');
          for (var line in data.downtime_totals_by_line) {
            var dtTotalSeconds = data.downtime_totals_by_line[line];
            var dtTotalMinutes = Math.floor(dtTotalSeconds / 60);
            var p = document.createElement('p');
            p.innerHTML = '<strong>Line ' + line + ':</strong> Downtime: ' + dtTotalMinutes + ' min';
            dtContentDiv.appendChild(p);
          }
        }
        // Planned downtime totals by line.
        if (data.planned_downtime_totals_by_line) {
          var plannedByLineDiv = document.getElementById('planned-downtime-by-line');
          plannedByLineDiv.innerHTML = '<div class="card shadow-sm mb-4"><div class="card-header bg-light"><h2 class="h5 mb-0">Planned Downtime by Line</h2></div><div class="card-body" id="planned-line-totals-content"></div></div>';
          var plannedContentDiv = document.getElementById('planned-line-totals-content');
          for (var line in data.planned_downtime_totals_by_line) {
            var plannedMinutes = data.planned_downtime_totals_by_line[line];
            var p = document.createElement('p');
            p.innerHTML = '<strong>Line ' + line + ':</strong> Planned Downtime: ' + plannedMinutes + ' min';
            plannedContentDiv.appendChild(p);
          }
        }
        // Unplanned downtime totals by line.
        if (data.unplanned_downtime_totals_by_line) {
          var unplannedByLineDiv = document.getElementById('unplanned-downtime-by-line');
          unplannedByLineDiv.innerHTML = '<div class="card shadow-sm mb-4"><div class="card-header bg-light"><h2 class="h5 mb-0">Unplanned Downtime by Line</h2></div><div class="card-body" id="unplanned-line-totals-content"></div></div>';
          var unplannedContentDiv = document.getElementById('unplanned-line-totals-content');
          for (var line in data.unplanned_downtime_totals_by_line) {
            var unplannedMinutes = data.unplanned_downtime_totals_by_line[line];
            var p = document.createElement('p');
            p.innerHTML = '<strong>Line ' + line + ':</strong> Unplanned Downtime: ' + unplannedMinutes + ' min';
            unplannedContentDiv.appendChild(p);
          }
        }
        // Potential minutes by line.
        if (data.potential_minutes_by_line) {
          var potentialMinutesDiv = document.getElementById('potential-minutes-by-line');
          potentialMinutesDiv.innerHTML = '<div class="card shadow-sm mb-4"><div class="card-header bg-light"><h2 class="h5 mb-0">Potential Minutes by Line</h2></div><div class="card-body" id="line-potential-minutes-content"></div></div>';
          var potentialContentDiv = document.getElementById('line-potential-minutes-content');
          for (var line in data.potential_minutes_by_line) {
            var linePotential = data.potential_minutes_by_line[line];
            var p = document.createElement('p');
            p.innerHTML = '<strong>Line ' + line + ':</strong> Potential Minutes: ' + linePotential;
            potentialContentDiv.appendChild(p);
          }
        }

        // Update Availability values.
        document.querySelectorAll('.availability').forEach(function(elem) {
          var lineName = elem.getAttribute('data-line');
          var machineNumber = elem.getAttribute('data-machine');
          if (window.productionData[lineName] && window.productionData[lineName][machineNumber] &&
              window.productionData[lineName][machineNumber].A !== undefined) {
            // Multiply by 100 to convert to a percentage.
            elem.innerText = (window.productionData[lineName][machineNumber].A * 100).toFixed(2) + "%";
          } else {
            elem.innerText = "N/A";
          }
        });

        // Update Performance values.
        document.querySelectorAll('.performance').forEach(function(elem) {
          var lineName = elem.getAttribute('data-line');
          var machineNumber = elem.getAttribute('data-machine');
          if (window.productionData[lineName] && window.productionData[lineName][machineNumber] &&
              window.productionData[lineName][machineNumber].P !== undefined) {
            elem.innerText = (window.productionData[lineName][machineNumber].P * 100).toFixed(2) + "%";
          } else {
            elem.innerText = "N/A";
          }
        });

        // Scrap totals by line.
        if (data.scrap_totals_by_line) {
          var scrapByLineDiv = document.getElementById('scrap-totals-by-line');
          scrapByLineDiv.innerHTML = '<div class="card shadow-sm mb-4"><div class="card-header bg-light"><h2 class="h5 mb-0">Scrap Totals by Line</h2></div><div class="card-body" id="scrap-line-totals-content"></div></div>';
          var scrapContentDiv = document.getElementById('scrap-line-totals-content');
          for (var line in data.scrap_totals_by_line) {
            var scrapTotal = data.scrap_totals_by_line[line];
            var p = document.createElement('p');
            p.innerHTML = '<strong>Line ' + line + ':</strong> Scrap: ' + scrapTotal;
            scrapContentDiv.appendChild(p);
          }
        }
        // Overall scrap total.
        if (data.overall_scrap_total !== undefined) {
          var overallScrapDiv = document.getElementById('overall-scrap-total');
          overallScrapDiv.innerHTML = '<div class="card shadow-sm mb-4"><div class="card-header bg-light"><h2 class="h5 mb-0">Overall Scrap Total</h2></div><div class="card-body"><p><strong>Total Scrap:</strong> <span id="scrap-total">Loading...</span></p></div></div>';
          document.getElementById('scrap-total').innerText = data.overall_scrap_total;
        }
        // OEE Metrics overall and by line.
        if (data.oee_metrics && data.oee_metrics.overall) {
          document.getElementById('overall-A').innerText = (data.oee_metrics.overall.A * 100).toFixed(2) + "%";
          document.getElementById('overall-P').innerText = (data.oee_metrics.overall.P * 100).toFixed(2) + "%";
          document.getElementById('overall-Q').innerText = (data.oee_metrics.overall.Q * 100).toFixed(2) + "%";
          document.getElementById('overall-OEE').innerText = (data.oee_metrics.overall.OEE * 100).toFixed(2) + "%";
        }
        
        if (data.oee_metrics && data.oee_metrics.lines) {
          var oeeByLineDiv = document.getElementById('oee-by-line');
          oeeByLineDiv.innerHTML = 
            '<div class="card shadow-sm mb-4">' +
              '<div class="card-header bg-light">' +
                '<h2 class="h5 mb-0">OEE Metrics by Line</h2>' +
              '</div>' +
              '<div class="card-body" id="oee-line-content"></div>' +
            '</div>';
          
          var oeeLineContentDiv = document.getElementById('oee-line-content');
          var lines = Object.keys(data.oee_metrics.lines);
          
          // Sort lines by highest OEE value
          lines.sort(function(a, b) {
            return data.oee_metrics.lines[b].OEE - data.oee_metrics.lines[a].OEE;
          });
          
          // Create a table to display the metrics nicely.
          var table = document.createElement('table');
          table.className = 'table table-striped';
          
          // Create table header.
          var thead = document.createElement('thead');
          thead.innerHTML = 
            '<tr>' +
              '<th>Line</th>' +
              '<th>Availability (A)</th>' +
              '<th>Performance (P)</th>' +
              '<th>Quality (Q)</th>' +
              '<th>OEE</th>' +
            '</tr>';
          table.appendChild(thead);
          
          // Create table body.
          var tbody = document.createElement('tbody');
          lines.forEach(function(line) {
            var metrics = data.oee_metrics.lines[line];
            var row = document.createElement('tr');
            row.innerHTML = 
              '<td>' + line + '</td>' +
              '<td>' + metrics.A.toFixed(2) + '</td>' +
              '<td>' + metrics.P.toFixed(2) + '</td>' +
              '<td>' + metrics.Q.toFixed(4) + '</td>' +
              '<td>' + metrics.OEE.toFixed(2) + '</td>';
            tbody.appendChild(row);
          });
          table.appendChild(tbody);
          
          oeeLineContentDiv.appendChild(table);
        }

        // At the end of the fetch callback, remove any remaining loading classes.
        document.querySelectorAll('.loading').forEach(function(elem) {
          elem.classList.remove('loading');
        });

      })
      .catch(error => console.error('Error fetching production data:', error));
  }

  // Set up Detailed Downtime button event listeners.
  document.querySelectorAll('.detailed-downtime-btn').forEach(function(btn) {
    btn.addEventListener('click', function() {
      var line = btn.getAttribute('data-line');
      var machine = btn.getAttribute('data-machine');
      var machineData = window.productionData && window.productionData[line] ? window.productionData[line][machine] : null;
      var prTbody = document.getElementById('modal-pr-downtime-body');
      var eventsTbody = document.getElementById('modal-downtime-events-body');
      prTbody.innerHTML = "";
      eventsTbody.innerHTML = "";
      if(machineData) {
        var prEntries = machineData.pr_downtime_entries;
        if(prEntries && prEntries.length > 0) {
          prEntries.forEach(function(entry) {
            var id = entry.idnumber || "N/A";
            var problem = entry.problem || "N/A";
            var called = entry.start_time ? new Date(entry.start_time).toISOString() : "N/A";
            var completed = entry.end_time ? new Date(entry.end_time).toISOString() : "N/A";
            var minutesDown = entry.minutes_down !== undefined ? entry.minutes_down : "N/A";
            var tr = document.createElement('tr');
            tr.innerHTML = "<td>" + id + "</td><td>" + problem + "</td><td>" + called + "</td><td>" + completed + "</td><td>" + minutesDown + "</td>";
            prTbody.appendChild(tr);
          });                 
        } else {
          prTbody.innerHTML = "<tr><td colspan='5'>No PR downtime entries found.</td></tr>";
        }
        if(machineData.downtime_events && machineData.downtime_events.length > 0) {
          machineData.downtime_events.forEach(function(event) {
            var tr = document.createElement('tr');
            tr.innerHTML = "<td>" + event.start + "</td>" +
                           "<td>" + event.end + "</td>" +
                           "<td>" + event.minutes_down + " min</td>" +
                           "<td>" + (event.overlap || "No Overlap") + "</td>" +
                           "<td>" + (event.pr_id ? event.pr_id : "") + "</td>";
            eventsTbody.appendChild(tr);
          });
        } else {
          eventsTbody.innerHTML = "<tr><td colspan='5'>No downtime events found.</td></tr>";
        }
      } else {
        prTbody.innerHTML = "<tr><td colspan='5'>No data found.</td></tr>";
        eventsTbody.innerHTML = "<tr><td colspan='5'>No data found.</td></tr>";
      }
    });
  });
});
</script>
{% endblock %}
