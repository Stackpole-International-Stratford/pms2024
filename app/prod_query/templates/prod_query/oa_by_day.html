{% extends "parent.html" %}
{% load static %}

{% block content %}
<div class="container mt-4">
    <!-- Header and Date Picker -->
    <div class="row mb-4">
        <div class="col-md-8">
            <h1>Production Data for <span id="selected-date-display">{{ selected_date }}</span></h1>
        </div>
        <div class="col-md-4">
            <form id="dateForm" class="form-inline">
                <div class="mb-3">
                    <label for="datePicker" class="form-label me-2">Select Date:</label>
                    <input type="date" id="datePicker" class="form-control" value="{{ selected_date }}">
                </div>
            </form>
        </div>
    </div>

    <!-- Production Data Cards -->
    <div id="productionData">
        {% for line in lines %}
        <div class="card mb-4">
            <div class="card-header">
                <h2 class="h5 mb-0">Line: {{ line.line }}</h2>
            </div>
            <div class="card-body">
                {% for operation in line.operations %}
                <h3 class="h6">Operation: {{ operation.op }}</h3>
                <div class="row">
                    {% for machine in operation.machines %}
                    <div class="col-md-4 mb-3">
                        <div class="card h-100">
                            <div class="card-body">
                                <p><strong>Machine Number:</strong> {{ machine.number }}</p>
                                <p><strong>Target:</strong> {{ machine.target }}</p>
                                {% if machine.part_numbers %}
                                    <p><strong>Part Numbers:</strong> {{ machine.part_numbers|join:", " }}</p>
                                {% endif %}
                                <p>
                                    <strong>Produced Parts:</strong>
                                    <span class="produced" data-line="{{ line.line }}" data-machine="{{ machine.number }}">
                                        Loading...
                                    </span>
                                </p>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
                {% endfor %}
            </div>
        </div>
        {% endfor %}
    </div>
</div>

<!-- JavaScript to fetch and update production data -->
<script>
    document.addEventListener("DOMContentLoaded", function() {
        function fetchProductionData(selectedDate) {
            fetch("{% url 'prod_query:fetch_oa_by_day_production_data' %}?date=" + selectedDate)
                .then(response => response.json())
                .then(data => {
                    document.querySelectorAll('.produced').forEach(function(elem) {
                        var lineName = elem.getAttribute('data-line');
                        var machineNumber = elem.getAttribute('data-machine');
                        if (data[lineName] && data[lineName][machineNumber]) {
                            elem.innerText = data[lineName][machineNumber].produced_parts;
                        } else {
                            elem.innerText = '0';
                        }
                    });
                })
                .catch(error => console.error('Error fetching production data:', error));
        }

        var datePicker = document.getElementById("datePicker");
        var selectedDateDisplay = document.getElementById("selected-date-display");

        // Initial fetch on page load.
        fetchProductionData(datePicker.value);

        // When the user selects a new date, update the header and refresh data.
        datePicker.addEventListener("change", function() {
            selectedDateDisplay.innerText = this.value;
            fetchProductionData(this.value);
        });
    });
</script>
{% endblock %}
