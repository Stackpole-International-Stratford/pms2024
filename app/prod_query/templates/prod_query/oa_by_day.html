{% extends "parent.html" %}
{% load static %}

{% block content %}
<div class="container my-4">
  <!-- Header -->
  <div class="row mb-4">
    <div class="col-12 text-center">
      <h1 class="display-5">
        <span id="selected-date-display">7am {{ previous_day }} to {{ end_date }}</span>
      </h1>
    </div>
  </div>

  <div class="card shadow-sm mb-4">
    <div class="card-body">
      <div class="row">
        <!-- Calendar Column -->
        <div class="col-md-6 mb-3 mb-md-0">
          <div id="calendar"></div>
          <!-- Add the Exclude Weekends checkbox -->
          <div class="form-check mt-3">
            <input class="form-check-input" type="checkbox" value="" id="exclude-weekends" checked style="display: none;">
            <label class="form-check-label" for="exclude-weekends" style="display: none;">
              Exclude weekends
            </label>            
          </div>
          <button id="submit-dates" class="btn btn-dark mt-3">Submit Dates</button>
        </div>
        
        <!-- OEE Metrics Column -->
        <div class="col-md-6 d-flex flex-column justify-content-center">
          <div class="card text-center">
            <div class="card-body">
              <!-- Main OEE Display -->
              <h2 id="overall-OEE" class="display-3 mb-1">Loading...</h2>
              <p class="lead mb-4">Overall OEE</p>
              <!-- Sub-metrics Row -->
              <div class="row">
                <div class="col">
                  <h5 id="overall-A" class="mb-0">Loading...</h5>
                  <small>Availability (A)</small>
                </div>
                <div class="col">
                  <h5 id="overall-P" class="mb-0">Loading...</h5>
                  <small>Performance (P)</small>
                </div>
                <div class="col">
                  <h5 id="overall-Q" class="mb-0">Loading...</h5>
                  <small>Quality (Q)</small>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>


  


  <!-- OEE Notes Accordion -->
<div class="accordion mb-4" id="oeeNotesAccordion">
  <div class="accordion-item">
    <h2 class="accordion-header" id="headingOeeNotes">
      <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse"
              data-bs-target="#collapseOeeNotes" aria-expanded="false"
              aria-controls="collapseOeeNotes">
        OEE Calculation Notes
      </button>
    </h2>
    <div id="collapseOeeNotes" class="accordion-collapse collapse"
         aria-labelledby="headingOeeNotes" data-bs-parent="#oeeNotesAccordion">
      <div class="accordion-body">
        <h5>Formula Used for OEE Calculation</h5>
        <p>We use the following formulas based on standard OEE methodology, adapted to our available data:</p>
        <ul>
          <li><strong>Planned Production Time (PPT)</strong> = Total Potential Minutes − Planned Downtime</li>
          <li><strong>Run Time</strong> = PPT − Unplanned Downtime</li>
          <!-- <li><strong>Uptime Ratio</strong> = Runtime / Potential Minutes</li> -->
          <li><strong>Ideal Cycle Time</strong> = PPT / Target Parts</li>
          <!-- <li><strong>Adjusted Target</strong> = Target * Uptime Ratio</li> -->
          <li><strong>Availability (A)</strong> = Run Time / PPT</li>
          <li><strong>Performance (P)</strong> = (Ideal Cycle Time x Produced Parts) / Run Time</li>
          <li><strong>Quality (Q)</strong> = (Produced Parts − Scrap) / Produced Parts</li>
          <li><strong>OEE</strong> = A × P × Q</li>
        </ul>
        <p>Source: <a href="https://www.oee.com/calculating-oee/" target="_blank">OEE.com</a></p>

        <h5>Important Notes</h5>
        <ul>
          <li><strong>Planned vs. Unplanned Downtime:</strong> This page distinguishes between planned and unplanned downtime, which improves the accuracy of the underlying Availability and Performance metrics. <strong>Planned downtime is considered</strong> any downtime event over 4 hours that does not overlap with a <code>PR_downtime entry</code></li>
          <li><strong>Downtime</strong> are gaps over 5 minutes between produced parts allowing us to capture both micro and macro stoppages.</li>
          <li><strong>Targets</strong> are adjusted to match the selected time range and are based on a 5-day (7200-minute) baseline week from the database table (<code>prod_query_oamachinetargets</code>).</li>
          <li><strong>Weekends (Friday 11pm - Sunday 11pm)</strong> are automatically excluded from the calculations.</li>
        </ul>
      </div>
    </div>
  </div>
</div>


  <!-- OEE Metrics by Line -->
  <div id="oee-by-line" class="mb-4"></div>

  <div class="accordion mb-4" id="summarizedDataAccordion">
    <div class="accordion-item">
      <h2 class="accordion-header" id="headingSummarizedData">
        <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseSummarizedData" aria-expanded="false" aria-controls="collapseSummarizedData">
          Summarized Data
        </button>
      </h2>
      <div id="collapseSummarizedData" class="accordion-collapse collapse" aria-labelledby="headingSummarizedData" data-bs-parent="#summarizedDataAccordion">
        <div class="accordion-body">
          <!-- Summary Totals -->
          <div class="card shadow-sm mb-4">
            <div class="card-header bg-light">
              <h2 class="h5 mb-0">Overall Totals</h2>
            </div>
            <div class="card-body">
              <p class="mb-2"><strong>Overall Produced Parts:</strong> <span id="overall-produced">Loading...</span></p>
              <p class="mb-0"><strong>Overall Target:</strong> <span id="overall-target">Loading...</span></p>
            </div>
          </div>
  
          <!-- Overall Downtime Totals -->
          <div class="card shadow-sm mb-4">
            <div class="card-header bg-light">
              <h2 class="h5 mb-0">Overall Downtime</h2>
            </div>
            <div class="card-body">
              <p class="mb-0"><strong>Overall Downtime:</strong> <span id="overall-downtime">Loading...</span></p>
              <p class="mb-0"><strong>Overall Planned Downtime:</strong> <span id="overall-planned-downtime">Loading...</span></p>
              <p class="mb-0"><strong>Overall Unplanned Downtime:</strong> <span id="overall-unplanned-downtime">Loading...</span></p>
            </div>
          </div>
  
          <!-- Overall Potential Minutes Totals -->
          <div class="card shadow-sm mb-4">
            <div class="card-header bg-light">
              <h2 class="h5 mb-0">Overall Potential Minutes</h2>
            </div>
            <div class="card-body">
              <p class="mb-0"><strong>Overall Potential Minutes:</strong> <span id="overall-potential-minutes">Loading...</span></p>
            </div>
          </div>
  
          <!-- Totals by Line for Production -->
          <div id="totals-by-line" class="mb-4"></div>
  
          <!-- Downtime Totals by Line -->
          <div id="downtime-totals-by-line" class="mb-4"></div>
  
          <!-- Planned Downtime Totals by Line -->
          <div id="planned-downtime-by-line" class="mb-4"></div>
  
          <!-- Unplanned Downtime Totals by Line -->
          <div id="unplanned-downtime-by-line" class="mb-4"></div>
  
          <!-- Potential Minutes by Line -->
          <div id="potential-minutes-by-line" class="mb-4"></div>
  
          <!-- Scrap Totals by Line -->
          <div id="scrap-totals-by-line" class="mb-4"></div>
  
          <!-- Overall Scrap Total -->
          <div id="overall-scrap-total" class="mb-4"></div>
        </div>
      </div>
    </div>
  </div>
  

<!-- Production Data Cards -->
<div class="accordion" id="productionData">
  {% for line in lines %}
  <div class="accordion-item">
    <h2 class="accordion-header" id="heading{{ forloop.counter }}">
      <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapse{{ forloop.counter }}" aria-expanded="false" aria-controls="collapse{{ forloop.counter }}">
        {{ line.line }}
      </button>
    </h2>
    <div id="collapse{{ forloop.counter }}" class="accordion-collapse collapse" aria-labelledby="heading{{ forloop.counter }}" data-bs-parent="#productionData">
      <div class="accordion-body">
        <!-- per-line CSV export button -->
        <button type="button"
        class="btn btn-sm btn-outline-secondary mb-3 export-csv-btn"
        data-line="{{ line.line }}">
    Export “{{ line.line }}” to CSV
        </button>
        {% for operation in line.operations %}
          <h3 class="h6 mt-3">Operation: {{ operation.op }}</h3>
          <table class="table table-striped">
            <thead>
              <tr>
                <th>Machine</th>
                <th>Parts</th>
                <th>Target</th>
                <th>Downtime</th>
                <th>Planned Downtime</th>
                <th>Unplanned Downtime</th>
                <th>Downtime %</th>
                <th>Performance</th>
                <th>Availability</th>
                <th>P × A</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody>
              {% for machine in operation.machines %}
              <tr>
                <td>
                  <strong>{{ machine.number }}</strong>
                  {% if machine.part_numbers %}
                    <br><small>{{ machine.part_numbers|join:", " }}</small>
                  {% endif %}
                </td>
                <td>
                  <span class="produced" data-line="{{ line.line }}" data-machine="{{ machine.number }}">
                    Loading...
                  </span>
                </td>
                <td>
                  <span class="target" data-line="{{ line.line }}" data-machine="{{ machine.number }}">
                    {{ machine.target }}
                  </span>
                </td>
                <td>
                  <span class="downtime" data-line="{{ line.line }}" data-machine="{{ machine.number }}">
                    Loading...
                  </span>
                </td>
                <td>
                  <span class="planned-downtime" data-line="{{ line.line }}" data-machine="{{ machine.number }}">
                    Loading...
                  </span>
                </td>
                <td>
                  <span class="unplanned-downtime" data-line="{{ line.line }}" data-machine="{{ machine.number }}">
                    Loading...
                  </span>
                </td>
                <td>
                  <span class="downtime-percentage" data-line="{{ line.line }}" data-machine="{{ machine.number }}">Loading...</span>
                </td>
                <td>
                  <span class="performance" data-line="{{ line.line }}" data-machine="{{ machine.number }}"
                        style="color: {{ machine.P_color }};">
                        {{ machine.P }}
                  </span>
                </td>
                <td>
                  <span class="availability" data-line="{{ line.line }}" data-machine="{{ machine.number }}"
                        style="color: {{ machine.A_color }};">
                        {{ machine.A }}
                  </span>
                </td>
                <td>
                  <span class="pa"
                        data-line="{{ line.line }}"
                        data-machine="{{ machine.number }}"
                        style="color: {{ machine.PA_color }};">
                    {{ machine.PA|floatformat:2 }}
                  </span>
                </td>
                <td class="text-center">
                  <div class="d-flex justify-content-center">
                    <button type="button" class="detailed-downtime-btn p-0" 
                            data-line="{{ line.line }}" 
                            data-machine="{{ machine.number }}" 
                            data-bs-toggle="modal" 
                            data-bs-target="#downtimeModal" 
                            style="border: none; background: transparent;"
                            data-bs-toggle="tooltip" 
                            data-bs-placement="top" 
                            title="View Downtime Details">
                      <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" 
                           class="bi bi-hourglass-split" viewBox="0 0 16 16" 
                           style="color: #FF9900;">
                        <path d="M2.5 15a.5.5 0 1 1 0-1h1v-1a4.5 4.5 0 0 1 2.557-4.06c.29-.139.443-.377.443-.59v-.7c0-.213-.154-.451-.443-.59A4.5 4.5 0 0 1 3.5 3V2h-1a.5.5 0 0 1 0-1h11a.5.5 0 0 1 0 1h-1v1a4.5 4.5 0 0 1-2.557 4.06c-.29.139-.443.377-.443.59v.7c0 .213.154.451.443.59A4.5 4.5 0 0 1 12.5 13v1h1a.5.5 0 0 1 0 1zm2-13v1c0 .537.12 1.045.337 1.5h6.326c.216-.455.337-.963.337-1.5V2zm3 6.35c0 .701-.478 1.236-1.011 1.492A3.5 3.5 0 0 0 4.5 13s.866-1.299 3-1.48zm1 0v3.17c2.134.181 3 1.48 3 1.48a3.5 3.5 0 0 0-1.989-3.158C8.978 9.586 8.5 9.052 8.5 8.351z"/>
                      </svg>
                    </button>
                  </div>
                </td>                
              </tr>
              {% endfor %}
            </tbody>
          </table>
        {% endfor %}
      </div>
    </div>
  </div>
  {% endfor %}
</div>


<!-- Accordion wrapper -->
<div class="accordion mt-4" id="operationTotalsAccordion">
  <div class="accordion-item">
    <h2 class="accordion-header" id="headingOperationTotals">
      <button
        class="accordion-button collapsed"
        type="button"
        data-bs-toggle="collapse"
        data-bs-target="#collapseOperationTotals"
        aria-expanded="false"
        aria-controls="collapseOperationTotals"
      >
        Operation Totals
      </button>
    </h2>
    <div
      id="collapseOperationTotals"
      class="accordion-collapse collapse"
      aria-labelledby="headingOperationTotals"
      data-bs-parent="#operationTotalsAccordion"
    >
      <div class="accordion-body">
        <!-- Your metrics will be injected here -->
        <div id="operation-oee-metrics"></div>
      </div>
    </div>
  </div>
</div>

  
  
<!-- Downtime Modal -->
<div class="modal fade" id="downtimeModal" tabindex="-1" aria-labelledby="downtimeModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="downtimeModalLabel">Detailed Downtime</h5>
        <button type="button" class="btn btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <!-- PR Downtime Entries -->
        <h6>PR Downtime Entries:</h6>
        <div class="table-responsive">
          <table class="table table-sm pr-downtime-modal-table">
            <thead>
              <tr>
                <th>Id</th>
                <th>Problem</th>
                <th>Called</th>
                <th>Completed</th>
                <th>Minutes Down</th>
              </tr>
            </thead>
            <tbody id="modal-pr-downtime-body">
              <tr>
                <td colspan="5">Loading...</td>
              </tr>
            </tbody>
          </table>
        </div>
        <!-- Downtime Events -->
        <h6 class="mt-3">Downtime Events:</h6>
        <div class="table-responsive">
          <table class="table table-sm downtime-modal-events-table">
            <thead>
              <tr>
                <th>Start</th>
                <th>End</th>
                <th>Minutes Down</th>
                <th>Overlap</th>
                <th>PR Id</th>
              </tr>
            </thead>
            <tbody id="modal-downtime-events-body">
              <tr>
                <td colspan="5">Loading...</td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
      </div>
    </div>
  </div>

  <style>
    @keyframes pulse {
      0% {
        opacity: 1;
      }
      50% {
        opacity: 0.5;
      }
      100% {
        opacity: 1;
      }
    }
    
    .loading {
      animation: pulse 2.5s infinite ease-in-out;
    }    
  </style>
</div>

<script>


    // Function to set loading state for key elements.
    function showLoadingState() {
      // Overall metrics
      const overallIds = [
        'overall-produced', 'overall-target', 'overall-downtime', 
        'overall-planned-downtime', 'overall-unplanned-downtime', 
        'overall-potential-minutes', 'overall-A', 'overall-P', 'overall-Q', 'overall-OEE'
      ];
      overallIds.forEach(function(id) {
        const elem = document.getElementById(id);
        if (elem) {
          elem.innerText = 'Loading...';
          elem.classList.add('loading');
        }
      });
    
      // Reset all machine-related metrics.
      document.querySelectorAll('.produced, .target, .downtime, .planned-downtime, .unplanned-downtime, .availability, .performance')
        .forEach(function(elem) {
          elem.innerText = 'Loading...';
          elem.classList.add('loading');
        });
    
      // Optionally, reset the innerHTML of container divs (e.g., totals, charts) if needed.
      const divIds = [
        'totals-by-line',
        'downtime-totals-by-line',
        'planned-downtime-by-line',
        'unplanned-downtime-by-line',
        'potential-minutes-by-line',
        'scrap-totals-by-line',
        'overall-scrap-total',
        'oee-by-line'
      ];
      divIds.forEach(function(id) {
        const div = document.getElementById(id);
        if (div) {
          div.innerHTML = 'Loading...';
          div.classList.add('loading');
        }
      });
    }
    
    
document.addEventListener("DOMContentLoaded", function() {
  // Initialize flatpickr and store the instance.
  const calendarInstance = flatpickr("#calendar", {
    mode: "range",
    inline: true,
    enableTime: true,         // Enable time picker
    time_24hr: true,          // Use 24-hour time format
    dateFormat: "Y-m-d H:i",  // Include time in the format
    // Default to 11pm for both start and end dates.
    defaultDate: ["{{ start_date }}", "{{ end_date }}"],

  });

  // Listen for button clicks.
  document.getElementById("submit-dates").addEventListener("click", function() {
    const selectedDates = calendarInstance.selectedDates;
    if (selectedDates.length === 2) {
      const startDate = calendarInstance.formatDate(selectedDates[0], "Y-m-d H:i");
      const endDate = calendarInstance.formatDate(selectedDates[1], "Y-m-d H:i");
      const startDateObj = new Date(selectedDates[0]);
      const previousDay = calendarInstance.formatDate(startDateObj, "Y-m-d H:i");
      document.getElementById("selected-date-display").innerText = previousDay + " to " + endDate;
  
      // Set the loading state before fetching new data.
      showLoadingState();
  
      // If "Exclude weekends" is checked, redirect to the new view.
      if (document.getElementById("exclude-weekends").checked) {
        const newUrl = "{% url 'prod_query:fetch_exclude_weekends_data' %}?start_date=" 
                       + encodeURIComponent(startDate) + "&end_date=" + encodeURIComponent(endDate);
        fetch(newUrl)
          .then(response => response.json())
          .then(data => {
            updateProductionData(data);  // reuse your existing DOM-update code
          })
          .catch(error => console.error('Error fetching production data:', error));
        return;
      }
      
  
      // Otherwise, fetch the new production data as before.
      fetchProductionData(startDate, endDate);
    } else {
      alert("Please select both a start and an end date.");
    }
  });
  
  // Global variable to store production data.
  window.productionData = {};
  
  // Initial fetch using the default dates passed in from the backend.
  fetchProductionData("{{ start_date }}", "{{ end_date }}");
  
  function fetchProductionData(startDate, endDate) {
    var url = "{% url 'prod_query:fetch_oa_by_day_production_data' %}?start_date=" 
              + encodeURIComponent(startDate) + "&end_date=" + encodeURIComponent(endDate);
    fetch(url)
      .then(response => response.json())
      .then(data => {
        // Store production data globally for modal lookup.
        window.productionData = data.production_data;

        // Update production data for each machine.
        document.querySelectorAll('.produced').forEach(function(elem) {
          var lineName = elem.getAttribute('data-line');
          var machineNumber = elem.getAttribute('data-machine');
          if (data.production_data[lineName] && data.production_data[lineName][machineNumber]) {
            elem.innerText = data.production_data[lineName][machineNumber].produced_parts;
          } else {
            elem.innerText = '0';
          }

          // Remove the loading effect once data is loaded
          elem.classList.remove('loading');
        });

        // Update target values.
        document.querySelectorAll('.target').forEach(function(elem) {
          var lineName = elem.getAttribute('data-line');
          var machineNumber = elem.getAttribute('data-machine');
          if (data.production_data[lineName] && data.production_data[lineName][machineNumber]) {
            elem.innerText = data.production_data[lineName][machineNumber].target;
          }
          // Remove the loading effect after updating content
          elem.classList.remove('loading');
        });

        // Update downtime values.
        document.querySelectorAll('.downtime').forEach(function(elem) {
          var lineName = elem.getAttribute('data-line');
          var machineNumber = elem.getAttribute('data-machine');
          if (data.production_data[lineName] && data.production_data[lineName][machineNumber] &&
              data.production_data[lineName][machineNumber].downtime_minutes !== undefined) {
            elem.innerText = parseFloat(data.production_data[lineName][machineNumber].downtime_minutes) + " min";
          } else {
            elem.innerText = '0 min';
          }
        });

        // Update planned downtime values.
        document.querySelectorAll('.planned-downtime').forEach(function(elem) {
          var lineName = elem.getAttribute('data-line');
          var machineNumber = elem.getAttribute('data-machine');
          if (window.productionData[lineName] && window.productionData[lineName][machineNumber] &&
              window.productionData[lineName][machineNumber].planned_downtime_minutes !== undefined) {
            elem.innerText = window.productionData[lineName][machineNumber].planned_downtime_minutes + " min";
          } else {
            elem.innerText = '0 min';
          }
        });
        
        // Update unplanned downtime values.
        document.querySelectorAll('.unplanned-downtime').forEach(function(elem) {
          var lineName = elem.getAttribute('data-line');
          var machineNumber = elem.getAttribute('data-machine');
          if (window.productionData[lineName] && window.productionData[lineName][machineNumber] &&
              window.productionData[lineName][machineNumber].unplanned_downtime_minutes !== undefined) {
            elem.innerText = window.productionData[lineName][machineNumber].unplanned_downtime_minutes + " min";
          } else {
            elem.innerText = '0 min';
          }
        });

        // Updated: Update downtime percentage values and apply color.
        document.querySelectorAll('.downtime-percentage').forEach(function(elem) {
          var lineName = elem.getAttribute('data-line');
          var machineNumber = elem.getAttribute('data-machine');
          var machineData = window.productionData[lineName] ? window.productionData[lineName][machineNumber] : null;
          if (machineData && machineData.downtime_percentage !== undefined) {
            // Display the raw downtime percentage with two decimals.
            elem.innerText = parseFloat(machineData.downtime_percentage).toFixed(2) + "%";
            // Apply the color gradient from the backend if available.
            if (machineData.downtime_percentage_color) {
              elem.style.color = machineData.downtime_percentage_color;
            }
          } else {
            elem.innerText = "0%";
          }
        });



        // Update overall totals.
        if (data.overall_totals) {
          document.getElementById('overall-produced').innerText = data.overall_totals.total_produced;
          document.getElementById('overall-target').innerText = data.overall_totals.total_target;
        }
        if (data.overall_downtime) {
          var overallDowntimeMinutes = parseFloat(data.overall_downtime.downtime_minutes);
          document.getElementById('overall-downtime').innerText = overallDowntimeMinutes + " min";
          var overallPlanned = parseFloat(data.overall_downtime.planned_downtime_minutes);
          document.getElementById('overall-planned-downtime').innerText = overallPlanned + " min";
          var overallUnplanned = parseFloat(data.overall_downtime.unplanned_downtime_minutes);
          document.getElementById('overall-unplanned-downtime').innerText = overallUnplanned + " min";
        }
        if (data.overall_potential_minutes !== undefined) {
          document.getElementById('overall-potential-minutes').innerText = data.overall_potential_minutes;
        }
        // Totals by line.
        if (data.totals_by_line) {
          var totalsByLineDiv = document.getElementById('totals-by-line');
          totalsByLineDiv.innerHTML = '<div class="card shadow-sm mb-4"><div class="card-header bg-light"><h2 class="h5 mb-0">Totals by Line</h2></div><div class="card-body" id="line-totals-content"></div></div>';
          var contentDiv = document.getElementById('line-totals-content');
          for (var line in data.totals_by_line) {
            var lineTotal = data.totals_by_line[line];
            var p = document.createElement('p');
            p.innerHTML = '<strong>Line ' + line + ':</strong> Parts: ' + lineTotal.total_produced + ', Target: ' + lineTotal.total_target;
            contentDiv.appendChild(p);
          }
        }
        // Downtime totals by line.
        if (data.downtime_totals_by_line) {
          var downtimeByLineDiv = document.getElementById('downtime-totals-by-line');
          downtimeByLineDiv.innerHTML = '<div class="card shadow-sm mb-4"><div class="card-header bg-light"><h2 class="h5 mb-0">Downtime Totals by Line</h2></div><div class="card-body" id="downtime-line-totals-content"></div></div>';
          var dtContentDiv = document.getElementById('downtime-line-totals-content');
          for (var line in data.downtime_totals_by_line) {
            var dtTotalSeconds = data.downtime_totals_by_line[line];
            var dtTotalMinutes = Math.floor(dtTotalSeconds / 60);
            var p = document.createElement('p');
            p.innerHTML = '<strong>Line ' + line + ':</strong> Downtime: ' + dtTotalMinutes + ' min';
            dtContentDiv.appendChild(p);
          }
        }
        // Planned downtime totals by line.
        if (data.planned_downtime_totals_by_line) {
          var plannedByLineDiv = document.getElementById('planned-downtime-by-line');
          plannedByLineDiv.innerHTML = '<div class="card shadow-sm mb-4"><div class="card-header bg-light"><h2 class="h5 mb-0">Planned Downtime by Line</h2></div><div class="card-body" id="planned-line-totals-content"></div></div>';
          var plannedContentDiv = document.getElementById('planned-line-totals-content');
          for (var line in data.planned_downtime_totals_by_line) {
            var plannedMinutes = data.planned_downtime_totals_by_line[line];
            var p = document.createElement('p');
            p.innerHTML = '<strong>Line ' + line + ':</strong> Planned Downtime: ' + plannedMinutes + ' min';
            plannedContentDiv.appendChild(p);
          }
        }
        // Unplanned downtime totals by line.
        if (data.unplanned_downtime_totals_by_line) {
          var unplannedByLineDiv = document.getElementById('unplanned-downtime-by-line');
          unplannedByLineDiv.innerHTML = '<div class="card shadow-sm mb-4"><div class="card-header bg-light"><h2 class="h5 mb-0">Unplanned Downtime by Line</h2></div><div class="card-body" id="unplanned-line-totals-content"></div></div>';
          var unplannedContentDiv = document.getElementById('unplanned-line-totals-content');
          for (var line in data.unplanned_downtime_totals_by_line) {
            var unplannedMinutes = data.unplanned_downtime_totals_by_line[line];
            var p = document.createElement('p');
            p.innerHTML = '<strong>Line ' + line + ':</strong> Unplanned Downtime: ' + unplannedMinutes + ' min';
            unplannedContentDiv.appendChild(p);
          }
        }
        // Potential minutes by line.
        if (data.potential_minutes_by_line) {
          var potentialMinutesDiv = document.getElementById('potential-minutes-by-line');
          potentialMinutesDiv.innerHTML = '<div class="card shadow-sm mb-4"><div class="card-header bg-light"><h2 class="h5 mb-0">Potential Minutes by Line</h2></div><div class="card-body" id="line-potential-minutes-content"></div></div>';
          var potentialContentDiv = document.getElementById('line-potential-minutes-content');
          for (var line in data.potential_minutes_by_line) {
            var linePotential = data.potential_minutes_by_line[line];
            var p = document.createElement('p');
            p.innerHTML = '<strong>Line ' + line + ':</strong> Potential Minutes: ' + linePotential;
            potentialContentDiv.appendChild(p);
          }
        }

      // Update Availability values.
      document.querySelectorAll('.availability').forEach(function(elem) {
        var lineName = elem.getAttribute('data-line');
        var machineNumber = elem.getAttribute('data-machine');
        if (window.productionData[lineName] && window.productionData[lineName][machineNumber] &&
            window.productionData[lineName][machineNumber].A !== undefined) {
          var machineData = window.productionData[lineName][machineNumber];
          // Multiply by 100 to convert to a percentage.
          elem.innerText = (machineData.A * 100).toFixed(2) + "%";
          // Set the inline style color based on the computed color.
          if (machineData.A_color) {
            elem.style.color = machineData.A_color;
          }
        } else {
          elem.innerText = "N/A";
        }
      });



        // Update Performance values.
        document.querySelectorAll('.performance').forEach(function(elem) {
          var lineName = elem.getAttribute('data-line');
          var machineNumber = elem.getAttribute('data-machine');
          if (window.productionData[lineName] &&
              window.productionData[lineName][machineNumber] &&
              window.productionData[lineName][machineNumber].P !== undefined) {
            var machineData = window.productionData[lineName][machineNumber];
            elem.innerText = (machineData.P * 100).toFixed(2) + "%";
            // Set the inline style using the computed color.
            if (machineData.P_color) {
              elem.style.color = machineData.P_color;
            }
          } else {
            elem.innerText = "N/A";
          }
        });

        
        // Update P×A values.
        document.querySelectorAll('.pa').forEach(function(elem) {
          var lineName      = elem.getAttribute('data-line');
          var machineNumber = elem.getAttribute('data-machine');
          var m = window.productionData[lineName] && window.productionData[lineName][machineNumber];
          if (m && m.PA !== undefined) {
            // Show as a percentage, just like A and P:
            elem.innerText = (m.PA * 100).toFixed(2) + "%";
            // Apply color if provided
            if (m.PA_color) {
              elem.style.color = m.PA_color;
            }
          } else {
            elem.innerText = "0%";
          }
          // Remove loading state if you’re using one
          elem.classList.remove('loading');
        });




        // Scrap totals by line.
        if (data.scrap_totals_by_line) {
          var scrapByLineDiv = document.getElementById('scrap-totals-by-line');
          scrapByLineDiv.innerHTML = '<div class="card shadow-sm mb-4"><div class="card-header bg-light"><h2 class="h5 mb-0">Scrap Totals by Line</h2></div><div class="card-body" id="scrap-line-totals-content"></div></div>';
          var scrapContentDiv = document.getElementById('scrap-line-totals-content');
          for (var line in data.scrap_totals_by_line) {
            var scrapTotal = data.scrap_totals_by_line[line];
            var p = document.createElement('p');
            p.innerHTML = '<strong>Line ' + line + ':</strong> Scrap: ' + scrapTotal;
            scrapContentDiv.appendChild(p);
          }
        }
        // Overall scrap total.
        if (data.overall_scrap_total !== undefined) {
          var overallScrapDiv = document.getElementById('overall-scrap-total');
          overallScrapDiv.innerHTML = '<div class="card shadow-sm mb-4"><div class="card-header bg-light"><h2 class="h5 mb-0">Overall Scrap Total</h2></div><div class="card-body"><p><strong>Total Scrap:</strong> <span id="scrap-total">Loading...</span></p></div></div>';
          document.getElementById('scrap-total').innerText = data.overall_scrap_total;
        }
        // OEE Metrics overall and by line.
        if (data.oee_metrics && data.oee_metrics.overall) {
          document.getElementById('overall-A').innerText = (data.oee_metrics.overall.A * 100).toFixed(2) + "%";
          document.getElementById('overall-P').innerText = (data.oee_metrics.overall.P * 100).toFixed(2) + "%";
          document.getElementById('overall-Q').innerText = (data.oee_metrics.overall.Q * 100).toFixed(2) + "%";
          document.getElementById('overall-OEE').innerText = (data.oee_metrics.overall.OEE * 100).toFixed(2) + "%";
        }
        
        if (data.oee_metrics && data.oee_metrics.lines) {
          var oeeByLineDiv = document.getElementById('oee-by-line');
          oeeByLineDiv.innerHTML = 
            '<div class="card shadow-sm mb-4">' +
              '<div class="card-header bg-light">' +
                '<h2 class="h5 mb-0">OEE Metrics by Line</h2>' +
              '</div>' +
              '<div class="card-body" id="oee-line-content"></div>' +
            '</div>';
          
          var oeeLineContentDiv = document.getElementById('oee-line-content');
          var lines = Object.keys(data.oee_metrics.lines);
          
          // Sort lines by highest OEE value
          lines.sort(function(a, b) {
            return data.oee_metrics.lines[b].OEE - data.oee_metrics.lines[a].OEE;
          });
          
          // Create a table to display the metrics nicely.
          var table = document.createElement('table');
          table.className = 'table table-striped';
          
          // Create table header.
          var thead = document.createElement('thead');
          thead.innerHTML = 
            '<tr>' +
              '<th>Line</th>' +
              '<th>Availability (A)</th>' +
              '<th>Performance (P)</th>' +
              '<th>Quality (Q)</th>' +
              '<th>OEE</th>' +
            '</tr>';
          table.appendChild(thead);
          
          // Create table body.
          var tbody = document.createElement('tbody');
          lines.forEach(function(line) {
            var metrics = data.oee_metrics.lines[line];
            var row = document.createElement('tr');
            row.innerHTML = 
              '<td>' + line + '</td>' +
              '<td>' + metrics.A.toFixed(2) + '</td>' +
              '<td>' + metrics.P.toFixed(2) + '</td>' +
              '<td>' + metrics.Q.toFixed(4) + '</td>' +
              '<td>' + metrics.OEE.toFixed(2) + '</td>';
            tbody.appendChild(row);
          });
          table.appendChild(tbody);
          
          oeeLineContentDiv.appendChild(table);
        }


// Update Operation OEE Metrics grouped by line, injecting into the accordion body.
if (data.operation_oee_metrics && data.operation_oee_metrics.length > 0) {
  var opMetricsContainer = document.getElementById('operation-oee-metrics');
  if (opMetricsContainer) {
    // Group metrics by line.
    var metricsByLine = {};
    data.operation_oee_metrics.forEach(function(op) {
      var lineName = op.line || op.line_name || 'Unknown';
      if (!metricsByLine[lineName]) {
        metricsByLine[lineName] = [];
      }
      metricsByLine[lineName].push(op);
    });

    // Clear existing content.
    opMetricsContainer.innerHTML = '';

    // Iterate over each line grouping.
    for (var line in metricsByLine) {
      var section = document.createElement('div');
      section.style.marginBottom = '20px';

      var heading = document.createElement('h2');
      heading.textContent = 'Line: ' + line;
      section.appendChild(heading);

      var table = document.createElement('table');
      table.className = 'table table-bordered';

    // 1) build the header
    var thead = document.createElement('thead');
    var headerRow = document.createElement('tr');
    var headers = [
      'Operation',
      'Total Parts Produced',
      'Total Target',
      'Downtime Minutes',
      'Planned Downtime',
      'Unplanned Downtime',
      'Total Queried Minutes',
      'Downtime Percentage',
      'Performance',
      'Availability',
      'PxA'           // ← new column
    ];
    headers.forEach(function(headerText) {
      var th = document.createElement('th');
      th.textContent = headerText;
      headerRow.appendChild(th);
    });
    thead.appendChild(headerRow);
    table.appendChild(thead);

    // 2) build the body
    var tbody = document.createElement('tbody');
    metricsByLine[line].forEach(function(op) {
      var row = document.createElement('tr');
      var opName = op.op_name || op.op || 'N/A';

      // format your percentages
      var perfPct  = (op.P  * 100).toFixed(2) + '%';
      var availPct = (op.A  * 100).toFixed(2) + '%';
      var paPct    = (op.PA * 100).toFixed(2) + '%';

      var cells = [
        opName,
        op.total_parts,
        op.total_target,
        op.total_downtime,
        op.total_planned_downtime,
        op.total_unplanned_downtime,
        op.total_queried_minutes,
        Number(op.downtime_percentage).toFixed(2) + '%',
        perfPct,   // Performance
        availPct,  // Availability
        paPct      // P×A
      ];

      // build a parallel array of cell‐background colors (null = no color)
      var colors = [
        null, null, null, null, null, null, null,
        op.downtime_percentage_color,
        op.P_color,
        op.A_color,
        op.PA_color
      ];

      cells.forEach(function(cellValue, idx) {
        var td = document.createElement('td');
        td.textContent = cellValue;
      
        // if a font-color was computed, apply it
        if (colors[idx]) {
          td.style.color = colors[idx];
        }
      
        row.appendChild(td);
      });

      tbody.appendChild(row);
    });
    table.appendChild(tbody);


      section.appendChild(table);
      opMetricsContainer.appendChild(section);
    }
  } else {
    console.error('Element with id "operation-oee-metrics" not found in the DOM.');
  }
}



appendOpTotalsRows();



        // At the end of the fetch callback, remove any remaining loading classes.
        document.querySelectorAll('.loading').forEach(function(elem) {
          elem.classList.remove('loading');
        });

      })
      .catch(error => console.error('Error fetching production data:', error));
  }

  function updateProductionData(data) {
    // Store production data globally for modal lookup.
    window.productionData = data.production_data;
  
    // Update production data for each machine.
    document.querySelectorAll('.produced').forEach(function(elem) {
      var lineName = elem.getAttribute('data-line');
      var machineNumber = elem.getAttribute('data-machine');
      if (data.production_data[lineName] && data.production_data[lineName][machineNumber]) {
        elem.innerText = data.production_data[lineName][machineNumber].produced_parts;
      } else {
        elem.innerText = '0';
      }
      elem.classList.remove('loading');
    });
  
    // Update target values.
    document.querySelectorAll('.target').forEach(function(elem) {
      var lineName = elem.getAttribute('data-line');
      var machineNumber = elem.getAttribute('data-machine');
      if (data.production_data[lineName] && data.production_data[lineName][machineNumber]) {
        elem.innerText = data.production_data[lineName][machineNumber].target;
      }
      elem.classList.remove('loading');
    });
  
    // Update downtime values.
    document.querySelectorAll('.downtime').forEach(function(elem) {
      var lineName = elem.getAttribute('data-line');
      var machineNumber = elem.getAttribute('data-machine');
      if (data.production_data[lineName] &&
          data.production_data[lineName][machineNumber] &&
          data.production_data[lineName][machineNumber].downtime_minutes !== undefined) {
        elem.innerText = parseFloat(data.production_data[lineName][machineNumber].downtime_minutes) + " min";
      } else {
        elem.innerText = '0 min';
      }
    });
  
    // Update planned downtime values.
    document.querySelectorAll('.planned-downtime').forEach(function(elem) {
      var lineName = elem.getAttribute('data-line');
      var machineNumber = elem.getAttribute('data-machine');
      if (window.productionData[lineName] &&
          window.productionData[lineName][machineNumber] &&
          window.productionData[lineName][machineNumber].planned_downtime_minutes !== undefined) {
        elem.innerText = window.productionData[lineName][machineNumber].planned_downtime_minutes + " min";
      } else {
        elem.innerText = '0 min';
      }
    });
  
    // Update unplanned downtime values.
    document.querySelectorAll('.unplanned-downtime').forEach(function(elem) {
      var lineName = elem.getAttribute('data-line');
      var machineNumber = elem.getAttribute('data-machine');
      if (window.productionData[lineName] &&
          window.productionData[lineName][machineNumber] &&
          window.productionData[lineName][machineNumber].unplanned_downtime_minutes !== undefined) {
        elem.innerText = window.productionData[lineName][machineNumber].unplanned_downtime_minutes + " min";
      } else {
        elem.innerText = '0 min';
      }
    });

    // Updated: Update downtime percentage values and apply color.
    document.querySelectorAll('.downtime-percentage').forEach(function(elem) {
      var lineName = elem.getAttribute('data-line');
      var machineNumber = elem.getAttribute('data-machine');
      var machineData = window.productionData[lineName] ? window.productionData[lineName][machineNumber] : null;
      if (machineData && machineData.downtime_percentage !== undefined) {
        // Display the raw downtime percentage with two decimals.
        elem.innerText = parseFloat(machineData.downtime_percentage).toFixed(2) + "%";
        // Apply the color gradient from the backend if available.
        if (machineData.downtime_percentage_color) {
          elem.style.color = machineData.downtime_percentage_color;
        }
      } else {
        elem.innerText = "0%";
      }
    });

  
    // Update overall totals.
    if (data.overall_totals) {
      document.getElementById('overall-produced').innerText = data.overall_totals.total_produced;
      document.getElementById('overall-target').innerText = data.overall_totals.total_target;
    }
    if (data.overall_downtime) {
      var overallDowntimeMinutes = parseFloat(data.overall_downtime.downtime_minutes);
      document.getElementById('overall-downtime').innerText = overallDowntimeMinutes + " min";
      var overallPlanned = parseFloat(data.overall_downtime.planned_downtime_minutes);
      document.getElementById('overall-planned-downtime').innerText = overallPlanned + " min";
      var overallUnplanned = parseFloat(data.overall_downtime.unplanned_downtime_minutes);
      document.getElementById('overall-unplanned-downtime').innerText = overallUnplanned + " min";
    }
    if (data.overall_potential_minutes !== undefined) {
      document.getElementById('overall-potential-minutes').innerText = data.overall_potential_minutes;
    }
  
    // Totals by line.
    if (data.totals_by_line) {
      var totalsByLineDiv = document.getElementById('totals-by-line');
      totalsByLineDiv.innerHTML = '<div class="card shadow-sm mb-4"><div class="card-header bg-light"><h2 class="h5 mb-0">Totals by Line</h2></div><div class="card-body" id="line-totals-content"></div></div>';
      var contentDiv = document.getElementById('line-totals-content');
      for (var line in data.totals_by_line) {
        var lineTotal = data.totals_by_line[line];
        var p = document.createElement('p');
        p.innerHTML = '<strong>Line ' + line + ':</strong> Parts: ' + lineTotal.total_produced + ', Target: ' + lineTotal.total_target;
        contentDiv.appendChild(p);
      }
    }
  
    // Downtime totals by line.
    if (data.downtime_totals_by_line) {
      var downtimeByLineDiv = document.getElementById('downtime-totals-by-line');
      downtimeByLineDiv.innerHTML = '<div class="card shadow-sm mb-4"><div class="card-header bg-light"><h2 class="h5 mb-0">Downtime Totals by Line</h2></div><div class="card-body" id="downtime-line-totals-content"></div></div>';
      var dtContentDiv = document.getElementById('downtime-line-totals-content');
      for (var line in data.downtime_totals_by_line) {
        var dtTotalSeconds = data.downtime_totals_by_line[line];
        var dtTotalMinutes = Math.floor(dtTotalSeconds / 60);
        var p = document.createElement('p');
        p.innerHTML = '<strong>Line ' + line + ':</strong> Downtime: ' + dtTotalMinutes + ' min';
        dtContentDiv.appendChild(p);
      }
    }
  
    // Planned downtime totals by line.
    if (data.planned_downtime_totals_by_line) {
      var plannedByLineDiv = document.getElementById('planned-downtime-by-line');
      plannedByLineDiv.innerHTML = '<div class="card shadow-sm mb-4"><div class="card-header bg-light"><h2 class="h5 mb-0">Planned Downtime by Line</h2></div><div class="card-body" id="planned-line-totals-content"></div></div>';
      var plannedContentDiv = document.getElementById('planned-line-totals-content');
      for (var line in data.planned_downtime_totals_by_line) {
        var plannedMinutes = data.planned_downtime_totals_by_line[line];
        var p = document.createElement('p');
        p.innerHTML = '<strong>Line ' + line + ':</strong> Planned Downtime: ' + plannedMinutes + ' min';
        plannedContentDiv.appendChild(p);
      }
    }
  
    // Unplanned downtime totals by line.
    if (data.unplanned_downtime_totals_by_line) {
      var unplannedByLineDiv = document.getElementById('unplanned-downtime-by-line');
      unplannedByLineDiv.innerHTML = '<div class="card shadow-sm mb-4"><div class="card-header bg-light"><h2 class="h5 mb-0">Unplanned Downtime by Line</h2></div><div class="card-body" id="unplanned-line-totals-content"></div></div>';
      var unplannedContentDiv = document.getElementById('unplanned-line-totals-content');
      for (var line in data.unplanned_downtime_totals_by_line) {
        var unplannedMinutes = data.unplanned_downtime_totals_by_line[line];
        var p = document.createElement('p');
        p.innerHTML = '<strong>Line ' + line + ':</strong> Unplanned Downtime: ' + unplannedMinutes + ' min';
        unplannedContentDiv.appendChild(p);
      }
    }
  
    // Potential minutes by line.
    if (data.potential_minutes_by_line) {
      var potentialMinutesDiv = document.getElementById('potential-minutes-by-line');
      potentialMinutesDiv.innerHTML = '<div class="card shadow-sm mb-4"><div class="card-header bg-light"><h2 class="h5 mb-0">Potential Minutes by Line</h2></div><div class="card-body" id="line-potential-minutes-content"></div></div>';
      var potentialContentDiv = document.getElementById('line-potential-minutes-content');
      for (var line in data.potential_minutes_by_line) {
        var linePotential = data.potential_minutes_by_line[line];
        var p = document.createElement('p');
        p.innerHTML = '<strong>Line ' + line + ':</strong> Potential Minutes: ' + linePotential;
        potentialContentDiv.appendChild(p);
      }
    }
  
    // Update Availability values.
    document.querySelectorAll('.availability').forEach(function(elem) {
      var lineName = elem.getAttribute('data-line');
      var machineNumber = elem.getAttribute('data-machine');
      if (window.productionData[lineName] &&
          window.productionData[lineName][machineNumber] &&
          window.productionData[lineName][machineNumber].A !== undefined) {
        var machineData = window.productionData[lineName][machineNumber];
        elem.innerText = (machineData.A * 100).toFixed(2) + "%";
        // Set the inline style using the computed color.
        if (machineData.A_color) {
          elem.style.color = machineData.A_color;
        }
      } else {
        elem.innerText = "N/A";
      }
    });
    


    // Update Performance values.
    document.querySelectorAll('.performance').forEach(function(elem) {
      var lineName = elem.getAttribute('data-line');
      var machineNumber = elem.getAttribute('data-machine');
      if (window.productionData[lineName] &&
          window.productionData[lineName][machineNumber] &&
          window.productionData[lineName][machineNumber].P !== undefined) {
        var machineData = window.productionData[lineName][machineNumber];
        elem.innerText = (machineData.P * 100).toFixed(2) + "%";
        // Set the inline style using the computed color.
        if (machineData.P_color) {
          elem.style.color = machineData.P_color;
        }
      } else {
        elem.innerText = "N/A";
      }
    });



      // Update P×A values.
      document.querySelectorAll('.pa').forEach(function(elem) {
        var lineName      = elem.getAttribute('data-line');
        var machineNumber = elem.getAttribute('data-machine');
        var m = window.productionData[lineName] && window.productionData[lineName][machineNumber];
        if (m && m.PA !== undefined) {
          // Show as a percentage, just like A and P:
          elem.innerText = (m.PA * 100).toFixed(2) + "%";
          // Apply color if provided
          if (m.PA_color) {
            elem.style.color = m.PA_color;
          }
        } else {
          elem.innerText = "0%";
        }
        // Remove loading state if you’re using one
        elem.classList.remove('loading');
      });


    // Scrap totals by line.
    if (data.scrap_totals_by_line) {
      var scrapByLineDiv = document.getElementById('scrap-totals-by-line');
      scrapByLineDiv.innerHTML = '<div class="card shadow-sm mb-4"><div class="card-header bg-light"><h2 class="h5 mb-0">Scrap Totals by Line</h2></div><div class="card-body" id="scrap-line-totals-content"></div></div>';
      var scrapContentDiv = document.getElementById('scrap-line-totals-content');
      for (var line in data.scrap_totals_by_line) {
        var scrapTotal = data.scrap_totals_by_line[line];
        var p = document.createElement('p');
        p.innerHTML = '<strong>Line ' + line + ':</strong> Scrap: ' + scrapTotal;
        scrapContentDiv.appendChild(p);
      }
    }
  
    // Overall scrap total.
    if (data.overall_scrap_total !== undefined) {
      var overallScrapDiv = document.getElementById('overall-scrap-total');
      overallScrapDiv.innerHTML = '<div class="card shadow-sm mb-4"><div class="card-header bg-light"><h2 class="h5 mb-0">Overall Scrap Total</h2></div><div class="card-body"><p><strong>Total Scrap:</strong> <span id="scrap-total">Loading...</span></p></div></div>';
      document.getElementById('scrap-total').innerText = data.overall_scrap_total;
    }
  
    // OEE Metrics overall and by line.
    if (data.oee_metrics && data.oee_metrics.overall) {
      document.getElementById('overall-A').innerText = (data.oee_metrics.overall.A * 100).toFixed(2) + "%";
      document.getElementById('overall-P').innerText = (data.oee_metrics.overall.P * 100).toFixed(2) + "%";
      document.getElementById('overall-Q').innerText = (data.oee_metrics.overall.Q * 100).toFixed(2) + "%";
      document.getElementById('overall-OEE').innerText = (data.oee_metrics.overall.OEE * 100).toFixed(2) + "%";
    }
    
    if (data.oee_metrics && data.oee_metrics.lines) {
      var oeeByLineDiv = document.getElementById('oee-by-line');
      oeeByLineDiv.innerHTML =
        '<div class="card shadow-sm mb-4">' +
          '<div class="card-header bg-light">' +
            '<h2 class="h5 mb-0">OEE Metrics by Line</h2>' +
          '</div>' +
          '<div class="card-body" id="oee-line-content"></div>' +
        '</div>';
      
      var oeeLineContentDiv = document.getElementById('oee-line-content');
      var lines = Object.keys(data.oee_metrics.lines);
      
      // Sort lines by highest OEE value.
      lines.sort(function(a, b) {
        return data.oee_metrics.lines[b].OEE - data.oee_metrics.lines[a].OEE;
      });
      
      // Create a table to display the metrics.
      var table = document.createElement('table');
      table.className = 'table table-striped';
      
      // Table header.
      var thead = document.createElement('thead');
      thead.innerHTML =
        '<tr>' +
          '<th>Line</th>' +
          '<th>Availability (A)</th>' +
          '<th>Performance (P)</th>' +
          '<th>Quality (Q)</th>' +
          '<th>OEE</th>' +
        '</tr>';
      table.appendChild(thead);
      
      // Table body.
      var tbody = document.createElement('tbody');
      lines.forEach(function(line) {
        var metrics = data.oee_metrics.lines[line];
        var row = document.createElement('tr');
        row.innerHTML =
          '<td>' + line + '</td>' +
          '<td>' + metrics.A.toFixed(2) + '</td>' +
          '<td>' + metrics.P.toFixed(2) + '</td>' +
          '<td>' + metrics.Q.toFixed(4) + '</td>' +
          '<td>' + metrics.OEE.toFixed(2) + '</td>';
        tbody.appendChild(row);
      });
      table.appendChild(tbody);
      
      oeeLineContentDiv.appendChild(table);
    }



// Update Operation OEE Metrics grouped by line, injecting into the accordion body.
if (data.operation_oee_metrics && data.operation_oee_metrics.length > 0) {
  var opMetricsContainer = document.getElementById('operation-oee-metrics');
  if (opMetricsContainer) {
    // Group metrics by line.
    var metricsByLine = {};
    data.operation_oee_metrics.forEach(function(op) {
      var lineName = op.line || op.line_name || 'Unknown';
      if (!metricsByLine[lineName]) {
        metricsByLine[lineName] = [];
      }
      metricsByLine[lineName].push(op);
    });

    // Clear existing content.
    opMetricsContainer.innerHTML = '';

    // Iterate over each line grouping.
    for (var line in metricsByLine) {
      var section = document.createElement('div');
      section.style.marginBottom = '20px';

      var heading = document.createElement('h2');
      heading.textContent = 'Line: ' + line;
      section.appendChild(heading);

      var table = document.createElement('table');
      table.className = 'table table-bordered';

    // 1) build the header
    var thead = document.createElement('thead');
    var headerRow = document.createElement('tr');
    var headers = [
      'Operation',
      'Total Parts Produced',
      'Total Target',
      'Downtime Minutes',
      'Planned Downtime',
      'Unplanned Downtime',
      'Total Queried Minutes',
      'Downtime Percentage',
      'Performance',
      'Availability',
      'PxA'           // ← new column
    ];
    headers.forEach(function(headerText) {
      var th = document.createElement('th');
      th.textContent = headerText;
      headerRow.appendChild(th);
    });
    thead.appendChild(headerRow);
    table.appendChild(thead);

    // 2) build the body
    var tbody = document.createElement('tbody');
    metricsByLine[line].forEach(function(op) {
      var row = document.createElement('tr');
      var opName = op.op_name || op.op || 'N/A';

      // format your percentages
      var perfPct  = (op.P  * 100).toFixed(2) + '%';
      var availPct = (op.A  * 100).toFixed(2) + '%';
      var paPct    = (op.PA * 100).toFixed(2) + '%';

      var cells = [
        opName,
        op.total_parts,
        op.total_target,
        op.total_downtime,
        op.total_planned_downtime,
        op.total_unplanned_downtime,
        op.total_queried_minutes,
        Number(op.downtime_percentage).toFixed(2) + '%',
        perfPct,   // Performance
        availPct,  // Availability
        paPct      // P×A
      ];

      // build a parallel array of cell‐background colors (null = no color)
      var colors = [
        null, null, null, null, null, null, null,
        op.downtime_percentage_color,
        op.P_color,
        op.A_color,
        op.PA_color
      ];

      cells.forEach(function(cellValue, idx) {
        var td = document.createElement('td');
        td.textContent = cellValue;
      
        // if a font-color was computed, apply it
        if (colors[idx]) {
          td.style.color = colors[idx];
        }
      
        row.appendChild(td);
      });

      tbody.appendChild(row);
    });
    table.appendChild(tbody);


      section.appendChild(table);
      opMetricsContainer.appendChild(section);
    }
  } else {
    console.error('Element with id "operation-oee-metrics" not found in the DOM.');
  }
}



appendOpTotalsRows();


  
    // Remove any remaining loading classes.
    document.querySelectorAll('.loading').forEach(function(elem) {
      elem.classList.remove('loading');
    });
  }
  


  // Set up Detailed Downtime button event listeners.
  document.querySelectorAll('.detailed-downtime-btn').forEach(function(btn) {
    btn.addEventListener('click', function() {
      var line = btn.getAttribute('data-line');
      var machine = btn.getAttribute('data-machine');
      var machineData = window.productionData && window.productionData[line] ? window.productionData[line][machine] : null;
      var prTbody = document.getElementById('modal-pr-downtime-body');
      var eventsTbody = document.getElementById('modal-downtime-events-body');
      prTbody.innerHTML = "";
      eventsTbody.innerHTML = "";
      if(machineData) {
        var prEntries = machineData.pr_downtime_entries;
        if(prEntries && prEntries.length > 0) {
          prEntries.forEach(function(entry) {
            var id = entry.idnumber || "N/A";
            var problem = entry.problem || "N/A";
            var called = entry.start_time ? new Date(entry.start_time).toISOString() : "N/A";
            var completed = entry.end_time ? new Date(entry.end_time).toISOString() : "N/A";
            var minutesDown = entry.minutes_down !== undefined ? entry.minutes_down : "N/A";
            var tr = document.createElement('tr');
            tr.innerHTML = "<td>" + id + "</td><td>" + problem + "</td><td>" + called + "</td><td>" + completed + "</td><td>" + minutesDown + "</td>";
            prTbody.appendChild(tr);
          });                 
        } else {
          prTbody.innerHTML = "<tr><td colspan='5'>No PR downtime entries found.</td></tr>";
        }
        if(machineData.downtime_events && machineData.downtime_events.length > 0) {
          machineData.downtime_events.forEach(function(event) {
            var tr = document.createElement('tr');
            tr.innerHTML = "<td>" + event.start + "</td>" +
                           "<td>" + event.end + "</td>" +
                           "<td>" + event.minutes_down + " min</td>" +
                           "<td>" + (event.overlap || "No Overlap") + "</td>" +
                           "<td>" + (event.pr_id ? event.pr_id : "") + "</td>";
            eventsTbody.appendChild(tr);
          });
        } else {
          eventsTbody.innerHTML = "<tr><td colspan='5'>No downtime events found.</td></tr>";
        }
      } else {
        prTbody.innerHTML = "<tr><td colspan='5'>No data found.</td></tr>";
        eventsTbody.innerHTML = "<tr><td colspan='5'>No data found.</td></tr>";
      }
    });
  });
});
</script>


<script>
  // pulled out so you can call it from your fetch callback
  function appendOpTotalsRows() {
    const opTables  = Array.from(document.querySelectorAll('#productionData table.table-striped'));
    const totalRows = Array.from(document.querySelectorAll('#operation-oee-metrics table.table-bordered tbody tr'));
  
    opTables.forEach((table, idx) => {
      // ——————————————————————————
      // 0) remove any previously appended total rows
      table
        .querySelectorAll('tbody tr.appended-total')
        .forEach(oldRow => oldRow.remove());
      // ——————————————————————————
  
      const srcRow = totalRows[idx];
      if (!srcRow) return;
  
      // 1) clone the summary row
      const clone = srcRow.cloneNode(true);
      // mark it so we can remove it next time
      clone.classList.add('appended-total');
  
      // 2) pull out its cells
      const cells = clone.querySelectorAll('td');
  
      // 3) rename first cell to "Total"
      if (cells[0]) cells[0].innerText = 'Total';
  
      // 4) remove the 7th cell (zero‑based index 6 = "Total Queried Minutes")
      if (cells[6]) cells[6].remove();
  
      // 5) override any inherited colors and force black text
      clone.querySelectorAll('td').forEach(td => {
        td.style.color = 'black';
      });
  
      // 6) append an extra empty <td> so this row isn't one cell short
      const emptyCell = document.createElement('td');
      emptyCell.innerHTML = '&nbsp;';
      clone.appendChild(emptyCell);
  
      // 7) append into the <tbody> of the matching op table
      table.querySelector('tbody').appendChild(clone);
    });
  }
  
  // …and at the very end of your fetchProductionData(...).then(data=>{…}) callback:
  appendOpTotalsRows();
</script>


  
<script>
  document.addEventListener('DOMContentLoaded', () => {
    const stripMin     = v => v ? v.replace(/\s*min$/i, '').trim() : '';
    const stripPercent = v => v ? v.replace(/%/g, '').trim() : '';
    const escapeCell   = v => `"${v.replace(/"/g, '""')}"`;
  
    document.querySelectorAll('.export-csv-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        const lineName  = btn.dataset.line.trim();
        const container = btn.closest('.accordion-item');
  
        const headers = [
          'Line','Operation','Machine','Parts','Target',
          'Downtime','Planned Downtime','Unplanned Downtime',
          'Downtime %','Performance','Availability','PxA'
        ];
  
        const dataRows = [];
  
        // grab all the operation headings up‐front so we can detect "last"
        const ops = Array.from(container.querySelectorAll('.accordion-body h3.h6'));
        ops.forEach((opHdr, idx) => {
          const opName = opHdr.textContent.replace(/^Operation:\s*/, '').trim();
          const table  = opHdr.nextElementSibling;
          if (!table || table.tagName !== 'TABLE') return;
  
          // 1) push every machine row (including your appended-total)
          table.querySelectorAll('tbody tr').forEach(row => {
            let machine, parts, target,
                downtime, planned, unplanned,
                downPct, perf, avail, pxA;
  
            if (row.classList.contains('appended-total')) {
              const cells = Array.from(row.querySelectorAll('td')).map(td => td.textContent.trim());
              machine   = cells[0];
              parts     = cells[1];
              target    = cells[2];
              downtime  = stripMin(cells[3]);
              planned   = stripMin(cells[4]);
              unplanned = stripMin(cells[5]);
              downPct   = stripPercent(cells[6]);
              perf      = stripPercent(cells[7]);
              avail     = stripPercent(cells[8]);
              pxA       = stripPercent(cells[9]);
            } else {
              machine   = row.querySelector('strong')?.textContent.trim()          || '';
              parts     = row.querySelector('.produced')?.textContent.trim()       || '';
              target    = row.querySelector('.target')?.textContent.trim()         || '';
              downtime  = stripMin(row.querySelector('.downtime')?.textContent.trim());
              planned   = stripMin(row.querySelector('.planned-downtime')?.textContent.trim());
              unplanned = stripMin(row.querySelector('.unplanned-downtime')?.textContent.trim());
              downPct   = stripPercent(row.querySelector('.downtime-percentage')?.textContent.trim());
              perf      = stripPercent(row.querySelector('.performance')?.textContent.trim());
              avail     = stripPercent(row.querySelector('.availability')?.textContent.trim());
              pxA       = stripPercent(row.querySelector('.pa')?.textContent.trim());
            }
  
            dataRows.push([
              lineName, opName,
              machine, parts, target,
              downtime, planned, unplanned,
              downPct, perf, avail, pxA
            ]);
          });
  
          // 2) if this isn’t the last operation, insert a blank line
          if (idx < ops.length - 1) {
            dataRows.push( Array(headers.length).fill('') );
          }
        });
  
        // 3) build & download CSV
        const csvLines = [
          headers.map(escapeCell).join(','),
          ...dataRows.map(row => row.map(escapeCell).join(','))
        ];
        const blob = new Blob([ csvLines.join('\r\n') ], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement('a');
        link.href     = URL.createObjectURL(blob);
        link.download = `${lineName.replace(/\s+/g,'_')}_production.csv`;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        URL.revokeObjectURL(link.href);
      });
    });
  });
  </script>
  
  
  
  
  
  

{% endblock %}