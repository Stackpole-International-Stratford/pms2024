{% extends "parent.html" %}
{% load static %}

{% block content %}
<div class="container my-4">
    <!-- Header -->
    <div class="row mb-4">
        <div class="col-12 text-center">
            <h1 class="display-5">
                <span id="selected-date-display">11pm {{ previous_day }} to 11pm {{ end_date }}</span>
            </h1>
        </div>
    </div>
    
    <div class="card shadow-sm mb-4">
        <div class="card-body">
          <div class="row">
            <!-- Calendar Column -->
            <div class="col-md-6 mb-3 mb-md-0">
              <div id="calendar"></div>
            </div>
            <!-- OEE Metrics Column -->
            <div class="col-md-6">
              <h5 class="mb-3">Overall OEE Metrics</h5>
              <p class="mb-2"><strong>OEE:</strong> <span id="overall-OEE">Loading...</span></p>
              <p class="mb-2"><strong>Availability (A):</strong> <span id="overall-A">Loading...</span></p>
              <p class="mb-2"><strong>Performance (P):</strong> <span id="overall-P">Loading...</span></p>
              <p class="mb-0"><strong>Quality (Q):</strong> <span id="overall-Q">Loading...</span></p>
            </div>
          </div>
        </div>
    </div>
      
    <!-- OEE Metrics by Line -->
    <div id="oee-by-line" class="mb-4"></div>
  
    <!-- Summary Totals -->
    <div class="card shadow-sm mb-4">
        <div class="card-header bg-light">
            <h2 class="h5 mb-0">Overall Totals</h2>
        </div>
        <div class="card-body">
            <p class="mb-2"><strong>Overall Produced Parts:</strong> <span id="overall-produced">Loading...</span></p>
            <p class="mb-0"><strong>Overall Target:</strong> <span id="overall-target">Loading...</span></p>
        </div>
    </div>

    <!-- Overall Downtime Totals -->
    <div class="card shadow-sm mb-4">
        <div class="card-header bg-light">
            <h2 class="h5 mb-0">Overall Downtime</h2>
        </div>
        <div class="card-body">
            <p class="mb-0"><strong>Overall Downtime:</strong> <span id="overall-downtime">Loading...</span></p>
        </div>
    </div>

    <!-- Overall Potential Minutes Totals -->
    <div class="card shadow-sm mb-4">
        <div class="card-header bg-light">
            <h2 class="h5 mb-0">Overall Potential Minutes</h2>
        </div>
        <div class="card-body">
            <p class="mb-0"><strong>Overall Potential Minutes:</strong> <span id="overall-potential-minutes">Loading...</span></p>
        </div>
    </div>

    <!-- Totals by Line for Production -->
    <div id="totals-by-line" class="mb-4"></div>

    <!-- Downtime Totals by Line -->
    <div id="downtime-totals-by-line" class="mb-4"></div>

    <!-- Potential Minutes by Line -->
    <div id="potential-minutes-by-line" class="mb-4"></div>
    
    <!-- Scrap Totals by Line -->
    <div id="scrap-totals-by-line" class="mb-4"></div>
    
    <!-- Overall Scrap Total -->
    <div id="overall-scrap-total" class="mb-4"></div>

    <!-- Production Data Cards -->
    <div id="productionData">
        {% for line in lines %}
        <div class="card shadow-sm mb-4">
            <div class="card-header bg-secondary text-white">
                <h2 class="h5 mb-0">Line: {{ line.line }}</h2>
            </div>
            <div class="card-body">
                {% for operation in line.operations %}
                <h3 class="h6 mt-3">Operation: {{ operation.op }}</h3>
                <div class="row">
                    {% for machine in operation.machines %}
                    <div class="col-md-4 mb-3">
                        <div class="card h-100">
                            <div class="card-body">
                                <p class="mb-2"><strong>Machine Number:</strong> {{ machine.number }}</p>
                                <p class="mb-2">
                                    <strong>Target:</strong>
                                    <span class="target" data-line="{{ line.line }}" data-machine="{{ machine.number }}">
                                        {{ machine.target }}
                                    </span>
                                </p>
                                
                                {% if machine.part_numbers %}
                                    <p class="mb-2"><strong>Part Numbers:</strong> {{ machine.part_numbers|join:", " }}</p>
                                {% endif %}
                                <p class="mb-2">
                                    <strong>Parts:</strong>
                                    <span class="produced" data-line="{{ line.line }}" data-machine="{{ machine.number }}">
                                        Loading...
                                    </span>
                                </p>
                                <p class="mb-0">
                                    <strong>Downtime:</strong>
                                    <span class="downtime" data-line="{{ line.line }}" data-machine="{{ machine.number }}">
                                        Loading...
                                    </span>
                                </p>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
                {% endfor %}
            </div>
        </div>
        {% endfor %}
    </div>
</div>

<script>
document.addEventListener("DOMContentLoaded", function() {
    // Initialize Flatpickr in range mode with inline display.
    // The default range comes from the backend context variables 'start_date' and 'end_date'.
    flatpickr("#calendar", {
        mode: "range",
        inline: true,
        enableTime: true,         // Enable time picker
        time_24hr: true,          // Use 24-hour time format
        dateFormat: "Y-m-d H:i",  // Include time in the format
        // Append " 23:00" to your default dates so they default to 11pm.
        defaultDate: ["{{ start_date }} 23:00", "{{ end_date }} 23:00"],
        onChange: function(selectedDates, dateStr, instance) {
            if (selectedDates.length === 2) {
                // Format both the start and end datetime strings with time.
                var startDate = instance.formatDate(selectedDates[0], "Y-m-d H:i");
                var endDate = instance.formatDate(selectedDates[1], "Y-m-d H:i");
                
                // Compute the previous datetime from the start date.
                var startDateObj = new Date(selectedDates[0]);
                startDateObj.setDate(startDateObj.getDate() - 1);
                var previousDay = instance.formatDate(startDateObj, "Y-m-d H:i");
                
                // Update the header title with the computed previous datetime.
                document.getElementById("selected-date-display").innerText = previousDay + " to " + endDate;
                fetchProductionData(startDate, endDate);
            }
        }
    });
    
    
    // Initial fetch using the default dates passed in from the backend.
    fetchProductionData("{{ start_date }}", "{{ end_date }}");
    
    function fetchProductionData(startDate, endDate) {
        var url = "{% url 'prod_query:fetch_oa_by_day_production_data' %}?start_date=" 
                  + encodeURIComponent(startDate) + "&end_date=" + encodeURIComponent(endDate);
        fetch(url)
            .then(response => response.json())
            .then(data => {
                // Update production data for each machine.
                document.querySelectorAll('.produced').forEach(function(elem) {
                    var lineName = elem.getAttribute('data-line');
                    var machineNumber = elem.getAttribute('data-machine');
                    if (data.production_data[lineName] && data.production_data[lineName][machineNumber]) {
                        elem.innerText = data.production_data[lineName][machineNumber].produced_parts;
                    } else {
                        elem.innerText = '0';
                    }
                });

                // Update target values with the adjusted target from the JSON response.
                document.querySelectorAll('.target').forEach(function(elem) {
                    var lineName = elem.getAttribute('data-line');
                    var machineNumber = elem.getAttribute('data-machine');
                    if (data.production_data[lineName] && data.production_data[lineName][machineNumber]) {
                        elem.innerText = data.production_data[lineName][machineNumber].target;
                    }
                });

                // Update downtime data.
                document.querySelectorAll('.downtime').forEach(function(elem) {
                    var lineName = elem.getAttribute('data-line');
                    var machineNumber = elem.getAttribute('data-machine');
                    if (data.production_data[lineName] && data.production_data[lineName][machineNumber] &&
                        data.production_data[lineName][machineNumber].downtime_minutes !== undefined) {
                        elem.innerText = parseFloat(data.production_data[lineName][machineNumber].downtime_minutes) + " min";
                    } else {
                        elem.innerText = '0 min';
                    }
                });
                // Update overall totals.
                if (data.overall_totals) {
                    document.getElementById('overall-produced').innerText = data.overall_totals.total_produced;
                    document.getElementById('overall-target').innerText = data.overall_totals.total_target;
                }
                if (data.overall_downtime) {
                    var overallDowntimeMinutes = parseFloat(data.overall_downtime.downtime_minutes);
                    document.getElementById('overall-downtime').innerText = overallDowntimeMinutes + " min";
                }
                if (data.overall_potential_minutes !== undefined) {
                    document.getElementById('overall-potential-minutes').innerText = data.overall_potential_minutes;
                }
                // Update totals by line.
                if (data.totals_by_line) {
                    var totalsByLineDiv = document.getElementById('totals-by-line');
                    totalsByLineDiv.innerHTML = '<div class="card shadow-sm mb-4"><div class="card-header bg-light"><h2 class="h5 mb-0">Totals by Line</h2></div><div class="card-body" id="line-totals-content"></div></div>';
                    var contentDiv = document.getElementById('line-totals-content');
                    for (var line in data.totals_by_line) {
                        var lineTotal = data.totals_by_line[line];
                        var p = document.createElement('p');
                        p.innerHTML = '<strong>Line ' + line + ':</strong> Parts: ' + lineTotal.total_produced + ', Target: ' + lineTotal.total_target;
                        contentDiv.appendChild(p);
                    }
                }
                // Update downtime totals by line.
                if (data.downtime_totals_by_line) {
                    var downtimeByLineDiv = document.getElementById('downtime-totals-by-line');
                    downtimeByLineDiv.innerHTML = '<div class="card shadow-sm mb-4"><div class="card-header bg-light"><h2 class="h5 mb-0">Downtime Totals by Line</h2></div><div class="card-body" id="downtime-line-totals-content"></div></div>';
                    var dtContentDiv = document.getElementById('downtime-line-totals-content');
                    for (var line in data.downtime_totals_by_line) {
                        var dtTotalSeconds = data.downtime_totals_by_line[line];
                        var dtTotalMinutes = Math.floor(dtTotalSeconds / 60);
                        var p = document.createElement('p');
                        p.innerHTML = '<strong>Line ' + line + ':</strong> Downtime: ' + dtTotalMinutes + ' min';
                        dtContentDiv.appendChild(p);
                    }
                }
                // Update potential minutes by line.
                if (data.potential_minutes_by_line) {
                    var potentialMinutesDiv = document.getElementById('potential-minutes-by-line');
                    potentialMinutesDiv.innerHTML = '<div class="card shadow-sm mb-4"><div class="card-header bg-light"><h2 class="h5 mb-0">Potential Minutes by Line</h2></div><div class="card-body" id="line-potential-minutes-content"></div></div>';
                    var potentialContentDiv = document.getElementById('line-potential-minutes-content');
                    for (var line in data.potential_minutes_by_line) {
                        var linePotential = data.potential_minutes_by_line[line];
                        var p = document.createElement('p');
                        p.innerHTML = '<strong>Line ' + line + ':</strong> Potential Minutes: ' + linePotential;
                        potentialContentDiv.appendChild(p);
                    }
                }
                // Update scrap totals by line.
                if (data.scrap_totals_by_line) {
                    var scrapByLineDiv = document.getElementById('scrap-totals-by-line');
                    scrapByLineDiv.innerHTML = '<div class="card shadow-sm mb-4"><div class="card-header bg-light"><h2 class="h5 mb-0">Scrap Totals by Line</h2></div><div class="card-body" id="scrap-line-totals-content"></div></div>';
                    var scrapContentDiv = document.getElementById('scrap-line-totals-content');
                    for (var line in data.scrap_totals_by_line) {
                        var scrapTotal = data.scrap_totals_by_line[line];
                        var p = document.createElement('p');
                        p.innerHTML = '<strong>Line ' + line + ':</strong> Scrap: ' + scrapTotal;
                        scrapContentDiv.appendChild(p);
                    }
                }
                // Update overall scrap total.
                if (data.overall_scrap_total !== undefined) {
                    var overallScrapDiv = document.getElementById('overall-scrap-total');
                    overallScrapDiv.innerHTML = '<div class="card shadow-sm mb-4"><div class="card-header bg-light"><h2 class="h5 mb-0">Overall Scrap Total</h2></div><div class="card-body"><p><strong>Total Scrap:</strong> <span id="scrap-total">Loading...</span></p></div></div>';
                    document.getElementById('scrap-total').innerText = data.overall_scrap_total;
                }

                // Update OEE Metrics overall and by line.
                if (data.oee_metrics && data.oee_metrics.overall) {
                    document.getElementById('overall-A').innerText = data.oee_metrics.overall.A.toFixed(2);
                    document.getElementById('overall-P').innerText = data.oee_metrics.overall.P.toFixed(2);
                    document.getElementById('overall-Q').innerText = data.oee_metrics.overall.Q.toFixed(2);
                    document.getElementById('overall-OEE').innerText = data.oee_metrics.overall.OEE.toFixed(2);
                }

                if (data.oee_metrics && data.oee_metrics.by_line) {
                    var oeeByLineDiv = document.getElementById('oee-by-line');
                    oeeByLineDiv.innerHTML = '<div class="card shadow-sm mb-4"><div class="card-header bg-light"><h2 class="h5 mb-0">OEE Metrics by Line</h2></div><div class="card-body" id="oee-line-content"></div></div>';
                    var oeeLineContentDiv = document.getElementById('oee-line-content');
                    for (var line in data.oee_metrics.by_line) {
                        var metrics = data.oee_metrics.by_line[line];
                        var p = document.createElement('p');
                        p.innerHTML = '<strong>Line ' + line + ':</strong> A: ' + metrics.A.toFixed(2) +
                                    ', P: ' + metrics.P.toFixed(2) +
                                    ', Q: ' + metrics.Q.toFixed(2) +
                                    ', OEE: ' + metrics.OEE.toFixed(2);
                        oeeLineContentDiv.appendChild(p);
                    }
                }

            })
            .catch(error => console.error('Error fetching production data:', error));
    }
});
</script>
{% endblock %}
