{% extends "parent.html" %}
{% load static %}

{% block content %}
<div class="container mt-4">
    <!-- Header and Date Picker -->
    <div class="row mb-4">
        <div class="col-md-8">
            <h1>Production Data for <span id="selected-date-display">{{ selected_date }}</span></h1>
        </div>
        <div class="col-md-4">
            <form id="dateForm" class="form-inline">
                <div class="mb-3">
                    <label for="datePicker" class="form-label me-2">Select Date:</label>
                    <input type="date" id="datePicker" class="form-control" value="{{ selected_date }}">
                </div>
            </form>
        </div>
    </div>

    <!-- Summary Totals -->
    <div class="card mb-4">
        <div class="card-header">
            <h2 class="h5 mb-0">Overall Totals</h2>
        </div>
        <div class="card-body">
            <p><strong>Overall Produced Parts:</strong> <span id="overall-produced">Loading...</span></p>
            <p><strong>Overall Target:</strong> <span id="overall-target">Loading...</span></p>
        </div>
    </div>

    <!-- Overall Downtime Totals -->
    <div class="card mb-4">
        <div class="card-header">
            <h2 class="h5 mb-0">Overall Downtime</h2>
        </div>
        <div class="card-body">
            <p><strong>Overall Downtime:</strong> <span id="overall-downtime">Loading...</span></p>
        </div>
    </div>

    <!-- Totals by Line for Production -->
    <div id="totals-by-line" class="mb-4"></div>

    <!-- Downtime Totals by Line -->
    <div id="downtime-totals-by-line" class="mb-4"></div>

    <!-- Production Data Cards -->
    <div id="productionData">
        {% for line in lines %}
        <div class="card mb-4">
            <div class="card-header">
                <h2 class="h5 mb-0">Line: {{ line.line }}</h2>
            </div>
            <div class="card-body">
                {% for operation in line.operations %}
                <h3 class="h6">Operation: {{ operation.op }}</h3>
                <div class="row">
                    {% for machine in operation.machines %}
                    <div class="col-md-4 mb-3">
                        <div class="card h-100">
                            <div class="card-body">
                                <p><strong>Machine Number:</strong> {{ machine.number }}</p>
                                <p><strong>Target:</strong> {{ machine.target }}</p>
                                {% if machine.part_numbers %}
                                    <p><strong>Part Numbers:</strong> {{ machine.part_numbers|join:", " }}</p>
                                {% endif %}
                                <p>
                                    <strong>Parts:</strong>
                                    <span class="produced" data-line="{{ line.line }}" data-machine="{{ machine.number }}">
                                        Loading...
                                    </span>
                                </p>
                                <p>
                                    <strong>Downtime:</strong>
                                    <span class="downtime" data-line="{{ line.line }}" data-machine="{{ machine.number }}">
                                        Loading...
                                    </span>
                                </p>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
                {% endfor %}
            </div>
        </div>
        {% endfor %}
    </div>
</div>

<!-- JavaScript to fetch and update production and downtime data -->
<script>
    document.addEventListener("DOMContentLoaded", function() {
        function fetchProductionData(selectedDate) {
            fetch("{% url 'prod_query:fetch_oa_by_day_production_data' %}?date=" + selectedDate)
                .then(response => response.json())
                .then(data => {
                    // Update each machine's production data
                    document.querySelectorAll('.produced').forEach(function(elem) {
                        var lineName = elem.getAttribute('data-line');
                        var machineNumber = elem.getAttribute('data-machine');
                        if (data.production_data[lineName] && data.production_data[lineName][machineNumber]) {
                            elem.innerText = data.production_data[lineName][machineNumber].produced_parts;
                        } else {
                            elem.innerText = '0';
                        }
                    });

                    // Update each machine's downtime data
                    document.querySelectorAll('.downtime').forEach(function(elem) {
                        var lineName = elem.getAttribute('data-line');
                        var machineNumber = elem.getAttribute('data-machine');
                        if (data.production_data[lineName] && data.production_data[lineName][machineNumber] && 
                            data.production_data[lineName][machineNumber].downtime_minutes !== undefined) {
                            // Display downtime in minutes with two decimal places.
                            elem.innerText = parseFloat(data.production_data[lineName][machineNumber].downtime_minutes).toFixed(2) + " min";
                        } else {
                            elem.innerText = '0 min';
                        }
                    });
                    
                    // Update overall production totals
                    if(data.overall_totals) {
                        document.getElementById('overall-produced').innerText = data.overall_totals.total_produced;
                        document.getElementById('overall-target').innerText = data.overall_totals.total_target;
                    }
                    
                    // Update overall downtime totals
                    if(data.overall_downtime) {
                        var overallDowntimeMinutes = parseFloat(data.overall_downtime.downtime_minutes).toFixed(2);
                        document.getElementById('overall-downtime').innerText = overallDowntimeMinutes + " min";
                    }
                    
                    // Update totals by line for production
                    if(data.totals_by_line) {
                        var totalsByLineDiv = document.getElementById('totals-by-line');
                        totalsByLineDiv.innerHTML = '<div class="card"><div class="card-header"><h2 class="h5 mb-0">Totals by Line</h2></div><div class="card-body" id="line-totals-content"></div></div>';
                        var contentDiv = document.getElementById('line-totals-content');
                        for (var line in data.totals_by_line) {
                            var lineTotal = data.totals_by_line[line];
                            var p = document.createElement('p');
                            p.innerHTML = '<strong>Line ' + line + ':</strong> Parts: ' + lineTotal.total_produced + ', Target: ' + lineTotal.total_target;
                            contentDiv.appendChild(p);
                        }
                    }

                    // Update downtime totals by line
                    if(data.downtime_totals_by_line) {
                        var downtimeByLineDiv = document.getElementById('downtime-totals-by-line');
                        downtimeByLineDiv.innerHTML = '<div class="card"><div class="card-header"><h2 class="h5 mb-0">Downtime Totals by Line</h2></div><div class="card-body" id="downtime-line-totals-content"></div></div>';
                        var dtContentDiv = document.getElementById('downtime-line-totals-content');
                        for (var line in data.downtime_totals_by_line) {
                            var dtTotalSeconds = data.downtime_totals_by_line[line];
                            var dtTotalMinutes = (dtTotalSeconds / 60).toFixed(2);
                            var p = document.createElement('p');
                            p.innerHTML = '<strong>Line ' + line + ':</strong> Downtime: ' + dtTotalMinutes + ' min (' + dtTotalSeconds + ' sec)';
                            dtContentDiv.appendChild(p);
                        }
                    }
                })
                .catch(error => console.error('Error fetching production data:', error));
        }

        var datePicker = document.getElementById("datePicker");
        var selectedDateDisplay = document.getElementById("selected-date-display");

        // Initial fetch on page load.
        fetchProductionData(datePicker.value);

        // When the user selects a new date, update the header and refresh data.
        datePicker.addEventListener("change", function() {
            selectedDateDisplay.innerText = this.value;
            fetchProductionData(this.value);
        });
    });
</script>
{% endblock %}
