{% extends "parent.html" %}

{% block title %}
  Production Query
{% endblock %}

{% block extra_styles %}
<style>
  .clickable { 
    cursor: pointer; 
  }
</style>
{% endblock %}

{% block content %}
<div class="col-12 mb-4">
  <h1 class="fw-bolder text-center">Production Query</h1>
</div>

<!-- Input Form Card -->
<div class="col-md-8 mx-auto">
  <div class="card shadow-sm border-0">
    <div class="card-header bg-dark text-white">
      <h5 class="mb-0">Query Input</h5>
    </div>
    <div class="card-body">
      <form method="post">
        {% csrf_token %}
        <div class="table-responsive">
          <table class="table">
            {{ form.as_table }}
          </table>
        </div>
        <div class="text-end">
          <button type="submit" class="btn btn-warning">Submit</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Production Data Table(s) -->
{% if production|length %}
  {% if is_weekly_shifts %}
    <!-- Week by 8-hour Shifts Card -->
    <div class="col-12 mt-5">
      <div class="card shadow-sm border-0">
        <div class="card-header" style="background-color: rgb(27, 91, 94); color: white;">
          <h5 class="mb-0 text-center">Week by 8-hour Shifts</h5>
        </div>
        <div class="card-body">
          <div class="table-responsive">
            <table class="table table-bordered table-striped table-hover align-middle">
              <thead class="table-dark">
                <tr>
                  <th rowspan="2">Machine</th>
                  <th rowspan="2">Part</th>
                  <th colspan="3">Monday</th>
                  <th colspan="3">Tuesday</th>
                  <th colspan="3">Wednesday</th>
                  <th colspan="3">Thursday</th>
                  <th colspan="3">Friday</th>
                  <th colspan="3">Saturday</th>
                  <th colspan="3">Sunday</th>
                  <th rowspan="2">Total</th>
                </tr>
                <tr>
                  <th>Mid</th>
                  <th>Days</th>
                  <th>Aft</th>
                  <th>Mid</th>
                  <th>Days</th>
                  <th>Aft</th>
                  <th>Mid</th>
                  <th>Days</th>
                  <th>Aft</th>
                  <th>Mid</th>
                  <th>Days</th>
                  <th>Aft</th>
                  <th>Mid</th>
                  <th>Days</th>
                  <th>Aft</th>
                  <th>Mid</th>
                  <th>Days</th>
                  <th>Aft</th>
                  <th>Mid</th>
                  <th>Days</th>
                  <th>Aft</th>
                </tr>
              </thead>
              <tbody>
                {% for row in production %}
                <tr class="clickable" 
                    onclick="parent.location='{% url 'prod_query:machine_detail' machine=row.0 start_timestamp=ts times=times %}'">
                  <td>{{ row.0 }}</td>
                  <td>{{ row.1 }}</td>
                  <td>{{ row.2 }}</td>
                  <td>{{ row.3 }}</td>
                  <td>{{ row.4 }}</td>
                  <td>{{ row.5 }}</td>
                  <td>{{ row.6 }}</td>
                  <td>{{ row.7 }}</td>
                  <td>{{ row.8 }}</td>
                  <td>{{ row.9 }}</td>
                  <td>{{ row.10 }}</td>
                  <td>{{ row.11 }}</td>
                  <td>{{ row.12 }}</td>
                  <td>{{ row.13 }}</td>
                  <td>{{ row.14 }}</td>
                  <td>{{ row.15 }}</td>
                  <td>{{ row.16 }}</td>
                  <td>{{ row.17 }}</td>
                  <td>{{ row.18 }}</td>
                  <td>{{ row.19 }}</td>
                  <td>{{ row.20 }}</td>
                  <td>{{ row.21 }}</td>
                  <td>{{ row.22 }}</td>
                  <td>{{ row.23 }}</td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  {% else %}
  <!-- Fallback Production Table -->
  <div class="col-12 mt-5">
    <div class="card shadow-sm border-0">
      <div class="card-header" style="background-color: rgb(27, 91, 94); color: white;">
        <h5 class="mb-0 text-center">Production Data</h5>
      </div>
      <div class="card-body">
        <div class="table-responsive">
          <table class="table table-bordered table-striped table-hover align-middle">
              <thead class="table-dark">
                <tr>
                  <th>Machine</th>
                  <th>Part</th>
                  {% if times <= 6 %}
                    <th>Hour 1</th>
                    <th>Hour 2</th>
                    <th>Hour 3</th>
                    <th>Hour 4</th>
                    <th>Hour 5</th>
                    <th>Hour 6</th>
                    <th>Hour 7</th>
                    <th>Hour 8</th>
                    <th>Total</th>
                  {% elif times <= 8 %}
                    <th>Days</th>
                    <th>Afts</th>
                    <th>Mid</th>
                    <th>Total</th>
                  {% elif times <= 10 %}
                    <th>Monday</th>
                    <th>Tuesday</th>
                    <th>Wednesday</th>
                    <th>Thursday</th>
                    <th>Friday</th>
                    <th>Saturday</th>
                    <th>Sunday</th>
                    <th>Total</th>
                  {% endif %}
                </tr>
              </thead>
              <tbody>
                {% for line in production %}
                <tr class="clickable" 
                    onclick="parent.location='{% url 'prod_query:machine_detail' machine=line.0 start_timestamp=ts times=times %}'">
                  {% for item in line %}
                    {% if forloop.counter0 == 0 %}
                      <td>{{ item }}</td>
                    {% elif forloop.counter0 == 1 %}
                      <td>{{ item }}</td>
                    {% else %}
                      <td>{{ item }}</td>
                    {% endif %}
                  {% endfor %}
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  {% endif %}

  <div class="col-12 mt-3">
    <p><strong>Times:</strong> {{ times }}</p>
    <p><strong>Start Date:</strong> {{ start }}</p>
    <p><strong>End Date:</strong> {{ end }}</p>
    <p><strong>Timestamp:</strong> {{ ts }}</p>
    <p><strong>Elapsed:</strong> {{ elapsed_time|floatformat:3 }} seconds</p>
  </div>
{% endif %}

{% endblock %}

{% block extra_js %}
<script>
  document.addEventListener("DOMContentLoaded", () => {
    const tables = document.querySelectorAll(".table");
    tables.forEach((table) => {
      const rows = table.querySelectorAll("tbody tr");
      if (rows.length === 0) return;

      const numCols = rows[0].children.length;
      const totalsRow = document.createElement("tr");

      for (let i = 0; i < numCols; i++) {
        const totalCell = document.createElement("td");
        if (i === 0) {
          totalCell.textContent = "Totals";
          totalCell.colSpan = 2;
          i++;
        } else {
          let total = 0;
          rows.forEach((row) => {
            const cellValue = parseFloat(row.children[i].textContent) || 0;
            total += cellValue;
          });
          totalCell.textContent = total.toFixed(0);
        }
        totalsRow.appendChild(totalCell);
      }

      const tfoot = document.createElement("tfoot");
      tfoot.appendChild(totalsRow);
      table.appendChild(tfoot);
    });
  });
</script>
{% endblock %}
