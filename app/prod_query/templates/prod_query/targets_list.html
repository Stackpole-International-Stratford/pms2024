{# templates/prod_query/targets_list.html #}
{% extends "parent.html" %}

{% block content %}
<div style="height: 2rem;"></div>  <!-- spacer div -->

<h1 class="text-center mb-5">
    OEE: Ideal Cycle Times (Machine Targets)
  </h1>
  
  <div style="height: 2rem;"></div>  <!-- spacer div -->


  {% if targets %}
    <table id="targets-table" class="table table-striped">
      <thead>
        <tr>
          <th>Machine ID</th>
          <th>Line</th>
          <th>Cycle Time (s)</th>
          <th>Effective (EST)</th>
          <th>Created At</th>
          <th>Comment</th>
          <th>Actions</th>
        </tr>
        <tr>
          <th><input class="column-filter form-control" data-column="0" placeholder="Filter Machine…"></th>
          <th><input class="column-filter form-control" data-column="1" placeholder="Filter Line…"></th>
          <th><input class="column-filter form-control" data-column="2" placeholder="Filter Cycle…"></th>
          <th><input class="column-filter form-control" data-column="3" placeholder="Filter Effective…"></th>
          <th><input class="column-filter form-control" data-column="4" placeholder="Filter Created…"></th>
          <th><input class="column-filter form-control" data-column="5" placeholder="Filter Comment…"></th>
          <th>  <!-- Add New Target Button -->
            <button id="add-target-btn"
                    class="btn btn-warning btn-sm"
                    data-bs-toggle="modal"
                    data-bs-target="#targetModal">
              <i class="bi bi-plus"></i> Add New Target
            </button></th>
        </tr>
      </thead>
      <tbody>
        {% for t in targets %}
          <tr data-id="{{ t.id }}">
            <td class="col-machine">{{ t.machine_id }}</td>
            <td class="col-line">{{ t.line|default:"—" }}</td>
            <td class="col-cycle">{{ t.cycle_time_seconds|floatformat:2 }}</td>
            <td class="col-effective">{{ t.effective_date_est|date:"Y‑m‑d" }}</td>
            <td class="col-created">{{ t.created_at|date:"Y‑m‑d H:i" }}</td>
            <td class="col-comment">{{ t.comment|default:"—" }}</td>
            <td>
                <button type="button"
                class="btn btn-sm btn-light edit-btn p-1"
                data-bs-toggle="modal"
                data-bs-target="#editTargetModal"
                title="Edit Target"
                style="color: black;">
          <svg xmlns="http://www.w3.org/2000/svg"
               width="16" height="16"
               fill="black"
               viewBox="0 0 16 16">
            <path d="M12.146.146a.5.5 0 0 1 .708 0l3 3a.5.5 0 0 1 0 
                     .708l-10 10a.5.5 0 0 1-.168.11l-5 2a.5.5 
                     0 0 1-.65-.65l2-5a.5.5 0 0 
                     1 .11-.168zM11.207 2.5 13.5 
                     4.793 14.793 3.5 12.5 
                     1.207zm1.586 3L10.5 3.207 4 
                     9.707V10h.5a.5.5 0 0 
                     1 .5.5v.5h.5a.5.5 0 0 
                     1 .5.5v.5h.293zm-9.761 
                     5.175-.106.106-1.528 
                     3.821 3.821-1.528.106-.106A.5.5 
                     0 0 1 5 12.5V12h-.5a.5.5 0 
                     0 1-.5-.5V11h-.5a.5.5 0 
                     0 1-.468-.325"/>
          </svg>
        </button>        
            </td>
          </tr>
        {% endfor %}
      </tbody>
    </table>
  {% else %}
    <p>No targets have been set yet.</p>
  {% endif %}

  {# ─────────── Add New Modal ─────────── #}
  <div class="modal fade" id="targetModal" tabindex="-1" aria-labelledby="targetModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <form id="target-form" class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="targetModalLabel">Add New Target</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <div class="mb-3">
            <label for="machine-input" class="form-label">Machine ID</label>
            <input type="text" id="machine-input" class="form-control" required>
          </div>
          <div class="mb-3">
            <label for="line-select" class="form-label">Line</label>
            <select id="line-select" class="form-select" required>
              <option value="">Choose…</option>
              <option>AB1V Reaction</option>
              <option>AB1V Input</option>
              <option>AB1VB Overdrive</option>
              <option>10R80</option>
              <option>10R60</option>
              <option>10R140</option>
              <option>Presses</option>
            </select>
          </div>
          <div class="mb-3">
            <label for="cycle-input" class="form-label">Cycle Time (s)</label>
            <input type="number" step="0.01" id="cycle-input" class="form-control" required>
          </div>
          <div class="mb-3">
            <label for="date-input" class="form-label">Effective Date</label>
            <input type="date" id="date-input" class="form-control" value="{% now 'Y-m-d' %}" required>
          </div>
          <div class="mb-3">
            <label for="comment-input" class="form-label">Comment</label>
            <textarea id="comment-input"
                      class="form-control"
                      rows="3"
                      placeholder="Up to 100 words…"></textarea>
            <div class="form-text">
              <span id="add-word-count">0</span>/100 words
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-dark" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-warning">Save Target</button>
        </div>
      </form>
    </div>
  </div>

  {# ─────────── Edit Modal ─────────── #}
  <div class="modal fade" id="editTargetModal" tabindex="-1" aria-labelledby="editTargetModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <form id="edit-target-form" class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="editTargetModalLabel">Edit Target</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <input type="hidden" id="edit-id">
          <div class="mb-3">
            <label for="edit-machine" class="form-label">Machine ID</label>
            <input type="text" id="edit-machine" class="form-control" required>
          </div>
          <div class="mb-3">
            <label for="edit-line" class="form-label">Line</label>
            <select id="edit-line" class="form-select" required>
              <option value="">Choose…</option>
              <option>AB1V Reaction</option>
              <option>AB1V Input</option>
              <option>AB1VB Overdrive</option>
              <option>10R80</option>
              <option>10R60</option>
              <option>10R140</option>
              <option>Presses</option>
            </select>
          </div>
          <div class="mb-3">
            <label for="edit-cycle" class="form-label">Cycle Time (s)</label>
            <input type="number" step="0.01" id="edit-cycle" class="form-control" required>
          </div>
          <div class="mb-3">
            <label for="edit-date" class="form-label">Effective Date</label>
            <input type="date" id="edit-date" class="form-control" required>
          </div>
          <div class="mb-3">
            <label for="edit-comment" class="form-label">Comment</label>
            <textarea id="edit-comment"
                      class="form-control"
                      rows="3"
                      placeholder="Up to 100 words…"></textarea>
            <div class="form-text">
              <span id="edit-word-count">0</span>/100 words
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-dark" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-warning">Save Changes</button>
        </div>
      </form>
    </div>
  </div>

  <script>
    // CSRF helper
    function getCookie(name) {
      let cookieValue = null;
      if (document.cookie && document.cookie !== '') {
        document.cookie.split(';').forEach(c => {
          c = c.trim();
          if (c.startsWith(name + '=')) {
            cookieValue = decodeURIComponent(c.slice(name.length + 1));
          }
        });
      }
      return cookieValue;
    }
    const csrftoken = getCookie('csrftoken');

    document.addEventListener('DOMContentLoaded', () => {
      const table = document.getElementById('targets-table');
      const filters = table?.querySelectorAll('.column-filter') || [];

      // Live‐filter logic
      function filterTable() {
        const vals = Array.from(filters).map(f => f.value.trim().toLowerCase());
        Array.from(table.tBodies[0].rows).forEach(row => {
          const cells = row.cells;
          const show = vals.every((v, i) =>
            !v || cells[i].textContent.toLowerCase().includes(v)
          );
          row.style.display = show ? '' : 'none';
        });
      }
      filters.forEach(inp => inp.addEventListener('input', filterTable));

      // Word‐limit enforcement
      function enforceWordLimit(txtEl, counterEl) {
        txtEl.addEventListener('input', () => {
          let words = txtEl.value.trim().split(/\s+/).filter(w => w);
          if (words.length > 100) {
            txtEl.value = words.slice(0, 100).join(' ');
            words = words.slice(0, 100);
          }
          counterEl.textContent = words.length;
        });
      }
      enforceWordLimit(
        document.getElementById('comment-input'),
        document.getElementById('add-word-count')
      );
      enforceWordLimit(
        document.getElementById('edit-comment'),
        document.getElementById('edit-word-count')
      );

      // Add‐new AJAX
      document.getElementById('target-form').addEventListener('submit', async e => {
        e.preventDefault();
        const data = {
          machine: document.getElementById('machine-input').value,
          line: document.getElementById('line-select').value,
          cycle_time: document.getElementById('cycle-input').value,
          effective_date: document.getElementById('date-input').value,
          comment: document.getElementById('comment-input').value
        };
        const resp = await fetch("/prod-query/targets/new/", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "X-CSRFToken": csrftoken
          },
          body: JSON.stringify(data),
        });
        if (resp.ok) {
          location.reload();
        } else {
          const err = await resp.json();
          alert("Error: " + (err.error || "Unknown"));
        }
      });

      // Populate Edit Modal
      table.querySelectorAll('.edit-btn').forEach(btn => {
        btn.addEventListener('click', e => {
          const row = e.target.closest('tr');
          document.getElementById('edit-id').value = row.dataset.id;
          document.getElementById('edit-machine').value = row.querySelector('.col-machine').textContent.trim();
          document.getElementById('edit-line').value = row.querySelector('.col-line').textContent.trim();
          document.getElementById('edit-cycle').value = row.querySelector('.col-cycle').textContent.trim();
          document.getElementById('edit-date').value = row.querySelector('.col-effective').textContent.trim();
          document.getElementById('edit-comment').value = row.querySelector('.col-comment').textContent.trim();
        });
      });

      // Edit‐AJAX
      document.getElementById('edit-target-form').addEventListener('submit', async e => {
        e.preventDefault();
        const id = document.getElementById('edit-id').value;
        const data = {
          machine: document.getElementById('edit-machine').value,
          line: document.getElementById('edit-line').value,
          cycle_time: document.getElementById('edit-cycle').value,
          effective_date: document.getElementById('edit-date').value,
          comment: document.getElementById('edit-comment').value
        };
        const resp = await fetch(`/prod-query/targets/${id}/edit/`, {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "X-CSRFToken": csrftoken
          },
          body: JSON.stringify(data)
        });
        if (resp.ok) {
          location.reload();
        } else {
          const err = await resp.json();
          alert("Error: " + (err.error || "Unknown"));
        }
      });
    });
  </script>
{% endblock %}
