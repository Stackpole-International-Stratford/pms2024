{# templates/prod_query/targets_list.html #}
{% extends "parent.html" %}

{% block content %}
  <h1>Machine Targets</h1>

  <!-- Add New button -->
  <button id="add-target-btn" class="btn btn-warning mb-3" data-bs-toggle="modal" data-bs-target="#targetModal">
    <i class="bi bi-plus"></i> Add New Target
  </button>

  {% if targets %}
    <table id="targets-table" class="table table-striped">
      <thead>
        <tr>
          <th>Machine ID</th>
          <th>Line</th>
          <th>Target Cycle Time (s)</th>
          <th>Effective (EST)</th>
          <th>Created At</th>
        </tr>
        <tr>
          <th><input type="text" class="column-filter form-control" data-column="0" placeholder="Filter Machine…"></th>
          <th><input type="text" class="column-filter form-control" data-column="1" placeholder="Filter Line…"></th>
          <th><input type="text" class="column-filter form-control" data-column="2" placeholder="Filter Cycle…"></th>
          <th><input type="text" class="column-filter form-control" data-column="3" placeholder="Filter Effective…"></th>
          <th><input type="text" class="column-filter form-control" data-column="4" placeholder="Filter Created…"></th>
        </tr>
      </thead>
      <tbody>
        {% for t in targets %}
          <tr>
            <td>{{ t.machine_id }}</td>
            <td>{{ t.line|default:"—" }}</td>
            <td>{{ t.cycle_time_seconds|floatformat:2 }}</td>
            <td>{{ t.effective_date_est|date:"Y‑m‑d" }}</td>
            <td>{{ t.created_at|date:"Y‑m‑d H:i:s" }}</td>
          </tr>
        {% endfor %}
      </tbody>
    </table>
  {% else %}
    <p>No targets have been set yet.</p>
  {% endif %}

  <!-- Bootstrap Modal -->
  <div class="modal fade" id="targetModal" tabindex="-1" aria-labelledby="targetModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <form id="target-form" class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="targetModalLabel">Add New Target</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <div class="mb-3">
            <label for="machine-input" class="form-label">Machine ID</label>
            <input type="text" id="machine-input" class="form-control" required>
          </div>
          <div class="mb-3">
            <label for="line-select" class="form-label">Line</label>
            <select id="line-select" class="form-select" required>
              <option value="">Choose…</option>
              <option>AB1V Reaction</option>
              <option>AB1V Input</option>
              <option>AB1VB Overdrive</option>
              <option>10R80</option>
              <option>10R60</option>
              <option>10R140</option>
              <option>Presses</option>
            </select>
          </div>
          <div class="mb-3">
            <label for="cycle-input" class="form-label">Cycle Time (s)</label>
            <input type="number" step="0.01" id="cycle-input" class="form-control" required>
          </div>
          <div class="mb-3">
            <label for="date-input" class="form-label">Effective Date</label>
            <input type="date" id="date-input" class="form-control" value="{% now 'Y-m-d' %}" required>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-dark" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-warning">Save Target</button>
        </div>
      </form>
    </div>
  </div>

  <script>
  // CSRF helper (Django)
  function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
      document.cookie.split(';').forEach(c => {
        c = c.trim();
        if (c.startsWith(name + '=')) {
          cookieValue = decodeURIComponent(c.slice(name.length + 1));
        }
      });
    }
    return cookieValue;
  }
  const csrftoken = getCookie('csrftoken');

  // Live‐filter logic
  document.addEventListener('DOMContentLoaded', () => {
    const table   = document.getElementById('targets-table');
    const filters = table?.querySelectorAll('.column-filter') || [];

    function filterTable() {
      const vals = Array.from(filters).map(f => f.value.trim().toLowerCase());
      Array.from(table.tBodies[0].rows).forEach(row => {
        const cells = row.cells;
        const show = vals.every((v,i) => !v || cells[i].textContent.toLowerCase().includes(v));
        row.style.display = show ? '' : 'none';
      });
    }
    filters.forEach(inp => inp.addEventListener('input', filterTable));
  });

  // AJAX submit
  document.getElementById('target-form').addEventListener('submit', async e => {
    e.preventDefault();
    const data = {
      machine: document.getElementById('machine-input').value,
      line:    document.getElementById('line-select').value,
      cycle_time: document.getElementById('cycle-input').value,
      effective_date: document.getElementById('date-input').value
    };
    const resp = await fetch("/prod-query/targets/new/", {
        method: "POST",
        headers: {
        "Content-Type": "application/json",
        "X-CSRFToken": csrftoken
      },
      body: JSON.stringify(data),
    });
    if (resp.ok){
      // reload to see the new row
      location.reload();
    } else {
      const err = await resp.json();
      alert("Error: " + (err.error || "Unknown"));
    }
  });
  </script>
{% endblock %}
