{% extends "parent.html" %}
{% load static %}
{% block content %}
<div class="container mt-4">
  {% csrf_token %}
  {{ user_roles|json_script:"user‑roles-json" }}   {# ←  place it here #}

  <h1 class="mb-4">Open Downtime Events</h1>


  {% if is_manager %}

    {# ───────────────────── New‑employee button + modal ───────────────────── #}

  <!-- Button -->
  <button type="button"
          class="btn btn-warning mb-3"
          data-bs-toggle="modal"
          data-bs-target="#newEmployeeModal">
    Add New or Update Employee
  </button>

  <!-- Modal (place it once per page, usually near bottom) -->
  <div class="modal fade" id="newEmployeeModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
      <form method="post" action="{% url 'add_employee' %}" class="modal-content">
        {% csrf_token %}
        <div class="modal-header">
          <h5 class="modal-title">Add New or Update Employee</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>

        <div class="modal-body">
          <div class="mb-3">
            <label for="empFirst" class="form-label">First name</label>
            <input id="empFirst" name="first_name" class="form-control" required>
          </div>
          <div class="mb-3">
            <label for="empLast" class="form-label">Last name</label>
            <input id="empLast" name="last_name" class="form-control" required>
          </div>

          <p class="mb-1 fw-semibold">Profession(s)</p>
          <div class="form-check">
            <input class="form-check-input" type="checkbox"
                   name="roles" value="electrician" id="role_elec">
            <label class="form-check-label" for="role_elec">Electrician</label>
          </div>
          <div class="form-check">
            <input class="form-check-input" type="checkbox"
                   name="roles" value="millwright" id="role_mill">
            <label class="form-check-label" for="role_mill">Millwright</label>
          </div>
          <div class="form-check">
            <input class="form-check-input" type="checkbox"
                   name="roles" value="tech" id="role_tech">
            <label class="form-check-label" for="role_tech">Tech</label>
          </div>
        </div>

        <div class="modal-footer">
          <button type="button" class="btn btn-dark"
                  data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-warning">Save</button>
        </div>
      </form>
    </div>
  </div>
  {# ───────────────────────── Line priorities accordion ────────────────────────── #}
  <div class="accordion mt-5 mb-4" id="linesPriorityAccordion">
    <div class="accordion-item">
      <h2 class="accordion-header" id="linesPriorityHeading">
        <button class="accordion-button d-flex justify-content-between"
                type="button"
                data-bs-toggle="collapse"
                data-bs-target="#linesPriorityCollapse"
                aria-expanded="false"
                aria-controls="linesPriorityCollapse">
          <span>Line Priorities</span>
        </button>
      </h2>

      <div id="linesPriorityCollapse"
           class="accordion-collapse collapse"
           aria-labelledby="linesPriorityHeading"
           data-bs-parent="#linesPriorityAccordion">

        <div class="accordion-body p-0">

          <ul class="list-group list-group-flush">
            {% for lp in line_priorities %}
              <li class="list-group-item d-flex justify-content-between align-items-center">

                {# ►► left side: line name + arrow buttons                         #}
                <div class="d-flex align-items-center gap-2">
                  <strong>{{ lp.line }}</strong>

                  {# move‑up form — hidden if already top priority (#1)            #}
                  {% if not forloop.first %}
                  <form method="post"
                        action="{% url 'move_line_priority' lp.id 'up' %}"
                        class="d-inline">
                    {% csrf_token %}
                    <button class="btn btn-sm btn-outline-secondary py-0 px-1"
                            title="Move up one">
                      ▲
                    </button>
                  </form>
                  {% endif %}

                  {# move‑down form — hidden if last entry                         #}
                  {% if not forloop.last %}
                  <form method="post"
                        action="{% url 'move_line_priority' lp.id 'down' %}"
                        class="d-inline">
                    {% csrf_token %}
                    <button class="btn btn-sm btn-outline-secondary py-0 px-1"
                            title="Move down one">
                      ▼
                    </button>
                  </form>
                  {% endif %}
                </div>

                {# ►► right side: coloured priority badge                         #}
                {% if lp.priority <= 3 %}
                  <span class="badge bg-danger rounded-pill">{{ lp.priority }}</span>
                {% elif lp.priority <= 7 %}
                  <span class="badge bg-warning text-dark rounded-pill">{{ lp.priority }}</span>
                {% else %}
                  <span class="badge bg-success rounded-pill">{{ lp.priority }}</span>
                {% endif %}

              </li>
            {% empty %}
              <li class="list-group-item text-muted">
                No line priorities defined.
              </li>
            {% endfor %}
          </ul>

        </div>
      </div>
    </div>
  </div>
  {# ───────────────────────── end accordion ────────────────────────────────────── #}
  {% endif %}



{# ───────────────────────── downtime events table ────────────────── #}
  <div class="table-responsive mt-4">
    <table class="table table-striped table-hover table-bordered align-middle">
      <thead class="table-light">
        <tr>
          <th>Start</th>
          <th>Close-out</th>
          <th>Line</th>
          <th>Machine</th>
          <th>Category</th>
          <th>Sub-category</th>
          <th>Labour&nbsp;Needed</th>
          <th>Comment</th>
        </tr>
      </thead>
      <tbody>
        {% for e in entries %}
        <tr class="{% if not e.closeout_epoch %}table-warning{% endif %}">
          {# ── Start time, conditionally formatted ── #}
          <td>{{ e.start_display }}</td>


          {# Close-out #}
          <td>
            {% if e.closeout_epoch %}
              {{ e.closeout_epoch|date:"Y-m-d H:i" }}
            {% else %}
              <button class="btn btn-sm btn-info closeout-btn"
                      data-entry-id="{{ e.id }}">
                Close&nbsp;out
              </button>
            {% endif %}
          </td>

          {# Line, Machine, Category, Sub-category #}
          <td>{{ e.line }}</td>
          <td>{{ e.machine }}</td>
          <td><span class="badge bg-dark">{{ e.category }}</span></td>
          <td><span class="badge bg-secondary">{{ e.subcategory }}</span></td>

          {# Labour needed badges #}
          <td>
            {% if e.labour_types %}
            {% for code in e.labour_types %}
            <button
            type="button"
            class="btn btn-outline-dark labour-btn me-1"
            data-event-id="{{ e.id }}"
            data-role="{{ code|title }}"
          >
            {{ code|title }}
          </button>
          
          
            {% endfor %}
          {% else %}
            <span class="text-muted">—</span>
          {% endif %}        
          </td>

          {# Comment #}
          <td>{{ e.comment }}</td>
        </tr>
        {% empty %}
        <tr>
          <td colspan="9" class="text-center py-4">No downtime events found.</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

  <div class="text-center mt-3">
    <button id="load-more-btn" class="btn btn-dark">Load&nbsp;More</button>
  </div>





  {# ─────────────── CLOSE‑OUT MODAL + SCRIPT (self‑contained) ─────────────── #}

  <!-- 1.  The modal itself -->
  <div class="modal fade" id="closeoutModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-sm">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Close Out Downtime</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>

        <div class="modal-body">
          <!-- hidden id -->
          <input type="hidden" id="closeout-entry-id">

          <div class="mb-3">
            <label for="closeout-date" class="form-label">Date</label>
            <input type="date" id="closeout-date" class="form-control" required>
          </div>

          <div class="mb-3">
            <label for="closeout-time" class="form-label">Time</label>
            <input type="time" id="closeout-time" class="form-control" required>
          </div>

          <div class="mb-3">
            <label for="closeout-comment" class="form-label">What was done?</label>
            <textarea id="closeout-comment"
                      class="form-control"
                      rows="3"
                      maxlength="2000"
                      required></textarea>
          </div>
        </div>

        <div class="modal-footer">
          <button type="button"
                  class="btn btn-secondary"
                  data-bs-dismiss="modal">
            Cancel
          </button>
          <button type="button"
                  id="closeout-confirm"
                  class="btn btn-info">
            Confirm
          </button>
        </div>
      </div>
    </div>
  </div>
    

<!-- -------------------------------------------------------------------------------------->
  
<!-- 1. History Modal -->
<div class="modal fade" id="historyModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Labour History</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <table class="table table-sm">
          <thead>
            <tr>
              <th>User</th>
              <th>Joined At</th>
              <th>Join Comment</th>
              <th>Left At</th>
              <th>Leave Comment</th>
              <th>Total Min</th>
            </tr>
          </thead>
          <tbody id="history-body">
            <!-- JS will inject <tr>…</tr> here -->
          </tbody>
        </table>
      </div>
      <div class="modal-footer">
        <button id="history-join-btn"
                type="button"
                class="btn btn-warning">
          Join
        </button>
        <button id="history-leave-btn"
                type="button"
                class="btn btn-outline-danger">
          Leave
        </button>
        <button type="button"
                class="btn btn-dark"
                data-bs-dismiss="modal">
          Close
        </button>
      </div>
    </div>
  </div>
</div>

<!-- 2. Join Modal -->
<div class="modal fade" id="joinModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-sm">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Join Event</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <input type="hidden" id="join-event-id">
        <div class="mb-3">
          <label class="form-label">Date &amp; Time</label>
          <input type="datetime-local"
                 id="join-datetime"
                 class="form-control"
                 readonly>
        </div>
        <div class="mb-3">
          <label for="join-comment" class="form-label">What will you do?</label>
          <textarea id="join-comment"
                    class="form-control"
                    rows="2"
                    required></textarea>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button"
                class="btn btn-dark"
                data-bs-dismiss="modal">
          Cancel
        </button>
        <button id="join-confirm-btn"
                type="button"
                class="btn btn-warning">
          Confirm Join
        </button>
      </div>
    </div>
  </div>
</div>

<!-- 3. Leave Modal -->
<div class="modal fade" id="leaveModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-sm">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Leave Event</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <input type="hidden" id="leave-event-id">
        <div class="mb-3">
          <label class="form-label">Date &amp; Time</label>
          <input type="datetime-local"
                 id="leave-datetime"
                 class="form-control"
                 readonly>
        </div>
        <div class="mb-3">
          <label for="leave-comment" class="form-label">What did you do?</label>
          <textarea id="leave-comment"
                    class="form-control"
                    rows="2"
                    required></textarea>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button"
                class="btn btn-secondary"
                data-bs-dismiss="modal">
          Cancel
        </button>
        <button id="leave-confirm-btn"
                type="button"
                class="btn btn-danger">
          Confirm Leave
        </button>
      </div>
    </div>
  </div>
</div>




<!-- -------------------------------------------------------------------------------------->


  
<!-- 2) Close-out modal logic -->
<script>
  document.addEventListener('DOMContentLoaded', () => {
    const modalEl      = document.getElementById('closeoutModal');
    const closeoutModal= new bootstrap.Modal(modalEl);
    const entryIdIn    = document.getElementById('closeout-entry-id');
    const dateIn       = document.getElementById('closeout-date');
    const timeIn       = document.getElementById('closeout-time');
    const commentIn    = document.getElementById('closeout-comment');
    const confirmBtn   = document.getElementById('closeout-confirm');
    const csrfToken    = document.querySelector('[name=csrfmiddlewaretoken]').value;
    const url          = "{% url 'closeout_downtime_entry' %}";
  
    document.querySelectorAll('.closeout-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        entryIdIn.value = btn.dataset.entryId;
        const now = new Date();
        dateIn.value    = now.toISOString().slice(0,10);
        timeIn.value    = now.toTimeString().slice(0,5);
        commentIn.value = '';
        confirmBtn.disabled = false;
        closeoutModal.show();
      });
    });
  
    confirmBtn.addEventListener('click', () => {
      const id   = entryIdIn.value;
      const date = dateIn.value;
      const time = timeIn.value;
      const note = commentIn.value.trim();
      if (!id || !date || !time || !note) {
        return alert('All fields are required.');
      }
      confirmBtn.disabled = true;
      fetch(url, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRFToken': csrfToken,
        },
        body: JSON.stringify({
          entry_id: id,
          closeout: `${date} ${time}`,
          closeout_comment: note
        })
      })
      .then(r => r.ok ? r.json() : Promise.reject())
      .then(() => {
        document
          .querySelector(`button.closeout-btn[data-entry-id="${id}"]`)
          .closest('tr')
          .remove();
        closeoutModal.hide();
      })
      .catch(() => alert('Error closing out entry.'))
      .finally(() => confirmBtn.disabled = false);
    });
  });
  </script>
  



  <script>
    document.addEventListener('DOMContentLoaded', () => {
      // ─── Track current user ───────────────────────────────────────────────
      const currentUser = "{{ request.user.username }}";
    
      // ─── Load-More logic ─────────────────────────────────────────────────
      const loadMoreBtn = document.getElementById('load-more-btn');
      const pageSize    = {{ page_size }};
      let offset        = pageSize;
      const loadUrl     = "{% url 'load_more_downtime_entries' %}";
    
      loadMoreBtn?.addEventListener('click', () => {
        loadMoreBtn.disabled = true;
        fetch(`${loadUrl}?offset=${offset}`)
          .then(r => r.ok ? r.json() : Promise.reject())
          .then(data => {
            const tbody = document.querySelector('table tbody');
            data.entries.forEach(e => tbody.insertAdjacentHTML('beforeend', renderRow(e)));
            offset += pageSize;
            if (!data.has_more) loadMoreBtn.remove();
            else loadMoreBtn.disabled = false;
          })
          .catch(() => {
            alert('Error loading more entries');
            loadMoreBtn.disabled = false;
          });
      });
    
      // ─── Labour-type live filter ──────────────────────────────────────────
      const labourCheckboxes = Array.from(document.querySelectorAll('.labour-filter'));
      function filterByLabour() {
        const sel = labourCheckboxes.filter(cb => cb.checked).map(cb => cb.value);
        document.querySelectorAll('table tbody tr').forEach(row => {
          const codes = Array.from(row.cells[6].querySelectorAll('span.badge.bg-info'))
                             .map(s => s.textContent.trim());
          row.style.display = sel.length === 0 || codes.some(c => sel.includes(c))
                              ? '' : 'none';
        });
      }
      labourCheckboxes.forEach(cb => cb.addEventListener('change', filterByLabour));
      filterByLabour();
    
      // ─── Participant filters ─────────────────────────────────────────────
      const container = document.getElementById('participant-filters');
      if (container) {
        const namesSet = new Set();
        document.querySelectorAll('.participants-cell').forEach(cell =>
          cell.querySelectorAll('div').forEach(div => {
            const txt = div.childNodes[0]?.textContent.trim();
            if (txt) namesSet.add(txt);
          })
        );
        const names    = Array.from(namesSet).sort();
        const selected = new Set();
    
        function renderButtons() {
          container.innerHTML = '';
          names.forEach(name => {
            const btn = document.createElement('button');
            btn.type        = 'button';
            btn.className   = 'btn btn-sm btn-outline-dark me-2 mb-2';
            btn.textContent = name;
            btn.dataset.name= name;
            if (selected.has(name)) btn.classList.add('active');
            container.appendChild(btn);
          });
        }
    
        function filterRows() {
          document.querySelectorAll('table tbody tr').forEach(row => {
            if (selected.size === 0) {
              row.style.display = '';
              return;
            }
            const rowNames = Array.from(
              row.querySelectorAll('.participants-cell > div')
            ).map(div => div.childNodes[0]?.textContent.trim());
            row.style.display = Array.from(selected).some(n => rowNames.includes(n))
                                ? '' : 'none';
          });
        }
    
        container.addEventListener('click', e => {
          const btn = e.target.closest('button');
          if (!btn?.dataset.name) return;
          const name = btn.dataset.name;
          if (selected.has(name)) {
            selected.delete(name);
            btn.classList.remove('active');
          } else {
            selected.add(name);
            btn.classList.add('active');
          }
          filterRows();
        });
    
        renderButtons();
      }
    
      // ─── Modals: History, Join & Leave ──────────────────────────────────
      const historyModal = new bootstrap.Modal(document.getElementById('historyModal'));
      const joinModal    = new bootstrap.Modal(document.getElementById('joinModal'));
      const leaveModal   = new bootstrap.Modal(document.getElementById('leaveModal'));
    
      // 1) Click any labour-btn → load history & show History Modal
      document.querySelectorAll('.labour-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          const eventId = btn.dataset.eventId;
          fetch(`/plant/downtime/${eventId}/history/`)
            .then(r => r.ok ? r.json() : Promise.reject())
            .then(data => {
              const tbody = document.getElementById('history-body');
              tbody.innerHTML = '';
              let userHasOpen = false;
    
              data.history.forEach(p => {
                if (p.user === currentUser && !p.leave_at) userHasOpen = true;
                tbody.insertAdjacentHTML('beforeend', `
                  <tr>
                    <td>${p.user}</td>
                    <td>${p.join_at}</td>
                    <td>${p.join_comment}</td>
                    <td>${p.leave_at || '—'}</td>
                    <td>${p.leave_comment}</td>
                    <td>${p.total_minutes}</td>
                  </tr>
                `);
              });
    
              // Show only the appropriate action button
              document.getElementById('history-join-btn').style.display  = userHasOpen ? 'none' : 'inline-block';
              document.getElementById('history-leave-btn').style.display = userHasOpen ? 'inline-block' : 'none';
    
              // Store eventId for the next steps
              document.getElementById('history-join-btn').dataset.eventId  = eventId;
              document.getElementById('history-leave-btn').dataset.eventId = eventId;
    
              historyModal.show();
            })
            .catch(() => alert('Could not load history.'));
        });
      });
    
      // 2) “Join” in History → open Join Modal
      document.getElementById('history-join-btn').addEventListener('click', evt => {
        const id = evt.currentTarget.dataset.eventId;
        document.getElementById('join-event-id').value   = id;
        document.getElementById('join-datetime').value   = new Date().toISOString().slice(0,16);
        document.getElementById('join-comment').value    = '';
        historyModal.hide();
        joinModal.show();
      });
    
      // 3) Confirm Join → POST → reload
      document.getElementById('join-confirm-btn').addEventListener('click', () => {
        const id   = document.getElementById('join-event-id').value;
        const note = document.getElementById('join-comment').value.trim();
        if (!note) return alert('Please say what you plan to do.');
        fetch("{% url 'join_downtime_event' %}", {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken':  document.querySelector('[name=csrfmiddlewaretoken]').value
          },
          body: JSON.stringify({ event_id: id, join_comment: note })
        })
        .then(r => r.ok ? location.reload() : Promise.reject())
        .catch(() => alert('Could not join event.'));
      });
    
      // 4) “Leave” in History → open Leave Modal
      document.getElementById('history-leave-btn').addEventListener('click', evt => {
        const id = evt.currentTarget.dataset.eventId;
        document.getElementById('leave-event-id').value   = id;
        document.getElementById('leave-datetime').value   = new Date().toISOString().slice(0,16);
        document.getElementById('leave-comment').value    = '';
        historyModal.hide();
        leaveModal.show();
      });
    
      // 5) Confirm Leave → POST → reload
      document.getElementById('leave-confirm-btn').addEventListener('click', () => {
        const id   = document.getElementById('leave-event-id').value;
        const note = document.getElementById('leave-comment').value.trim();
        if (!note) return alert('Please describe what you did.');
        fetch("{% url 'leave_downtime_event' %}", {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken':  document.querySelector('[name=csrfmiddlewaretoken]').value
          },
          body: JSON.stringify({ event_id: id, leave_comment: note })
        })
        .then(r => r.ok ? location.reload() : Promise.reject())
        .catch(() => alert('Could not leave event.'));
      });
    
      // ─── Helper: renderRow (unchanged) ────────────────────────────────────
      function renderRow(e) {
        const labourHtml = Array.isArray(e.labour_types) && e.labour_types.length
          ? e.labour_types.map(l => `<span class="badge bg-info">${l}</span>`).join(' ')
          : '<span class="text-muted">—</span>';
    
        const parts = [];
        if (Array.isArray(e.participants)) {
          e.participants.forEach(p => {
            if (p.leave_epoch == null) {
              parts.push(`
                <div>
                  ${p.user}
                  ${p.user === currentUser
                    ? `<button class="btn btn-sm btn-outline-danger leave-btn"
                               data-event-id="${e.id}">Leave</button>`
                    : ''}
                </div>`);
            } else {
              parts.push(`<div>${p.user} <small>– ${p.total_minutes} min</small></div>`);
            }
          });
        }
        if (!e.user_has_open) {
          parts.push(`
            <button class="btn btn-sm btn-outline-dark join-btn mt-2"
                    data-event-id="${e.id}">Join</button>`);
        }
    
        const closeoutHtml = e.closeout_at
          ? e.closeout_at
          : `<span class="text-muted">— open —</span>`;
    
        return `
          <tr class="${e.closeout_at ? '' : 'table-warning'}">
            <td>${e.start_at}</td>
            <td>${closeoutHtml}</td>
            <td>${e.line}</td>
            <td>${e.machine}</td>
            <td><span class="badge bg-dark">${e.category}</span></td>
            <td><span class="badge bg-secondary">${e.subcategory}</span></td>
            <td>${labourHtml}</td>
            <td class="participants-cell" data-event-id="${e.id}">
              ${parts.join('')}
            </td>
            <td>${e.comment}</td>
          </tr>`;
      }
    });
    </script>
    
  




</div>




      
  
{% endblock %}
