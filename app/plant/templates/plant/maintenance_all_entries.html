{% extends "parent.html" %}
{% load static %}
{% block content %}
<div class="container mt-4">
  <h1 class="mb-4">Open Downtime Events</h1>


  {% if is_manager %}
  {# ───────────────────────── Line priorities accordion ────────────────────────── #}
  <div class="accordion mt-5 mb-4" id="linesPriorityAccordion">
    <div class="accordion-item">
      <h2 class="accordion-header" id="linesPriorityHeading">
        <button class="accordion-button d-flex justify-content-between"
                type="button"
                data-bs-toggle="collapse"
                data-bs-target="#linesPriorityCollapse"
                aria-expanded="false"
                aria-controls="linesPriorityCollapse">
          <span>Line Priorities</span>
        </button>
      </h2>

      <div id="linesPriorityCollapse"
           class="accordion-collapse collapse"
           aria-labelledby="linesPriorityHeading"
           data-bs-parent="#linesPriorityAccordion">

        <div class="accordion-body p-0">

          <ul class="list-group list-group-flush">
            {% for lp in line_priorities %}
              <li class="list-group-item d-flex justify-content-between align-items-center">

                {# ►► left side: line name + arrow buttons                         #}
                <div class="d-flex align-items-center gap-2">
                  <strong>{{ lp.line }}</strong>

                  {# move‑up form — hidden if already top priority (#1)            #}
                  {% if not forloop.first %}
                  <form method="post"
                        action="{% url 'move_line_priority' lp.id 'up' %}"
                        class="d-inline">
                    {% csrf_token %}
                    <button class="btn btn-sm btn-outline-secondary py-0 px-1"
                            title="Move up one">
                      ▲
                    </button>
                  </form>
                  {% endif %}

                  {# move‑down form — hidden if last entry                         #}
                  {% if not forloop.last %}
                  <form method="post"
                        action="{% url 'move_line_priority' lp.id 'down' %}"
                        class="d-inline">
                    {% csrf_token %}
                    <button class="btn btn-sm btn-outline-secondary py-0 px-1"
                            title="Move down one">
                      ▼
                    </button>
                  </form>
                  {% endif %}
                </div>

                {# ►► right side: coloured priority badge                         #}
                {% if lp.priority <= 3 %}
                  <span class="badge bg-danger rounded-pill">{{ lp.priority }}</span>
                {% elif lp.priority <= 7 %}
                  <span class="badge bg-warning text-dark rounded-pill">{{ lp.priority }}</span>
                {% else %}
                  <span class="badge bg-success rounded-pill">{{ lp.priority }}</span>
                {% endif %}

              </li>
            {% empty %}
              <li class="list-group-item text-muted">
                No line priorities defined.
              </li>
            {% endfor %}
          </ul>

        </div>
      </div>
    </div>
  </div>
  {# ───────────────────────── end accordion ────────────────────────────────────── #}
  {% endif %}

    {# ────── Labour-type filters (exclude OPERATOR) ────── #}
    <div class="mb-4">
      {% for code,label in labour_choices %}
        {% if code != 'OPERATOR' %}
          <div class="form-check form-check-inline">
            <input
              class="form-check-input labour-filter"
              type="checkbox"
              id="filter{{ code }}"
              value="{{ code }}"
            >
            <label
              class="form-check-label"
              for="filter{{ code }}"
            >{{ label }}</label>
          </div>
        {% endif %}
      {% endfor %}
    </div>
  

{# ───────────────────────── downtime events table ────────────────── #}
<div class="table-responsive mt-4">
  <table class="table table-striped table-hover table-bordered align-middle">
    <thead class="table-light">
      <tr>
        <th>Start</th>
        <th>Close-out</th>
        <th>Line</th>
        <th>Machine</th>
        <th>Category</th>
        <th>Sub-category</th>
        <th>Labour&nbsp;Needed</th>
        <th>Participants</th>
        <th>Comment</th>
      </tr>
    </thead>
    <tbody>
      {% for e in entries %}
      <tr class="{% if not e.closeout_epoch %}table-warning{% endif %}">
        {# Start time #}
        <td>{{ e.start_at|date:"Y-m-d H:i" }}</td>

        {# Close-out #}
        <td>
          {% if e.closeout_epoch %}
            {{ e.closeout_epoch|date:"Y-m-d H:i" }}
          {% else %}
            {% if e.assigned_to == request.user.username %}
              <button class="btn btn-sm btn-info closeout-btn"
                      data-entry-id="{{ e.id }}">
                Close Out
              </button>
            {% else %}
              <span class="text-muted">— open —</span>
            {% endif %}
          {% endif %}
        </td>

        {# Line, Machine, Category, Sub-category #}
        <td>{{ e.line }}</td>
        <td>{{ e.machine }}</td>
        <td><span class="badge bg-dark">{{ e.category }}</span></td>
        <td><span class="badge bg-secondary">{{ e.subcategory }}</span></td>

        {# Labour needed badges #}
        <td>
          {% if e.labour_types %}
            {% for code in e.labour_types %}
              <span class="badge bg-info">{{ code }}</span>
            {% endfor %}
          {% else %}
            <span class="text-muted">—</span>
          {% endif %}
        </td>

        {# Participants column #}
        <td class="participants-cell" data-event-id="{{ e.id }}">
          {% for p in e.participants.all %}
            <div class="mb-1">
              {{ p.user.username }}
        
              {% if p.user == request.user %}
                {# only *you* get a Leave button on your own open participation #}
                {% if p.leave_epoch is None %}
                  <button
                    class="btn btn-sm btn-outline-danger leave-btn"
                    data-event-id="{{ e.id }}"
                  >Leave</button>
                {% else %}
                  <small>– {{ p.total_minutes }} min</small>
                {% endif %}
        
              {% else %}
                {# for everyone else, if they’ve left show minutes, otherwise nothing #}
                {% if p.leave_epoch %}
                  <small>– {{ p.total_minutes }} min</small>
                {% endif %}
              {% endif %}
            </div>
          {% endfor %}
        
          {# Show Join only if *you* don’t already have an open participation #}
          {% if not e.user_has_open %}
            <button
              class="btn btn-sm btn-outline-dark join-btn mt-2"
              data-event-id="{{ e.id }}"
            >Join</button>
          {% endif %}
        </td>
        

        {# Comment #}
        <td>{{ e.comment }}</td>
      </tr>
      {% empty %}
      <tr>
        <td colspan="9" class="text-center py-4">No downtime events found.</td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
</div>

<div class="text-center mt-3">
  <button id="load-more-btn" class="btn btn-dark">Load&nbsp;More</button>
</div>



  <!-- ─────────────────── Join Comment Modal ─────────────────── -->
  <div class="modal fade" id="joinCommentModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-sm">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Joining Downtime Event</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <div class="mb-3">
            <label for="join-comment-text" class="form-label">Plan of action:</label>
            <textarea id="join-comment-text" class="form-control" rows="3" maxlength="2000" required></textarea>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-dark" data-bs-dismiss="modal">Cancel</button>
          <button type="button" id="join-confirm-btn" class="btn btn-warning">Confirm</button>
        </div>
      </div>
    </div>
  </div>

  <!-- ─────────────────── Leave Comment Modal ─────────────────── -->
  <div class="modal fade" id="leaveCommentModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-sm">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Leaving Downtime Event</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <div class="mb-3">
            <label for="leave-comment-text" class="form-label">Reason for leaving:</label>
            <textarea id="leave-comment-text" class="form-control" rows="3" maxlength="2000" required></textarea>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-dark" data-bs-dismiss="modal">Cancel</button>
          <button type="button" id="leave-confirm-btn" class="btn btn-warning">Confirm</button>
        </div>
      </div>
    </div>
  </div>


{# ───────────────────────── Close‑out modal (unchanged) ────────────────────────── #}
<div class="modal fade" id="allCloseoutModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-sm">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Close Out Assigned Downtime</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <form id="all-closeout-form">
          {% csrf_token %}
          <input type="hidden" id="all-closeout-entry-id">
          <div class="mb-3">
            <label for="all-closeout-date" class="form-label">Date</label>
            <input type="date" id="all-closeout-date" class="form-control" required>
          </div>
          <div class="mb-3">
            <label for="all-closeout-time" class="form-label">Time</label>
            <input type="time" id="all-closeout-time" class="form-control" required>
          </div>
          <div class="mb-3">
            <label for="all-closeout-comment" class="form-label">What was done?</label>
            <textarea id="all-closeout-comment" class="form-control"
                      rows="3" maxlength="2000" required></textarea>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button"
                class="btn btn-secondary"
                data-bs-dismiss="modal">Cancel</button>
        <button type="button"
                id="all-closeout-confirm"
                class="btn btn-info">Confirm</button>
      </div>
    </div>
  </div>
</div>

<script>
  /*  ───────────  Join / Leave overlay (independent)  ─────────── */
  (() => {
    /* helpers --------------------------------------------------------------- */
    const currentUser = "{{ request.user.username }}",
          csrftoken   = document.cookie
                         .split(';')
                         .map(c => c.trim())
                         .find(c => c.startsWith('csrftoken='))?.split('=')[1] ?? '',
          joinUrl     = "{% url 'join_downtime_event' %}",
          leaveUrl    = "{% url 'leave_downtime_event' %}",
          table       = document.querySelector('table');
  
    if (!table) return;          /* defensive guard */
  
    /* cached textarea elements --------------------------------------------- */
    const joinTA  = document.getElementById('join-comment-text'),
          leaveTA = document.getElementById('leave-comment-text');
  
    let pendingJoinId  = null,
        pendingLeaveId = null;
  
    /* capture‑phase listener ------------------------------------------------ */
    table.addEventListener('click', (ev) => {
      const btn = ev.target.closest('button.join-btn, button.leave-btn');
      if (!btn) return;
  
      ev.stopImmediatePropagation();
      ev.preventDefault();
  
      if (btn.classList.contains('join-btn')) {
        pendingJoinId   = btn.dataset.eventId;
        joinTA.value    = '';
        bootstrap.Modal.getOrCreateInstance(
          document.getElementById('joinCommentModal')
        ).show();
      } else {
        pendingLeaveId  = btn.dataset.eventId;
        leaveTA.value   = '';
        bootstrap.Modal.getOrCreateInstance(
          document.getElementById('leaveCommentModal')
        ).show();
      }
    }, true);                       // capture=true
  
    /* JOIN confirm ---------------------------------------------------------- */
    document.getElementById('join-confirm-btn')
      .addEventListener('click', () => {
        const comment = joinTA.value.trim();
        if (!comment) {
          alert('Please describe what you plan on doing.');
          return;
        }
  
        fetch(joinUrl, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json',
                     'X-CSRFToken': csrftoken },
          body: JSON.stringify({ event_id: pendingJoinId,
                                 join_comment: comment })
        })
        .then(r => r.ok ? r.json() : Promise.reject())
        .then(() => {
          const cell = table.querySelector(
            `.participants-cell[data-event-id="${pendingJoinId}"]`
          );
          if (cell) {
            cell.querySelector('.join-btn')?.remove();
            cell.insertAdjacentHTML('afterbegin', `
              <div>
                ${currentUser}
                <button class="btn btn-sm btn-outline-danger leave-btn"
                        data-event-id="${pendingJoinId}">Leave</button>
              </div>`);
          }
          bootstrap.Modal.getInstance(
            document.getElementById('joinCommentModal')
          ).hide();
        })
        .catch(() => alert('Error joining event'));
      });
  
    /* LEAVE confirm --------------------------------------------------------- */
    document.getElementById('leave-confirm-btn')
      .addEventListener('click', () => {
        const comment = leaveTA.value.trim();
        if (!comment) {
          alert('Please describe what you did.');
          return;
        }
  
        fetch(leaveUrl, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json',
                     'X-CSRFToken': csrftoken },
          body: JSON.stringify({ event_id: pendingLeaveId,
                                 leave_comment: comment })
        })
        .then(r => r.ok ? r.json() : Promise.reject())
        .then(data => {
          const cell = table.querySelector(
            `.participants-cell[data-event-id="${pendingLeaveId}"]`
          );
          if (cell) {
            const leaveBtn = cell.querySelector(
              `button.leave-btn[data-event-id="${pendingLeaveId}"]`);
            if (leaveBtn) {
              leaveBtn.insertAdjacentHTML(
                'afterend', `<small>– ${data.total_minutes} min</small>`);
              leaveBtn.remove();
            }
            cell.insertAdjacentHTML('beforeend', `
              <button class="btn btn-sm btn-outline-dark join-btn mt-2"
                      data-event-id="${pendingLeaveId}">Join</button>`);
          }
          bootstrap.Modal.getInstance(
            document.getElementById('leaveCommentModal')
          ).hide();
        })
        .catch(() => alert('Error leaving event'));
      });
  })();
  </script>
  

  <script>
    (function () {
      /* ─────────────────────────── Utilities & config ────────────────────────── */
      function getCookie(name) {
        let v = null;
        document.cookie?.split(';').forEach(c => {
          c = c.trim();
          if (c.startsWith(name + '=')) v = decodeURIComponent(c.slice(name.length + 1));
        });
        return v;
      }
    
      const currentUser = "{{ request.user.username }}",            // used by renderer
            loadMoreUrl = "{% url 'load_more_downtime_entries' %}",
            pageSize    = {{ page_size }},
            table       = document.querySelector('table'),
            loadMoreBtn = document.getElementById('load-more-btn');
    
      /* ───────────────────────────── Row renderer ────────────────────────────── */
      function renderRow(e) {
        const labourHtml = Array.isArray(e.labour_types) && e.labour_types.length
          ? e.labour_types.map(l => `<span class="badge bg-info">${l}</span>`).join(' ')
          : '<span class="text-muted">—</span>';
    
        /* participants (Join/Leave buttons stay so the add‑on can hook them) */
        const parts = [];
        if (Array.isArray(e.participants) && e.participants.length) {
          e.participants.forEach(p => {
            if (p.leave_epoch == null) {
              parts.push(`
                <div>
                  ${p.user}
                  ${p.user === currentUser ? `
                    <button class="btn btn-sm btn-outline-danger leave-btn"
                            data-event-id="${e.id}">Leave</button>` : ''}
                </div>`);
            } else {
              parts.push(`<div>${p.user} <small>– ${p.total_minutes} min</small></div>`);
            }
          });
        }
    
        if (!e.user_has_open) {
          parts.push(`
            <button class="btn btn-sm btn-outline-dark join-btn mt-2"
                    data-event-id="${e.id}">Join</button>`);
        }
    
        const closeoutHtml = e.closeout_at
          ? e.closeout_at
          : `<span class="text-muted">— open —</span>`;
    
        return `
          <tr class="${e.closeout_at ? '' : 'table-warning'}">
            <td>${e.start_at}</td>
            <td>${closeoutHtml}</td>
            <td>${e.line}</td>
            <td>${e.machine}</td>
            <td><span class="badge bg-dark">${e.category}</span></td>
            <td><span class="badge bg-secondary">${e.subcategory}</span></td>
            <td>${labourHtml}</td>
            <td class="participants-cell" data-event-id="${e.id}">
              ${parts.join('')}
            </td>
            <td>${e.comment}</td>
          </tr>`;
      }
    
      /* ───────────────────────────── Load‑More AJAX ──────────────────────────── */
      let offset = pageSize;
    
      loadMoreBtn.addEventListener('click', () => {
        loadMoreBtn.disabled = true;
        fetch(`${loadMoreUrl}?offset=${offset}`)
          .then(r => r.ok ? r.json() : Promise.reject())
          .then(data => {
            data.entries.forEach(e => {
              document.querySelector('tbody')
                      .insertAdjacentHTML('beforeend', renderRow(e));
            });
            offset += pageSize;
            if (!data.has_more) {
              loadMoreBtn.remove();
            } else {
              loadMoreBtn.disabled = false;
            }
          })
          .catch(() => {
            alert('Error loading more entries');
            loadMoreBtn.disabled = false;
          });
      });
    
      /* ──────────────────────── Labour‑type live filter ──────────────────────── */
      const labourCheckboxes = Array.from(document.querySelectorAll('.labour-filter'));
    
      function filterByLabour() {
        const selected = labourCheckboxes.filter(cb => cb.checked).map(cb => cb.value);
    
        document.querySelectorAll('table tbody tr').forEach(row => {
          const rowCodes = Array.from(
            row.cells[6].querySelectorAll('span.badge.bg-info')
          ).map(span => span.textContent.trim());
    
          row.style.display =
            selected.length === 0 || rowCodes.some(c => selected.includes(c))
              ? ''
              : 'none';
        });
      }
    
      labourCheckboxes.forEach(cb => cb.addEventListener('change', filterByLabour));
      filterByLabour();     // initial state
    })();
    </script>
    
  

  
{% endblock %}
