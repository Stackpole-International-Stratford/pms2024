{% extends "parent.html" %}
{% block content %}
<div class="container mt-4">
  <h1 class="mb-4">All Downtime Events</h1>
  <div class="table-responsive">
    <table class="table table-striped table-hover table-bordered align-middle">
      <thead class="table-light">
        <tr>
          <th>Start</th>
          <th>Closeout</th>
          <th>Line</th>
          <th>Machine</th>
          <th>Category</th>
          <th>Subcategory</th>
          <th>Labour Needed</th>
          <th>Assigned To</th>
          <th>Comment</th>
        </tr>
      </thead>
      <tbody>
        {% for e in entries %}
        <tr class="{% if not e.closeout_epoch %}table-warning{% endif %}">
          <td>{{ e.start_at|date:"Y-m-d H:i" }}</td>
          <td>
            {% if e.closeout_epoch %}
              {{ e.closeout_epoch|date:"Y-m-d H:i" }}
            {% else %}
              {% if e.assigned_to == request.user.username %}
                <button
                  class="btn btn-sm btn-info closeout-btn"
                  data-entry-id="{{ e.id }}"
                >Close Out</button>
              {% else %}
                <span class="text-muted">— open —</span>
              {% endif %}
            {% endif %}
          </td>
          <td>{{ e.line }}</td>
          <td>{{ e.machine }}</td>
          <td><span class="badge bg-primary">{{ e.category }}</span></td>
          <td><span class="badge bg-secondary">{{ e.subcategory }}</span></td>
          <td>{{ e.labour_type }}</td>
          <td class="assigned-to-cell" data-entry-id="{{ e.id }}">
            {% if e.assigned_to %}
              {{ e.assigned_to }}
              {% if e.assigned_to == request.user.username %}
                <button
                  class="btn btn-sm btn-outline-warning unassign-btn"
                  data-entry-id="{{ e.id }}"
                >Unassign</button>
              {% endif %}
            {% else %}
              <button
                class="btn btn-sm btn-outline-primary assign-btn"
                data-entry-id="{{ e.id }}"
              >Assign to me</button>
            {% endif %}
          </td>
          <td>{{ e.comment }}</td>
        </tr>
        {% empty %}
        <tr>
          <td colspan="9" class="text-center py-4">No downtime events found.</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>

<!-- Close-out modal -->
<div class="modal fade" id="allCloseoutModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-sm">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Close Out Assigned Downtime</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <form id="all-closeout-form">
          {% csrf_token %}
          <input type="hidden" id="all-closeout-entry-id">
          <div class="mb-3">
            <label for="all-closeout-date" class="form-label">Date</label>
            <input type="date" id="all-closeout-date" class="form-control" required>
          </div>
          <div class="mb-3">
            <label for="all-closeout-time" class="form-label">Time</label>
            <input type="time" id="all-closeout-time" class="form-control" required>
          </div>
          <div class="mb-3">
            <label for="all-closeout-comment" class="form-label">What was done?</label>
            <textarea
              id="all-closeout-comment"
              class="form-control"
              rows="3"
              maxlength="2000"
              required
            ></textarea>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button
          type="button"
          class="btn btn-secondary"
          data-bs-dismiss="modal"
        >Cancel</button>
        <button
          type="button"
          id="all-closeout-confirm"
          class="btn btn-info"
        >Confirm</button>
      </div>
    </div>
  </div>
</div>

<script>
  function getCookie(name) {
    let val = null;
    if (document.cookie) {
      document.cookie.split(';').forEach(c => {
        c = c.trim();
        if (c.startsWith(name + '=')) {
          val = decodeURIComponent(c.slice(name.length + 1));
        }
      });
    }
    return val;
  }
  const csrftoken      = getCookie('csrftoken'),
        assignUrl      = "{% url 'assign_downtime_entry' %}",
        unassignUrl    = "{% url 'unassign_downtime_entry' %}",
        allCloseoutUrl = "{% url 'closeout_assigned_downtime_entry' %}";

  const table = document.querySelector('table');

  table.addEventListener('click', e => {
    const btn = e.target.closest('button');
    if (!btn) return;
    const entryId = btn.dataset.entryId;

    // Assign / Unassign
    if (btn.classList.contains('assign-btn') ||
        btn.classList.contains('unassign-btn')) {
      const url = btn.classList.contains('assign-btn') ? assignUrl : unassignUrl;
      fetch(url, {
        method: 'POST',
        headers: {
          'Content-Type':'application/json',
          'X-CSRFToken': csrftoken
        },
        body: JSON.stringify({ entry_id: entryId })
      })
      .then(r => { if (!r.ok) throw Error(); return r.json(); })
      .then(data => {
        const cell = btn.closest('td.assigned-to-cell');
        if (data.assigned_to) {
          cell.innerHTML = `
            ${data.assigned_to}
            <button class="btn btn-sm btn-outline-warning unassign-btn"
                    data-entry-id="${entryId}">
              Unassign
            </button>`;
        } else {
          cell.innerHTML = `
            <button class="btn btn-sm btn-outline-primary assign-btn"
                    data-entry-id="${entryId}">
              Assign to me
            </button>`;
        }
      })
      .catch(() => alert('Error performing request.'));
      return;
    }

    // Close-out
    if (btn.classList.contains('closeout-btn')) {
      document.getElementById('all-closeout-entry-id').value = entryId;
      const now = new Date();
      document.getElementById('all-closeout-date').value    = now.toISOString().slice(0,10);
      document.getElementById('all-closeout-time').value    = now.toTimeString().slice(0,5);
      document.getElementById('all-closeout-comment').value = '';
      new bootstrap.Modal(document.getElementById('allCloseoutModal')).show();
      return;
    }
  });

  document.getElementById('all-closeout-confirm').addEventListener('click', () => {
    const entryId = document.getElementById('all-closeout-entry-id').value,
          date    = document.getElementById('all-closeout-date').value,
          time    = document.getElementById('all-closeout-time').value,
          comment = document.getElementById('all-closeout-comment').value.trim();

    if (!date || !time)    return alert('Pick date & time.');
    if (!comment)          return alert('Please describe what you did to fix the issue.');

    fetch(allCloseoutUrl, {
      method: 'POST',
      headers: {
        'Content-Type':'application/json',
        'X-CSRFToken': csrftoken
      },
      body: JSON.stringify({
        entry_id:         entryId,
        closeout:         `${date} ${time}`,
        closeout_comment: comment
      })
    })
    .then(r => { if (!r.ok) throw Error(); return r.json(); })
    .then(() => window.location.reload())
    .catch(() => alert('Error closing out.'));
  });
</script>
{% endblock %}
