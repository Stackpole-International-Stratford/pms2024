{% extends "parent.html" %}
{% block content %}
<div class="container mt-4">
  <h1 class="mb-4">Open Downtime Events</h1>
  <div class="table-responsive">
    <table class="table table-striped table-hover table-bordered align-middle">
      <thead class="table-light">
        <tr>
          <th>Start</th>
          <th>Closeout</th>
          <th>Line</th>
          <th>Machine</th>
          <th>Category</th>
          <th>Subcategory</th>
          <th>Labour Needed</th>
          <th>Assigned To</th>
          <th>Comment</th>
        </tr>
      </thead>
      <tbody>
        {# initial batch #}
        {% for e in entries %}
        <tr class="{% if not e.closeout_epoch %}table-warning{% endif %}">
          <td>{{ e.start_at|date:"Y-m-d H:i" }}</td>
          <td>
            {% if e.closeout_epoch %}
              {{ e.closeout_epoch|date:"Y-m-d H:i" }}
            {% else %}
              {% if e.assigned_to == request.user.username %}
                <button
                  class="btn btn-sm btn-info closeout-btn"
                  data-entry-id="{{ e.id }}"
                >Close Out</button>
              {% else %}
                <span class="text-muted">— open —</span>
              {% endif %}
            {% endif %}
          </td>
          <td>{{ e.line }}</td>
          <td>{{ e.machine }}</td>
          <td><span class="badge bg-dark">{{ e.category }}</span></td>
          <td><span class="badge bg-secondary">{{ e.subcategory }}</span></td>
          <td>{{ e.labour_type }}</td>
          <td class="assigned-to-cell" data-entry-id="{{ e.id }}">
            {% if e.assigned_to %}
              {{ e.assigned_to }}
              {% if e.assigned_to == request.user.username %}
                <button
                  class="btn btn-sm btn-outline-dark unassign-btn"
                  data-entry-id="{{ e.id }}"
                >Unassign</button>
              {% endif %}
            {% else %}
              <button
                class="btn btn-sm btn-outline-dark assign-btn"
                data-entry-id="{{ e.id }}"
              >Assign to me</button>
            {% endif %}
          </td>
          <td>{{ e.comment }}</td>
        </tr>
        {% empty %}
        <tr>
          <td colspan="9" class="text-center py-4">No downtime events found.</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

  <div class="text-center mt-3">
    <button id="load-more-btn" class="btn btn-dark">
      Load More
    </button>
  </div>
</div>

<!-- Close-out modal (unchanged) -->
<div class="modal fade" id="allCloseoutModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-sm">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Close Out Assigned Downtime</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <form id="all-closeout-form">
          {% csrf_token %}
          <input type="hidden" id="all-closeout-entry-id">
          <div class="mb-3">
            <label for="all-closeout-date" class="form-label">Date</label>
            <input type="date" id="all-closeout-date" class="form-control" required>
          </div>
          <div class="mb-3">
            <label for="all-closeout-time" class="form-label">Time</label>
            <input type="time" id="all-closeout-time" class="form-control" required>
          </div>
          <div class="mb-3">
            <label for="all-closeout-comment" class="form-label">What was done?</label>
            <textarea
              id="all-closeout-comment"
              class="form-control"
              rows="3"
              maxlength="2000"
              required
            ></textarea>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button
          type="button"
          class="btn btn-secondary"
          data-bs-dismiss="modal"
        >Cancel</button>
        <button
          type="button"
          id="all-closeout-confirm"
          class="btn btn-info"
        >Confirm</button>
      </div>
    </div>
  </div>
</div>

<script>
  // ── Utilities & Config ────────────────────────────────────────────
  function getCookie(name) {
    let val = null;
    document.cookie?.split(';').forEach(c => {
      c = c.trim();
      if (c.startsWith(name + '=')) {
        val = decodeURIComponent(c.slice(name.length + 1));
      }
    });
    return val;
  }

  const currentUser    = "{{ request.user.username }}",
        csrftoken      = getCookie('csrftoken'),
        assignUrl      = "{% url 'assign_downtime_entry' %}",
        unassignUrl    = "{% url 'unassign_downtime_entry' %}",
        allCloseoutUrl = "{% url 'closeout_assigned_downtime_entry' %}",
        loadMoreUrl    = "{% url 'load_more_downtime_entries' %}",
        pageSize       = {{ page_size }},
        table          = document.querySelector('table'),
        loadMoreBtn    = document.getElementById('load-more-btn');

  let offset = pageSize;

  // ── Row Renderer ──────────────────────────────────────────────────
  function renderRow(e) {
    return `
    <tr class="${e.closeout_at ? '' : 'table-warning'}">
      <td>${e.start_at}</td>
      <td>
        ${ e.closeout_at
           ? e.closeout_at
           : (e.assigned_to === currentUser
              ? `<button class="btn btn-sm btn-info closeout-btn" data-entry-id="${e.id}">Close Out</button>`
              : '<span class="text-muted">— open —</span>')
        }
      </td>
      <td>${e.line}</td>
      <td>${e.machine}</td>
      <td><span class="badge bg-dark">${e.category}</span></td>
      <td><span class="badge bg-secondary">${e.subcategory}</span></td>
      <td>${e.labour_type}</td>
      <td class="assigned-to-cell" data-entry-id="${e.id}">
        ${ e.assigned_to
           ? `${e.assigned_to}${
               e.assigned_to === currentUser
               ? ` <button class="btn btn-sm btn-outline-dark unassign-btn" data-entry-id="${e.id}">Unassign</button>`
               : ''
             }`
           : `<button class="btn btn-sm btn-outline-dark assign-btn" data-entry-id="${e.id}">Assign to me</button>`
        }
      </td>
      <td>${e.comment}</td>
    </tr>`;
  }

  // ── Assign / Unassign / Close-Out Delegation ───────────────────────
  table.addEventListener('click', e => {
    const btn = e.target.closest('button');
    if (!btn) return;

    const entryId = btn.dataset.entryId,
          row     = btn.closest('tr');

    // Assign / Unassign
    if (btn.classList.contains('assign-btn') ||
        btn.classList.contains('unassign-btn')) {

      const url = btn.classList.contains('assign-btn')
                ? assignUrl
                : unassignUrl;

      fetch(url, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRFToken':  csrftoken
        },
        body: JSON.stringify({ entry_id: entryId })
      })
      .then(r => r.ok ? r.json() : Promise.reject())
      .then(data => {
        // update assigned cell
        const cell = row.querySelector('td.assigned-to-cell');
        if (data.assigned_to) {
          cell.innerHTML = `
            ${data.assigned_to}
            <button class="btn btn-sm btn-outline-dark unassign-btn"
                    data-entry-id="${entryId}">
              Unassign
            </button>`;
        } else {
          cell.innerHTML = `
            <button class="btn btn-sm btn-outline-dark assign-btn"
                    data-entry-id="${entryId}">
              Assign to me
            </button>`;
        }
        // update closeout cell
        const co = row.cells[1];
        if (data.assigned_to === currentUser) {
          co.innerHTML = `<button class="btn btn-sm btn-info closeout-btn" data-entry-id="${entryId}">Close Out</button>`;
        } else {
          co.innerHTML = `<span class="text-muted">— open —</span>`;
        }
      })
      .catch(() => alert('Error performing request.'));
      return;
    }

    // Open modal for close-out
    if (btn.classList.contains('closeout-btn')) {
      const now = new Date(),
            d   = now.toISOString().slice(0,10),
            t   = now.toTimeString().slice(0,5);

      document.getElementById('all-closeout-entry-id').value = entryId;
      document.getElementById('all-closeout-date').value     = d;
      document.getElementById('all-closeout-time').value     = t;
      document.getElementById('all-closeout-comment').value  = '';
      new bootstrap.Modal(document.getElementById('allCloseoutModal')).show();
    }
  });

  // ── Confirm Close-Out ─────────────────────────────────────────────
  document.getElementById('all-closeout-confirm')
    .addEventListener('click', () => {
      const entryId = document.getElementById('all-closeout-entry-id').value,
            date    = document.getElementById('all-closeout-date').value,
            time    = document.getElementById('all-closeout-time').value,
            comment = document.getElementById('all-closeout-comment').value.trim();

      if (!date || !time)    return alert('Pick date & time.');
      if (!comment)          return alert('Please describe what you did.');

      fetch(allCloseoutUrl, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRFToken':  csrftoken
        },
        body: JSON.stringify({
          entry_id:         entryId,
          closeout:         `${date} ${time}`,
          closeout_comment: comment
        })
      })
      .then(r => r.ok ? r.json() : Promise.reject())
      .then(() => {
        bootstrap.Modal.getInstance(
          document.getElementById('allCloseoutModal')
        ).hide();
        const row = table.querySelector(
          `button[data-entry-id="${entryId}"]`
        ).closest('tr');
        row.remove();
      })
      .catch(() => alert('Error closing out.'));
    });

  // ── Load More AJAX ────────────────────────────────────────────────
  loadMoreBtn.addEventListener('click', () => {
    loadMoreBtn.disabled = true;
    fetch(`${loadMoreUrl}?offset=${offset}`)
      .then(r => r.ok ? r.json() : Promise.reject())
      .then(data => {
        data.entries.forEach(e =>
          table.querySelector('tbody')
               .insertAdjacentHTML('beforeend', renderRow(e))
        );
        offset += pageSize;
        if (!data.has_more) {
          loadMoreBtn.remove();
        } else {
          loadMoreBtn.disabled = false;
        }
      })
      .catch(() => {
        alert('Error loading more entries');
        loadMoreBtn.disabled = false;
      });
  });
</script>
{% endblock %}
