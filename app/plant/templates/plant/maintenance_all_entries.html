{% extends "parent.html" %}
{% block content %}
<div class="container mt-4">
  <h1 class="mb-4">All Downtime Events</h1>
  <div class="table-responsive">
    <table class="table table-striped table-hover table-bordered align-middle">
      <thead class="table-light">
        <tr>
          <th>Start</th>
          <th>Closeout</th>
          <th>Line</th>
          <th>Machine</th>
          <th>Category</th>
          <th>Subcategory</th>
          <th>Labour Needed</th>
          <th>Assigned To</th>
          <th>Comment</th>
        </tr>
      </thead>
      <tbody>
        {% for e in entries %}
        <tr class="{% if not e.closeout_epoch %}table-warning{% endif %}">
          <td>{{ e.start_at|date:"Y-m-d H:i" }}</td>
          <td>
            {% if e.closeout_epoch %}
              {% with ts=e.closeout_epoch %}
                {{ ts|date:"Y-m-d H:i" }}
              {% endwith %}
            {% else %}
              <span class="text-muted">— open —</span>
            {% endif %}
          </td>
          <td>{{ e.line }}</td>
          <td>{{ e.machine }}</td>
          <td><span class="badge bg-primary">{{ e.category }}</span></td>
          <td><span class="badge bg-secondary">{{ e.subcategory }}</span></td>
          <td>{{ e.labour_type }}</td>
          <td class="assigned-to-cell" data-entry-id="{{ e.id }}">
            {% if e.assigned_to %}
              {{ e.assigned_to }}
              {% if e.assigned_to == request.user.username %}
                <button
                  class="btn btn-sm btn-outline-warning unassign-btn"
                  data-entry-id="{{ e.id }}"
                >
                  Unassign
                </button>
              {% endif %}
            {% else %}
              <button
                class="btn btn-sm btn-outline-primary assign-btn"
                data-entry-id="{{ e.id }}"
              >
                Assign to me
              </button>
            {% endif %}
          </td>
          <td>{{ e.comment }}</td>
        </tr>
        {% empty %}
        <tr>
          <td colspan="9" class="text-center py-4">No downtime events found.</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>

<script>
  // CSRF helper
  function getCookie(name) {
    let val = null;
    if (document.cookie) {
      document.cookie.split(';').forEach(c => {
        c = c.trim();
        if (c.startsWith(name + '=')) {
          val = decodeURIComponent(c.slice(name.length + 1));
        }
      });
    }
    return val;
  }
  const csrftoken   = getCookie('csrftoken');
  const assignUrl   = "{% url 'assign_downtime_entry' %}";
  const unassignUrl = "{% url 'unassign_downtime_entry' %}";

  document.querySelector('table').addEventListener('click', e => {
    const btn = e.target.closest('button');
    if (!btn) return;
    const cell    = btn.closest('td.assigned-to-cell');
    const entryId = btn.dataset.entryId;
    let url, success;

    if (btn.classList.contains('assign-btn')) {
      url = assignUrl;
      success = data => {
        cell.innerHTML = 
          `${data.assigned_to}
           <button class="btn btn-sm btn-outline-warning unassign-btn" data-entry-id="${entryId}">Unassign</button>`;
      };
    } 
    else if (btn.classList.contains('unassign-btn')) {
      url = unassignUrl;
      success = () => {
        cell.innerHTML = 
          `<button class="btn btn-sm btn-outline-primary assign-btn" data-entry-id="${entryId}">Assign to me</button>`;
      };
    } 
    else {
      return;
    }

    fetch(url, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken':  csrftoken,
      },
      body: JSON.stringify({ entry_id: entryId }),
    })
    .then(r => {
      if (!r.ok) throw new Error("Bad response");
      return r.json();
    })
    .then(data => {
      if (data.status === 'ok') {
        success(data);
      } else {
        alert('Operation failed.');
      }
    })
    .catch(err => {
      console.error(err);
      alert('Error performing request.');
    });
  });
</script>
{% endblock %}
