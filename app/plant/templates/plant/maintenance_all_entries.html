{% extends "parent.html" %}
{% load static %}
{% block content %}
<div class="container mt-4">
  {% csrf_token %}
  {{ user_roles|json_script:"user‑roles-json" }}   {# ←  place it here #}

  <div class="title-container">
    <h1 class="mb-4 text-center">Open Downtime Events</h1>
    <div class="todo">
      ToDo: build ability to edit the entry (this will take a couple of hours)<br>
      ToDo: allow for filtering by profession and auto-filter on page load  based on user
    </div>
  </div>
  

<style>
  .title-container {
    position: relative;
    width: 100%;
    text-align: center; /* center the H1 */
  }
  
  .title-container .todo {
    display: none;
    margin-top: 0.5em;
    font-size: 0.9em;
    color: #555;
  }
  
  .title-container:hover .todo {
    display: block;
  }
  
  
</style>

  {% if is_manager %}

    {# ───────────────────── New‑employee button + modal ───────────────────── #}



  <!-- Modal (place it once per page, usually near bottom) -->
  <div class="modal fade" id="newEmployeeModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
      <form method="post" action="{% url 'add_employee' %}" class="modal-content">
        {% csrf_token %}
        <div class="modal-header">
          <h5 class="modal-title">Add New or Update Employee</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>

        <div class="modal-body">
          <div class="mb-3">
            <label for="empFirst" class="form-label">First name</label>
            <input id="empFirst" name="first_name" class="form-control" required>
          </div>
          <div class="mb-3">
            <label for="empLast" class="form-label">Last name</label>
            <input id="empLast" name="last_name" class="form-control" required>
          </div>

          <p class="mb-1 fw-semibold">Profession(s)</p>
          <div class="form-check">
            <input class="form-check-input" type="checkbox"
                   name="roles" value="electrician" id="role_elec">
            <label class="form-check-label" for="role_elec">Electrician</label>
          </div>
          <div class="form-check">
            <input class="form-check-input" type="checkbox"
                   name="roles" value="millwright" id="role_mill">
            <label class="form-check-label" for="role_mill">Millwright</label>
          </div>
          <div class="form-check">
            <input class="form-check-input" type="checkbox"
                   name="roles" value="tech" id="role_tech">
            <label class="form-check-label" for="role_tech">Tech</label>
          </div>
        </div>

        <div class="modal-footer">
          <button type="button" class="btn btn-dark"
                  data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-warning">Save</button>
        </div>
      </form>
    </div>
  </div>
  {# ───────────────────────── Line priorities accordion ────────────────────────── #}
  <div class="accordion mt-5 mb-4" id="linesPriorityAccordion">
    <div class="accordion-item">
      <h2 class="accordion-header" id="linesPriorityHeading">
        <button class="accordion-button d-flex justify-content-between"
                type="button"
                data-bs-toggle="collapse"
                data-bs-target="#linesPriorityCollapse"
                aria-expanded="false"
                aria-controls="linesPriorityCollapse">
          <span>Line Priorities</span>
        </button>
      </h2>

      <div id="linesPriorityCollapse"
           class="accordion-collapse collapse"
           aria-labelledby="linesPriorityHeading"
           data-bs-parent="#linesPriorityAccordion">

        <div class="accordion-body p-0">

          <ul class="list-group list-group-flush">
            {% for lp in line_priorities %}
              <li class="list-group-item d-flex justify-content-between align-items-center">

                {# ►► left side: line name + arrow buttons                         #}
                <div class="d-flex align-items-center gap-2">
                  <strong>{{ lp.line }}</strong>

                  {# move‑up form — hidden if already top priority (#1)            #}
                  {% if not forloop.first %}
                  <form method="post"
                        action="{% url 'move_line_priority' lp.id 'up' %}"
                        class="d-inline">
                    {% csrf_token %}
                    <button class="btn btn-sm btn-outline-secondary py-0 px-1"
                            title="Move up one">
                      ▲
                    </button>
                  </form>
                  {% endif %}

                  {# move‑down form — hidden if last entry                         #}
                  {% if not forloop.last %}
                  <form method="post"
                        action="{% url 'move_line_priority' lp.id 'down' %}"
                        class="d-inline">
                    {% csrf_token %}
                    <button class="btn btn-sm btn-outline-secondary py-0 px-1"
                            title="Move down one">
                      ▼
                    </button>
                  </form>
                  {% endif %}
                </div>

                {# ►► right side: coloured priority badge                         #}
                {% if lp.priority <= 3 %}
                  <span class="badge bg-danger rounded-pill">{{ lp.priority }}</span>
                {% elif lp.priority <= 7 %}
                  <span class="badge bg-warning text-dark rounded-pill">{{ lp.priority }}</span>
                {% else %}
                  <span class="badge bg-success rounded-pill">{{ lp.priority }}</span>
                {% endif %}

              </li>
            {% empty %}
              <li class="list-group-item text-muted">
                No line priorities defined.
              </li>
            {% endfor %}
          </ul>

        </div>
      </div>
    </div>
  </div>
  {# ───────────────────────── end accordion ────────────────────────────────────── #}



    <!-- Button -->
    <button type="button"
    class="btn btn-warning mb-3"
    data-bs-toggle="modal"
    data-bs-target="#newEmployeeModal">
Add New or Update Employee
</button>
  {% endif %}






{# ───────────────────────── downtime events table ────────────────── #}
<div class="row mt-4{% if not is_manager %} justify-content-center{% endif %}">
  
  <!-- Left: downtime events (always col-md-8) -->
<div class="col-md-8 mb-2">
  <div class="table-responsive mb-2">
    <table class="table table-striped table-hover table-bordered align-middle small mb-0">
      <thead class="table-light">
        <tr>
          <th class="py-1">Open Jobs</th>
        </tr>
      </thead>
      <tbody>
        {% for e in entries %}
          <tr class="{% if not e.closeout_epoch %}table-warning{% endif %}">
            <td class="py-1">
              <div class="d-flex align-items-center">
                
                <!-- Left block: info + labour -->
                <div class="d-flex align-items-center flex-grow-1">
                  <!-- Info text -->
                  <span>
                    {{ e.start_display }} – {{ e.machine }} – {{ e.subcategory }} || Need:
                  </span>

                  <!-- Labour buttons -->
                  {% if e.labour_types %}
                    {% for code in e.labour_types %}
                      {% with code|title as role %}
                        <button
                          type="button"
                          class="btn {% if e.being_worked_on %}btn-dark labour-btn{% else %}btn-outline-dark labour-btn{% endif %} btn-sm ms-2 py-0 px-1"
                          data-event-id="{{ e.id }}"
                          data-role="{{ role }}">
                          {{ role|slice:":1" }}
                        </button>
                      {% endwith %}
                    {% endfor %}
                  {% else %}
                    <span class="text-muted ms-2">–</span>
                  {% endif %}
                </div>

                <!-- Close button or closed timestamp -->
                {% if not e.closeout_epoch %}
                  <button
                    type="button"
                    class="btn btn-info btn-sm py-0 px-1 ms-2 closeout-btn"
                    data-entry-id="{{ e.id }}">
                    Close
                  </button>
                {% else %}
                  <small class="text-muted ms-2">
                    Closed {{ e.closeout_epoch|date:"Y-m-d H:i" }}
                  </small>
                {% endif %}
                
              </div>
            </td>
          </tr>
        {% empty %}
          <tr>
            <td class="text-center py-2">No downtime events found.</td>
          </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>


  {% if is_manager or is_supervisor %}
    <!-- Right: Active List + Maintenance Staff Status -->
    <div class="col-md-4">

      <!-- Active List accordion -->
      <div class="accordion mb-3" id="activeListAccordion">
        <div class="accordion-item">
          <h2 class="accordion-header" id="activeListHeading">
            <button class="accordion-button collapsed"
                    type="button"
                    data-bs-toggle="collapse"
                    data-bs-target="#activeListCollapse"
                    aria-expanded="false"
                    aria-controls="activeListCollapse">
              Active List (who’s working)
            </button>
          </h2>
          <div id="activeListCollapse"
               class="accordion-collapse collapse"
               aria-labelledby="activeListHeading"
               data-bs-parent="#activeListAccordion">
            <div class="accordion-body p-0">
              <ul class="list-group list-group-flush">
                {% for w in inactive_workers %}
                  <li class="list-group-item d-flex justify-content-between align-items-center">
                    {{ w.name }} ({{ w.roles|join:", " }})
                    <button type="button"
                            class="btn btn-sm btn-outline-danger toggle-active-btn"
                            data-username="{{ w.username }}"
                            data-action="activate">
                      Not Active
                    </button>
                  </li>
                {% empty %}
                  <li class="list-group-item text-muted">No inactive staff.</li>
                {% endfor %}
                {% for w in active_workers %}
                  <li class="list-group-item d-flex justify-content-between align-items-center">
                    {{ w.name }} ({{ w.roles|join:", " }})
                    <button type="button"
                            class="btn btn-sm btn-outline-info toggle-active-btn"
                            data-username="{{ w.username }}"
                            data-action="deactivate">
                      Active
                    </button>
                  </li>
                {% endfor %}
              </ul>
            </div>
          </div>
        </div>
      </div>

      <!-- Maintenance Staff Status table -->
      <h5>Maintenance Staff Status</h5>
      <div class="table-responsive">
        <table class="table table-sm table-striped table-bordered align-middle mb-0">
          <thead class="table-light">
            <tr>
              <th>Name</th>
              <th>Roles</th>
              <th>Machine</th>
              <th>Subcategory</th>
            </tr>
          </thead>
          <tbody>
            {% for w in active_workers %}
              {% if w.jobs %}
                {% for job in w.jobs %}
                  <tr>
                    {% if forloop.first %}
                      <td rowspan="{{ w.jobs|length }}">{{ w.name }}</td>
                      <td rowspan="{{ w.jobs|length }}">{{ w.roles|join:", " }}</td>
                    {% endif %}
                    <td>{{ job.machine }}</td>
                    <td>{{ job.subcategory }}</td>
                  </tr>
                {% endfor %}
              {% else %}
                <tr>
                  <td>{{ w.name }}</td>
                  <td>{{ w.roles|join:", " }}</td>
                  <td colspan="2" class="text-center text-muted">Free</td>
                </tr>
              {% endif %}
            {% empty %}
              <tr>
                <td colspan="4" class="text-center py-2">No active maintenance staff.</td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>

    </div>
  {% endif %}

</div>
















  {# ─────────────── CLOSE‑OUT MODAL + SCRIPT (self‑contained) ─────────────── #}

  <!-- 1.  The modal itself -->
  <div class="modal fade" id="closeoutModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-sm">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Close Out Downtime</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>

        <div class="modal-body">
          <!-- hidden id -->
          <input type="hidden" id="closeout-entry-id">

          <div class="mb-3">
            <label for="closeout-date" class="form-label">Date</label>
            <input type="date" id="closeout-date" class="form-control" required>
          </div>

          <div class="mb-3">
            <label for="closeout-time" class="form-label">Time</label>
            <input type="time" id="closeout-time" class="form-control" required>
          </div>

          <div class="mb-3">
            <label for="closeout-comment" class="form-label">What was done?</label>
            <textarea id="closeout-comment"
                      class="form-control"
                      rows="3"
                      maxlength="2000"
                      required></textarea>
          </div>
        </div>

        <div class="modal-footer">
          <button type="button"
                  class="btn btn-secondary"
                  data-bs-dismiss="modal">
            Cancel
          </button>
          <button type="button"
                  id="closeout-confirm"
                  class="btn btn-info">
            Confirm
          </button>
        </div>
      </div>
    </div>
  </div>
    

<!-- -------------------------------------------------------------------------------------->
  
<!-- 1. History Modal -->
<div class="modal fade" id="historyModal" tabindex="-1" aria-hidden="true">
  <!-- fullscreen-sm-down makes it modal-lg on md+ but fullscreen on sm and xs -->
  <div class="modal-dialog modal-lg modal-fullscreen-sm-down">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Labour History</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <!-- Wrap table in table-responsive -->
        <div class="table-responsive">
          <table class="table table-sm mb-0">
            <thead>
              <tr>
                <th>User</th>
                <th>Roles</th>
                <th>Joined At</th>
                <th>Join Comment</th>
                <th>Left At</th>
                <th>Leave Comment</th>
                <th>Total Min</th>
              </tr>
            </thead>
            <tbody id="history-body">
              <!-- JS will inject <tr>…</tr> here -->
            </tbody>
          </table>
        </div>
      </div>
      <div class="modal-footer">
        <button id="history-join-btn" type="button" class="btn btn-warning">Join</button>
        <button id="history-leave-btn" type="button" class="btn btn-outline-danger">Leave</button>
        <button type="button" class="btn btn-dark" data-bs-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>



<!-- 2. Join Modal -->
<div class="modal fade" id="joinModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-sm">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Join Event</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <input type="hidden" id="join-event-id">
        <div class="mb-3">
          <label class="form-label">Date &amp; Time</label>
          <input type="datetime-local"
                 id="join-datetime"
                 class="form-control">
        </div>
        <div class="mb-3">
          <label for="join-comment" class="form-label">Action Plan:</label>
          <textarea id="join-comment"
                    class="form-control"
                    rows="2"
                    required></textarea>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button"
                class="btn btn-dark"
                data-bs-dismiss="modal">
          Cancel
        </button>
        <button id="join-confirm-btn"
                type="button"
                class="btn btn-warning">
          Confirm Join
        </button>
      </div>
    </div>
  </div>
</div>

<!-- 3. Leave Modal -->
<div class="modal fade" id="leaveModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-sm">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Leave Event</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <input type="hidden" id="leave-event-id">
        <div class="mb-3">
          <label class="form-label">Date &amp; Time</label>
          <input type="datetime-local"
                 id="leave-datetime"
                 class="form-control">
        </div>
        <div class="mb-3">
          <label for="leave-comment" class="form-label">What was accomplished:</label>
          <textarea id="leave-comment"
                    class="form-control"
                    rows="2"
                    required></textarea>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button"
                class="btn btn-secondary"
                data-bs-dismiss="modal">
          Cancel
        </button>
        <button id="leave-confirm-btn"
                type="button"
                class="btn btn-danger">
          Confirm Leave
        </button>
      </div>
    </div>
  </div>
</div>




<!-- -------------------------------------------------------------------------------------->


  
<!-- 2) Close-out modal logic -->
<script>
  document.addEventListener('DOMContentLoaded', () => {
    const modalEl      = document.getElementById('closeoutModal');
    const closeoutModal= new bootstrap.Modal(modalEl);
    const entryIdIn    = document.getElementById('closeout-entry-id');
    const dateIn       = document.getElementById('closeout-date');
    const timeIn       = document.getElementById('closeout-time');
    const commentIn    = document.getElementById('closeout-comment');
    const confirmBtn   = document.getElementById('closeout-confirm');
    const csrfToken    = document.querySelector('[name=csrfmiddlewaretoken]').value;
    const url          = "{% url 'closeout_downtime_entry' %}";
  
    document.querySelectorAll('.closeout-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        entryIdIn.value = btn.dataset.entryId;
        const now = new Date();
        dateIn.value    = now.toISOString().slice(0,10);
        timeIn.value    = now.toTimeString().slice(0,5);
        commentIn.value = '';
        confirmBtn.disabled = false;
        closeoutModal.show();
      });
    });
  
    confirmBtn.addEventListener('click', () => {
      const id   = entryIdIn.value;
      const date = dateIn.value;
      const time = timeIn.value;
      const note = commentIn.value.trim();
      if (!id || !date || !time || !note) {
        return alert('All fields are required.');
      }
      confirmBtn.disabled = true;
      fetch(url, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRFToken': csrfToken,
        },
        body: JSON.stringify({
          entry_id: id,
          closeout: `${date} ${time}`,
          closeout_comment: note
        })
      })
      .then(r => r.ok ? r.json() : Promise.reject())
      .then(() => {
        document
          .querySelector(`button.closeout-btn[data-entry-id="${id}"]`)
          .closest('tr')
          .remove();
        closeoutModal.hide();
      })
      .catch(() => alert('Error closing out entry.'))
      .finally(() => confirmBtn.disabled = false);
    });
  });
  </script>
  



  <script>
    document.addEventListener('DOMContentLoaded', () => {
      // ── Helpers & Modals ─────────────────────────────────────────────────────
      const currentUser = "{{ request.user.username }}";
      const historyModal = new bootstrap.Modal(document.getElementById('historyModal'));
      const joinModal    = new bootstrap.Modal(document.getElementById('joinModal'));
      const leaveModal   = new bootstrap.Modal(document.getElementById('leaveModal'));
    
      function getLocalDateTimeValue() {
        const now = new Date();
        const pad = n => String(n).padStart(2,'0');
        return [
          now.getFullYear(),
          pad(now.getMonth()+1),
          pad(now.getDate())
        ].join('-') + 'T' +
        pad(now.getHours()) + ':' + pad(now.getMinutes());
      }
    
      // ── Render a single row (8 <td> to match your <thead>) ────────────────────
      function renderRow(e) {
        const isOpen  = !e.closeout_at;
        const rowCls  = isOpen ? 'table-warning' : '';
        const closeCell = isOpen
          ? `<button class="btn btn-sm btn-info closeout-btn" data-entry-id="${e.id}">Close out</button>`
          : e.closeout_at;
    
        // Labour-needed buttons
        let labourHtml = '<span class="text-muted">—</span>';
        if (e.labour_types && e.labour_types.length) {
          labourHtml = e.labour_types.map(code => {
            const style = e.being_worked_on ? 'btn-dark' : 'btn-outline-dark';
            return `
              <button
                type="button"
                class="btn ${style} btn-sm labour-btn me-1"
                data-event-id="${e.id}"
                data-role="${code}"
              >${code}</button>`;
          }).join('');
        }
    
        // Comment cell: just the comment text now
        const commentCell = e.comment;
    
        return `
          <tr class="${rowCls}">
            <td>${e.start_display}</td>
            <td>${closeCell}</td>
            <td>${e.line}</td>
            <td>${e.machine}</td>
            <td><span class="badge bg-dark">${e.category}</span></td>
            <td><span class="badge bg-secondary">${e.subcategory}</span></td>
            <td>${labourHtml}</td>
            <td>${commentCell}</td>
          </tr>`;
      }
    
      // ── Labour-button → “History” modal hookup ────────────────────────────────
      function attachLabourHandlers() {
        document.querySelectorAll('.labour-btn').forEach(btn => {
          if (btn.dataset.init) return;
          btn.dataset.init = '1';
          btn.addEventListener('click', () => {
            const id = btn.dataset.eventId;
            fetch(`/plant/downtime/${id}/history/`)
              .then(r => r.ok ? r.json() : Promise.reject())
              .then(data => {
                const tbody = document.getElementById('history-body');
                tbody.innerHTML = '';
                let userHasOpen = false;
                data.history.forEach(p => {

                  // build a little badge list (or comma-list if you prefer)
                  const rolesHtml = p.roles.length
                  ? p.roles.map(r => `<span class="badge bg-secondary me-1">${r}</span>`).join('')
                  : '<span class="text-muted">—</span>';
                  
                  if (p.user === currentUser && !p.leave_at) userHasOpen = true;
                  tbody.insertAdjacentHTML('beforeend', `
                    <tr>
                      <td>${p.user}</td>
                      <td>${rolesHtml}</td>           <!-- ← render roles here -->
                      <td>${p.join_at}</td>
                      <td>${p.join_comment}</td>
                      <td>${p.leave_at || '—'}</td>
                      <td>${p.leave_comment}</td>
                      <td>${p.total_minutes}</td>
                    </tr>`);
                });
                // toggle the history‐modal buttons
                document.getElementById('history-join-btn').style.display  = userHasOpen ? 'none' : 'inline-block';
                document.getElementById('history-leave-btn').style.display = userHasOpen ? 'inline-block' : 'none';
                document.getElementById('history-join-btn').dataset.eventId  = id;
                document.getElementById('history-leave-btn').dataset.eventId = id;
                historyModal.show();
              })
              .catch(() => alert('Could not load history.'));
          });
        });
      }
      attachLabourHandlers();
    
      // ── Load-More logic ───────────────────────────────────────────────────────
      const loadMoreBtn = document.getElementById('load-more-btn');
      let offset        = {{ page_size }};
      const loadUrl     = "{% url 'load_more_downtime_entries' %}";
    
      loadMoreBtn?.addEventListener('click', () => {
        loadMoreBtn.disabled = true;
        fetch(`${loadUrl}?offset=${offset}`)
          .then(r => r.ok ? r.json() : Promise.reject())
          .then(data => {
            const tbody = document.querySelector('table tbody');
            data.entries.forEach(e => tbody.insertAdjacentHTML('beforeend', renderRow(e)));
            offset += {{ page_size }};
            if (!data.has_more) loadMoreBtn.remove();
            else loadMoreBtn.disabled = false;
            attachLabourHandlers();
          })
          .catch(() => {
            alert('Error loading more entries');
            loadMoreBtn.disabled = false;
          });
      });
    
      // ── Filters (unchanged) ────────────────────────────────────────────────────
      // ... your labour‐type and participant‐filters code here ...
    
      // ── History→Join & Leave modals ──────────────────────────────────────────
      document.getElementById('history-join-btn').addEventListener('click', e => {
        const id = e.currentTarget.dataset.eventId;
        document.getElementById('join-event-id').value     = id;
        document.getElementById('join-datetime').value     = getLocalDateTimeValue();
        document.getElementById('join-comment').value      = '';
        historyModal.hide();
        joinModal.show();
      });
      document.getElementById('join-confirm-btn').addEventListener('click', () => {
        const id   = document.getElementById('join-event-id').value;
        const note = document.getElementById('join-comment').value.trim();
        if (!note) return alert('Please say what you plan to do.');
        fetch("{% url 'join_downtime_event' %}", {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken':  document.querySelector('[name=csrfmiddlewaretoken]').value
          },
          body: JSON.stringify({
            event_id:     id,
            join_comment: note,
            join_datetime: document.getElementById('join-datetime').value
          })
        })
        .then(r => r.ok ? location.reload() : Promise.reject())
        .catch(() => alert('Could not join event.'));
      });
    
      document.getElementById('history-leave-btn').addEventListener('click', e => {
        const id = e.currentTarget.dataset.eventId;
        document.getElementById('leave-event-id').value    = id;
        document.getElementById('leave-datetime').value    = getLocalDateTimeValue();
        document.getElementById('leave-comment').value     = '';
        historyModal.hide();
        leaveModal.show();
      });
      document.getElementById('leave-confirm-btn').addEventListener('click', () => {
        const id   = document.getElementById('leave-event-id').value;
        const note = document.getElementById('leave-comment').value.trim();
        if (!note) return alert('Please describe what you did.');
        fetch("{% url 'leave_downtime_event' %}", {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken':  document.querySelector('[name=csrfmiddlewaretoken]').value
          },
          body: JSON.stringify({
            event_id:      id,
            leave_comment: note,
            leave_datetime: document.getElementById('leave-datetime').value
          })
        })
        .then(r => r.ok ? location.reload() : Promise.reject())
        .catch(() => alert('Could not leave event.'));
      });
    });







    document.addEventListener('DOMContentLoaded', () => {
      // 1) On load, check if we told it to reopen:
      if (localStorage.getItem('activeListWasOpen') === 'true') {
        const collapseEl = document.getElementById('activeListCollapse');
        new bootstrap.Collapse(collapseEl, { toggle: false }).show();
        localStorage.removeItem('activeListWasOpen');
      }
    
      // 2) Wire up each toggle button
      document.querySelectorAll('.toggle-active-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          // before we hit “fetch”, save the current open/closed state
          const collapseEl = document.getElementById('activeListCollapse');
          localStorage.setItem(
            'activeListWasOpen',
            collapseEl.classList.contains('show')
          );
    
          // now fire off your existing toggle call
          const username = btn.dataset.username;
          const action   = btn.dataset.action;
          const formData = new FormData();
          formData.append('username', username);
          formData.append('action', action);
    
          fetch("{% url 'toggle_active' %}", {
            method: 'POST',
            headers: {
              'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            },
            body: formData
          })
          .then(r => {
            if (!r.ok) throw new Error();
            return r.json();
          })
          .then(() => {
            // reload—and on next DOMContentLoaded we’ll re-open it
            location.reload();
          })
          .catch(() => alert('Error updating active list.'));
        });
      });
    });
    
    </script>
    
    
    
    
  




</div>




      
  
{% endblock %}