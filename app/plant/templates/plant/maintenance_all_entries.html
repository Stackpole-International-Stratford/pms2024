{% extends "parent.html" %}
{% load static %}
{% block content %}
<div class="container mt-4">
  <h1 class="mb-4">Open Downtime Events</h1>


  {% if is_manager %}
  {# ───────────────────────── Line priorities accordion ────────────────────────── #}
  <div class="accordion mt-5" id="linesPriorityAccordion">
    <div class="accordion-item">
      <h2 class="accordion-header" id="linesPriorityHeading">
        <button class="accordion-button d-flex justify-content-between"
                type="button"
                data-bs-toggle="collapse"
                data-bs-target="#linesPriorityCollapse"
                aria-expanded="false"
                aria-controls="linesPriorityCollapse">
          <span>Line Priorities</span>
        </button>
      </h2>

      <div id="linesPriorityCollapse"
           class="accordion-collapse collapse"
           aria-labelledby="linesPriorityHeading"
           data-bs-parent="#linesPriorityAccordion">

        <div class="accordion-body p-0">

          <ul class="list-group list-group-flush">
            {% for lp in line_priorities %}
              <li class="list-group-item d-flex justify-content-between align-items-center">

                {# ►► left side: line name + arrow buttons                         #}
                <div class="d-flex align-items-center gap-2">
                  <strong>{{ lp.line }}</strong>

                  {# move‑up form — hidden if already top priority (#1)            #}
                  {% if not forloop.first %}
                  <form method="post"
                        action="{% url 'move_line_priority' lp.id 'up' %}"
                        class="d-inline">
                    {% csrf_token %}
                    <button class="btn btn-sm btn-outline-secondary py-0 px-1"
                            title="Move up one">
                      ▲
                    </button>
                  </form>
                  {% endif %}

                  {# move‑down form — hidden if last entry                         #}
                  {% if not forloop.last %}
                  <form method="post"
                        action="{% url 'move_line_priority' lp.id 'down' %}"
                        class="d-inline">
                    {% csrf_token %}
                    <button class="btn btn-sm btn-outline-secondary py-0 px-1"
                            title="Move down one">
                      ▼
                    </button>
                  </form>
                  {% endif %}
                </div>

                {# ►► right side: coloured priority badge                         #}
                {% if lp.priority <= 3 %}
                  <span class="badge bg-danger rounded-pill">{{ lp.priority }}</span>
                {% elif lp.priority <= 7 %}
                  <span class="badge bg-warning text-dark rounded-pill">{{ lp.priority }}</span>
                {% else %}
                  <span class="badge bg-success rounded-pill">{{ lp.priority }}</span>
                {% endif %}

              </li>
            {% empty %}
              <li class="list-group-item text-muted">
                No line priorities defined.
              </li>
            {% endfor %}
          </ul>

        </div>
      </div>
    </div>
  </div>
  {# ───────────────────────── end accordion ────────────────────────────────────── #}
  {% endif %}

    {# ────── Labour-type filters (exclude OPERATOR) ────── #}
    <div class="mb-4">
      {% for code,label in labour_choices %}
        {% if code != 'OPERATOR' %}
          <div class="form-check form-check-inline">
            <input
              class="form-check-input labour-filter"
              type="checkbox"
              id="filter{{ code }}"
              value="{{ code }}"
            >
            <label
              class="form-check-label"
              for="filter{{ code }}"
            >{{ label }}</label>
          </div>
        {% endif %}
      {% endfor %}
    </div>
  

{# ───────────────────────── downtime events table ────────────────── #}
<div class="table-responsive mt-4">
  <table class="table table-striped table-hover table-bordered align-middle">
    <thead class="table-light">
      <tr>
        <th>Start</th>
        <th>Close-out</th>
        <th>Line</th>
        <th>Machine</th>
        <th>Category</th>
        <th>Sub-category</th>
        <th>Labour&nbsp;Needed</th>
        <th>Participants</th>
        <th>Comment</th>
      </tr>
    </thead>
    <tbody>
      {% for e in entries %}
      <tr class="{% if not e.closeout_epoch %}table-warning{% endif %}">
        {# Start time #}
        <td>{{ e.start_at|date:"Y-m-d H:i" }}</td>

        {# Close-out #}
        <td>
          {% if e.closeout_epoch %}
            {{ e.closeout_epoch|date:"Y-m-d H:i" }}
          {% else %}
            {% if e.assigned_to == request.user.username %}
              <button class="btn btn-sm btn-info closeout-btn"
                      data-entry-id="{{ e.id }}">
                Close Out
              </button>
            {% else %}
              <span class="text-muted">— open —</span>
            {% endif %}
          {% endif %}
        </td>

        {# Line, Machine, Category, Sub-category #}
        <td>{{ e.line }}</td>
        <td>{{ e.machine }}</td>
        <td><span class="badge bg-dark">{{ e.category }}</span></td>
        <td><span class="badge bg-secondary">{{ e.subcategory }}</span></td>

        {# Labour needed badges #}
        <td>
          {% if e.labour_types %}
            {% for code in e.labour_types %}
              <span class="badge bg-info">{{ code }}</span>
            {% endfor %}
          {% else %}
            <span class="text-muted">—</span>
          {% endif %}
        </td>

        {# Participants column #}
        <td class="participants-cell" data-event-id="{{ e.id }}">
          {% for p in e.participants.all %}
            <div class="mb-1">
              {{ p.user.username }}
              {% if p.leave_epoch is None %}
                <button
                  class="btn btn-sm btn-outline-danger leave-btn"
                  data-event-id="{{ e.id }}"
                >Leave</button>
              {% else %}
                <small>– {{ p.total_minutes }} min</small>
              {% endif %}
            </div>
          {% endfor %}

          {# Show Join if user doesn’t currently have an open participation #}
          {% if not e.user_has_open %}
            <button
              class="btn btn-sm btn-outline-success join-btn mt-2"
              data-event-id="{{ e.id }}"
            >Join</button>
          {% endif %}
        </td>

        {# Comment #}
        <td>{{ e.comment }}</td>
      </tr>
      {% empty %}
      <tr>
        <td colspan="9" class="text-center py-4">No downtime events found.</td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
</div>

<div class="text-center mt-3">
  <button id="load-more-btn" class="btn btn-dark">Load&nbsp;More</button>
</div>



{# ───────────────────────── Close‑out modal (unchanged) ────────────────────────── #}
<div class="modal fade" id="allCloseoutModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-sm">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Close Out Assigned Downtime</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <form id="all-closeout-form">
          {% csrf_token %}
          <input type="hidden" id="all-closeout-entry-id">
          <div class="mb-3">
            <label for="all-closeout-date" class="form-label">Date</label>
            <input type="date" id="all-closeout-date" class="form-control" required>
          </div>
          <div class="mb-3">
            <label for="all-closeout-time" class="form-label">Time</label>
            <input type="time" id="all-closeout-time" class="form-control" required>
          </div>
          <div class="mb-3">
            <label for="all-closeout-comment" class="form-label">What was done?</label>
            <textarea id="all-closeout-comment" class="form-control"
                      rows="3" maxlength="2000" required></textarea>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button"
                class="btn btn-secondary"
                data-bs-dismiss="modal">Cancel</button>
        <button type="button"
                id="all-closeout-confirm"
                class="btn btn-info">Confirm</button>
      </div>
    </div>
  </div>
</div>

<script>
  (function(){
    // ── Utilities & Config ────────────────────────────────────────────
    function getCookie(name) {
      let val = null;
      document.cookie?.split(';').forEach(c => {
        c = c.trim();
        if (c.startsWith(name + '=')) {
          val = decodeURIComponent(c.slice(name.length + 1));
        }
      });
      return val;
    }
  
    const currentUser    = "{{ request.user.username }}",
          csrftoken      = getCookie('csrftoken'),
          joinUrl        = "{% url 'join_downtime_event' %}",
          leaveUrl       = "{% url 'leave_downtime_event' %}",
          allCloseoutUrl = "{% url 'closeout_assigned_downtime_entry' %}",
          loadMoreUrl    = "{% url 'load_more_downtime_entries' %}",
          pageSize       = {{ page_size }},
          table          = document.querySelector('table'),
          loadMoreBtn    = document.getElementById('load-more-btn');
  
    let offset = pageSize;
  
    // ── Row Renderer ──────────────────────────────────────────────────
    function renderRow(e) {
      // labour-needed badges
      const labourHtml = Array.isArray(e.labour_types) && e.labour_types.length
        ? e.labour_types.map(l => `<span class="badge bg-info">${l}</span>`).join(' ')
        : '<span class="text-muted">—</span>';
  
      // participants cell
      const participantsHtml = (() => {
        if (Array.isArray(e.participants) && e.participants.length) {
          return e.participants.map(p => {
            if (p.leave_epoch == null) {
              // still on the job
              return `<div>
                ${p.user}
                ${p.user === currentUser
                  ? `<button
                       class="btn btn-sm btn-outline-danger leave-btn"
                       data-event-id="${e.id}">
                       Leave
                     </button>`
                  : ''}
              </div>`;
            } else {
              // finished
              return `<div>${p.user} <small>– ${p.total_minutes} min</small></div>`;
            }
          }).join('');
        }
        // no participants yet
        return `<button
          class="btn btn-sm btn-outline-success join-btn"
          data-event-id="${e.id}">
          Join
        </button>`;
      })();
  
      // close-out cell
      const closeoutHtml = e.closeout_at
        ? e.closeout_at
        : `<span class="text-muted">— open —</span>`;
  
      return `
        <tr class="${e.closeout_at ? '' : 'table-warning'}">
          <td>${e.start_at}</td>
          <td>${closeoutHtml}</td>
          <td>${e.line}</td>
          <td>${e.machine}</td>
          <td><span class="badge bg-dark">${e.category}</span></td>
          <td><span class="badge bg-secondary">${e.subcategory}</span></td>
          <td>${labourHtml}</td>
          <td class="participants-cell" data-event-id="${e.id}">
            ${participantsHtml}
          </td>
          <td>${e.comment}</td>
        </tr>`;
    }
  
    // ── Load More AJAX ────────────────────────────────────────────────
    loadMoreBtn.addEventListener('click', () => {
      loadMoreBtn.disabled = true;
      fetch(`${loadMoreUrl}?offset=${offset}`)
        .then(r => r.ok ? r.json() : Promise.reject())
        .then(data => {
          data.entries.forEach(e => {
            // ensure the JSON includes a `participants` array for each entry
            document.querySelector('tbody')
                    .insertAdjacentHTML('beforeend', renderRow(e));
          });
          offset += pageSize;
          if (!data.has_more) {
            loadMoreBtn.remove();
          } else {
            loadMoreBtn.disabled = false;
          }
        })
        .catch(() => {
          alert('Error loading more entries');
          loadMoreBtn.disabled = false;
        });
    });
  
    // ── Delegated Table Clicks: Join, Leave, Close-Out ─────────────────
    table.addEventListener('click', e => {
      const btn = e.target.closest('button');
      if (!btn) return;
      const eventId = btn.dataset.eventId;
  
      // JOIN
      if (btn.classList.contains('join-btn')) {
        fetch(joinUrl, {
          method: 'POST',
          headers: {
            'Content-Type':'application/json',
            'X-CSRFToken': csrftoken
          },
          body: JSON.stringify({ event_id: eventId })
        })
        .then(r => r.ok ? r.json() : Promise.reject())
        .then(data => {
          // replace JOIN with currentUser + LEAVE button
          btn.outerHTML = `
            <div>
              ${currentUser}
              <button
                class="btn btn-sm btn-outline-danger leave-btn"
                data-event-id="${eventId}">
                Leave
              </button>
            </div>`;
        })
        .catch(() => alert('Error joining event'));
        return;
      }
  
      // LEAVE
      if (btn.classList.contains('leave-btn')) {
        fetch(leaveUrl, {
          method: 'POST',
          headers: {
            'Content-Type':'application/json',
            'X-CSRFToken': csrftoken
          },
          body: JSON.stringify({ event_id: eventId })
        })
        .then(r => r.ok ? r.json() : Promise.reject())
        .then(data => {
          btn.outerHTML = `<small>– ${data.total_minutes} min</small>`;
        })
        .catch(() => alert('Error leaving event'));
        return;
      }
  
      // CLOSE-OUT (unmodified)
      if (btn.classList.contains('closeout-btn')) {
        const now = new Date(),
              d   = now.toISOString().slice(0,10),
              t   = now.toTimeString().slice(0,5);
  
        document.getElementById('all-closeout-entry-id').value = eventId;
        document.getElementById('all-closeout-date').value     = d;
        document.getElementById('all-closeout-time').value     = t;
        document.getElementById('all-closeout-comment').value  = '';
        new bootstrap.Modal(
          document.getElementById('allCloseoutModal')
        ).show();
      }
    });
  
    // ── Confirm Close-Out ─────────────────────────────────────────────
    document.getElementById('all-closeout-confirm')
      .addEventListener('click', () => {
        const entryId = document.getElementById('all-closeout-entry-id').value,
              date    = document.getElementById('all-closeout-date').value,
              time    = document.getElementById('all-closeout-time').value,
              comment = document.getElementById('all-closeout-comment').value.trim();
  
        if (!date || !time)   return alert('Pick date & time.');
        if (!comment)         return alert('Please describe what you did.');
  
        fetch(allCloseoutUrl, {
          method: 'POST',
          headers: {
            'Content-Type':'application/json',
            'X-CSRFToken': csrftoken
          },
          body: JSON.stringify({
            entry_id:         entryId,
            closeout:         `${date} ${time}`,
            closeout_comment: comment
          })
        })
        .then(r => r.ok ? r.json() : Promise.reject())
        .then(() => {
          bootstrap.Modal.getInstance(
            document.getElementById('allCloseoutModal')
          ).hide();
          const row = table.querySelector(
            `button[data-entry-id="${entryId}"]`
          ).closest('tr');
          row.remove();
        })
        .catch(() => alert('Error closing out.'));
      });
  
    // ── Labour-Type Live Filtering ─────────────────────────────────────
    const labourCheckboxes = Array.from(
      document.querySelectorAll('.labour-filter')
    );
  
    function filterByLabour() {
      const selected = labourCheckboxes
        .filter(cb => cb.checked)
        .map(cb => cb.value);
  
      document
        .querySelectorAll('table tbody tr')
        .forEach(row => {
          const labourCell = row.cells[6];
          const rowCodes   = Array.from(
            labourCell.querySelectorAll('span.badge.bg-info')
          ).map(span => span.textContent.trim());
  
          if (selected.length === 0) {
            row.style.display = '';
          } else {
            row.style.display = rowCodes.some(c => selected.includes(c))
              ? ''
              : 'none';
          }
        });
    }
  
    labourCheckboxes.forEach(cb =>
      cb.addEventListener('change', filterByLabour)
    );
    filterByLabour();
  
  })();
  </script>
  
{% endblock %}
