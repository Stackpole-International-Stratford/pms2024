{% extends "parent.html" %}
{% load static %}
{% block content %}
<div class="container mt-4">
  {{ user_roles|json_script:"user‑roles-json" }}   {# ←  place it here #}

  <h1 class="mb-4">Open Downtime Events</h1>


  {% if is_manager %}

    {# ───────────────────── New‑employee button + modal ───────────────────── #}

  <!-- Button -->
  <button type="button"
          class="btn btn-warning mb-3"
          data-bs-toggle="modal"
          data-bs-target="#newEmployeeModal">
    Add New or Update Employee
  </button>

  <!-- Modal (place it once per page, usually near bottom) -->
  <div class="modal fade" id="newEmployeeModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
      <form method="post" action="{% url 'add_employee' %}" class="modal-content">
        {% csrf_token %}
        <div class="modal-header">
          <h5 class="modal-title">Add New or Update Employee</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>

        <div class="modal-body">
          <div class="mb-3">
            <label for="empFirst" class="form-label">First name</label>
            <input id="empFirst" name="first_name" class="form-control" required>
          </div>
          <div class="mb-3">
            <label for="empLast" class="form-label">Last name</label>
            <input id="empLast" name="last_name" class="form-control" required>
          </div>

          <p class="mb-1 fw-semibold">Profession(s)</p>
          <div class="form-check">
            <input class="form-check-input" type="checkbox"
                   name="roles" value="electrician" id="role_elec">
            <label class="form-check-label" for="role_elec">Electrician</label>
          </div>
          <div class="form-check">
            <input class="form-check-input" type="checkbox"
                   name="roles" value="millwright" id="role_mill">
            <label class="form-check-label" for="role_mill">Millwright</label>
          </div>
          <div class="form-check">
            <input class="form-check-input" type="checkbox"
                   name="roles" value="tech" id="role_tech">
            <label class="form-check-label" for="role_tech">Tech</label>
          </div>
        </div>

        <div class="modal-footer">
          <button type="button" class="btn btn-dark"
                  data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-warning">Save</button>
        </div>
      </form>
    </div>
  </div>
  {# ───────────────────────── Line priorities accordion ────────────────────────── #}
  <div class="accordion mt-5 mb-4" id="linesPriorityAccordion">
    <div class="accordion-item">
      <h2 class="accordion-header" id="linesPriorityHeading">
        <button class="accordion-button d-flex justify-content-between"
                type="button"
                data-bs-toggle="collapse"
                data-bs-target="#linesPriorityCollapse"
                aria-expanded="false"
                aria-controls="linesPriorityCollapse">
          <span>Line Priorities</span>
        </button>
      </h2>

      <div id="linesPriorityCollapse"
           class="accordion-collapse collapse"
           aria-labelledby="linesPriorityHeading"
           data-bs-parent="#linesPriorityAccordion">

        <div class="accordion-body p-0">

          <ul class="list-group list-group-flush">
            {% for lp in line_priorities %}
              <li class="list-group-item d-flex justify-content-between align-items-center">

                {# ►► left side: line name + arrow buttons                         #}
                <div class="d-flex align-items-center gap-2">
                  <strong>{{ lp.line }}</strong>

                  {# move‑up form — hidden if already top priority (#1)            #}
                  {% if not forloop.first %}
                  <form method="post"
                        action="{% url 'move_line_priority' lp.id 'up' %}"
                        class="d-inline">
                    {% csrf_token %}
                    <button class="btn btn-sm btn-outline-secondary py-0 px-1"
                            title="Move up one">
                      ▲
                    </button>
                  </form>
                  {% endif %}

                  {# move‑down form — hidden if last entry                         #}
                  {% if not forloop.last %}
                  <form method="post"
                        action="{% url 'move_line_priority' lp.id 'down' %}"
                        class="d-inline">
                    {% csrf_token %}
                    <button class="btn btn-sm btn-outline-secondary py-0 px-1"
                            title="Move down one">
                      ▼
                    </button>
                  </form>
                  {% endif %}
                </div>

                {# ►► right side: coloured priority badge                         #}
                {% if lp.priority <= 3 %}
                  <span class="badge bg-danger rounded-pill">{{ lp.priority }}</span>
                {% elif lp.priority <= 7 %}
                  <span class="badge bg-warning text-dark rounded-pill">{{ lp.priority }}</span>
                {% else %}
                  <span class="badge bg-success rounded-pill">{{ lp.priority }}</span>
                {% endif %}

              </li>
            {% empty %}
              <li class="list-group-item text-muted">
                No line priorities defined.
              </li>
            {% endfor %}
          </ul>

        </div>
      </div>
    </div>
  </div>
  {# ───────────────────────── end accordion ────────────────────────────────────── #}
  {% endif %}

    {# ────── Labour-type filters (exclude OPERATOR) ────── #}
    <div class="mb-4">
      {% for code,label in labour_choices %}
        {% if code != 'OPERATOR' %}
          <div class="form-check form-check-inline">
            <input
              class="form-check-input labour-filter"
              type="checkbox"
              id="filter{{ code }}"
              value="{{ code }}"
            >
            <label
              class="form-check-label"
              for="filter{{ code }}"
            >{{ label }}</label>
          </div>
        {% endif %}
      {% endfor %}
    </div>
  

    {# ────── Participant filters will go here ────── #}
    <div id="participant-filters" class="mb-3"></div>


{# ───────────────────────── downtime events table ────────────────── #}
<div class="table-responsive mt-4">
  <table class="table table-striped table-hover table-bordered align-middle">
    <thead class="table-light">
      <tr>
        <th>Start</th>
        <th>Close-out</th>
        <th>Line</th>
        <th>Machine</th>
        <th>Category</th>
        <th>Sub-category</th>
        <th>Labour&nbsp;Needed</th>
        <th>Participants</th>
        <th>Comment</th>
      </tr>
    </thead>
    <tbody>
      {% for e in entries %}
      <tr class="{% if not e.closeout_epoch %}table-warning{% endif %}">
        {# ── Start time, conditionally formatted ── #}
        <td>{{ e.start_display }}</td>


        {# Close-out #}
        <td>
          {% if e.closeout_epoch %}
            {{ e.closeout_epoch|date:"Y-m-d H:i" }}
          {% else %}
            <button class="btn btn-sm btn-info closeout-btn"
                    data-entry-id="{{ e.id }}">
              Close&nbsp;out
            </button>
          {% endif %}
        </td>

        {# Line, Machine, Category, Sub-category #}
        <td>{{ e.line }}</td>
        <td>{{ e.machine }}</td>
        <td><span class="badge bg-dark">{{ e.category }}</span></td>
        <td><span class="badge bg-secondary">{{ e.subcategory }}</span></td>

        {# Labour needed badges #}
        <td>
          {% if e.labour_types %}
            {% for code in e.labour_types %}
              <span class="badge bg-info">{{ code }}</span>
            {% endfor %}
          {% else %}
            <span class="text-muted">—</span>
          {% endif %}
        </td>

        {# Participants column #}
        <td class="participants-cell" data-event-id="{{ e.id }}">
          {% for p in e.participants.all %}
            <div class="mb-1">
              {{ p.user.username }}
        
              {% if p.user == request.user %}
                {# only *you* get a Leave button on your own open participation #}
                {% if p.leave_epoch is None %}
                  <button
                    class="btn btn-sm btn-outline-danger leave-btn"
                    data-event-id="{{ e.id }}"
                  >Leave</button>
                {% else %}
                  <small>– {{ p.total_minutes }} min</small>
                {% endif %}
        
              {% else %}
                {# for everyone else, if they’ve left show minutes, otherwise nothing #}
                {% if p.leave_epoch %}
                  <small>– {{ p.total_minutes }} min</small>
                {% endif %}
              {% endif %}
            </div>
          {% endfor %}
        
          {# Show Join only if *you* don’t already have an open participation #}
          {% if not e.user_has_open %}
            <button
              class="btn btn-sm btn-outline-dark join-btn mt-2"
              data-event-id="{{ e.id }}"
            >Join</button>
          {% endif %}
        </td>
        

        {# Comment #}
        <td>{{ e.comment }}</td>
      </tr>
      {% empty %}
      <tr>
        <td colspan="9" class="text-center py-4">No downtime events found.</td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
</div>

<div class="text-center mt-3">
  <button id="load-more-btn" class="btn btn-dark">Load&nbsp;More</button>
</div>


  <!-- ─────────────────── Join Comment Modal ─────────────────── -->
  <div class="modal fade" id="joinCommentModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-sm">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Joining Downtime Event</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <div class="mb-3">
            <label for="join-comment-text" class="form-label">Plan of action:</label>
            <textarea id="join-comment-text" class="form-control" rows="3" maxlength="2000" required></textarea>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-dark" data-bs-dismiss="modal">Cancel</button>
          <button type="button" id="join-confirm-btn" class="btn btn-warning">Confirm</button>
        </div>
      </div>
    </div>
  </div>

  <!-- ─────────────────── Leave Comment Modal ─────────────────── -->
  <div class="modal fade" id="leaveCommentModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-sm">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Leaving Downtime Event</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <div class="mb-3">
            <label for="leave-comment-text" class="form-label">Reason for leaving:</label>
            <textarea id="leave-comment-text" class="form-control" rows="3" maxlength="2000" required></textarea>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-dark" data-bs-dismiss="modal">Cancel</button>
          <button type="button" id="leave-confirm-btn" class="btn btn-warning">Confirm</button>
        </div>
      </div>
    </div>
  </div>


{# ─────────────── CLOSE‑OUT MODAL + SCRIPT (self‑contained) ─────────────── #}

<!-- 1.  The modal itself -->
<div class="modal fade" id="closeoutModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-sm">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Close Out Downtime</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>

      <div class="modal-body">
        <!-- hidden id -->
        <input type="hidden" id="closeout-entry-id">

        <div class="mb-3">
          <label for="closeout-date" class="form-label">Date</label>
          <input type="date" id="closeout-date" class="form-control" required>
        </div>

        <div class="mb-3">
          <label for="closeout-time" class="form-label">Time</label>
          <input type="time" id="closeout-time" class="form-control" required>
        </div>

        <div class="mb-3">
          <label for="closeout-comment" class="form-label">What was done?</label>
          <textarea id="closeout-comment"
                    class="form-control"
                    rows="3"
                    maxlength="2000"
                    required></textarea>
        </div>
      </div>

      <div class="modal-footer">
        <button type="button"
                class="btn btn-secondary"
                data-bs-dismiss="modal">
          Cancel
        </button>
        <button type="button"
                id="closeout-confirm"
                class="btn btn-info">
          Confirm
        </button>
      </div>
    </div>
  </div>
  
</div>



<script>
  document.addEventListener('DOMContentLoaded', () => {
    /* ---- read the roles we just embedded ---- */
    const userRoles = JSON.parse(
          document.getElementById('user‑roles-json').textContent
        ).map(r => r.toUpperCase());           // ['ELECTRICIAN', 'TECH']
  
    /* ---- delay the auto‑tick by one second ---- */
    setTimeout(() => {
      /* check the corresponding boxes */
      userRoles.forEach(code => {
        const cb = document.querySelector(`.labour-filter[value="${code}"]`);
        if (cb) cb.checked = true;
      });
  
      /* refresh the table filter */
      if (typeof filterByLabour === 'function') filterByLabour();
    }, 1000);   // 1 000 ms = 1 s
  });
  </script>
  
  


<!-- 2.  JavaScript that powers the modal -->
<script>
  
  /* ───────── loader guard ───────── */
  document.addEventListener('DOMContentLoaded', () => {
    /* if the Bootstrap bundle hasn’t executed yet, wait for the window load‑event */
    if (typeof bootstrap === 'undefined') {
      window.addEventListener('load', initCloseout);
    } else {
      initCloseout();
    }
  
    /* ─────── the original script, moved into a function ─────── */
    function initCloseout () {
  
      /* ------------------------------------------------------------------
       *  configuration
       * -----------------------------------------------------------------*/
      const closeoutUrl = "{% url 'closeout_downtime_entry' %}";
      const csrfToken   =
            document.querySelector('[name=csrfmiddlewaretoken]')?.value || '';
  
      /* ------------------------------------------------------------------
       *  quick handles to modal elements
       * -----------------------------------------------------------------*/
      const modalEl      = document.getElementById('closeoutModal');
      const entryIdInput = document.getElementById('closeout-entry-id');
      const dateInput    = document.getElementById('closeout-date');
      const timeInput    = document.getElementById('closeout-time');
      const commentInput = document.getElementById('closeout-comment');
      const confirmBtn   = document.getElementById('closeout-confirm');
      const bsModal      = new bootstrap.Modal(modalEl, { backdrop: 'static' });
  
      /* helper: open the modal with fresh defaults ----------------------- */
      function openModal(entryId) {
        entryIdInput.value = entryId;
  
        const now = new Date();
        dateInput.value    = now.toISOString().slice(0, 10);
        timeInput.value    = now.toTimeString().slice(0, 5);
        commentInput.value = '';
  
        bsModal.show();
      }
  
      /* helper: POST the close‑out to the server ------------------------- */
      function submitCloseout() {
        const id   = entryIdInput.value;
        const date = dateInput.value;
        const time = timeInput.value;
        const note = commentInput.value.trim();
  
        if (!id)   return alert('Missing entry id.');
        if (!date || !time) return alert('Pick both date and time.');
        if (!note)          return alert('Please describe what you did.');
  
        confirmBtn.disabled = true;
  
        fetch(closeoutUrl, {
          method : 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken' : csrfToken
          },
          body: JSON.stringify({
            entry_id        : id,
            closeout        : `${date} ${time}`,
            closeout_comment: note
          })
        })
        .then(r => r.ok ? r.json() : Promise.reject())
        .then(() => {
          /* success: remove the row, then hide modal */
          document
            .querySelector(`button.closeout-btn[data-entry-id="${id}"]`)
            ?.closest('tr')?.remove();
          bsModal.hide();
        })
        .catch(() => alert('Error closing out entry.'))
        .finally(() => confirmBtn.disabled = false);
      }
  
      /* attach listeners -------------------------------------------------- */
      document.addEventListener('click', ev => {
        const btn = ev.target.closest('.closeout-btn');
        if (!btn) return;
        openModal(btn.dataset.entryId);
      });
  
      confirmBtn.addEventListener('click', submitCloseout);
    }  /* end initCloseout */
  });
  </script>
  
<!-- ─────────────────────────────────────────────────────────────────────── -->




<script>
  /*  ───────────  Join / Leave overlay (independent)  ─────────── */
  (() => {
    /* helpers --------------------------------------------------------------- */
    const currentUser = "{{ request.user.username }}",
          csrftoken   = document.cookie
                         .split(';')
                         .map(c => c.trim())
                         .find(c => c.startsWith('csrftoken='))?.split('=')[1] ?? '',
          joinUrl     = "{% url 'join_downtime_event' %}",
          leaveUrl    = "{% url 'leave_downtime_event' %}",
          table       = document.querySelector('table');
  
    if (!table) return;          /* defensive guard */
  
    /* cached textarea elements --------------------------------------------- */
    const joinTA  = document.getElementById('join-comment-text'),
          leaveTA = document.getElementById('leave-comment-text');
  
    let pendingJoinId  = null,
        pendingLeaveId = null;
  
    /* capture‑phase listener ------------------------------------------------ */
    table.addEventListener('click', (ev) => {
      const btn = ev.target.closest('button.join-btn, button.leave-btn');
      if (!btn) return;
  
      ev.stopImmediatePropagation();
      ev.preventDefault();
  
      if (btn.classList.contains('join-btn')) {
        pendingJoinId   = btn.dataset.eventId;
        joinTA.value    = '';
        bootstrap.Modal.getOrCreateInstance(
          document.getElementById('joinCommentModal')
        ).show();
      } else {
        pendingLeaveId  = btn.dataset.eventId;
        leaveTA.value   = '';
        bootstrap.Modal.getOrCreateInstance(
          document.getElementById('leaveCommentModal')
        ).show();
      }
    }, true);                       // capture=true
  
    /* JOIN confirm ---------------------------------------------------------- */
    document.getElementById('join-confirm-btn')
      .addEventListener('click', () => {
        const comment = joinTA.value.trim();
        if (!comment) {
          alert('Please describe what you plan on doing.');
          return;
        }
  
        fetch(joinUrl, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json',
                     'X-CSRFToken': csrftoken },
          body: JSON.stringify({ event_id: pendingJoinId,
                                 join_comment: comment })
        })
        .then(r => r.ok ? r.json() : Promise.reject())
        .then(() => {
          const cell = table.querySelector(
            `.participants-cell[data-event-id="${pendingJoinId}"]`
          );
          if (cell) {
            cell.querySelector('.join-btn')?.remove();
            cell.insertAdjacentHTML('afterbegin', `
              <div>
                ${currentUser}
                <button class="btn btn-sm btn-outline-danger leave-btn"
                        data-event-id="${pendingJoinId}">Leave</button>
              </div>`);
          }
          bootstrap.Modal.getInstance(
            document.getElementById('joinCommentModal')
          ).hide();
        })
        .catch(() => alert('Error joining event'));
      });
  
    /* LEAVE confirm --------------------------------------------------------- */
    document.getElementById('leave-confirm-btn')
      .addEventListener('click', () => {
        const comment = leaveTA.value.trim();
        if (!comment) {
          alert('Please describe what you did.');
          return;
        }
  
        fetch(leaveUrl, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json',
                     'X-CSRFToken': csrftoken },
          body: JSON.stringify({ event_id: pendingLeaveId,
                                 leave_comment: comment })
        })
        .then(r => r.ok ? r.json() : Promise.reject())
        .then(data => {
          const cell = table.querySelector(
            `.participants-cell[data-event-id="${pendingLeaveId}"]`
          );
          if (cell) {
            const leaveBtn = cell.querySelector(
              `button.leave-btn[data-event-id="${pendingLeaveId}"]`);
            if (leaveBtn) {
              leaveBtn.insertAdjacentHTML(
                'afterend', `<small>– ${data.total_minutes} min</small>`);
              leaveBtn.remove();
            }
            cell.insertAdjacentHTML('beforeend', `
              <button class="btn btn-sm btn-outline-dark join-btn mt-2"
                      data-event-id="${pendingLeaveId}">Join</button>`);
          }
          bootstrap.Modal.getInstance(
            document.getElementById('leaveCommentModal')
          ).hide();
        })
        .catch(() => alert('Error leaving event'));
      });
  })();
  </script>
  

  <script>
    (function () {
      /* ─────────────────────────── Utilities & config ────────────────────────── */
      function getCookie(name) {
        let v = null;
        document.cookie?.split(';').forEach(c => {
          c = c.trim();
          if (c.startsWith(name + '=')) v = decodeURIComponent(c.slice(name.length + 1));
        });
        return v;
      }
    
      const currentUser = "{{ request.user.username }}",            // used by renderer
            loadMoreUrl = "{% url 'load_more_downtime_entries' %}",
            pageSize    = {{ page_size }},
            table       = document.querySelector('table'),
            loadMoreBtn = document.getElementById('load-more-btn');
    
      /* ───────────────────────────── Row renderer ────────────────────────────── */
      function renderRow(e) {
        const labourHtml = Array.isArray(e.labour_types) && e.labour_types.length
          ? e.labour_types.map(l => `<span class="badge bg-info">${l}</span>`).join(' ')
          : '<span class="text-muted">—</span>';
    
        /* participants (Join/Leave buttons stay so the add‑on can hook them) */
        const parts = [];
        if (Array.isArray(e.participants) && e.participants.length) {
          e.participants.forEach(p => {
            if (p.leave_epoch == null) {
              parts.push(`
                <div>
                  ${p.user}
                  ${p.user === currentUser ? `
                    <button class="btn btn-sm btn-outline-danger leave-btn"
                            data-event-id="${e.id}">Leave</button>` : ''}
                </div>`);
            } else {
              parts.push(`<div>${p.user} <small>– ${p.total_minutes} min</small></div>`);
            }
          });
        }
    
        if (!e.user_has_open) {
          parts.push(`
            <button class="btn btn-sm btn-outline-dark join-btn mt-2"
                    data-event-id="${e.id}">Join</button>`);
        }
    
        const closeoutHtml = e.closeout_at
          ? e.closeout_at
          : `<span class="text-muted">— open —</span>`;
    
        return `
          <tr class="${e.closeout_at ? '' : 'table-warning'}">
            <td>${e.start_at}</td>
            <td>${closeoutHtml}</td>
            <td>${e.line}</td>
            <td>${e.machine}</td>
            <td><span class="badge bg-dark">${e.category}</span></td>
            <td><span class="badge bg-secondary">${e.subcategory}</span></td>
            <td>${labourHtml}</td>
            <td class="participants-cell" data-event-id="${e.id}">
              ${parts.join('')}
            </td>
            <td>${e.comment}</td>
          </tr>`;
      }
    
      /* ───────────────────────────── Load‑More AJAX ──────────────────────────── */
      let offset = pageSize;
    
      loadMoreBtn.addEventListener('click', () => {
        loadMoreBtn.disabled = true;
        fetch(`${loadMoreUrl}?offset=${offset}`)
          .then(r => r.ok ? r.json() : Promise.reject())
          .then(data => {
            data.entries.forEach(e => {
              document.querySelector('tbody')
                      .insertAdjacentHTML('beforeend', renderRow(e));
            });
            offset += pageSize;
            if (!data.has_more) {
              loadMoreBtn.remove();
            } else {
              loadMoreBtn.disabled = false;
            }
          })
          .catch(() => {
            alert('Error loading more entries');
            loadMoreBtn.disabled = false;
          });
      });
    
      /* ──────────────────────── Labour‑type live filter ──────────────────────── */
      const labourCheckboxes = Array.from(document.querySelectorAll('.labour-filter'));
    
      function filterByLabour() {
        const selected = labourCheckboxes.filter(cb => cb.checked).map(cb => cb.value);
    
        document.querySelectorAll('table tbody tr').forEach(row => {
          const rowCodes = Array.from(
            row.cells[6].querySelectorAll('span.badge.bg-info')
          ).map(span => span.textContent.trim());
    
          row.style.display =
            selected.length === 0 || rowCodes.some(c => selected.includes(c))
              ? ''
              : 'none';
        });
      }

      window.filterByLabour = filterByLabour;

    
      labourCheckboxes.forEach(cb => cb.addEventListener('change', filterByLabour));
      filterByLabour();     // initial state
    })();
    </script>
    
  
    <script>
      document.addEventListener('DOMContentLoaded', () => {
        const container = document.getElementById('participant-filters');
        if (!container) return;
      
        // 1) collect all names
        const namesSet = new Set();
        document.querySelectorAll('.participants-cell').forEach(cell => {
          cell.querySelectorAll('div').forEach(div => {
            // grab the text before any child button/small
            const txt = div.childNodes[0]?.textContent.trim();
            if (txt) namesSet.add(txt);
          });
        });
        const names = Array.from(namesSet).sort();
      
        // 2) state of which names are selected
        const selected = new Set();
      
        // 3) render the buttons
        function renderButtons() {
          container.innerHTML = '';
          names.forEach(name => {
            const btn = document.createElement('button');
            btn.type = 'button';
            btn.className = 'btn btn-sm btn-outline-dark me-2 mb-2 participant-filter-btn';
            btn.textContent = name;
            btn.dataset.name = name;
            if (selected.has(name)) btn.classList.add('active');
            container.appendChild(btn);
          });
        }
      
        // 4) filter table rows by any selected name
        function filterRows() {
          const rows = document.querySelectorAll('table tbody tr');
          if (selected.size === 0) {
            rows.forEach(r => r.style.display = '');
            return;
          }
          rows.forEach(row => {
            const rowNames = Array.from(
              row.querySelectorAll('.participants-cell > div')
            ).map(div => div.childNodes[0]?.textContent.trim());
            const match = Array.from(selected).some(n => rowNames.includes(n));
            row.style.display = match ? '' : 'none';
          });
        }
      
        // 5) click‐handler to toggle selection + re‐filter
        container.addEventListener('click', e => {
          const btn = e.target.closest('.participant-filter-btn');
          if (!btn) return;
          const name = btn.dataset.name;
          if (selected.has(name)) {
            selected.delete(name);
            btn.classList.remove('active');
          } else {
            selected.add(name);
            btn.classList.add('active');
          }
          filterRows();
        });
      
        // init
        renderButtons();
      });
      </script>
      
  
{% endblock %}
