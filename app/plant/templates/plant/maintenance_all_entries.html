{% extends "parent.html" %}
{% load static %}
{% block content %}
<div class="container mt-4">
  {{ user_roles|json_script:"user‑roles-json" }}   {# ←  place it here #}

  <h1 class="mb-4">Open Downtime Events</h1>


  {% if is_manager %}

    {# ───────────────────── New‑employee button + modal ───────────────────── #}

  <!-- Button -->
  <button type="button"
          class="btn btn-warning mb-3"
          data-bs-toggle="modal"
          data-bs-target="#newEmployeeModal">
    Add New or Update Employee
  </button>

  <!-- Modal (place it once per page, usually near bottom) -->
  <div class="modal fade" id="newEmployeeModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
      <form method="post" action="{% url 'add_employee' %}" class="modal-content">
        {% csrf_token %}
        <div class="modal-header">
          <h5 class="modal-title">Add New or Update Employee</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>

        <div class="modal-body">
          <div class="mb-3">
            <label for="empFirst" class="form-label">First name</label>
            <input id="empFirst" name="first_name" class="form-control" required>
          </div>
          <div class="mb-3">
            <label for="empLast" class="form-label">Last name</label>
            <input id="empLast" name="last_name" class="form-control" required>
          </div>

          <p class="mb-1 fw-semibold">Profession(s)</p>
          <div class="form-check">
            <input class="form-check-input" type="checkbox"
                   name="roles" value="electrician" id="role_elec">
            <label class="form-check-label" for="role_elec">Electrician</label>
          </div>
          <div class="form-check">
            <input class="form-check-input" type="checkbox"
                   name="roles" value="millwright" id="role_mill">
            <label class="form-check-label" for="role_mill">Millwright</label>
          </div>
          <div class="form-check">
            <input class="form-check-input" type="checkbox"
                   name="roles" value="tech" id="role_tech">
            <label class="form-check-label" for="role_tech">Tech</label>
          </div>
        </div>

        <div class="modal-footer">
          <button type="button" class="btn btn-dark"
                  data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-warning">Save</button>
        </div>
      </form>
    </div>
  </div>
  {# ───────────────────────── Line priorities accordion ────────────────────────── #}
  <div class="accordion mt-5 mb-4" id="linesPriorityAccordion">
    <div class="accordion-item">
      <h2 class="accordion-header" id="linesPriorityHeading">
        <button class="accordion-button d-flex justify-content-between"
                type="button"
                data-bs-toggle="collapse"
                data-bs-target="#linesPriorityCollapse"
                aria-expanded="false"
                aria-controls="linesPriorityCollapse">
          <span>Line Priorities</span>
        </button>
      </h2>

      <div id="linesPriorityCollapse"
           class="accordion-collapse collapse"
           aria-labelledby="linesPriorityHeading"
           data-bs-parent="#linesPriorityAccordion">

        <div class="accordion-body p-0">

          <ul class="list-group list-group-flush">
            {% for lp in line_priorities %}
              <li class="list-group-item d-flex justify-content-between align-items-center">

                {# ►► left side: line name + arrow buttons                         #}
                <div class="d-flex align-items-center gap-2">
                  <strong>{{ lp.line }}</strong>

                  {# move‑up form — hidden if already top priority (#1)            #}
                  {% if not forloop.first %}
                  <form method="post"
                        action="{% url 'move_line_priority' lp.id 'up' %}"
                        class="d-inline">
                    {% csrf_token %}
                    <button class="btn btn-sm btn-outline-secondary py-0 px-1"
                            title="Move up one">
                      ▲
                    </button>
                  </form>
                  {% endif %}

                  {# move‑down form — hidden if last entry                         #}
                  {% if not forloop.last %}
                  <form method="post"
                        action="{% url 'move_line_priority' lp.id 'down' %}"
                        class="d-inline">
                    {% csrf_token %}
                    <button class="btn btn-sm btn-outline-secondary py-0 px-1"
                            title="Move down one">
                      ▼
                    </button>
                  </form>
                  {% endif %}
                </div>

                {# ►► right side: coloured priority badge                         #}
                {% if lp.priority <= 3 %}
                  <span class="badge bg-danger rounded-pill">{{ lp.priority }}</span>
                {% elif lp.priority <= 7 %}
                  <span class="badge bg-warning text-dark rounded-pill">{{ lp.priority }}</span>
                {% else %}
                  <span class="badge bg-success rounded-pill">{{ lp.priority }}</span>
                {% endif %}

              </li>
            {% empty %}
              <li class="list-group-item text-muted">
                No line priorities defined.
              </li>
            {% endfor %}
          </ul>

        </div>
      </div>
    </div>
  </div>
  {# ───────────────────────── end accordion ────────────────────────────────────── #}
  {% endif %}



{# ───────────────────────── downtime events table ────────────────── #}
  <div class="table-responsive mt-4">
    <table class="table table-striped table-hover table-bordered align-middle">
      <thead class="table-light">
        <tr>
          <th>Start</th>
          <th>Close-out</th>
          <th>Line</th>
          <th>Machine</th>
          <th>Category</th>
          <th>Sub-category</th>
          <th>Labour&nbsp;Needed</th>
          <th>Comment</th>
        </tr>
      </thead>
      <tbody>
        {% for e in entries %}
        <tr class="{% if not e.closeout_epoch %}table-warning{% endif %}">
          {# ── Start time, conditionally formatted ── #}
          <td>{{ e.start_display }}</td>


          {# Close-out #}
          <td>
            {% if e.closeout_epoch %}
              {{ e.closeout_epoch|date:"Y-m-d H:i" }}
            {% else %}
              <button class="btn btn-sm btn-info closeout-btn"
                      data-entry-id="{{ e.id }}">
                Close&nbsp;out
              </button>
            {% endif %}
          </td>

          {# Line, Machine, Category, Sub-category #}
          <td>{{ e.line }}</td>
          <td>{{ e.machine }}</td>
          <td><span class="badge bg-dark">{{ e.category }}</span></td>
          <td><span class="badge bg-secondary">{{ e.subcategory }}</span></td>

          {# Labour needed badges #}
          <td>
            {% if e.labour_types %}
            {% for code in e.labour_types %}
            <button
            type="button"
            class="btn btn-outline-dark labour-btn me-1"
            data-event-id="{{ e.id }}"
            data-role="{{ code|title }}"
            data-bs-toggle="modal"
            data-bs-target="#labourModal"
          >
            {{ code|title }}
          </button>
          
            {% endfor %}
          {% else %}
            <span class="text-muted">—</span>
          {% endif %}        
          </td>

          {# Comment #}
          <td>{{ e.comment }}</td>
        </tr>
        {% empty %}
        <tr>
          <td colspan="9" class="text-center py-4">No downtime events found.</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

  <div class="text-center mt-3">
    <button id="load-more-btn" class="btn btn-dark">Load&nbsp;More</button>
  </div>





  {# ─────────────── CLOSE‑OUT MODAL + SCRIPT (self‑contained) ─────────────── #}

  <!-- 1.  The modal itself -->
  <div class="modal fade" id="closeoutModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-sm">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Close Out Downtime</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>

        <div class="modal-body">
          <!-- hidden id -->
          <input type="hidden" id="closeout-entry-id">

          <div class="mb-3">
            <label for="closeout-date" class="form-label">Date</label>
            <input type="date" id="closeout-date" class="form-control" required>
          </div>

          <div class="mb-3">
            <label for="closeout-time" class="form-label">Time</label>
            <input type="time" id="closeout-time" class="form-control" required>
          </div>

          <div class="mb-3">
            <label for="closeout-comment" class="form-label">What was done?</label>
            <textarea id="closeout-comment"
                      class="form-control"
                      rows="3"
                      maxlength="2000"
                      required></textarea>
          </div>
        </div>

        <div class="modal-footer">
          <button type="button"
                  class="btn btn-secondary"
                  data-bs-dismiss="modal">
            Cancel
          </button>
          <button type="button"
                  id="closeout-confirm"
                  class="btn btn-info">
            Confirm
          </button>
        </div>
      </div>
    </div>
  </div>
    


  <!-- Join-as Role Modal -->
  <div class="modal fade" id="labourModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-sm">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">
            Join as <span id="labour-role-label"></span>
          </h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <!-- store event id -->
          <input type="hidden" id="labour-event-id">
          <div class="mb-3">
            <label for="labour-comment" class="form-label">
              Comment (optional)
            </label>
            <textarea id="labour-comment"
                      class="form-control"
                      rows="2"
                      maxlength="2000"
            ></textarea>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button"
                  class="btn btn-secondary"
                  data-bs-dismiss="modal">
            Cancel
          </button>
          <button type="button"
                  id="labour-confirm-btn"
                  class="btn btn-primary">
            Join
          </button>
        </div>
      </div>
    </div>
  </div>


  
<!-- 2) Close-out modal logic -->
<script>
  document.addEventListener('DOMContentLoaded', () => {
    const modalEl      = document.getElementById('closeoutModal');
    const closeoutModal= new bootstrap.Modal(modalEl);
    const entryIdIn    = document.getElementById('closeout-entry-id');
    const dateIn       = document.getElementById('closeout-date');
    const timeIn       = document.getElementById('closeout-time');
    const commentIn    = document.getElementById('closeout-comment');
    const confirmBtn   = document.getElementById('closeout-confirm');
    const csrfToken    = document.querySelector('[name=csrfmiddlewaretoken]').value;
    const url          = "{% url 'closeout_downtime_entry' %}";
  
    document.querySelectorAll('.closeout-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        entryIdIn.value = btn.dataset.entryId;
        const now = new Date();
        dateIn.value    = now.toISOString().slice(0,10);
        timeIn.value    = now.toTimeString().slice(0,5);
        commentIn.value = '';
        confirmBtn.disabled = false;
        closeoutModal.show();
      });
    });
  
    confirmBtn.addEventListener('click', () => {
      const id   = entryIdIn.value;
      const date = dateIn.value;
      const time = timeIn.value;
      const note = commentIn.value.trim();
      if (!id || !date || !time || !note) {
        return alert('All fields are required.');
      }
      confirmBtn.disabled = true;
      fetch(url, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRFToken': csrfToken,
        },
        body: JSON.stringify({
          entry_id: id,
          closeout: `${date} ${time}`,
          closeout_comment: note
        })
      })
      .then(r => r.ok ? r.json() : Promise.reject())
      .then(() => {
        document
          .querySelector(`button.closeout-btn[data-entry-id="${id}"]`)
          .closest('tr')
          .remove();
        closeoutModal.hide();
      })
      .catch(() => alert('Error closing out entry.'))
      .finally(() => confirmBtn.disabled = false);
    });
  });
  </script>
  



<!-- 3) Load-More, filters, and labour-modal hookup -->
<script>
  document.addEventListener('DOMContentLoaded', () => {
    // — keep track of current user for renderRow —
    const currentUser = "{{ request.user.username }}";
  
    // — Load More —
    const loadMoreBtn = document.getElementById('load-more-btn');
    const pageSize    = {{ page_size }};
    let offset        = pageSize;
    const loadUrl     = "{% url 'load_more_downtime_entries' %}";
    loadMoreBtn?.addEventListener('click', () => {
      loadMoreBtn.disabled = true;
      fetch(`${loadUrl}?offset=${offset}`)
        .then(r => r.ok ? r.json() : Promise.reject())
        .then(data => {
          const tbody = document.querySelector('table tbody');
          data.entries.forEach(e => tbody.insertAdjacentHTML('beforeend', renderRow(e)));
          offset += pageSize;
          if (!data.has_more) loadMoreBtn.remove();
          else loadMoreBtn.disabled = false;
        })
        .catch(() => {
          alert('Error loading more entries');
          loadMoreBtn.disabled = false;
        });
    });
  
    // — Labour-type live filter —
    const labourCheckboxes = Array.from(document.querySelectorAll('.labour-filter'));
    function filterByLabour() {
      const sel = labourCheckboxes.filter(cb => cb.checked).map(cb => cb.value);
      document.querySelectorAll('table tbody tr').forEach(row => {
        const codes = Array.from(row.cells[6].querySelectorAll('span.badge.bg-info'))
                           .map(s => s.textContent.trim());
        row.style.display = sel.length === 0 || codes.some(c => sel.includes(c))
                            ? '' : 'none';
      });
    }
    labourCheckboxes.forEach(cb => cb.addEventListener('change', filterByLabour));
    filterByLabour();
  
    // — Participant filters —
    const container = document.getElementById('participant-filters');
    if (container) {
      const namesSet = new Set();
      document.querySelectorAll('.participants-cell').forEach(cell =>
        cell.querySelectorAll('div').forEach(div => {
          const txt = div.childNodes[0]?.textContent.trim();
          if (txt) namesSet.add(txt);
        })
      );
      const names    = Array.from(namesSet).sort();
      const selected = new Set();
  
      function renderButtons() {
        container.innerHTML = '';
        names.forEach(name => {
          const btn = document.createElement('button');
          btn.type        = 'button';
          btn.className   = 'btn btn-sm btn-outline-dark me-2 mb-2';
          btn.textContent = name;
          btn.dataset.name= name;
          if (selected.has(name)) btn.classList.add('active');
          container.appendChild(btn);
        });
      }
  
      function filterRows() {
        document.querySelectorAll('table tbody tr').forEach(row => {
          if (selected.size === 0) {
            row.style.display = '';
            return;
          }
          const rowNames = Array.from(
            row.querySelectorAll('.participants-cell > div')
          ).map(div => div.childNodes[0]?.textContent.trim());
          row.style.display = Array.from(selected).some(n => rowNames.includes(n))
                              ? '' : 'none';
        });
      }
  
      container.addEventListener('click', e => {
        const btn = e.target.closest('button');
        if (!btn?.dataset.name) return;
        const name = btn.dataset.name;
        if (selected.has(name)) {
          selected.delete(name);
          btn.classList.remove('active');
        } else {
          selected.add(name);
          btn.classList.add('active');
        }
        filterRows();
      });
  
      renderButtons();
    }
  
    // — Labour-Modal hookup via data-bs attributes —
    const labourModalEl = document.getElementById('labourModal');
    labourModalEl?.addEventListener('show.bs.modal', evt => {
      const btn = evt.relatedTarget;
      document.getElementById('labour-role-label').textContent    = btn.getAttribute('data-role');
      document.getElementById('labour-event-id').value           = btn.getAttribute('data-event-id');
      document.getElementById('labour-comment').value            = '';
    });
  
    document.getElementById('labour-confirm-btn')
      ?.addEventListener('click', () => {
        const id      = document.getElementById('labour-event-id').value;
        const comment = document.getElementById('labour-comment').value.trim();
        fetch("{% url 'join_downtime_event' %}", {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken':  document.querySelector('[name=csrfmiddlewaretoken]').value
          },
          body: JSON.stringify({ event_id: id, join_comment: comment })
        })
        .then(r => r.ok ? r.json() : Promise.reject())
        .then(() => window.location.reload())
        .catch(() => alert('Could not join event. Try again.'));
      });
  });
  
  // — helper to render a row from AJAX payload —
  function renderRow(e) {
    const labourHtml = Array.isArray(e.labour_types) && e.labour_types.length
      ? e.labour_types.map(l => `<span class="badge bg-info">${l}</span>`).join(' ')
      : '<span class="text-muted">—</span>';
  
    const parts = [];
    if (Array.isArray(e.participants)) {
      e.participants.forEach(p => {
        if (p.leave_epoch == null) {
          parts.push(`
            <div>
              ${p.user}
              ${p.user === currentUser
                ? `<button class="btn btn-sm btn-outline-danger leave-btn"
                           data-event-id="${e.id}">Leave</button>`
                : ''}
            </div>`);
        } else {
          parts.push(`<div>${p.user} <small>– ${p.total_minutes} min</small></div>`);
        }
      });
    }
    if (!e.user_has_open) {
      parts.push(`
        <button class="btn btn-sm btn-outline-dark join-btn mt-2"
                data-event-id="${e.id}">Join</button>`);
    }
  
    const closeoutHtml = e.closeout_at
      ? e.closeout_at
      : `<span class="text-muted">— open —</span>`;
  
    return `
      <tr class="${e.closeout_at ? '' : 'table-warning'}">
        <td>${e.start_at}</td>
        <td>${closeoutHtml}</td>
        <td>${e.line}</td>
        <td>${e.machine}</td>
        <td><span class="badge bg-dark">${e.category}</span></td>
        <td><span class="badge bg-secondary">${e.subcategory}</span></td>
        <td>${labourHtml}</td>
        <td class="participants-cell" data-event-id="${e.id}">
          ${parts.join('')}
        </td>
        <td>${e.comment}</td>
      </tr>`;
  }
  </script>
  




</div>




      
  
{% endblock %}
