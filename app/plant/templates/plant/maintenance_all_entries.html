{% extends "parent.html" %}
{% load static %}
{% block content %}
<div class="container mt-4">
  {% csrf_token %}
  {{ user_roles|json_script:"user‑roles-json" }}   {# ←  place it here #}

  <h1 class="mb-4 text-center">Open Downtime Events</h1>
  

<style>

    /* prevent any auto-detected phone links from being clickable or styled as links */
    a[href^="tel"] {
      pointer-events: none;
      color: inherit;
      text-decoration: none;
      cursor: default;
    }

      /* make the entire editable row show the hand pointer on hover */
  tr.editable-row:hover {
    cursor: pointer;
  }



  /* in your custom CSS */
.table-responsive {
  overflow-x: auto;
  overflow-y: auto;           /* allow vertical scroll too */
  -webkit-overflow-scrolling: touch;
}

</style>

  {% if is_manager %}

    {# ───────────────────── New‑employee button + modal ───────────────────── #}



  <!-- Modal (place it once per page, usually near bottom) -->
  <div class="modal fade" id="newEmployeeModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
      <form method="post" action="{% url 'add_employee' %}" class="modal-content">
        {% csrf_token %}
        <div class="modal-header">
          <h5 class="modal-title">Add New or Update Employee</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>

        <div class="modal-body">
          <div class="mb-3">
            <label for="empFirst" class="form-label">First name</label>
            <input id="empFirst" name="first_name" class="form-control" required>
          </div>
          <div class="mb-3">
            <label for="empLast" class="form-label">Last name</label>
            <input id="empLast" name="last_name" class="form-control" required>
          </div>

          <p class="mb-1 fw-semibold">Profession(s)</p>
          <div class="form-check">
            <input class="form-check-input" type="checkbox"
                   name="roles" value="electrician" id="role_elec">
            <label class="form-check-label" for="role_elec">Electrician</label>
          </div>
          <div class="form-check">
            <input class="form-check-input" type="checkbox"
                   name="roles" value="millwright" id="role_mill">
            <label class="form-check-label" for="role_mill">Millwright</label>
          </div>
          <div class="form-check">
            <input class="form-check-input" type="checkbox"
                   name="roles" value="tech" id="role_tech">
            <label class="form-check-label" for="role_tech">Tech</label>
          </div>
          <div class="form-check">
            <input class="form-check-input" type="checkbox"
                   name="roles" value="plctech" id="role_plctech">
            <label class="form-check-label" for="role_plctech">PLC Technician</label>
          </div>
          <div class="form-check">
            <input class="form-check-input" type="checkbox"
                   name="roles" value="imt" id="role_imt">
            <label class="form-check-label" for="role_imt">IMT</label>
          </div>
        </div>

        <div class="modal-footer">
          <button type="button" class="btn btn-dark"
                  data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-warning">Save</button>
        </div>
      </form>
    </div>
  </div>
  {# ───────────────────────── Line priorities accordion ────────────────────────── #}
  <div class="accordion mt-5 mb-4" id="linesPriorityAccordion">
    <div class="accordion-item">
      <h2 class="accordion-header" id="linesPriorityHeading">
        <button class="accordion-button d-flex justify-content-between"
                type="button"
                data-bs-toggle="collapse"
                data-bs-target="#linesPriorityCollapse"
                aria-expanded="false"
                aria-controls="linesPriorityCollapse">
          <span>Line Priorities</span>
        </button>
      </h2>

      <div id="linesPriorityCollapse"
           class="accordion-collapse collapse"
           aria-labelledby="linesPriorityHeading"
           data-bs-parent="#linesPriorityAccordion">

        <div class="accordion-body p-0">

          <ul class="list-group list-group-flush">
            {% for lp in line_priorities %}
              <li class="list-group-item d-flex justify-content-between align-items-center">

                {# ►► left side: line name + arrow buttons                         #}
                <div class="d-flex align-items-center gap-2">
                  <strong>{{ lp.line }}</strong>

                  {# move‑up form — hidden if already top priority (#1)            #}
                  {% if not forloop.first %}
                  <form method="post"
                        action="{% url 'move_line_priority' lp.id 'up' %}"
                        class="d-inline">
                    {% csrf_token %}
                    <button class="btn btn-sm btn-outline-secondary py-0 px-1"
                            title="Move up one">
                      ▲
                    </button>
                  </form>
                  {% endif %}

                  {# move‑down form — hidden if last entry                         #}
                  {% if not forloop.last %}
                  <form method="post"
                        action="{% url 'move_line_priority' lp.id 'down' %}"
                        class="d-inline">
                    {% csrf_token %}
                    <button class="btn btn-sm btn-outline-secondary py-0 px-1"
                            title="Move down one">
                      ▼
                    </button>
                  </form>
                  {% endif %}
                </div>

                {# ►► right side: coloured priority badge                         #}
                {% if lp.priority <= 3 %}
                  <span class="badge bg-danger rounded-pill">{{ lp.priority }}</span>
                {% elif lp.priority <= 7 %}
                  <span class="badge bg-warning text-dark rounded-pill">{{ lp.priority }}</span>
                {% else %}
                  <span class="badge bg-success rounded-pill">{{ lp.priority }}</span>
                {% endif %}

              </li>
            {% empty %}
              <li class="list-group-item text-muted">
                No line priorities defined.
              </li>
            {% endfor %}
          </ul>

        </div>
      </div>
    </div>
  </div>
  {# ───────────────────────── end accordion ────────────────────────────────────── #}



    <!-- Button -->
    <button type="button"
    class="btn btn-dark mb-3"
    data-bs-toggle="modal"
    data-bs-target="#newEmployeeModal">
Add New or Update Employee
</button>

<div class="manage-downtime-codes">
  <a href="{% url 'downtime_codes_list' %}"
     target="_blank" rel="noopener noreferrer">
    Manage Downtime Codes
  </a>
</div>




  {% endif %}






{# ───────────────────────── downtime events table ────────────────── #}
<div class="row mt-4{% if not is_manager %} justify-content-center{% endif %}">
  
  <!-- Left: downtime events (always col-md-8) -->
<div class="col-md-8 mb-2">
  <div class="table-responsive mb-2">
    <table class="table table-striped table-hover table-bordered align-middle small mb-0">
      <!-- 1) Table header with a warning‐style button -->
      <!-- Trigger button (in your <th> next to “Open Jobs”) -->
        <thead class="table-light">
  <tr>
    <th class="py-1 d-flex align-items-center">
      <span>Open Jobs</span>

      <button
        id="machine-history-btn"
        type="button"
        class="btn btn-warning btn-sm ms-2"
        aria-label="Machine History">
        Machine History
      </button>

      <!-- New filter input -->
      <input
        id="job-filter"
        type="text"
        class="form-control form-control-sm ms-2"
        placeholder="Filter jobs…"
        style="max-width: 150px;"
      >

      <!-- ► our new SVG button: -->
      <span id="target-lines-icon" class="ms-2" style="cursor: pointer;" title="Show Target Lines">
        <!-- ─── replace the contents of this <svg> with your actual icon ─── -->
        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="#CC0000" class="bi bi-crosshair2" viewBox="0 0 16 16">
          <path d="M8 0a.5.5 0 0 1 .5.5v.518A7 7 0 0 1 14.982 7.5h.518a.5.5 0 0 1 0 1h-.518A7 7 0 0 1 8.5 14.982v.518a.5.5 0 0 1-1 0v-.518A7 7 0 0 1 1.018 8.5H.5a.5.5 0 0 1 0-1h.518A7 7 0 0 1 7.5 1.018V.5A.5.5 0 0 1 8 0m-.5 2.02A6 6 0 0 0 2.02 7.5h1.005A5 5 0 0 1 7.5 3.025zm1 1.005A5 5 0 0 1 12.975 7.5h1.005A6 6 0 0 0 8.5 2.02zM12.975 8.5A5 5 0 0 1 8.5 12.975v1.005a6 6 0 0 0 5.48-5.48zM7.5 12.975A5 5 0 0 1 3.025 8.5H2.02a6 6 0 0 0 5.48 5.48zM10 8a2 2 0 1 0-4 0 2 2 0 0 0 4 0"/>
        </svg>
      </span>

    </th>
  </tr>
</thead>

      <tbody>
        {% for e in entries %}
          <tr
            class="editable-row {% if not e.closeout_epoch %}table-light{% endif %}"
            data-entry-id="{{ e.id }}"
            data-line="{{ e.line }}"
          >
            <td class="py-1">
              <div class="d-flex align-items-center">
                
                <!-- Left block: info + labour -->
                <div class="d-flex align-items-center flex-grow-1">
                  <span>
                    {{ e.start_display }} – {{ e.machine }} – 
                    {% if e.labour_types %}
                      {% for code in e.labour_types %}
                        {% with code|title as role %}
                          <button
                            type="button"
                            class="btn {% if e.being_worked_on %}btn-dark{% else %}btn-outline-dark{% endif %} labour-btn btn-sm ms-2 py-0 px-1"
                            data-event-id="{{ e.id }}"
                            data-role="{{ role }}"
                          >{{ role|slice:":1" }}</button>
                        {% endwith %}
                      {% endfor %}
                    {% else %}
                      <span class="text-muted ms-2">–</span>
                    {% endif %}
                     – {{ e.category }}
                  </span>
                </div>
      
                {# hidden, used by row-click to trigger the same handler #}
                {% if not e.closeout_epoch %}
                  <button
                    type="button"
                    class="closeout-btn d-none"
                    data-entry-id="{{ e.id }}"
                  ></button>
                {% endif %}
              
              </div>
            </td>
          </tr>
        {% empty %}
          <tr>
            <td class="text-center py-2">No downtime events found.</td>
          </tr>
        {% endfor %}
      </tbody>
      
    </table>
  </div>


 <!-- Machine History Modal (wide + scrollable) -->
 <div class="modal fade" id="machineHistoryModal"
 tabindex="-1"
 aria-labelledby="machineHistoryModalLabel"
 aria-hidden="true">
 <div class="modal-dialog modal-dialog-centered modal-dialog-scrollable">
<div class="modal-content">
  <form id="machineHistoryForm">
    <div class="modal-header">
      <h5 class="modal-title" id="machineHistoryModalLabel">
        Machine History
      </h5>
      <button type="button" class="btn-close"
              data-bs-dismiss="modal"
              aria-label="Close"></button>
    </div>
    <div class="modal-body">
      {% csrf_token %}
      <div class="mb-3">
        <label for="machine-input" class="form-label">Machine #</label>
        <input
          type="text"
          id="machine-input"
          class="form-control"
          placeholder="Enter machine number"
          required
        >
      </div>
    </div>
    <div class="modal-footer">
      <button type="button"
              class="btn btn-dark"
              data-bs-dismiss="modal">
        Cancel
      </button>
      <button type="submit"
              class="btn btn-warning">
        Submit
      </button>
    </div>
  </form>
</div>
</div>
</div>


</div>


  {% if is_manager or is_supervisor %}
    <!-- Right: Active List + Maintenance Staff Status -->
    <div class="col-md-4">

      <!-- Active List accordion -->
      <div class="accordion mb-3" id="activeListAccordion">
        <div class="accordion-item">
          <h2 class="accordion-header" id="activeListHeading">
            <button class="accordion-button collapsed"
                    type="button"
                    data-bs-toggle="collapse"
                    data-bs-target="#activeListCollapse"
                    aria-expanded="false"
                    aria-controls="activeListCollapse">
              Active List (who’s working)
            </button>
          </h2>
          <div id="activeListCollapse"
               class="accordion-collapse collapse"
               aria-labelledby="activeListHeading"
               data-bs-parent="#activeListAccordion">
            <div class="accordion-body p-0">
              <ul class="list-group list-group-flush">
                {% for w in inactive_workers %}
                  <li class="list-group-item d-flex justify-content-between align-items-center">
                    {{ w.name }} ({{ w.roles|join:", " }})
                    <button type="button"
                            class="btn btn-sm btn-outline-danger toggle-active-btn"
                            data-username="{{ w.username }}"
                            data-action="activate">
                      Not Active
                    </button>
                  </li>
                {% empty %}
                  <li class="list-group-item text-muted">No inactive staff.</li>
                {% endfor %}
                {% for w in active_workers %}
                  <li class="list-group-item d-flex justify-content-between align-items-center">
                    {{ w.name }} ({{ w.roles|join:", " }})
                    <button type="button"
                            class="btn btn-sm btn-outline-info toggle-active-btn"
                            data-username="{{ w.username }}"
                            data-action="deactivate">
                      Active
                    </button>
                  </li>
                {% endfor %}
              </ul>
            </div>
          </div>
        </div>
      </div>

      <!-- Maintenance Staff Status table -->
      <div class="table-responsive">
        <table class="table table-sm table-striped table-bordered align-middle mb-0">
          <thead class="table-light">
            <tr>
              <th>Name</th>
              <th>Roles</th>
              <th>Machine</th>
              <th>Subcategory</th>
              <th>Priority</th>
            </tr>
          </thead>
          <tbody>
            {% for w in active_workers %}
              {% if w.jobs %}
                {% for job in w.jobs %}
                  <tr>
                    {% if forloop.first %}
                      <td rowspan="{{ w.jobs|length }}">{{ w.name }}</td>
                      <td rowspan="{{ w.jobs|length }}">{{ w.roles|join:", " }}</td>
                    {% endif %}
                    <td>{{ job.machine }}</td>
                    <td>{{ job.subcategory }}</td>
                    <td>{{ job.priority }}</td>
                  </tr>
                {% endfor %}
              {% else %}
                <tr>
                  <td>{{ w.name }}</td>
                  <td>{{ w.roles|join:", " }}</td>
                  <td colspan="2" class="text-center text-muted">Free</td>
                </tr>
              {% endif %}
            {% empty %}
              <tr>
                <td colspan="4" class="text-center py-2">No active maintenance staff.</td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>

    </div>
  {% endif %}

</div>
















  {# ─────────────── CLOSE‑OUT MODAL + SCRIPT (self‑contained) ─────────────── #}

 {# ───────── CLOSE-OUT / EDIT MODAL ───────── #}
<div class="modal fade" id="closeoutModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-xl"><!-- make it wider -->
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Edit / Close Out Downtime</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>

      <div class="modal-body">
        <input type="hidden" id="closeout-entry-id">

        <div class="row">
          <!-- ─── Left column: Edit fields + Save button ──────────────────── -->
          <div class="col-md-6 border-end pe-4">
            <h6>Edit Details</h6>

            <div class="mb-3">
              <label for="closeout-line" class="form-label">Line</label>
              <select id="closeout-line" class="form-select"></select>
            </div>
            <div class="mb-3">
              <label for="closeout-machine" class="form-label">Machine</label>
              <select id="closeout-machine" class="form-select"></select>
            </div>

            <div class="mb-3">
              <label for="closeout-category" class="form-label">Category</label>
              <select id="closeout-category" class="form-select" required>
                <option value="" disabled selected>— Select category —</option>
              </select>
            </div>
            <div class="mb-3">
              <label for="closeout-subcategory" class="form-label">Subcategory</label>
              <select id="closeout-subcategory" class="form-select" required>
                <option value="" disabled selected>— Select subcategory —</option>
              </select>
            </div>


            <div class="mb-3">
              <label class="form-label">Started At</label>
              <div class="d-flex gap-2">
                <input type="date" id="closeout-start-date" class="form-control" required>
                <input type="time" id="closeout-start-time" class="form-control" required>
              </div>
            </div>

            <div class="mb-3">
              <label for="closeout-original-comment" class="form-label">Original Comment</label>
              <textarea id="closeout-original-comment"
                        class="form-control"
                        rows="2"
                        maxlength="2000"></textarea>
            </div>

            <div class="mb-3">
              <label class="form-label">Labour Types</label>
              <div id="closeout-labour-container">
                {% for code,label in labour_choices %}
                  <div class="form-check">
                    <input
                      class="form-check-input closeout-labour-checkbox"
                      type="checkbox"
                      id="closeout-labour-{{ code }}"
                      value="{{ code }}"
                    >
                    <label
                      class="form-check-label"
                      for="closeout-labour-{{ code }}"
                    >{{ label }}</label>
                  </div>
                {% endfor %}
              </div>
            </div>

            <div class="d-grid">
              <button type="button"
                      id="closeout-save"
                      class="btn btn-warning">
                Save Changes
              </button>
            </div>
          </div>

          <!-- ─── Right column: Close-out fields + Confirm button ─────────── -->
          <div class="col-md-6 ps-4">
            <h6>Close Out</h6>

            <div class="mb-3">
              <label for="closeout-date" class="form-label">Close-out Date</label>
              <input type="date" id="closeout-date" class="form-control" required>
            </div>
            <div class="mb-3">
              <label for="closeout-time" class="form-label">Close-out Time</label>
              <input type="time" id="closeout-time" class="form-control" required>
            </div>
            <div class="mb-3">
              <label for="closeout-comment" class="form-label">What was done?</label>
              <textarea id="closeout-comment"
                        class="form-control"
                        rows="3"
                        maxlength="2000"
                        placeholder="Optional, but make sure to select sub-category"></textarea>
            </div>

            <div class="d-grid">
              <button type="button"
                      id="closeout-confirm"
                      class="btn btn-info">
                Confirm Close
              </button>
            </div>
          </div>
        </div>
      </div>

      <div class="modal-footer">
        <button type="button"
                class="btn btn-secondary"
                data-bs-dismiss="modal">
          Cancel
        </button>
      </div>
    </div>
  </div>
</div>


 <!-- Exclude Lines Modal -->
  <div class="modal fade" id="excludeLinesModal" tabindex="-1" aria-labelledby="excludeLinesModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="excludeLinesModalLabel">Exclude Lines (Personal Preference)</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body" id="exclude-lines-body">
          <!-- checkboxes will be injected here -->
        </div>
          <div class="modal-footer">
            <!-- new select controls -->
            <button type="button"
                    class="btn btn-sm btn-link me-auto"
                    id="exclude-lines-select-all">
              Select All
            </button>
            <button type="button"
                    class="btn btn-sm btn-link"
                    id="exclude-lines-deselect-all">
              Deselect All
            </button>

            <!-- existing buttons -->
            <button type="button" class="btn btn-dark" data-bs-dismiss="modal">Cancel</button>
            <button type="button" class="btn btn-warning" id="exclude-lines-save">Save</button>
          </div>
      </div>
    </div>
  </div>


  
    

<!-- -------------------------------------------------------------------------------------->
  
<!-- 1. History Modal -->
<div class="modal fade" id="historyModal" tabindex="-1" aria-hidden="true">
  <!-- fullscreen-sm-down makes it modal-lg on md+ but fullscreen on sm and xs -->
  <div class="modal-dialog modal-lg modal-fullscreen-sm-down">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Labour History</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <!-- Wrap table in table-responsive -->
        <div class="table-responsive">
          <table class="table table-sm mb-0">
            <thead>
              <tr>
                <th>User</th>
                <th>Roles</th>
                <th>Joined At</th>
                <th>Join Comment</th>
                <th>Left At</th>
                <th>Leave Comment</th>
                <th>Total Min</th>
              </tr>
            </thead>
            <tbody id="history-body">
              <!-- JS will inject <tr>…</tr> here -->
            </tbody>
          </table>
        </div>
      </div>
      <div class="modal-footer">
        <button id="history-join-btn" type="button" class="btn btn-warning">Join</button>
        <button id="history-leave-btn" type="button" class="btn btn-outline-danger">Leave</button>
        <button type="button" class="btn btn-dark" data-bs-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>



<!-- 2. Join Modal -->
<div class="modal fade" id="joinModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-sm">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Join Event</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <input type="hidden" id="join-event-id">
        <div class="mb-3">
          <label class="form-label">Date &amp; Time</label>
          <input type="datetime-local"
                 id="join-datetime"
                 class="form-control">
        </div>
        <div class="mb-3">
          <label for="join-comment" class="form-label">Action Plan:</label>
          <textarea id="join-comment"
                    class="form-control"
                    rows="2"
                    required></textarea>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button"
                class="btn btn-dark"
                data-bs-dismiss="modal">
          Cancel
        </button>
        <button id="join-confirm-btn"
                type="button"
                class="btn btn-warning">
          Confirm Join
        </button>
      </div>
    </div>
  </div>
</div>

<!-- 3. Leave Modal -->
<div class="modal fade" id="leaveModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-sm">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Leave Event</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <input type="hidden" id="leave-event-id">
        <div class="mb-3">
          <label class="form-label">Date &amp; Time</label>
          <input type="datetime-local"
                 id="leave-datetime"
                 class="form-control">
        </div>
        <div class="mb-3">
          <label for="leave-comment" class="form-label">What was accomplished:</label>
          <textarea id="leave-comment"
                    class="form-control"
                    rows="2"
                    required></textarea>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button"
                class="btn btn-secondary"
                data-bs-dismiss="modal">
          Cancel
        </button>
        <button id="leave-confirm-btn"
                type="button"
                class="btn btn-danger">
          Confirm Leave
        </button>
      </div>
    </div>
  </div>
</div>




<!-- -------------------------------------------------------------------------------------->


  <!-- 2) Close-out modal logic -->
<script>
document.addEventListener('DOMContentLoaded', () => {
  const modalEl       = document.getElementById('closeoutModal');
  const closeoutModal = new bootstrap.Modal(modalEl);

  const fetchUrl    = "{% url 'maintenance_edit' %}";
  const updateUrl   = "{% url 'maintenance_update_event' %}";
  const closeoutUrl = "{% url 'closeout_downtime_entry' %}";
  const token       = document.querySelector('[name=csrfmiddlewaretoken]').value;

  const idIn        = document.getElementById('closeout-entry-id');
  const lineSel     = document.getElementById('closeout-line');
  const machineSel  = document.getElementById('closeout-machine');
  const catSel      = document.getElementById('closeout-category');
  const subcatSel   = document.getElementById('closeout-subcategory');
  const startDate   = document.getElementById('closeout-start-date');
  const startTime   = document.getElementById('closeout-start-time');
  const origComm    = document.getElementById('closeout-original-comment');
  const closeDate   = document.getElementById('closeout-date');
  const closeTime   = document.getElementById('closeout-time');
  const closeComm   = document.getElementById('closeout-comment');

  const btnSave     = document.getElementById('closeout-save');
  const btnConfirm  = document.getElementById('closeout-confirm');

  // Helper to populate a <select> with simple strings or {code,name} items
  function populateSelect(sel, items, isSimple = false, placeholder = '— Select —') {
    sel.innerHTML = '';
    const ph = document.createElement('option');
    ph.value    = '';
    ph.text     = placeholder;
    ph.disabled = true;
    ph.selected = true;
    sel.appendChild(ph);

    items.forEach(item => {
      const o = document.createElement('option');
      if (isSimple) {
        o.value = o.text = item;
      } else {
        o.value = item.code;
        o.text  = item.name;
      }
      sel.appendChild(o);
    });
  }

  // 1) Load event into modal when any “close-out” button is clicked
  document.querySelectorAll('.closeout-btn').forEach(button => {
    button.addEventListener('click', () => {
      const entryId = button.dataset.entryId;
      idIn.value = entryId;

      fetch(fetchUrl, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRFToken':  token
        },
        body: JSON.stringify({ entry_id: entryId })
      })
      .then(resp => {
        if (!resp.ok) throw new Error('Fetch failed');
        return resp.json();
      })
      .then(data => {
        // — Lines & Machines —
        populateSelect(lineSel, data.lines, true, '— Select line —');
        lineSel.value = data.line;
        function updateMachines() {
          const blk = data.lines_data.find(l => l.line === lineSel.value);
          const machines = blk
            ? blk.operations.flatMap(op => op.machines.map(m => m.number))
            : [];
          populateSelect(machineSel, machines, true, '— Select machine —');
        }
        updateMachines();
        machineSel.value = data.machine;
        lineSel.addEventListener('change', () => {
          updateMachines();
          machineSel.value = '';
        });

        // populate the dropdown…
        populateSelect(catSel, data.categories, false, '— Select category —');

        // pick which code to select
        let pick = data.category_code;

        // if the API told us “NOTSELECTED”, look up the real category by its display-name
        if (!data.categories.some(c => c.code === pick)) {
          const match = data.categories.find(c => c.name === data.category_name);
          if (match) pick = match.code;
        }

        catSel.value = pick;


        if (catSel.value !== data.category_code) {
          console.warn(`Category "${data.category_code}" not found in dropdown`);
        }

        // — Subcategories for the selected category —
        function updateSubcats() {
          // pull only the “real” subcats for this category
          let scs = data.subcategories
            .filter(s => s.parent === catSel.value)
            .map(s => ({ code: s.code, name: s.name }));

          // if this record was saved with NOTSELECTED, prepend it so it can be selected
          if (data.subcategory_code === 'NOTSELECTED') {
            scs.unshift({ code: 'NOTSELECTED', name: 'Not Selected' });
          }

          populateSelect(subcatSel, scs, false, '— Select subcategory —');
        }
        updateSubcats();
        subcatSel.value = data.subcategory_code || '';
        catSel.addEventListener('change', () => {
          updateSubcats();
          subcatSel.value = '';
        });

        // — Timestamps & comments —
        startDate.value = data.start_date;
        startTime.value = data.start_time;
        origComm.value  = data.comment;

        // — Default close-out date/time = now —
        const now = new Date();
        closeDate.value = now.toISOString().slice(0,10);
        closeTime.value = now.toTimeString().slice(0,5);
        closeComm.value = '';

        // — Labour-type checkboxes —
        const labourCbs = Array.from(modalEl.querySelectorAll('.closeout-labour-checkbox'));
        labourCbs.forEach(cb => cb.checked = false);
        (data.labour_types || []).forEach(code => {
          const cb = labourCbs.find(c => c.value === code);
          if (cb) cb.checked = true;
        });

        // — Show the modal! —
        closeoutModal.show();
      })
      .catch(err => {
        console.error(err);
        alert('Could not load event details.');
      });
    });
  });

  // 2) “Save Changes” (update without closing out)
  btnSave.addEventListener('click', () => {
    const payload = {
      entry_id:    idIn.value,
      line:        lineSel.value,
      machine:     machineSel.value,
      category:    catSel.value,
      subcategory: subcatSel.value,
      start_at:    `${startDate.value} ${startTime.value}`,
      comment:     origComm.value,
      labour_types: Array.from(modalEl.querySelectorAll('.closeout-labour-checkbox'))
                        .filter(cb => cb.checked)
                        .map(cb => cb.value)
    };

    fetch(updateUrl, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken':  token
      },
      body: JSON.stringify(payload)
    })
    .then(r => {
      if (!r.ok) throw new Error('Save failed');
      return r.json();
    })
    .then(() => {
      alert('Saved changes.');
      closeoutModal.hide();
      location.reload();
    })
    .catch(() => {
      alert('Error saving changes.');
    });
  });

  // 3) “Confirm Close” (update, then close out)
  btnConfirm.addEventListener('click', () => {
    if (!catSel.value || !subcatSel.value) {
      return alert('Please select both category and subcategory before closing out.');
    }
    if (!closeDate.value || !closeTime.value) {
      return alert('Close-out date and time are required.');
    }

    const updatePayload = {
      entry_id:    idIn.value,
      line:        lineSel.value,
      machine:     machineSel.value,
      category:    catSel.value,
      subcategory: subcatSel.value,
      start_at:    `${startDate.value} ${startTime.value}`,
      comment:     origComm.value,
      labour_types: Array.from(modalEl.querySelectorAll('.closeout-labour-checkbox'))
                        .filter(cb => cb.checked)
                        .map(cb => cb.value)
    };

    // 3a) Update
    fetch(updateUrl, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken':  token
      },
      body: JSON.stringify(updatePayload)
    })
    .then(r => {
      if (!r.ok) throw new Error('update_fail');
      return r.json();
    })
    // 3b) Then close out
    .then(() => {
      const note = closeComm.value.trim();
      return fetch(closeoutUrl, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRFToken':  token
        },
        body: JSON.stringify({
          entry_id:         idIn.value,
          closeout:         `${closeDate.value} ${closeTime.value}`,
          closeout_comment: note
        })
      });
    })
    .then(r => {
      if (r.ok) return r.json();
      if (r.status === 403) throw new Error('not_all_left');
      throw new Error('closeout_fail');
    })
    .then(() => {
      location.reload();
    })
    .catch(err => {
      if (err.message === 'not_all_left') {
        alert('Cannot close out until all participants have left.');
      } else {
        alert('Error closing out entry. Did you select a sub-category?');
      }
    });
  });

});
</script>





    
    
    
    




    









    
  



  <script>
    document.addEventListener('DOMContentLoaded', () => {
      // ── Helpers & Modals ─────────────────────────────────────────────────────
      const currentUser = "{{ request.user.username }}";
      const historyModal = new bootstrap.Modal(document.getElementById('historyModal'));
      const joinModal    = new bootstrap.Modal(document.getElementById('joinModal'));
      const leaveModal   = new bootstrap.Modal(document.getElementById('leaveModal'));
    
      function getLocalDateTimeValue() {
        const now = new Date();
        const pad = n => String(n).padStart(2,'0');
        return [
          now.getFullYear(),
          pad(now.getMonth()+1),
          pad(now.getDate())
        ].join('-') + 'T' +
        pad(now.getHours()) + ':' + pad(now.getMinutes());
      }
    
      // ── Render a single row (8 <td> to match your <thead>) ────────────────────
      function renderRow(e) {
        const isOpen  = !e.closeout_at;
        const rowCls  = isOpen ? 'table-warning' : '';
        const closeCell = isOpen
          ? `<button class="btn btn-sm btn-info closeout-btn" data-entry-id="${e.id}">Close out</button>`
          : e.closeout_at;
    
        // Labour-needed buttons
        let labourHtml = '<span class="text-muted">—</span>';
        if (e.labour_types && e.labour_types.length) {
          labourHtml = e.labour_types.map(code => {
            const style = e.being_worked_on ? 'btn-dark' : 'btn-outline-dark';
            return `
              <button
                type="button"
                class="btn ${style} btn-sm labour-btn me-1"
                data-event-id="${e.id}"
                data-role="${code}"
              >${code}</button>`;
          }).join('');
        }
    
        // Comment cell: just the comment text now
        const commentCell = e.comment;
    
        return `
          <tr class="${rowCls}">
            <td>${e.start_display}</td>
            <td>${closeCell}</td>
            <td>${e.line}</td>
            <td>${e.machine}</td>
            <td><span class="badge bg-dark">${e.category}</span></td>
            <td><span class="badge bg-secondary">${e.subcategory}</span></td>
            <td>${labourHtml}</td>
            <td>${commentCell}</td>
          </tr>`;
      }
    
      // ── Labour-button → “History” modal hookup ────────────────────────────────
      function attachLabourHandlers() {
        document.querySelectorAll('.labour-btn').forEach(btn => {
          if (btn.dataset.init) return;
          btn.dataset.init = '1';
          btn.addEventListener('click', () => {
            const id = btn.dataset.eventId;
            fetch(`/plant/downtime/${id}/history/`)
              .then(r => r.ok ? r.json() : Promise.reject())
              .then(data => {
                const tbody = document.getElementById('history-body');
                tbody.innerHTML = '';
                let userHasOpen = false;
                data.history.forEach(p => {

                  // build a little badge list (or comma-list if you prefer)
                  const rolesHtml = p.roles.length
                  ? p.roles.map(r => `<span class="badge bg-secondary me-1">${r}</span>`).join('')
                  : '<span class="text-muted">—</span>';
                  
                  if (p.user === currentUser && !p.leave_at) userHasOpen = true;
                  tbody.insertAdjacentHTML('beforeend', `
                    <tr>
                      <td>${p.user}</td>
                      <td>${rolesHtml}</td>           <!-- ← render roles here -->
                      <td>${p.join_at}</td>
                      <td>${p.join_comment}</td>
                      <td>${p.leave_at || '—'}</td>
                      <td>${p.leave_comment}</td>
                      <td>${p.total_minutes}</td>
                    </tr>`);
                });
                // toggle the history‐modal buttons
                document.getElementById('history-join-btn').style.display  = userHasOpen ? 'none' : 'inline-block';
                document.getElementById('history-leave-btn').style.display = userHasOpen ? 'inline-block' : 'none';
                document.getElementById('history-join-btn').dataset.eventId  = id;
                document.getElementById('history-leave-btn').dataset.eventId = id;
                historyModal.show();
              })
              .catch(() => alert('Could not load history.'));
          });
        });
      }
      attachLabourHandlers();


      // allow clicking the row (but not labour buttons) to open the edit/closeout modal
      document.querySelectorAll('.editable-row').forEach(row => {
        row.addEventListener('click', e => {
          // ignore clicks on labour buttons
          if (e.target.closest('.labour-btn')) return;
          // forward to the hidden closeout-btn
          const btn = row.querySelector('.closeout-btn');
          if (btn) btn.click();
        });
      });



    
      // ── Load-More logic ───────────────────────────────────────────────────────
      const loadMoreBtn = document.getElementById('load-more-btn');
      let offset        = {{ page_size }};
      const loadUrl     = "{% url 'load_more_downtime_entries' %}";
    
      loadMoreBtn?.addEventListener('click', () => {
        loadMoreBtn.disabled = true;
        fetch(`${loadUrl}?offset=${offset}`)
          .then(r => r.ok ? r.json() : Promise.reject())
          .then(data => {
            const tbody = document.querySelector('table tbody');
            data.entries.forEach(e => tbody.insertAdjacentHTML('beforeend', renderRow(e)));
            offset += {{ page_size }};
            if (!data.has_more) loadMoreBtn.remove();
            else loadMoreBtn.disabled = false;
            attachLabourHandlers();
          })
          .catch(() => {
            alert('Error loading more entries');
            loadMoreBtn.disabled = false;
          });
      });
    
      // ── Filters (unchanged) ────────────────────────────────────────────────────
      // ... your labour‐type and participant‐filters code here ...
    
      // ── History→Join & Leave modals ──────────────────────────────────────────
      document.getElementById('history-join-btn').addEventListener('click', e => {
        const id = e.currentTarget.dataset.eventId;
        document.getElementById('join-event-id').value     = id;
        document.getElementById('join-datetime').value     = getLocalDateTimeValue();
        document.getElementById('join-comment').value      = 'Assess the situation';
        historyModal.hide();
        joinModal.show();
      });
      document.getElementById('join-confirm-btn').addEventListener('click', () => {
        const id   = document.getElementById('join-event-id').value;
        const note = document.getElementById('join-comment').value.trim();
        if (!note) return alert('Please say what you plan to do.');
        fetch("{% url 'join_downtime_event' %}", {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken':  document.querySelector('[name=csrfmiddlewaretoken]').value
          },
          body: JSON.stringify({
            event_id:     id,
            join_comment: note,
            join_datetime: document.getElementById('join-datetime').value
          })
        })
        .then(r => r.ok ? location.reload() : Promise.reject())
        .catch(() => alert('Could not join event.'));
      });
    
      document.getElementById('history-leave-btn').addEventListener('click', e => {
        const id = e.currentTarget.dataset.eventId;
        document.getElementById('leave-event-id').value    = id;
        document.getElementById('leave-datetime').value    = getLocalDateTimeValue();
        document.getElementById('leave-comment').value     = '';
        historyModal.hide();
        leaveModal.show();
      });
      document.getElementById('leave-confirm-btn').addEventListener('click', () => {
        const id   = document.getElementById('leave-event-id').value;
        const note = document.getElementById('leave-comment').value.trim();
        if (!note) return alert('Please describe what you did.');
        fetch("{% url 'leave_downtime_event' %}", {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken':  document.querySelector('[name=csrfmiddlewaretoken]').value
          },
          body: JSON.stringify({
            event_id:      id,
            leave_comment: note,
            leave_datetime: document.getElementById('leave-datetime').value
          })
        })
        .then(r => r.ok ? location.reload() : Promise.reject())
        .catch(() => alert('Could not leave event.'));
      });
    });







    document.addEventListener('DOMContentLoaded', () => {
      // 1) On load, check if we told it to reopen:
      if (localStorage.getItem('activeListWasOpen') === 'true') {
        const collapseEl = document.getElementById('activeListCollapse');
        new bootstrap.Collapse(collapseEl, { toggle: false }).show();
        localStorage.removeItem('activeListWasOpen');
      }
    
      // 2) Wire up each toggle button
      document.querySelectorAll('.toggle-active-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          // before we hit “fetch”, save the current open/closed state
          const collapseEl = document.getElementById('activeListCollapse');
          localStorage.setItem(
            'activeListWasOpen',
            collapseEl.classList.contains('show')
          );
    
          // now fire off your existing toggle call
          const username = btn.dataset.username;
          const action   = btn.dataset.action;
          const formData = new FormData();
          formData.append('username', username);
          formData.append('action', action);
    
          fetch("{% url 'toggle_active' %}", {
            method: 'POST',
            headers: {
              'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            },
            body: formData
          })
          .then(r => {
            if (!r.ok) throw new Error();
            return r.json();
          })
          .then(() => {
            // reload—and on next DOMContentLoaded we’ll re-open it
            location.reload();
          })
          .catch(() => alert('Error updating active list.'));
        });
      });
    });
    
    </script>
    
    
    
    <!-- 3) Self-contained script -->
    <script>
      (function(){
        document.addEventListener('DOMContentLoaded', function(){
          const modalEl             = document.getElementById('machineHistoryModal');
          const modalDialog         = modalEl.querySelector('.modal-dialog');
          const machineHistoryModal = new bootstrap.Modal(modalEl);
          const form                = document.getElementById('machineHistoryForm');
          const body                = modalEl.querySelector('.modal-body');
      
          const formHTML = `
            {% csrf_token %}
            <div class="mb-3">
              <label for="machine-input" class="form-label">Machine #</label>
              <input
                type="text"
                id="machine-input"
                class="form-control"
                placeholder="Enter machine number"
                required
              >
            </div>`;
      

          // 1) Open narrow form
          document
            .getElementById('machine-history-btn')
            .addEventListener('click', () => {
              // remove any wide classes
              modalDialog.classList.remove('modal-xl', 'modal-dialog-scrollable');
              // reset to form
              body.innerHTML = formHTML;
              // make sure Submit is visible again
              const submitBtn = modalEl.querySelector('button[type="submit"]');
              if (submitBtn) submitBtn.classList.remove('d-none');
              machineHistoryModal.show();
            });

      
          // 2) On submit, widen & inject table
          form.addEventListener('submit', function(e){
            e.preventDefault();
            const machine = body.querySelector('#machine-input').value.trim();
            if (!machine) return;
      
            fetch("{% url 'machine_history' %}", {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
              },
              body: JSON.stringify({ machine })
            })
            .then(r => r.json())
            .then(data => {
              if (data.status === 'ok') {
                // make the dialog wide & scrollable
                modalDialog.classList.add('modal-xl', 'modal-dialog-scrollable');
                // inject the table inside a responsive wrapper
                body.innerHTML = `
                   <div class="overflow-auto" style="max-height:75vh; display:block; -webkit-overflow-scrolling:touch;">
                     <div class="table-responsive" style="overflow-y:visible;">
                       ${data.html}
                     </div>
                   </div>`;
            
                // hide the submit button (and optionally keep the Cancel so they can close)
                const submitBtn = modalEl.querySelector('button[type="submit"]');
                if (submitBtn) submitBtn.classList.add('d-none');
              } else {
                body.innerHTML = `<div class="alert alert-danger">Error: ${data.message}</div>`;
              }
            })
            
            .catch(err => {
              body.innerHTML = `<div class="alert alert-danger">Request failed</div>`;
              console.error(err);
            });
          });
        });
      })();
      </script>
      
  
      <script>
          // ─── INACTIVITY-BASED RELOAD ───────────────────────────────────────
          let inactivityTimer;
          function resetInactivityTimer(){
            clearTimeout(inactivityTimer);
            inactivityTimer = setTimeout(()=>{
              console.log('Reloading after 5 m inactivity');
              location.reload();
            }, 2*60*1000);
          }
          document.addEventListener('click', resetInactivityTimer);
          resetInactivityTimer();
      </script>
        
    <script>
      document.addEventListener('DOMContentLoaded', function() {
        const input = document.getElementById('job-filter');
        const rows  = document.querySelectorAll('table tbody tr.editable-row');

        input.addEventListener('input', function() {
          const q = this.value.trim().toLowerCase();
          rows.forEach(row => {
            // 1) text match (machine #, subcategory, comment…)
            const textMatch = row.textContent.toLowerCase().includes(q);

            // 2) labour-role match (using full role in data-role)
            const roleMatch = Array.from(row.querySelectorAll('.labour-btn'))
              .some(btn => btn.dataset.role.toLowerCase().includes(q));

            row.style.display = (textMatch || roleMatch) ? '' : 'none';
          });
        });
      });
    </script>





    <script>
    document.addEventListener('DOMContentLoaded', () => {
      // ─── Cookie helpers ───────────────────────────────────────────────────────
      function getExcludedLines() {
        const m = document.cookie.match(/(?:^|; )excluded_lines=([^;]+)/);
        return m ? JSON.parse(decodeURIComponent(m[1])) : [];
      }
      function setExcludedLines(list) {
        document.cookie =
          `excluded_lines=${encodeURIComponent(JSON.stringify(list))};path=/;max-age=${60*60*24*30}`;
      }

      // ─── Row-filtering based on excluded lines ───────────────────────────────
      function applyExcludedFilter() {
        const excluded = getExcludedLines();
        document
          .querySelectorAll('table.table-striped tbody tr.editable-row')
          .forEach(tr => {
            const line = tr.dataset.line;
            tr.style.display = excluded.includes(line) ? 'none' : '';
          });
      }

      // ─── Modal & controls setup ───────────────────────────────────────────────
      const icon     = document.getElementById('target-lines-icon');
      const modalEl  = document.getElementById('excludeLinesModal');
      const modal    = new bootstrap.Modal(modalEl);
      const body     = modalEl.querySelector('.modal-body');
      const btnSelectAll    = document.getElementById('exclude-lines-select-all');
      const btnDeselectAll  = document.getElementById('exclude-lines-deselect-all');
      const btnSave         = document.getElementById('exclude-lines-save');

      // When you click the crosshair icon, fetch and build the checkbox list
      icon.addEventListener('click', () => {
        fetch("{% url 'target_lines' %}")
          .then(r => r.json())
          .then(data => {
            const excluded = getExcludedLines();
            body.innerHTML = '';
            data.lines.forEach(line => {
              const id = 'exclude-line-' + line.replace(/\W+/g,'_');
              body.insertAdjacentHTML('beforeend', `
                <div class="form-check">
                  <input
                    class="form-check-input"
                    type="checkbox"
                    id="${id}"
                    value="${line}"
                    ${excluded.includes(line) ? 'checked' : ''}
                  >
                  <label class="form-check-label" for="${id}">${line}</label>
                </div>`);
            });
            modal.show();
          })
          .catch(() => {
            body.innerHTML = '<div class="alert alert-danger">Could not load lines.</div>';
            modal.show();
          });
      });

      // Select All
      btnSelectAll.addEventListener('click', () => {
        modalEl.querySelectorAll('.form-check-input').forEach(cb => cb.checked = true);
      });

      // Deselect All
      btnDeselectAll.addEventListener('click', () => {
        modalEl.querySelectorAll('.form-check-input').forEach(cb => cb.checked = false);
      });

      // Save & reapply filter
      btnSave.addEventListener('click', () => {
        const chosen = Array.from(
          modalEl.querySelectorAll('.form-check-input:checked')
        ).map(cb => cb.value);
        setExcludedLines(chosen);
        applyExcludedFilter();
        modal.hide();
      });

      // Initial run on page load
      applyExcludedFilter();
    });
    </script>








</div>




      
  
{% endblock %}