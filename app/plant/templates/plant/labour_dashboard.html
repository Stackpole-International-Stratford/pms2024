{% extends "parent.html" %}
{% block content %}
  {# hidden CSRF token for AJAX posts #}
  <form id="csrf-token-form" style="display:none;">{% csrf_token %}</form>

  <div class="container py-4">
    <h3>Labour Dashboard</h3>

    {# —–– filter by labour type —––––––––––––––––––––––––––––––––––––––––– #}
    <form class="row g-2 mb-3" method="get" action="{% url 'labour_dashboard' %}">
      <div class="col-auto">
        <select name="labour_type" class="form-select form-select-sm">
          <option value="">All types</option>
          {% for code,label in labour_choices %}
            <option value="{{ code }}"{% if code == current_filter %} selected{% endif %}>
              {{ label }}
            </option>
          {% endfor %}
        </select>
      </div>
      <div class="col-auto">
        <button type="submit" class="btn btn-sm btn-outline-primary">
          Filter
        </button>
      </div>
    </form>

    {# —–– open events table —––––––––––––––––––––––––––––––––––––––––––––– #}
    <table class="table table-striped table-sm">
      <thead>
        <tr>
          <th>Start</th><th>Line</th><th>Machine</th>
          <th>Category</th><th>Subcat</th><th>Labour</th>
          <th>Assigned</th><th>Action</th>
        </tr>
      </thead>
      <tbody>
        {% for e in open_events %}
        <tr id="row-{{ e.id }}">
          <td>{{ e.start_at|date:"Y-m-d H:i" }}</td>
          <td>{{ e.line }}</td>
          <td>{{ e.machine }}</td>
          <td>{{ e.category }}</td>
          <td>{{ e.subcategory }}</td>
          <td>{{ e.get_labour_type_display }}</td>
          <td class="assigned-col">
            {{ e.assigned_to|default:"—" }}
          </td>
          <td>
            {% if not e.assigned_to %}
              <button class="btn btn-sm btn-success assign-btn"
                      data-id="{{ e.id }}">
                Assign to me
              </button>
            {% else %}
              {% with request.user.first_name|lower|add:"."|add:request.user.last_name|lower as me %}
                {% if e.assigned_to == me %}
                  <button class="btn btn-sm btn-warning unassign-btn"
                          data-id="{{ e.id }}">
                    Unassign
                  </button>
                {% else %}
                  <span class="text-muted">Taken</span>
                {% endif %}
              {% endwith %}
            {% endif %}
          </td>
        </tr>
        {% empty %}
        <tr>
          <td colspan="8" class="text-center">No open jobs.</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>

    <hr>

    {# —–– grouped current assignments —–––––––––––––––––––––––––––––––––––– #}
    <h5>Current Assignments</h5>
    {% for user_name, events in assignments.items %}
      <div class="mb-3">
        <h6>{{ user_name }}</h6>
        <ul class="list-unstyled">
          {% for e in events %}
          <li>
            [{{ e.start_at|date:"Y-m-d H:i" }}]
            {{ e.line }}–{{ e.machine }}
            &ndash; {{ e.get_labour_type_display }}
            {% with request.user.first_name|lower|add:"."|add:request.user.last_name|lower as me %}
              {# only allow “Unassign” if this is your own job #}
              {% if user_name == me %}
                <button class="btn btn-sm btn-link unassign-btn"
                        data-id="{{ e.id }}">
                  Unassign
                </button>
              {% endif %}
            {% endwith %}
          </li>
          {% endfor %}
        </ul>
      </div>
    {% empty %}
      <p>No assignments yet.</p>
    {% endfor %}

  </div>

  <script>
    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;

    function postAction(url, entryId, onSuccess) {
      fetch(url, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/x-www-form-urlencoded',
          'X-CSRFToken': csrfToken
        },
        body: new URLSearchParams({ entry_id: entryId })
      })
      .then(resp => resp.ok ? resp.json() : Promise.reject())
      .then(onSuccess)
      .catch(() => alert('Error; please try again.'));
    }

    // Assign buttons
    document.querySelectorAll('.assign-btn').forEach(btn =>
      btn.addEventListener('click', e => {
        const id = e.currentTarget.dataset.id;
        postAction("{% url 'assign_downtime' %}", id, data => {
          const row = document.getElementById(`row-${id}`);
          row.querySelector('.assigned-col').textContent = data.assigned_to;
          e.currentTarget.outerHTML =
            `<button class="btn btn-sm btn-warning unassign-btn" data-id="${id}">
               Unassign
             </button>`;
        });
      })
    );

    // Unassign (both in table and in assignment lists)
    document.body.addEventListener('click', e => {
      if (!e.target.matches('.unassign-btn')) return;
      const id = e.target.dataset.id;
      postAction("{% url 'unassign_downtime' %}", id, () => {
        // clear from main table row if present
        const row = document.getElementById(`row-${id}`);
        if (row) {
          row.querySelector('.assigned-col').textContent = '—';
          e.target.outerHTML =
            `<button class="btn btn-sm btn-success assign-btn" data-id="${id}">
               Assign to me
             </button>`;
        } else {
          // if it's in the assignments list, just reload the page
          location.reload();
        }
      });
    });
  </script>
{% endblock %}
