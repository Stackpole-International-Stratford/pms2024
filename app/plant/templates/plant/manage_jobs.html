{% extends "parent.html" %}
{% block content %}
  <h1>Manage Training Jobs</h1>

  {# always-visible add button #}
  <button
    type="button"
    class="btn btn-sm btn-primary mb-3"
    data-bs-toggle="modal"
    data-bs-target="#addJobModal">
    Add Job
  </button>

  {% if jobs %}
    <div class="table-responsive">
      <table class="table table-striped table-hover">
        <thead>
          <tr>
            <th>Area</th>
            <th>Line</th>
            <th>Operation</th>
            <th>Description</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody>
          {% for job in jobs %}
            <tr data-job-id="{{ job.id }}">
              <td class="col-area">{{ job.get_area_display }}</td>
              <td class="col-line">{{ job.line }}</td>
              <td class="col-operation">{{ job.operation }}</td>
              <td class="col-description">{{ job.description }}</td>
              <td>
                <button
                  type="button"
                  class="btn btn-sm btn-secondary edit-btn"
                  data-bs-toggle="modal"
                  data-bs-target="#editJobModal"
                  data-id="{{ job.id }}"
                  data-area="{{ job.area }}"
                  data-line="{{ job.line }}"
                  data-operation="{{ job.operation }}"
                  data-description="{{ job.description }}"
                >
                  Edit
                </button>
              </td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  {% else %}
    <p>No training jobs found.</p>
  {% endif %}

  {# —————————————————————————— #}
  {# Add Job Modal (unchanged)     #}
  <div class="modal fade" id="addJobModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <form id="addJobForm" method="post" action="{% url 'add_job' %}">
          {% csrf_token %}
          <div class="modal-header">
            <h5 class="modal-title">Add Training Job</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body">
            <div class="mb-3">
              <label for="id_area" class="form-label">Area</label>
              <select name="area" id="id_area" class="form-select">
                {% for val, label in area_choices %}
                  <option value="{{ val }}">{{ label }}</option>
                {% endfor %}
              </select>
            </div>
            <div class="mb-3">
              <label for="id_line" class="form-label">Line</label>
              <input type="text" name="line" id="id_line" class="form-control">
            </div>
            <div class="mb-3">
              <label for="id_operation" class="form-label">Operation</label>
              <input type="text" name="operation" id="id_operation" class="form-control">
            </div>
            <div class="mb-3">
              <label for="id_description" class="form-label">Description</label>
              <textarea name="description" id="id_description" class="form-control"></textarea>
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
              Close
            </button>
            <button type="submit" class="btn btn-primary">
              Save Job
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>
  {# —————————————————————————— #}

  {# Edit Job Modal — one shared modal #}
  <div class="modal fade" id="editJobModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <form id="editJobForm" method="post">
          {% csrf_token %}
          <div class="modal-header">
            <h5 class="modal-title">Edit Training Job</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body">
            <input type="hidden" name="id" id="edit_id">

            <div class="mb-3">
              <label for="edit_area" class="form-label">Area</label>
              <select name="area" id="edit_area" class="form-select">
                {% for val, label in area_choices %}
                  <option value="{{ val }}">{{ label }}</option>
                {% endfor %}
              </select>
            </div>
            <div class="mb-3">
              <label for="edit_line" class="form-label">Line</label>
              <input type="text" name="line" id="edit_line" class="form-control">
            </div>
            <div class="mb-3">
              <label for="edit_operation" class="form-label">Operation</label>
              <input type="text" name="operation" id="edit_operation" class="form-control">
            </div>
            <div class="mb-3">
              <label for="edit_description" class="form-label">Description</label>
              <textarea name="description" id="edit_description" class="form-control"></textarea>
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
              Close
            </button>
            <button type="submit" class="btn btn-primary">
              Save Changes
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>

  {# AJAX script for both add & edit #}
  <script>
    function getCookie(name) {
      let cookieValue = null;
      if (document.cookie && document.cookie !== "") {
        document.cookie.split(";").forEach(c => {
          c = c.trim();
          if (c.startsWith(name + "=")) {
            cookieValue = decodeURIComponent(c.substring(name.length + 1));
          }
        });
      }
      return cookieValue;
    }

    document.addEventListener("DOMContentLoaded", () => {
      const csrfToken = getCookie("csrftoken");

      // 1) Populate Edit modal
      document.querySelectorAll(".edit-btn").forEach(btn => {
        btn.addEventListener("click", () => {
          const { id, area, line, operation, description } = btn.dataset;
          document.getElementById("edit_id").value          = id;
          document.getElementById("edit_area").value        = area;
          document.getElementById("edit_line").value        = line;
          document.getElementById("edit_operation").value   = operation;
          document.getElementById("edit_description").value = description;
          document.getElementById("editJobForm").action =
            `{% url 'edit_job' 0 %}`.replace("/0/", `/${id}/`);
        });
      });

      // 2) Submit Edit form
      document.getElementById("editJobForm").addEventListener("submit", e => {
        e.preventDefault();
        const form = e.target;
        fetch(form.action, {
          method: "POST",
          headers: {
            "X-CSRFToken": csrfToken,
            "X-Requested-With": "XMLHttpRequest"
          },
          body: new FormData(form)
        })
        .then(r => r.json())
        .then(json => {
          if (!json.success) {
            return alert("Error: " + (json.errors||"Unknown error"));
          }
          const info = json.job;
          const row  = document.querySelector(`tr[data-job-id='${info.id}']`);
          row.querySelector(".col-area").textContent        = info.area_display;
          row.querySelector(".col-line").textContent        = info.line;
          row.querySelector(".col-operation").textContent   = info.operation;
          row.querySelector(".col-description").textContent = info.description;
          bootstrap.Modal.getInstance(
            document.getElementById("editJobModal")
          ).hide();
        })
        .catch(err => console.error("Edit-job AJAX error:", err));
      });

      // 3) Submit Add form
      document.getElementById("addJobForm").addEventListener("submit", e => {
        e.preventDefault();
        const form = e.target;
        fetch(form.action, {
          method: "POST",
          headers: {
            "X-CSRFToken": csrfToken,
            "X-Requested-With": "XMLHttpRequest"
          },
          body: new FormData(form)
        })
        .then(r => r.json())
        .then(json => {
          if (!json.success) {
            return alert("Error: " + (json.errors||"Unknown error"));
          }
          const tbody = document.querySelector("table tbody");
          const job   = json.job;
          const row   = document.createElement("tr");
          row.setAttribute("data-job-id", job.id);
          row.innerHTML = `
            <td class="col-area">${job.area_display}</td>
            <td class="col-line">${job.line}</td>
            <td class="col-operation">${job.operation}</td>
            <td class="col-description">${job.description}</td>
            <td>
              <button
                type="button"
                class="btn btn-sm btn-secondary edit-btn"
                data-bs-toggle="modal"
                data-bs-target="#editJobModal"
                data-id="${job.id}"
                data-area="${job.area}"
                data-line="${job.line}"
                data-operation="${job.operation}"
                data-description="${job.description}"
              >Edit</button>
            </td>
          `;
          if (tbody) {
            tbody.prepend(row);
            // re-bind its edit handler
            row.querySelector(".edit-btn").addEventListener("click", () => {
              const btnData = row.querySelector(".edit-btn").dataset;
              document.getElementById("edit_id").value          = btnData.id;
              document.getElementById("edit_area").value        = btnData.area;
              document.getElementById("edit_line").value        = btnData.line;
              document.getElementById("edit_operation").value   = btnData.operation;
              document.getElementById("edit_description").value = btnData.description;
              document.getElementById("editJobForm").action =
                `{% url 'edit_job' 0 %}`.replace("/0/", `/${btnData.id}/`);
            });
          } else {
            location.reload();
          }
          bootstrap.Modal.getInstance(
            document.getElementById("addJobModal")
          ).hide();
          form.reset();
        })
        .catch(err => console.error("Add-job AJAX error:", err));
      });
    });
  </script>
{% endblock %}
