{% extends "parent.html" %}
{% block content %}
<div class="container mt-4">
  <h3>Bulk Close-out</h3>
  <p class="text-muted mb-3">You selected {{ events|length }} open entr{{ events|length|pluralize:"y,ies" }}.</p>

  {% csrf_token %}

  <div class="card mb-3">
    <div class="card-body">
      <div class="row g-2">
        <div class="col-md-3">
          <label class="form-label" for="all-date">Close-out Date (apply to all)</label>
          <input id="all-date" type="date" class="form-control">
        </div>
        <div class="col-md-3">
          <label class="form-label" for="all-time">Close-out Time (apply to all)</label>
          <input id="all-time" type="time" class="form-control">
        </div>
        <div class="col-md-6">
          <label class="form-label" for="all-comment">Comment (apply to all)</label>
          <input id="all-comment" class="form-control" placeholder="Set a comment for all (optional)">
        </div>
      </div>
      <div class="form-text">Use the fields above to prefill rows; you can still edit per row.</div>
      <div class="mt-2 d-flex align-items-center gap-2">
        <button id="apply-to-all" class="btn btn-outline-secondary btn-sm" type="button">Apply to all rows</button>
        <span id="missing-note" class="text-danger small ms-1" role="status" aria-live="polite"></span>
      </div>
    </div>
  </div>

  <div class="table-responsive">
    <table class="table table-sm table-striped align-middle">
      <thead class="table-light">
        <tr>
          <th>Entry</th>
          <th>Line</th>
          <th>Machine</th>
          <th>Category</th>
          <th>Started</th>
          <th style="width: 12rem;">Date</th>
          <th style="width: 10rem;">Time</th>
          <th style="width: 28rem;">Comment <span class="text-danger">*</span></th>
        </tr>
      </thead>
      <tbody id="bulk-tbody">
        {% for e in events %}
        <tr data-id="{{ e.id }}">
          <td>#{{ e.id }}</td>
          <td>{{ e.line }}</td>
          <td>{{ e.machine }}</td>
          <td>{{ e.category }}{% if e.subcategory %} – {{ e.subcategory }}{% endif %}</td>
          <td>{{ e.start_display }}</td>
          <td><input type="date" class="form-control row-date"></td>
          <td><input type="time" class="form-control row-time"></td>
          <td>
            <input type="text" class="form-control row-comment" placeholder="What was done?" aria-required="true">
            <div class="invalid-feedback">Comment required.</div>
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

  <div class="d-flex gap-2 mt-3">
    <a href="{% url 'maintenance_all' %}" class="btn btn-secondary">Back</a>
    <button id="bulk-submit" class="btn btn-danger" type="button" disabled>Confirm Close {{ events|length }}</button>
  </div>

  <div id="bulk-results" class="mt-3"></div>
</div>

<style>
  /* minimal highlight without relying on full Bootstrap validation cycle */
  .row-comment.is-invalid { border-color: #dc3545; box-shadow: none; }
</style>

<script>
(function(){
  // --- Utilities ---
  const pad2 = n => String(n).padStart(2,'0');
  const nowDate = () => {
    const d = new Date();
    return `${d.getFullYear()}-${pad2(d.getMonth()+1)}-${pad2(d.getDate())}`;
  };
  const nowTime = () => {
    const d = new Date();
    return `${pad2(d.getHours())}:${pad2(d.getMinutes())}`;
  };
  const qs = sel => document.querySelector(sel);
  const qsa = sel => Array.from(document.querySelectorAll(sel));

  // --- Defaults: now for every row ---
  qsa('.row-date').forEach(i => i.value = nowDate());
  qsa('.row-time').forEach(i => i.value = nowTime());

  // --- CSRF (cookie or hidden input fallback) ---
  const csrf = (document.cookie.match(/(?:^|; )csrftoken=([^;]+)/)||[])[1] ||
               qs('[name=csrfmiddlewaretoken]')?.value || '';

  const submitBtn   = qs('#bulk-submit');
  const resultsBox  = qs('#bulk-results');
  const missingNote = qs('#missing-note');

  // --- Validation: every row must have a non-empty comment ---
  function validateAllRows() {
    let missing = 0;
    qsa('#bulk-tbody tr').forEach(r => {
      const input = r.querySelector('.row-comment');
      const ok = input.value.trim().length > 0;
      input.classList.toggle('is-invalid', !ok);
      // show/hide bootstrap invalid feedback
      const fb = input.nextElementSibling;
      if (fb && fb.classList.contains('invalid-feedback')) {
        fb.style.display = ok ? 'none' : 'block';
      }
      if (!ok) missing += 1;
    });

    submitBtn.disabled = missing > 0;
    missingNote.textContent = missing ? `Add a comment to all rows (${missing} missing).` : '';
    return missing === 0;
  }

  // Run once at load
  validateAllRows();

  // Revalidate on any comment input
  qsa('.row-comment').forEach(i => {
    i.addEventListener('input', validateAllRows);
  });

  // --- Apply to all handler ---
  qs('#apply-to-all').addEventListener('click', () => {
    const d = qs('#all-date').value || nowDate();
    const t = qs('#all-time').value || nowTime();
    const c = qs('#all-comment').value || '';

    qsa('.row-date').forEach(i => i.value = d);
    qsa('.row-time').forEach(i => i.value = t);
    if (c.trim()) qsa('.row-comment').forEach(i => i.value = c);

    validateAllRows();
  });

  // --- Submit handler ---
  qs('#bulk-submit').addEventListener('click', async () => {
    // Block if invalid and scroll to first missing
    if (!validateAllRows()) {
      const firstMissing = qs('.row-comment.is-invalid');
      if (firstMissing) firstMissing.scrollIntoView({ behavior: 'smooth', block: 'center' });
      return;
    }

    const rows = qsa('#bulk-tbody tr');
    const items = rows.map(r => {
      const id = Number(r.dataset.id);
      const d  = r.querySelector('.row-date').value;
      const t  = r.querySelector('.row-time').value;
      const c  = r.querySelector('.row-comment').value.trim();
      return { entry_id: id, closeout: `${d} ${t}`, comment: c };
    });

    resultsBox.innerHTML = '<div class="alert alert-info">Processing…</div>';

    try {
      const resp = await fetch("{% url 'bulk_closeout_submit' %}", {
        method: 'POST',
        credentials: 'same-origin',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRFToken': csrf
        },
        body: JSON.stringify({ items })
      });

      const data = await resp.json();
      const ok   = (data.results || []).filter(r => r.ok).length;
      const fail = (data.results || []).length - ok;

      let html = `<div class="alert alert-${fail ? 'warning' : 'success'}">Closed ${ok} / ${items.length}${fail ? ', some failed.' : ''}</div>`;
      html += '<ul class="small mb-0">';
      (data.results || []).forEach(r => {
        html += `<li>#${r.entry_id}: ${r.ok ? 'ok' : ('fail – ' + (r.error || 'unknown'))}</li>`;
      });
      html += '</ul>';
      resultsBox.innerHTML = html;
    } catch (e) {
      resultsBox.innerHTML = '<div class="alert alert-danger">Bulk close failed.</div>';
    }
  });
})();
</script>
{% endblock %}
