{% extends "parent.html" %}
{% block content %}
<div class="container mt-4">
  <h3>Bulk Close-out</h3>
  <p class="text-muted mb-3">You selected {{ events|length }} open entr{{ events|length|pluralize:"y,ies" }}.</p>

  {% csrf_token %}

  <div class="card mb-3">
    <div class="card-body">
      <div class="row g-2">
        <div class="col-md-3">
          <label class="form-label">Close-out Date</label>
          <input id="all-date" type="date" class="form-control">
        </div>
        <div class="col-md-3">
          <label class="form-label">Close-out Time</label>
          <input id="all-time" type="time" class="form-control">
        </div>
        <div class="col-md-6">
          <label class="form-label">Comment (apply to all – optional)</label>
          <input id="all-comment" class="form-control" placeholder="Set a comment for all (optional)">
        </div>
      </div>
      <div class="form-text">Use the fields above to prefill rows; you can still edit per row.</div>
      <div class="mt-2">
        <button id="apply-to-all" class="btn btn-outline-secondary btn-sm">Apply to all rows</button>
      </div>
    </div>
  </div>

  <div class="table-responsive">
    <table class="table table-sm table-striped align-middle">
      <thead class="table-light">
        <tr>
          <th>Entry</th>
          <th>Line</th>
          <th>Machine</th>
          <th>Category</th>
          <th>Started</th>
          <th style="width: 12rem;">Date</th>
          <th style="width: 10rem;">Time</th>
          <th style="width: 28rem;">Comment</th>
        </tr>
      </thead>
      <tbody id="bulk-tbody">
        {% for e in events %}
        <tr data-id="{{ e.id }}">
          <td>#{{ e.id }}</td>
          <td>{{ e.line }}</td>
          <td>{{ e.machine }}</td>
          <td>{{ e.category }}{% if e.subcategory %} – {{ e.subcategory }}{% endif %}</td>
          <td>{{ e.start_display }}</td>
          <td><input type="date" class="form-control row-date"></td>
          <td><input type="time" class="form-control row-time"></td>
          <td><input type="text"  class="form-control row-comment" placeholder="What was done?"></td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

  <div class="d-flex gap-2 mt-3">
    <a href="{% url 'maintenance_all' %}" class="btn btn-secondary">Back</a>
    <button id="bulk-submit" class="btn btn-danger">Confirm Close {{ events|length }}</button>
  </div>

  <div id="bulk-results" class="mt-3"></div>
</div>

<script>
(function(){
  function pad2(n){ return String(n).padStart(2,'0'); }
  function nowDate(){ const d=new Date(); return `${d.getFullYear()}-${pad2(d.getMonth()+1)}-${pad2(d.getDate())}`; }
  function nowTime(){ const d=new Date(); return `${pad2(d.getHours())}:${pad2(d.getMinutes())}`; }

  // defaults: now for every row
  document.querySelectorAll('.row-date').forEach(i => i.value = nowDate());
  document.querySelectorAll('.row-time').forEach(i => i.value = nowTime());

  const csrf = (document.cookie.match(/(?:^|; )csrftoken=([^;]+)/)||[])[1] ||
               document.querySelector('[name=csrfmiddlewaretoken]')?.value;

  document.getElementById('apply-to-all').addEventListener('click', () => {
    const d = document.getElementById('all-date').value || nowDate();
    const t = document.getElementById('all-time').value || nowTime();
    const c = document.getElementById('all-comment').value || '';
    document.querySelectorAll('.row-date').forEach(i => i.value = d);
    document.querySelectorAll('.row-time').forEach(i => i.value = t);
    if (c.trim()) document.querySelectorAll('.row-comment').forEach(i => i.value = c);
  });

  document.getElementById('bulk-submit').addEventListener('click', async () => {
    const rows = Array.from(document.querySelectorAll('#bulk-tbody tr'));
    const items = rows.map(r => {
      const id = r.dataset.id;
      const d  = r.querySelector('.row-date').value;
      const t  = r.querySelector('.row-time').value;
      const c  = r.querySelector('.row-comment').value.trim();
      return { entry_id: Number(id), closeout: `${d} ${t}`, comment: c };
    });

    const resBox = document.getElementById('bulk-results');
    resBox.innerHTML = '<div class="alert alert-info">Processing…</div>';

    try {
      const resp = await fetch("{% url 'bulk_closeout_submit' %}", {
        method: 'POST',
        credentials: 'same-origin',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRFToken': csrf
        },
        body: JSON.stringify({ items })
      });
      const data = await resp.json();
      const ok = (data.results || []).filter(r => r.ok).length;
      const fail = (data.results || []).length - ok;

      // render a small summary + per-row messages
      let html = `<div class="alert alert-${fail? 'warning':'success'}">Closed ${ok} / ${items.length}${fail? ', some failed.':''}</div>`;
      html += '<ul class="small">';
      (data.results || []).forEach(r => {
        html += `<li>#${r.entry_id}: ${r.ok ? 'ok' : ('fail – ' + (r.error || 'unknown'))}</li>`;
      });
      html += '</ul>';
      resBox.innerHTML = html;
    } catch (e) {
      resBox.innerHTML = '<div class="alert alert-danger">Bulk close failed.</div>';
    }
  });
})();
</script>
{% endblock %}
