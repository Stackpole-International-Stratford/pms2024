{# templates/plant/heat_toggle.html #}
{% extends "parent.html" %}
{% block content %}
<div class="container mt-4">
    <h1 class="mb-4">Heat Toggle</h1>

    <div class="accordion" id="linesAccordion">
        {% for line, machines in grouped_data.items %}
            <div class="accordion-item">
                <h2 class="accordion-header" id="heading-{{ forloop.counter }}">
                    <button class="accordion-button {% if not forloop.first %}collapsed{% endif %}"
                            type="button"
                            data-bs-toggle="collapse"
                            data-bs-target="#collapse-{{ forloop.counter }}"
                            aria-expanded="{% if forloop.first %}true{% else %}false{% endif %}"
                            aria-controls="collapse-{{ forloop.counter }}">
                        {{ line }}
                    </button>
                </h2>
                <div id="collapse-{{ forloop.counter }}"
                     class="accordion-collapse collapse {% if forloop.first %}show{% endif %}"
                     aria-labelledby="heading-{{ forloop.counter }}"
                     data-bs-parent="#linesAccordion">
                    <div class="accordion-body">
                        <div class="table-responsive">
                            <table class="table table-striped table-bordered align-middle">
                                <thead class="table-dark">
                                    <tr>
                                        <th>Operation</th>
                                        <th>Machine #</th>
                                        <th>Heat Break</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for machine in machines %}
                                        {# Carry the active state as data attributes on the row #}
                                        <tr
                                            id="row-{{ machine.id }}"
                                            data-machine="{{ machine.id }}"
                                            {% if machine.active_hb %}
                                                data-active-hb-id="{{ machine.active_hb.id }}"
                                                data-active-duration="{{ machine.active_hb.duration }}"
                                                data-start-time-iso="{{ machine.active_hb.start_time_iso }}"
                                            {% endif %}
                                            >

                                            <td>{{ machine.operation }}</td>
                                            <td>{{ machine.machine_number }}</td>
                                            <td>
                                                <div class="d-flex flex-wrap align-items-center gap-3">
                                                    {# "No heat break" default radio #}
                                                    <div class="form-check form-check-inline">
                                                        <input class="form-check-input toggle-radio"
                                                               type="radio"
                                                               name="toggle-{{ machine.id }}"
                                                               id="toggle-{{ machine.id }}-none"
                                                               value="none"
                                                               data-machine="{{ machine.id }}">
                                                        <label class="form-check-label"
                                                               for="toggle-{{ machine.id }}-none">No heat break</label>
                                                    </div>

                                                    {# Existing duration radios #}
                                                    {% for mins in durations %}
                                                        <div class="form-check form-check-inline">
                                                            <input class="form-check-input toggle-radio"
                                                                   type="radio"
                                                                   name="toggle-{{ machine.id }}"
                                                                   id="toggle-{{ machine.id }}-{{ mins }}"
                                                                   value="{{ mins }}"
                                                                   data-machine="{{ machine.id }}">
                                                            <label class="form-check-label"
                                                                   for="toggle-{{ machine.id }}-{{ mins }}">{{ mins }} min</label>
                                                        </div>
                                                    {% endfor %}
                                                </div>
                                            </td>
                                        </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        {% empty %}
            <p>No tracked machines found.</p>
        {% endfor %}
    </div>
</div>

<!-- Modal -->
<div class="modal fade" id="offModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <form id="offForm" method="post">
      {% csrf_token %}
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Confirm Heat Break End</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <p>The heat break was between:</p>
          <div class="mb-3">
            <label class="form-label">Start Time</label>
            <input type="datetime-local" class="form-control" name="start_time" id="offStart" readonly>
          </div>
          <div class="mb-3">
            <label class="form-label">End Time</label>
            <input type="datetime-local" class="form-control" name="end_time" id="offEnd">
            <div id="offEndFeedback" class="invalid-feedback">
                End time cannot be before the start time.
            </div>
            </div>
          <input type="hidden" name="heatbreak_id" id="heatbreakId">
          <input type="hidden" id="offMachineId">
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-dark" data-bs-dismiss="modal">Close</button>
          <button type="submit" class="btn btn-warning">Confirm</button>
        </div>
      </div>
    </form>
  </div>
</div>

<script>
document.addEventListener("DOMContentLoaded", function () {
    // ---------- helpers ----------
    const ACTIVE = new Map(); // machineId -> { hbId, startIso, duration }

    function pad2(n) { return String(n).padStart(2, "0"); }

    // Format a Date into YYYY-MM-DDTHH:MM for <input type="datetime-local">
    function formatForDatetimeLocal(d) {
        return [
            d.getFullYear(), "-", pad2(d.getMonth() + 1), "-", pad2(d.getDate()),
            "T", pad2(d.getHours()), ":", pad2(d.getMinutes())
        ].join("");
    }

    // Convert an ISO string (which may include timezone) into local datetime-local string
    function isoToLocalInput(iso) {
        try {
            const d = new Date(iso);
            if (isNaN(d.getTime())) return "";
            return formatForDatetimeLocal(d);
        } catch {
            return "";
        }
    }

    // Parse a datetime-local string as LOCAL time safely (no timezone)
    function parseLocalInput(str) {
        // Expect "YYYY-MM-DDTHH:MM"
        if (!str || !str.includes("T")) return null;
        const [datePart, timePart] = str.split("T");
        const [y, m, d] = datePart.split("-").map(Number);
        const [hh, mm] = timePart.split(":").map(Number);
        // Month is 0-based in Date()
        const dt = new Date(y, (m || 1) - 1, d || 1, hh || 0, mm || 0, 0, 0);
        return isNaN(dt.getTime()) ? null : dt;
    }

    function selectRadio(machineId, value) {
        const target = document.getElementById(`toggle-${machineId}-${value}`);
        if (target) target.checked = true;
    }

    function selectNone(machineId) {
        selectRadio(machineId, "none");
    }

    function setEndInvalid(isInvalid) {
        const endInput = document.getElementById("offEnd");
        if (!endInput) return;
        if (isInvalid) {
            endInput.classList.add("is-invalid");
        } else {
            endInput.classList.remove("is-invalid");
        }
    }

    // ---------- initialize UI from server-emitted data-* ----------
    document.querySelectorAll("tr[id^='row-']").forEach(function (row) {
        const machineId = row.dataset.machine;
        const hbId      = row.dataset.activeHbId || null;
        const duration  = row.dataset.activeDuration || null;
        const startIso  = row.dataset.startTimeIso || null;

        if (hbId && duration) {
            ACTIVE.set(machineId, { hbId: hbId, startIso: startIso, duration: duration });
            selectRadio(machineId, duration);
        } else {
            selectNone(machineId);
        }
    });

    // ---------- radio change handling (No heat break + durations) ----------
    document.querySelectorAll(".toggle-radio").forEach(function (radio) {
        radio.addEventListener("change", function () {
            const machineId = this.dataset.machine;
            const val = this.value;

            if (val === "none") {
                // User wants to turn OFF (end) an active heat break
                const active = ACTIVE.get(machineId);
                if (!active) {
                    // No active HB; nothing to end
                    return;
                }

                // Prefill modal values
                const offStart = document.getElementById("offStart");
                const offEnd   = document.getElementById("offEnd");
                document.getElementById("heatbreakId").value = active.hbId;
                document.getElementById("offMachineId").value = machineId;

                // Start time displayed in LOCAL time (read-only)
                const startLocalStr = active.startIso ? isoToLocalInput(active.startIso) : "";
                offStart.value = startLocalStr;

                // End time defaults to "now" in LOCAL time
                const nowLocalStr = formatForDatetimeLocal(new Date());
                offEnd.value = nowLocalStr;

                // Validation setup: enforce min = startLocalStr
                offEnd.min = startLocalStr || "";

                // Clear invalid state on open
                setEndInvalid(false);

                // Attach live validation
                offEnd.oninput = function () {
                    const start = parseLocalInput(offStart.value);
                    const end   = parseLocalInput(offEnd.value);
                    const invalid = !!(start && end && end < start);
                    setEndInvalid(invalid);
                };
                offEnd.dispatchEvent(new Event("input"));

                new bootstrap.Modal(document.getElementById("offModal")).show();
                return;
            }

            // Turning ON with a chosen duration
            fetch(`/plant/heat/${machineId}/on/`, {
                method: "POST",
                headers: {"X-CSRFToken": "{{ csrf_token }}"},
                body: new URLSearchParams({ duration: val })
            })
            .then(r => r.json())
            .then(data => {
                if (data.status === "ok") {
                    ACTIVE.set(machineId, {
                        hbId: String(data.heatbreak_id),
                        startIso: data.start_time_iso, // keep ISO (UTC offset aware)
                        duration: String(val)
                    });
                    selectRadio(machineId, val);
                } else {
                    selectNone(machineId);
                }
            })
            .catch(() => {
                selectNone(machineId);
            });
        });
    });

    // ---------- modal submit -> validate, call /off/, clear state, set "No heat break" ----------
    document.getElementById("offForm").addEventListener("submit", function (e) {
        e.preventDefault();

        const hbId = document.getElementById("heatbreakId").value;
        const machineId = document.getElementById("offMachineId").value;
        const startTimeStr = document.getElementById("offStart").value; // local
        const endTimeStr   = document.getElementById("offEnd").value;   // local

        const start = parseLocalInput(startTimeStr);
        const end   = parseLocalInput(endTimeStr);

        // Block submit if end < start
        if (start && end && end < start) {
            setEndInvalid(true);
            document.getElementById("offEnd").focus();
            return; // do not POST
        }
        setEndInvalid(false);

        fetch(`/plant/heat/${hbId}/off/`, {
            method: "POST",
            headers: {"X-CSRFToken": "{{ csrf_token }}"},
            body: new URLSearchParams({ end_time: endTimeStr })
        })
        .then(r => r.json())
        .then(data => {
            if (data.status === "ok") {
                const modalEl = document.getElementById("offModal");
                const modal = bootstrap.Modal.getInstance(modalEl);
                if (modal) modal.hide();

                ACTIVE.delete(machineId);
                selectNone(machineId);
            }
        });
    });
});
</script>


{% endblock %}
