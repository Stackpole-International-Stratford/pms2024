{# templates/plant/heat_toggle.html #}
{% extends "parent.html" %}
{% block content %}
<div class="container mt-4">
    <h1 class="mb-4">Heat Toggle</h1>

    <div class="accordion" id="linesAccordion">
        {% for line, machines in grouped_data.items %}
            <div class="accordion-item">
                <h2 class="accordion-header" id="heading-{{ forloop.counter }}">
                    <button class="accordion-button {% if not forloop.first %}collapsed{% endif %}"
                            type="button"
                            data-bs-toggle="collapse"
                            data-bs-target="#collapse-{{ forloop.counter }}"
                            aria-expanded="{% if forloop.first %}true{% else %}false{% endif %}"
                            aria-controls="collapse-{{ forloop.counter }}">
                        {{ line }}
                    </button>
                </h2>
                <div id="collapse-{{ forloop.counter }}"
                     class="accordion-collapse collapse {% if forloop.first %}show{% endif %}"
                     aria-labelledby="heading-{{ forloop.counter }}"
                     data-bs-parent="#linesAccordion">
                    <div class="accordion-body">
                        <div class="table-responsive">
                            <table class="table table-striped table-bordered align-middle">
                                <thead class="table-dark">
                                    <tr>
                                        <th>Operation</th>
                                        <th>Machine #</th>
                                        <th>Heat Break</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for machine in machines %}
                                        {# Carry the active state as data attributes on the row #}
                                        <tr
                                            id="row-{{ machine.id }}"
                                            data-machine="{{ machine.id }}"
                                            {% if machine.active_hb %}
                                                data-active-hb-id="{{ machine.active_hb.id }}"
                                                data-active-duration="{{ machine.active_hb.duration }}"
                                                data-start-time-iso="{{ machine.active_hb.start_time_iso }}"
                                            {% endif %}
                                            >

                                            <td>{{ machine.operation }}</td>
                                            <td>{{ machine.machine_number }}</td>
                                            <td>
                                                <div class="d-flex flex-wrap align-items-center gap-3">
                                                    {# "No heat break" default radio #}
                                                    <div class="form-check form-check-inline">
                                                        <input class="form-check-input toggle-radio"
                                                               type="radio"
                                                               name="toggle-{{ machine.id }}"
                                                               id="toggle-{{ machine.id }}-none"
                                                               value="none"
                                                               data-machine="{{ machine.id }}">
                                                        <label class="form-check-label"
                                                               for="toggle-{{ machine.id }}-none">No heat break</label>
                                                    </div>

                                                    {# Existing duration radios #}
                                                    {% for mins in durations %}
                                                        <div class="form-check form-check-inline">
                                                            <input class="form-check-input toggle-radio"
                                                                   type="radio"
                                                                   name="toggle-{{ machine.id }}"
                                                                   id="toggle-{{ machine.id }}-{{ mins }}"
                                                                   value="{{ mins }}"
                                                                   data-machine="{{ machine.id }}">
                                                            <label class="form-check-label"
                                                                   for="toggle-{{ machine.id }}-{{ mins }}">{{ mins }} min</label>
                                                        </div>
                                                    {% endfor %}
                                                </div>
                                            </td>
                                        </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        {% empty %}
            <p>No tracked machines found.</p>
        {% endfor %}
    </div>
</div>

<!-- Modal -->
<div class="modal fade" id="offModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <form id="offForm" method="post">
      {% csrf_token %}
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Confirm Heat Break End</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <p>The heat break was between:</p>
          <div class="mb-3">
            <label class="form-label">Start Time</label>
            <input type="datetime-local" class="form-control" name="start_time" id="offStart" readonly>
          </div>
          <div class="mb-3">
            <label class="form-label">End Time</label>
            <input type="datetime-local" class="form-control" name="end_time" id="offEnd">
          </div>
          <input type="hidden" name="heatbreak_id" id="heatbreakId">
          <input type="hidden" id="offMachineId">
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
          <button type="submit" class="btn btn-primary">Confirm</button>
        </div>
      </div>
    </form>
  </div>
</div>

<script>
document.addEventListener("DOMContentLoaded", function () {
    const ACTIVE = new Map(); // machineId -> {hbId, startIso, duration}

    // Initialize radios to reflect server state
    document.querySelectorAll("tr[id^='row-']").forEach(function (row) {
        const machineId = row.dataset.machine;
        const hbId = row.dataset.activeHbId || null;
        const duration = row.dataset.activeDuration || null;
        const startIso = row.dataset.startTimeIso || null;

        if (hbId && duration) {
            ACTIVE.set(machineId, { hbId: hbId, startIso: startIso, duration: duration });
            const radio = document.getElementById(`toggle-${machineId}-${duration}`);
            if (radio) radio.checked = true;
        } else {
            const radioNone = document.getElementById(`toggle-${machineId}-none`);
            if (radioNone) radioNone.checked = true;
        }
    });

    // One handler for all radios
    document.querySelectorAll(".toggle-radio").forEach(function (radio) {
        radio.addEventListener("change", function () {
            const machineId = this.dataset.machine;
            const val = this.value;

            if (val === "none") {
                // Turning OFF if an active HB exists
                const active = ACTIVE.get(machineId);
                if (!active) {
                    // Nothing to turn off; just ensure "No heat break" stays selected
                    return;
                }

                // Prefill modal
                document.getElementById("heatbreakId").value = active.hbId;
                document.getElementById("offMachineId").value = machineId;

                // Start time: use the known start if available; fall back empty
                if (active.startIso) {
                    // match <input type="datetime-local"> format (YYYY-MM-DDTHH:MM)
                    document.getElementById("offStart").value = active.startIso.slice(0,16);
                } else {
                    document.getElementById("offStart").value = "";
                }
                // End time defaults to "now"
                document.getElementById("offEnd").value = new Date().toISOString().slice(0,16);

                const modal = new bootstrap.Modal(document.getElementById("offModal"));
                modal.show();
            } else {
                // Turning ON with a specific duration
                fetch(`/plant/heat/${machineId}/on/`, {
                    method: "POST",
                    headers: {"X-CSRFToken": "{{ csrf_token }}"},
                    body: new URLSearchParams({duration: val})
                })
                .then(r => r.json())
                .then(data => {
                    if (data.status === "ok") {
                        ACTIVE.set(machineId, {
                            hbId: String(data.heatbreak_id),
                            startIso: data.start_time_iso,
                            duration: String(val)
                        });
                        // Ensure the chosen radio stays selected (idempotent)
                        const radio = document.getElementById(`toggle-${machineId}-${val}`);
                        if (radio) radio.checked = true;
                    } else {
                        // revert to "No heat break" on error
                        const radioNone = document.getElementById(`toggle-${machineId}-none`);
                        if (radioNone) radioNone.checked = true;
                    }
                })
                .catch(() => {
                    const radioNone = document.getElementById(`toggle-${machineId}-none`);
                    if (radioNone) radioNone.checked = true;
                });
            }
        });
    });

    // Submit OFF modal -> call /off/, then clear local state and flip radio to None
    document.getElementById("offForm").addEventListener("submit", function (e) {
        e.preventDefault();
        const hbId = document.getElementById("heatbreakId").value;
        const machineId = document.getElementById("offMachineId").value;
        const endTime = document.getElementById("offEnd").value;

        fetch(`/plant/heat/${hbId}/off/`, {
            method: "POST",
            headers: {"X-CSRFToken": "{{ csrf_token }}"},
            body: new URLSearchParams({end_time: endTime})
        })
        .then(r => r.json())
        .then(data => {
            if (data.status === "ok") {
                // Close modal
                bootstrap.Modal.getInstance(document.getElementById("offModal")).hide();
                // Clear active state and select "No heat break"
                ACTIVE.delete(machineId);
                const radioNone = document.getElementById(`toggle-${machineId}-none`);
                if (radioNone) radioNone.checked = true;
            }
        });
    });
});
</script>
{% endblock %}
