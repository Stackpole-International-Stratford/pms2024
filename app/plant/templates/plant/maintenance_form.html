{% extends "parent.html" %}

{% block content %}
  {# ───── Form Container ─────────────────────────────────────────────── #}
  <div class="container-fluid d-flex justify-content-center py-5">
    <form id="maintenance-form" method="POST">
      {% csrf_token %}
      <div class="card shadow-sm">
        <div class="card-body">
          <h5 class="card-title mb-4 text-center">Downtime Entry</h5>

          <!-- form fields… -->
          <div class="d-flex flex-nowrap align-items-start gap-3">
            <!-- Line -->
            <div class="flex-fill">
              <label for="line-select" class="form-label">Line</label>
              <select id="line-select" name="line" class="form-select">
                <option value="">Select Line</option>
              </select>
            </div>
            <!-- Machine -->
            <div class="flex-fill">
              <label for="machine-select" class="form-label">Machine</label>
              <select id="machine-select" name="machine" class="form-select" disabled>
                <option value="">Select Machine</option>
              </select>
            </div>
            <!-- Category -->
            <div id="category-container" class="flex-fill" style="display: none;">
              <label for="category-select" class="form-label">Category</label>
              <select id="category-select" name="category" class="form-select" disabled>
                <option value="">Select Category</option>
              </select>
            </div>
            <!-- Subcategory -->
            <div id="subcategory-container" class="flex-fill" style="display: none;">
              <label for="subcategory-select" class="form-label">Subcategory</label>
              <select id="subcategory-select" name="subcategory" class="form-select" disabled>
                <option value="">Select Subcategory</option>
              </select>
            </div>
          </div>

          <div class="mt-3" id="description-container" style="display: none;">
            <div class="row g-2">
              <div class="col">
                <label for="start-date" class="form-label">Start Date</label>
                <input type="date" id="start-date" name="start_date" class="form-control" required>
              </div>
              <div class="col">
                <label for="start-time" class="form-label">Start Time</label>
                <input type="time" id="start-time" name="start_time" class="form-control" required>
              </div>
            </div>
            <div class="mt-3">
              <label for="description" class="form-label">Comment:</label>
              <textarea id="description"
                        name="description"
                        class="form-control"
                        rows="2"
                        maxlength="5000"
                        required></textarea>
            </div>
          </div>

          <div class="mt-3 text-end" id="submit-container" style="display: none;">
            <button type="submit" class="btn btn-dark">Submit</button>
          </div>
        </div>
      </div>
    </form>
  </div>

  {# ───── Entries Container ──────────────────────────────────────────── #}
  {% if entries %}
    <div class="container-fluid py-5">
      <div class="d-flex justify-content-center">
        <div style="width:100%; max-width:900px;">
          <h5 class="mb-3">Recent Downtime Entries</h5>
          <table id="recent-entries" class="table table-sm table-striped">
            <thead>
              <tr>
                <th>When (epoch)</th>
                <th>Line</th>
                <th>Machine</th>
                <th>Category</th>
                <th>Sub-category</th>
                <th>Code</th>
                <th>Comment</th>
              </tr>
            </thead>
            <tbody>
              {% for e in entries %}
                <tr>
                  <td>{{ e.start_epoch }}</td>
                  <td>{{ e.line }}</td>
                  <td>{{ e.machine }}</td>
                  <td>{{ e.category }}</td>
                  <td>{{ e.subcategory }}</td>
                  <td>{{ e.code }}</td>
                  <td>{{ e.comment|truncatechars:50 }}</td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
          {% if has_more %}
            <div class="text-center">
              <button id="load-more" class="btn btn-outline-primary">Load more</button>
            </div>
          {% endif %}
        </div>
      </div>
    </div>
  {% endif %}

  {# ───── AJAX Loader Script ────────────────────────────────────────── #}
  <script>
    (() => {
      let offset = {{ entries|length }};
      const loadBtn = document.getElementById('load-more');
      const tbody   = document.querySelector('#recent-entries tbody');
      const url     = "{% url 'maintenance_entries' %}";

      if (loadBtn) {
        loadBtn.addEventListener('click', () => {
          fetch(`${url}?offset=${offset}`)
            .then(r => r.json())
            .then(data => {
              data.entries.forEach(e => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                  <td>${e.start_epoch}</td>
                  <td>${e.line}</td>
                  <td>${e.machine}</td>
                  <td>${e.category}</td>
                  <td>${e.subcategory}</td>
                  <td>${e.code}</td>
                  <td>${e.comment.substring(0,50)}${e.comment.length>50?'…':''}</td>
                `;
                tbody.appendChild(tr);
              });
              offset += data.entries.length;
              if (!data.has_more) loadBtn.style.display = 'none';
            })
            .catch(console.error);
        });
      }
    })();
  </script>

  {# ───── Choices.js & Form Script ─────────────────────────────────── #}
  <script>
    // Data from view
    const prodLines     = JSON.parse('{{ lines_json|escapejs }}');
    const downtimeCodes = JSON.parse('{{ downtime_codes_json|escapejs }}');

    // Element refs
    const lineSelect        = document.getElementById('line-select');
    const machineSelect     = document.getElementById('machine-select');
    const categorySelect    = document.getElementById('category-select');
    const subcategorySelect = document.getElementById('subcategory-select');

    const startDateInput    = document.getElementById('start-date');
    const startTimeInput    = document.getElementById('start-time');

    const categoryContainer    = document.getElementById('category-container');
    const subcategoryContainer = document.getElementById('subcategory-container');
    const descCtr              = document.getElementById('description-container');
    const submitCtr            = document.getElementById('submit-container');

    // Initialize Choices.js
    const lineChoice        = new Choices(lineSelect,        { searchEnabled: false, itemSelectText: '' });
    const machineChoice     = new Choices(machineSelect,     { searchEnabled: false, itemSelectText: '', shouldSort: false });
    const categoryChoice    = new Choices(categorySelect,    { searchEnabled: false, itemSelectText: '' });
    const subcategoryChoice = new Choices(subcategorySelect, { searchEnabled: false, itemSelectText: '' });

    function hide(...els) { els.forEach(el => el.style.display = 'none'); }
    function show(...els) { els.forEach(el => el.style.display = 'block'); }

    function setDefaultDateTime() {
      const now = new Date();
      startDateInput.value = now.toISOString().slice(0,10);
      startTimeInput.value = now.toTimeString().slice(0,5);
    }

    hide(categoryContainer, subcategoryContainer, descCtr, submitCtr);
    machineChoice.disable();
    categoryChoice.disable();
    subcategoryChoice.disable();

    // Populate Line → Machine
    lineChoice.setChoices(
      prodLines.map(l => ({ value: l.line, label: l.line })),
      'value','label',true
    );
    lineSelect.addEventListener('change', () => {
      const line = lineSelect.value;
      machineChoice.clearChoices().disable();
      categoryChoice.clearChoices().disable();
      subcategoryChoice.clearChoices().disable();
      hide(categoryContainer, subcategoryContainer, descCtr, submitCtr);
      if (!line) return;
      const lineObj = prodLines.find(l => l.line === line);
      const groups  = lineObj.operations.map(op => ({
        label: `Op ${op.op}`,
        choices: op.machines.map(m => ({ value: m.number, label: `${m.number}` }))
      }));
      machineChoice.setChoices(groups,'value','label',true);
      machineChoice.enable().showDropdown();
      show(machineSelect.parentElement);
    });

    // Machine → Category
    machineSelect.addEventListener('change', () => {
      const machine = machineSelect.value;
      categoryChoice.clearChoices().disable();
      subcategoryChoice.clearChoices().disable();
      hide(subcategoryContainer, descCtr, submitCtr);
      if (!machine) return;
      const cats = downtimeCodes.map(c => ({ value: c.code, label: c.name }));
      categoryChoice.setChoices(cats,'value','label',true);
      categoryChoice.enable().showDropdown();
      show(categoryContainer);
    });

    // Category → Subcategory
    categorySelect.addEventListener('change', () => {
      const cat = categorySelect.value;
      subcategoryChoice.clearChoices().disable();
      hide(descCtr, submitCtr);
      if (!cat) return;
      const subcats = downtimeCodes
        .find(c => c.code === cat).subcategories
        .map(s => ({ value: s.code, label: s.name }));
      subcategoryChoice.setChoices(subcats,'value','label',true);
      subcategoryChoice.enable().showDropdown();
      show(subcategoryContainer);
    });

    // Subcategory → Show Date/Time + Comment
    subcategorySelect.addEventListener('change', () => {
      if (subcategorySelect.value) {
        setDefaultDateTime();
        show(descCtr, submitCtr);
        document.getElementById('description').focus();
      } else {
        hide(descCtr, submitCtr);
      }
    });
  </script>
{% endblock %}
