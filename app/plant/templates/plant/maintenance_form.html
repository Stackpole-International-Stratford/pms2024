{% extends "parent.html" %}

{% block content %}
<div class="container-fluid d-flex justify-content-center py-5">
  <form id="maintenance-form" method="POST">
    {% csrf_token %}
    <div class="card shadow-sm">
      <div class="card-body">
        <h5 class="card-title mb-4 text-center">Downtime Entry</h5>

        <!-- HORIZONTAL, NO-WRAP selects that flexibly fill available space -->
        <div class="d-flex flex-nowrap align-items-start gap-3">
          <!-- Line -->
          <div class="flex-fill">
            <label for="line-select" class="form-label">Line</label>
            <select id="line-select" name="line" class="form-select">
              <option value="">Select Line</option>
            </select>
          </div>

          <!-- Machine -->
          <div class="flex-fill">
            <label for="machine-select" class="form-label">Machine</label>
            <select id="machine-select" name="machine" class="form-select" disabled>
              <option value="">Select Machine</option>
            </select>
          </div>

          <!-- Category -->
          <div id="category-container" class="flex-fill" style="display: none;">
            <label for="category-select" class="form-label">Category</label>
            <select id="category-select" name="category" class="form-select" disabled>
              <option value="">Select Category</option>
            </select>
          </div>

          <!-- Subcategory -->
          <div id="subcategory-container" class="flex-fill" style="display: none;">
            <label for="subcategory-select" class="form-label">Subcategory</label>
            <select id="subcategory-select" name="subcategory" class="form-select" disabled>
              <option value="">Select Subcategory</option>
            </select>
          </div>
        </div>

        <!-- Comment -->
        <div class="mt-3" id="description-container" style="display: none;">
          <label for="description" class="form-label">Comment:</label>
          <textarea id="description" name="description"
                    class="form-control" rows="2" maxlength="5000" required></textarea>
        </div>

        <!-- Start Date & Time (side by side) -->
        <div id="datetime-container" class="mt-3 d-flex flex-nowrap align-items-end gap-3" style="display: none;">
          <div class="d-flex flex-column">
            <label for="start-date" class="form-label">Start Date:</label>
            <input type="date" id="start-date" name="start_date" class="form-control" required>
          </div>
          <div class="d-flex flex-column">
            <label for="start-time" class="form-label">Start Time:</label>
            <input type="time" id="start-time" name="start_time" class="form-control" required>
          </div>
        </div>


        <!-- Submit -->
        <div class="mt-3 text-end" id="submit-container" style="display: none;">
          <button type="submit" class="btn btn-dark">Submit</button>
        </div>

      </div>
    </div>
  </form>
</div>

<style>
  .form-label {
    margin-bottom: .25rem;
  }
  /* override Bootstrap’s full‐width selects so they size to their content */
  #maintenance-form .form-select {
    width: auto !important;
    min-width: 150px;
  }
  /* ensure the card itself shrinks or grows with its content */
  #maintenance-form .card {
    display: inline-block;
    width: auto;
  }
</style>

<script>
  (function(){
    // this runs immediately if DOM is ready, or on DOMContentLoaded if not yet
    function initDowntimeForm(){
      // Data from view
      const prodLines     = JSON.parse('{{ lines_json|escapejs }}');
      const downtimeCodes = JSON.parse('{{ downtime_codes_json|escapejs }}');
  
      // Element refs
      const lineSelect        = document.getElementById('line-select');
      const machineSelect     = document.getElementById('machine-select');
      const categorySelect    = document.getElementById('category-select');
      const subcategorySelect = document.getElementById('subcategory-select');
  
      const categoryContainer    = document.getElementById('category-container');
      const subcategoryContainer = document.getElementById('subcategory-container');
      const descCtr              = document.getElementById('description-container');
      const datetimeCtr          = document.getElementById('datetime-container');
      const submitCtr            = document.getElementById('submit-container');
  
      const dateInput        = document.getElementById('start-date');
      const timeInput        = document.getElementById('start-time');
      const descriptionField = document.getElementById('description');
  
      // Initialize Choices.js
      const lineChoice        = new Choices(lineSelect,        { searchEnabled: false, itemSelectText: '' });
      const machineChoice     = new Choices(machineSelect,     { searchEnabled: false, itemSelectText: '', shouldSort: false });
      const categoryChoice    = new Choices(categorySelect,    { searchEnabled: false, itemSelectText: '' });
      const subcategoryChoice = new Choices(subcategorySelect, { searchEnabled: false, itemSelectText: '' });
  
      // simple show/hide
      function hide(...els){ els.forEach(e=>e.style.display='none'); }
      function show(...els){ els.forEach(e=>e.style.display='block'); }
  
      // **1)** initial hide
      hide(categoryContainer, subcategoryContainer, descCtr, datetimeCtr, submitCtr);
      machineChoice.disable();
      categoryChoice.disable();
      subcategoryChoice.disable();
  
      // **2)** Populate Line
      lineChoice.setChoices(
        prodLines.map(l => ({ value: l.line, label: l.line })),
        'value','label',true
      );
  
      // **3)** Line → Machine
      lineSelect.addEventListener('change', () => {
        const line = lineSelect.value;
        machineChoice.clearChoices().disable();
        categoryChoice.clearChoices().disable();
        subcategoryChoice.clearChoices().disable();
        hide(categoryContainer, subcategoryContainer, descCtr, datetimeCtr, submitCtr);
        if (!line) return;
  
        const ops = prodLines.find(l=>l.line===line).operations;
        const groups = ops.map(op => ({
          label: `Op ${op.op}`,
          choices: op.machines.map(m=>({value:m.number,label:m.number}))
        }));
        machineChoice.setChoices(groups,'value','label',true)
                     .enable().showDropdown();
      });
  
      // **4)** Machine → Category
      machineSelect.addEventListener('change', () => {
        const m = machineSelect.value;
        categoryChoice.clearChoices().disable();
        subcategoryChoice.clearChoices().disable();
        hide(subcategoryContainer, descCtr, datetimeCtr, submitCtr);
        if (!m) return;
  
        categoryChoice
          .setChoices(downtimeCodes.map(c=>({value:c.code,label:c.name})),'value','label',true)
          .enable().showDropdown();
        show(categoryContainer);
      });
  
      // **5)** Category → Subcategory
      categorySelect.addEventListener('change', () => {
        const c = categorySelect.value;
        subcategoryChoice.clearChoices().disable();
        hide(descCtr, datetimeCtr, submitCtr);
        if (!c) return;
  
        const subs = downtimeCodes.find(x=>x.code===c).subcategories
                        .map(sc=>({value:sc.code,label:sc.name}));
        subcategoryChoice.setChoices(subs,'value','label',true)
                         .enable().showDropdown();
        show(subcategoryContainer);
      });
  
      // **6)** Subcategory → only show comment box
      subcategorySelect.addEventListener('change', () => {
        if (!subcategorySelect.value) {
          hide(descCtr, datetimeCtr, submitCtr);
          return;
        }
        const now = new Date();
        dateInput.value = now.toISOString().slice(0,10);
        timeInput.value = now.toTimeString().slice(0,5);
  
        show(descCtr);
        hide(datetimeCtr, submitCtr);
        descriptionField.focus();
      });
  
      // **7)** On typing comment → show date/time & submit
      descriptionField.addEventListener('input', () => {
        if (descriptionField.value.trim()) {
          show(datetimeCtr, submitCtr);
        } else {
          hide(datetimeCtr, submitCtr);
        }
      });
    }
  
    if (document.readyState === 'loading'){
      document.addEventListener('DOMContentLoaded', initDowntimeForm);
    } else {
      initDowntimeForm();
    }
  })();
  </script>
  
  

{% endblock %}
