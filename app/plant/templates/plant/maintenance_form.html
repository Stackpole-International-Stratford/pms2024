{% extends "parent.html" %}

{% block content %}
<div class="container py-5">
  <form id="downtime-form" method="POST">
    {% csrf_token %}

    <div class="card shadow-sm">
      <div class="card-body">
        <div class="row g-3 align-items-end">
          <div class="col">
            <label for="line-select" class="form-label">Line</label>
            <select id="line-select" class="form-select">
              <option value="">Select Line</option>
            </select>
          </div>
          <div class="col">
            <label for="machine-select" class="form-label">Machine</label>
            <select id="machine-select" class="form-select" disabled>
              <option value="">Select Machine</option>
            </select>
          </div>
          <div class="col">
            <label for="category-select" class="form-label">Category</label>
            <select id="category-select" class="form-select" disabled>
              <option value="">Select Category</option>
            </select>
          </div>
          <div class="col">
            <label for="subcategory-select" class="form-label">Subcategory</label>
            <select id="subcategory-select" class="form-select" disabled>
              <option value="">Select Subcategory</option>
            </select>
          </div>
        </div>
      </div>
    </div>

    <div id="description-container" class="mt-4" style="display: none;">
      <label for="description" class="form-label">Comment:</label>
      <textarea class="form-control" name="description" id="description" rows="2" maxlength="5000" required></textarea>
    </div>

    <div class="mt-3" id="submit-container" style="display: none;">
      <input type="hidden" name="machine" id="machine-hidden">
      <input type="hidden" name="category" id="category-hidden">
      <input type="hidden" name="subcategory" id="subcategory-hidden">
      <button type="submit" class="btn btn-dark">Submit</button>
    </div>
  </form>
</div>


<script>
const downtimeCodes = JSON.parse('{{ downtime_codes_json|escapejs }}');
const prodLines = JSON.parse('{{ lines_json|escapejs }}');

const lineSelect = document.getElementById('line-select');
const machineSelect = document.getElementById('machine-select');
const categorySelect = document.getElementById('category-select');
const subcategorySelect = document.getElementById('subcategory-select');
const descriptionContainer = document.getElementById('description-container');
const submitContainer = document.getElementById('submit-container');

const machineHidden = document.getElementById('machine-hidden');
const categoryHidden = document.getElementById('category-hidden');
const subcategoryHidden = document.getElementById('subcategory-hidden');

// Populate Line dropdown
prodLines.forEach(line => {
  const option = document.createElement('option');
  option.value = line.line;
  option.textContent = line.line;
  lineSelect.appendChild(option);
});

lineSelect.addEventListener('change', () => {
  const selectedLine = lineSelect.value;
  machineSelect.innerHTML = '<option value="">Select Machine</option>';
  machineSelect.disabled = true;
  categorySelect.disabled = true;
  subcategorySelect.disabled = true;
  descriptionContainer.style.display = 'none';
  submitContainer.style.display = 'none';

  if (!selectedLine) return;

  const lineObj = prodLines.find(l => l.line === selectedLine);
  const machines = [];
  lineObj.operations.forEach(op => {
    op.machines.forEach(m => {
      machines.push({ number: m.number, op: op.op });
    });
  });

  machines.forEach(machine => {
    const option = document.createElement('option');
    option.value = machine.number;
    option.textContent = `${machine.number} (Op ${machine.op})`;
    machineSelect.appendChild(option);
  });

  machineSelect.disabled = false;
});

machineSelect.addEventListener('change', () => {
  const selectedMachine = machineSelect.value;
  categorySelect.innerHTML = '<option value="">Select Category</option>';
  subcategorySelect.innerHTML = '<option value="">Select Subcategory</option>';
  categorySelect.disabled = true;
  subcategorySelect.disabled = true;
  descriptionContainer.style.display = 'none';
  submitContainer.style.display = 'none';

  if (!selectedMachine) return;

  machineHidden.value = selectedMachine;

  downtimeCodes.forEach(cat => {
    const option = document.createElement('option');
    option.value = cat.code;
    option.textContent = cat.name;
    categorySelect.appendChild(option);
  });

  categorySelect.disabled = false;
});

categorySelect.addEventListener('change', () => {
  const selectedCategory = categorySelect.value;
  subcategorySelect.innerHTML = '<option value="">Select Subcategory</option>';
  subcategorySelect.disabled = true;
  descriptionContainer.style.display = 'none';
  submitContainer.style.display = 'none';

  if (!selectedCategory) return;

  categoryHidden.value = selectedCategory;

  const category = downtimeCodes.find(c => c.code === selectedCategory);
  category.subcategories.forEach(sc => {
    const option = document.createElement('option');
    option.value = sc.code;
    option.textContent = sc.name;
    subcategorySelect.appendChild(option);
  });

  subcategorySelect.disabled = false;
});

subcategorySelect.addEventListener('change', () => {
  const selectedSubcategory = subcategorySelect.value;

  if (!selectedSubcategory) {
    descriptionContainer.style.display = 'none';
    submitContainer.style.display = 'none';
    return;
  }

  subcategoryHidden.value = selectedSubcategory;
  descriptionContainer.style.display = 'block';
  submitContainer.style.display = 'block';
});
</script>
{% endblock %}
