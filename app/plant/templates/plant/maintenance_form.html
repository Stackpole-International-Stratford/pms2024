{% extends "parent.html" %}

{% block content %}
<div class="container py-5">
  <form id="downtime-form" method="POST">
    {% csrf_token %}

    <div class="card shadow-sm">
      <div class="card-body">
        <h5 class="card-title mb-4 text-center">Downtime Entry</h5>
        <div class="row g-3 align-items-end">
          <!-- Line selector -->
          <div class="col">
            <label for="line-select" class="form-label">Line</label>
            <select id="line-select" name="line" class="form-select">
              <option value="">Select Line</option>
            </select>
          </div>

          <!-- Machine selector -->
          <div class="col">
            <label for="machine-select" class="form-label">Machine</label>
            <select id="machine-select" name="machine" class="form-select" disabled>
              <option value="">Select Machine</option>
            </select>
          </div>

          <!-- Nested Category → Subcategory dropdown -->
          <div class="col">
            <label for="category-btn" class="form-label">Category &amp; Subcategory</label>
            <div class="dropdown">
              <button id="category-btn"
                      class="btn btn-outline-secondary dropdown-toggle w-100 text-start"
                      type="button"
                      data-bs-toggle="dropdown"
                      aria-expanded="false">
                Select Category
              </button>
              <ul id="category-menu" class="dropdown-menu w-100">
                <!-- JS will populate categories and nested subcategories here -->
              </ul>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Comment textarea, shown once a subcategory is picked -->
    <div id="description-container" class="mt-4" style="display: none;">
      <label for="description" class="form-label">Comment:</label>
      <textarea class="form-control" name="description" id="description" rows="2" maxlength="5000" required></textarea>
    </div>

    <!-- Hidden inputs for category/subcategory and submit button -->
    <div class="mt-3" id="submit-container" style="display: none;">
      <input type="hidden" name="category" id="category-hidden">
      <input type="hidden" name="subcategory" id="subcategory-hidden">
      <button type="submit" class="btn btn-dark">Submit</button>
    </div>
  </form>
</div>

<!-- CSS for flying-out submenus -->
<style>
  .dropdown-submenu { position: relative; }
  .dropdown-submenu:hover > .dropdown-menu { display: block; }
  .dropdown-submenu > .dropdown-menu {
    top: 0;
    left: 100%;
    margin-top: -1px;
  }
</style>

<script>
  const downtimeCodes = JSON.parse('{{ downtime_codes_json|escapejs }}');
  const prodLines      = JSON.parse('{{ lines_json|escapejs }}');

  const lineSelect       = document.getElementById('line-select');
  const machineSelect    = document.getElementById('machine-select');
  const categoryBtn      = document.getElementById('category-btn');
  const categoryMenu     = document.getElementById('category-menu');
  const descriptionCtr   = document.getElementById('description-container');
  const submitCtr        = document.getElementById('submit-container');
  const categoryHidden   = document.getElementById('category-hidden');
  const subcategoryHidden= document.getElementById('subcategory-hidden');

  // Populate lines
  prodLines.forEach(line => {
    const opt = document.createElement('option');
    opt.value   = line.line;
    opt.textContent = line.line;
    lineSelect.appendChild(opt);
  });

  // When line changes → load machines
  lineSelect.addEventListener('change', () => {
    resetMachine();
    resetCategoryMenu();
    hide(descriptionCtr, submitCtr);

    if (!lineSelect.value) return;

    const ops = prodLines.find(l => l.line === lineSelect.value).operations;
    ops.forEach(op => {
      op.machines.forEach(m => {
        const opt = document.createElement('option');
        opt.value       = m.number;
        opt.textContent = `${m.number} (Op ${op.op})`;
        machineSelect.appendChild(opt);
      });
    });
    machineSelect.disabled = false;
  });

  // When machine changes → build category & subcategory menu
  machineSelect.addEventListener('change', () => {
    resetCategoryMenu();
    hide(descriptionCtr, submitCtr);

    if (!machineSelect.value) return;

    downtimeCodes.forEach(cat => {
      const li = document.createElement('li');
      li.classList.add('dropdown-submenu');

      // category toggle
      const a = document.createElement('a');
      a.classList.add('dropdown-item', 'dropdown-toggle');
      a.href = '#';
      a.textContent         = cat.name;
      a.dataset.catCode     = cat.code;
      li.appendChild(a);

      // nested subcategory list
      const subUl = document.createElement('ul');
      subUl.classList.add('dropdown-menu');
      cat.subcategories.forEach(sc => {
        const subLi = document.createElement('li');
        const subA  = document.createElement('a');
        subA.classList.add('dropdown-item');
        subA.href            = '#';
        subA.textContent     = sc.name;
        subA.dataset.subCode = sc.code;
        subLi.appendChild(subA);
        subUl.appendChild(subLi);
      });
      li.appendChild(subUl);

      categoryMenu.appendChild(li);
    });
  });

  // Handle subcategory click
  categoryMenu.addEventListener('click', e => {
    e.preventDefault();
    const tgt = e.target;
    if (tgt.matches('.dropdown-item') && tgt.dataset.subCode) {
      // set hidden inputs
      const parentCat = tgt.closest('.dropdown-submenu')
                          .querySelector('.dropdown-toggle').dataset.catCode;
      categoryHidden.value    = parentCat;
      subcategoryHidden.value = tgt.dataset.subCode;

      // update button text
      categoryBtn.textContent = tgt.textContent;

      // reveal comment + submit
      show(descriptionCtr, submitCtr);
    }
  });

  function resetMachine() {
    machineSelect.innerHTML = '<option value=\"\">Select Machine</option>';
    machineSelect.disabled  = true;
  }
  function resetCategoryMenu() {
    categoryBtn.textContent = 'Select Category';
    categoryMenu.innerHTML  = '';
  }
  function hide(...els) {
    els.forEach(el => el.style.display = 'none');
  }
  function show(...els) {
    els.forEach(el => el.style.display = 'block');
  }
</script>
{% endblock %}
