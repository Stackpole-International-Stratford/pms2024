{% extends "parent.html" %}

{% block content %}
<div class="container py-5">
  <form id="downtime-form" method="POST">
    {% csrf_token %}
    <div class="card shadow-sm">
      <div class="card-body">
        <h5 class="card-title mb-4 text-center">Downtime Entry</h5>

        <!-- HORIZONTAL, NO-WRAP selects -->
        <div class="d-flex flex-nowrap align-items-start gap-2">
          <!-- Line -->
          <div class="flex-shrink-0">
            <label for="line-select" class="form-label">Line</label>
            <select id="line-select" name="line"
                    class="form-select form-select-sm w-auto">
              <option value="">Select Line</option>
            </select>
          </div>

          <!-- Machine -->
          <div class="flex-shrink-0">
            <label for="machine-select" class="form-label">Machine</label>
            <select id="machine-select" name="machine"
                    class="form-select form-select-sm w-auto" disabled>
              <option value="">Select Machine</option>
            </select>
          </div>

          <!-- Category -->
          <div id="category-container" class="flex-shrink-0" style="display: none;">
            <label for="category-select" class="form-label">Category</label>
            <select id="category-select" name="category"
                    class="form-select form-select-sm w-auto" disabled>
              <option value="">Select Category</option>
            </select>
          </div>

          <!-- Subcategory -->
          <div id="subcategory-container" class="flex-shrink-0" style="display: none;">
            <label for="subcategory-select" class="form-label">Subcategory</label>
            <select id="subcategory-select" name="subcategory"
                    class="form-select form-select-sm w-auto" disabled>
              <option value="">Select Subcategory</option>
            </select>
          </div>
        </div>

        <!-- Comment -->
        <div class="mt-3" id="description-container" style="display: none;">
          <label for="description" class="form-label">Comment:</label>
          <textarea id="description" name="description"
                    class="form-control" rows="2" maxlength="5000" required></textarea>
        </div>

        <!-- Submit -->
        <div class="mt-3 text-end" id="submit-container" style="display: none;">
          <button type="submit" class="btn btn-dark">Submit</button>
        </div>
      </div>
    </div>
  </form>
</div>

<style>
  .form-label { margin-bottom: .25rem; }
  .form-select-sm { padding: .25rem .5rem; font-size: .875rem; }
  .w-auto { width: auto !important; }


  .card-body {
    overflow-x: auto;
  }
  
</style>

<script>
  const downtimeCodes     = JSON.parse('{{ downtime_codes_json|escapejs }}');
  const prodLines         = JSON.parse('{{ lines_json|escapejs }}');

  const lineSelect        = document.getElementById('line-select');
  const machineSelect     = document.getElementById('machine-select');
  const categoryContainer = document.getElementById('category-container');
  const categorySelect    = document.getElementById('category-select');
  const subcatContainer   = document.getElementById('subcategory-container');
  const subcatSelect      = document.getElementById('subcategory-select');
  const descCtr           = document.getElementById('description-container');
  const submitCtr         = document.getElementById('submit-container');

  // Populate Line dropdown
  prodLines.forEach(line => {
    const opt = document.createElement('option');
    opt.value = line.line;
    opt.textContent = line.line;
    lineSelect.appendChild(opt);
  });

  // Utility resets
  function resetMachine() {
    machineSelect.innerHTML = '<option value="">Select Machine</option>';
    machineSelect.disabled  = true;
  }
  function resetCategory() {
    categorySelect.innerHTML = '<option value="">Select Category</option>';
    categorySelect.disabled  = true;
    categoryContainer.style.display = 'none';
  }
  function resetSubcategory() {
    subcatSelect.innerHTML = '<option value="">Select Subcategory</option>';
    subcatSelect.disabled  = true;
    subcatContainer.style.display = 'none';
  }
  function hide(...els) { els.forEach(e => e.style.display = 'none'); }
  function show(...els) { els.forEach(e => e.style.display = 'block'); }

  // When Line changes → reset downstream
  lineSelect.addEventListener('change', () => {
    resetMachine();
    resetCategory();
    resetSubcategory();
    hide(descCtr, submitCtr);

    if (!lineSelect.value) return;

    const ops = prodLines.find(l => l.line === lineSelect.value).operations;
    ops.forEach(op => {
      op.machines.forEach(m => {
        const opt = document.createElement('option');
        opt.value = m.number;
        opt.textContent = `${m.number} (Op ${op.op})`;
        machineSelect.appendChild(opt);
      });
    });
    machineSelect.disabled = false;
  });

  // When Machine changes → show categories
  machineSelect.addEventListener('change', () => {
    resetCategory();
    resetSubcategory();
    hide(descCtr, submitCtr);

    if (!machineSelect.value) return;

    downtimeCodes.forEach(cat => {
      const opt = document.createElement('option');
      opt.value = cat.code;
      opt.textContent = cat.name;
      categorySelect.appendChild(opt);
    });
    categorySelect.disabled = false;
    show(categoryContainer);
  });

  // When Category changes → show subcategories
  categorySelect.addEventListener('change', () => {
    resetSubcategory();
    hide(descCtr, submitCtr);

    if (!categorySelect.value) return;

    const cat = downtimeCodes.find(c => c.code === categorySelect.value);
    cat.subcategories.forEach(sc => {
      const opt = document.createElement('option');
      opt.value = sc.code;
      opt.textContent = sc.name;
      subcatSelect.appendChild(opt);
    });
    subcatSelect.disabled = false;
    show(subcatContainer);
  });

  // When Subcategory changes → show comment & submit
  subcatSelect.addEventListener('change', () => {
    if (subcatSelect.value) {
      show(descCtr, submitCtr);
    } else {
      hide(descCtr, submitCtr);
    }
  });
</script>
{% endblock %}
