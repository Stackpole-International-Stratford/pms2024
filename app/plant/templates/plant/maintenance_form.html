{% extends "parent.html" %}
{% block content %}
<div class="container-fluid py-5">
  <form id="maintenance-form" method="POST">
    {% csrf_token %}
    <div id="downtime-table-wrapper" class="table-responsive" style="-webkit-overflow-scrolling: touch;">
      <table id="downtime-table" class="table table-sm table-striped">
        <thead>
          <tr>
            <th style="min-width:140px">
              Started at<br>
              <input type="hidden" id="start-date" name="start_date"
                     class="form-control form-control-sm" required>
              <input type="time" id="start-time" name="start_time"
                     class="form-control form-control-sm mt-1" required>
            </th>
            <th style="min-width:100px">
              Line<br>
              <select id="line-select" name="line"
                      class="form-select form-select-sm" required>
                <option value="">Select Line</option>
              </select>
            </th>
            <th style="min-width:100px">
              Machine<br>
              <select id="machine-select" name="machine"
                      class="form-select form-select-sm" required disabled>
                <option value="">Select Machine</option>
              </select>
            </th>
            <th style="min-width:160px">
              Category<br>
              <select id="category-select" name="category"
                      class="form-select form-select-sm" required disabled>
                <option value="">Select Category</option>
              </select>
            </th>
            <th style="min-width:180px">
              Sub-category<br>
              <select id="subcategory-select" name="subcategory"
                      class="form-select form-select-sm" required disabled>
                <option value="">Select Subcategory</option>
              </select>
            </th>
            <th style="min-width:100px">Code</th>
            <th style="min-width:200px">
              Comment<br>
              <textarea id="description" name="description"
                        class="form-control form-control-sm"
                        rows="1" maxlength="5000" required></textarea>
            </th>
            <th style="width:1%;">
              <button type="submit"
                      id="add-button"
                      class="btn btn-dark btn-sm mt-4"
                      disabled>
                Add
              </button>
            </th>
          </tr>
        </thead>
        <tbody id="entries-body">
          {% for e in entries %}
          <tr data-entry-id="{{ e.id }}">
            <td>{{ e.start_at|date:"Y-m-d H:i" }}</td>
            <td>{{ e.line }}</td>
            <td>{{ e.machine }}</td>
            <td>{{ e.category }}</td>
            <td>{{ e.subcategory }}</td>
            <td>{{ e.code }}</td>
            <td>{{ e.comment|truncatechars:50 }}</td>
            <td></td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>

    {% if has_more %}
    <div class="text-center mt-3">
      <button id="load-more" class="btn btn-outline-dark btn-sm">Load more</button>
    </div>
    {% endif %}
  </form>

  <!-- Edit Details Modal -->
  <div class="modal fade" id="entryModal" tabindex="-1" aria-labelledby="entryModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="entryModalLabel">Entry Details</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <ul class="list-unstyled mb-0">
            <li><strong>Database ID:</strong> <span id="modal-entry-id"></span></li>
            <li><strong>Started at:</strong> <span id="modal-started-at"></span></li>
            <li><strong>Line:</strong> <span id="modal-line"></span></li>
            <li><strong>Machine:</strong> <span id="modal-machine"></span></li>
            <li><strong>Category:</strong> <span id="modal-category"></span></li>
            <li><strong>Sub-category:</strong> <span id="modal-subcategory"></span></li>
            <li><strong>Comment:</strong> <span id="modal-comment"></span></li>
          </ul>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
        </div>
      </div>
    </div>
  </div>
</div>

<style>
  .table-responsive { overflow-x: auto; }
  #downtime-table thead th {
    position: sticky;
    top: 0;
    background: white;
    z-index: 2;
  }
  #downtime-table-wrapper { min-height: 800px; }
</style>

<script>
(function(){
  const prodLines     = JSON.parse('{{ lines_json|escapejs }}');
  const downtimeCodes = JSON.parse('{{ downtime_codes_json|escapejs }}');

  const lineSelect        = document.getElementById('line-select');
  const machineSelect     = document.getElementById('machine-select');
  const categorySelect    = document.getElementById('category-select');
  const subcategorySelect = document.getElementById('subcategory-select');
  const startDateInput    = document.getElementById('start-date');
  const startTimeInput    = document.getElementById('start-time');
  const descriptionInput  = document.getElementById('description');
  const addBtn            = document.getElementById('add-button');
  const tbody             = document.getElementById('entries-body');
  const loadBtn           = document.getElementById('load-more');
  const entriesUrl        = "{% url 'maintenance_entries' %}";
  let   offset            = {{ entries|length }};

  // Prefill date/time
  (function setDefaultDateTime(){
    const now = new Date();
    startDateInput.value = now.toISOString().slice(0,10);
    startTimeInput.value = now.toTimeString().slice(0,5);
  })();

  // Choices.js inits
  const lineChoice        = new Choices(lineSelect,        { searchEnabled:false, itemSelectText:'' });
  const machineChoice     = new Choices(machineSelect,     { searchEnabled:false, itemSelectText:'', shouldSort:false });
  const categoryChoice    = new Choices(categorySelect,    { searchEnabled:false, itemSelectText:'' });
  const subcategoryChoice = new Choices(subcategorySelect, { searchEnabled:false, itemSelectText:'' });

  machineChoice.disable();
  categoryChoice.disable();
  subcategoryChoice.disable();

  // filter & add-button logic
  function filterEntries(){
    const fLine    = lineSelect.value;
    const fMachine = machineSelect.value;
    const fCat     = categorySelect.value;
    const fSub     = subcategorySelect.value;

    Array.from(tbody.rows).forEach(tr=>{
      const cols       = tr.cells;
      const rowLine    = cols[1].textContent.trim();
      const rowMachine = cols[2].textContent.trim();
      const rowCode    = cols[5].textContent.trim();
      let show = true;
      if (fLine    && rowLine    !== fLine)          show = false;
      if (fMachine && rowMachine !== fMachine)       show = false;
      if (fCat     && !rowCode.startsWith(fCat+'-')) show = false;
      if (fSub     && rowCode !== fSub)              show = false;
      tr.style.display = show ? '' : 'none';
    });
  }

  function updateAddBtnState(){
    const ok = lineSelect.value
            && machineSelect.value
            && categorySelect.value
            && subcategorySelect.value
            && descriptionInput.value.trim();
    addBtn.disabled = !ok;
  }

  [ lineSelect, machineSelect, categorySelect, subcategorySelect ]
    .forEach(el => el.addEventListener('change', ()=>{
      filterEntries();
      updateAddBtnState();
    }));
  descriptionInput.addEventListener('input', updateAddBtnState);

  // populate dropdowns
  lineChoice.setChoices(
    prodLines.map(l=>({ value:l.line, label:l.line })),
    'value','label',true
  );
  lineSelect.addEventListener('change', ()=>{
    machineChoice.clearChoices().disable();
    categoryChoice.clearChoices().disable();
    subcategoryChoice.clearChoices().disable();
    if (!lineSelect.value) return;
    const ops = prodLines.find(l=>l.line===lineSelect.value).operations;
    machineChoice.setChoices(
      ops.map(op=>({
        label:`Op ${op.op}`,
        choices: op.machines.map(m=>({ value:m.number, label:m.number }))
      })),
      'value','label',true
    );
    machineChoice.enable().showDropdown();
  });

  machineSelect.addEventListener('change', ()=>{
    categoryChoice.clearChoices().disable();
    subcategoryChoice.clearChoices().disable();
    if (!machineSelect.value) return;
    categoryChoice.setChoices(
      downtimeCodes.map(c=>({ value:c.code, label:c.name })),
      'value','label',true
    );
    categoryChoice.enable().showDropdown();
  });

  categorySelect.addEventListener('change', ()=>{
    subcategoryChoice.clearChoices().disable();
    if (!categorySelect.value) return;
    subcategoryChoice.setChoices(
      downtimeCodes
        .find(c=>c.code===categorySelect.value)
        .subcategories
        .map(s=>({ value:s.code, label:s.name })),
      'value','label',true
    );
    subcategoryChoice.enable().showDropdown();
  });

  subcategorySelect.addEventListener('change', ()=>{
    if (subcategorySelect.value) descriptionInput.focus();
  });

  // AJAX Load more
  if (loadBtn) loadBtn.addEventListener('click', ()=>{
    fetch(`${entriesUrl}?offset=${offset}`)
      .then(r=>r.json())
      .then(data=>{
        data.entries.forEach(e=>{
          const tr = document.createElement('tr');
          tr.setAttribute('data-entry-id', e.id);
          tr.innerHTML = `
            <td>${e.start_at}</td>
            <td>${e.line}</td>
            <td>${e.machine}</td>
            <td>${e.category}</td>
            <td>${e.subcategory}</td>
            <td>${e.code}</td>
            <td>${e.comment.substring(0,50)}${e.comment.length>50?'â€¦':''}</td>
            <td></td>
          `;
          tbody.appendChild(tr);
        });
        offset += data.entries.length;
        if (!data.has_more) loadBtn.style.display = 'none';
        filterEntries();
      })
      .catch(console.error);
  });

  // Show full details in modal on row click
  tbody.addEventListener('click', e => {
    const tr = e.target.closest('tr[data-entry-id]');
    if (!tr) return;
    const cells = tr.cells;
    document.getElementById('modal-entry-id').textContent    = tr.dataset.entryId;
    document.getElementById('modal-started-at').textContent  = cells[0].textContent.trim();
    document.getElementById('modal-line').textContent        = cells[1].textContent.trim();
    document.getElementById('modal-machine').textContent     = cells[2].textContent.trim();
    document.getElementById('modal-category').textContent    = cells[3].textContent.trim();
    document.getElementById('modal-subcategory').textContent = cells[4].textContent.trim();
    document.getElementById('modal-comment').textContent     = cells[6].textContent.trim();
    const entryModal = new bootstrap.Modal(document.getElementById('entryModal'));
    entryModal.show();
  });

  // init
  filterEntries();
  updateAddBtnState();
})();
</script>
{% endblock %}
