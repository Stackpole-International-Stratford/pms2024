{% extends "parent.html" %}
{% block content %}
<div class="container-fluid py-5">
  <!-- ADD FORM & TABLE -->
  <form id="maintenance-form" method="POST">
    {% csrf_token %}
    <div id="downtime-table-wrapper" class="table-responsive" style="-webkit-overflow-scrolling: touch;">
      <table id="downtime-table" class="table table-sm table-striped">
        <thead>
          <tr>
            <th style="min-width:140px">
              Started at<br>
              <input type="hidden" id="start-date" name="start_date"
                     class="form-control form-control-sm" required>
              <input type="time" id="start-time" name="start_time"
                     class="form-control form-control-sm mt-1" required>
            </th>
            <th style="min-width:100px">
              Line<br>
              <select id="line-select" name="line"
                      class="form-select form-select-sm" required>
                <option value="">Select Line</option>
              </select>
            </th>
            <th style="min-width:100px">
              Machine<br>
              <select id="machine-select" name="machine"
                      class="form-select form-select-sm" required disabled>
                <option value="">Select Machine</option>
              </select>
            </th>
            <th style="min-width:160px">
              Category<br>
              <select id="category-select" name="category"
                      class="form-select form-select-sm" required disabled>
                <option value="">Select Category</option>
              </select>
            </th>
            <th style="min-width:180px">
              Sub-category<br>
              <select id="subcategory-select" name="subcategory"
                      class="form-select form-select-sm" required disabled>
                <option value="">Select Subcategory</option>
              </select>
            </th>
            <th style="min-width:100px">Code</th>
            <th style="min-width:200px">
              Comment<br>
              <textarea id="description" name="description"
                        class="form-control form-control-sm"
                        rows="1" maxlength="5000" required></textarea>
            </th>
            <th style="width:1%;">
              <button type="submit"
                      id="add-button"
                      class="btn btn-dark btn-sm mt-4"
                      disabled>
                Add
              </button>
            </th>
          </tr>
        </thead>
        <tbody id="entries-body">
          {% for e in entries %}
          <tr data-entry-id="{{ e.id }}">
            <td>{{ e.start_at|date:"Y-m-d H:i" }}</td>
            <td>{{ e.line }}</td>
            <td>{{ e.machine }}</td>
            <td data-category-code="{{ e.code|cut:'-' }}">{{ e.category }}</td>
            <td data-subcategory-code="{{ e.code }}">{{ e.subcategory }}</td>       
            <td>{{ e.code }}</td>
            <td>{{ e.comment|truncatechars:50 }}</td>
            <td></td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
    <div class="text-center mt-3">
      <button id="load-more" class="btn btn-outline-dark btn-sm">Load more</button>
    </div>

  </form>


  <!-- EDIT ENTRY MODAL -->
  <div class="modal fade" id="editEntryModal" tabindex="-1" aria-labelledby="editEntryModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="editEntryModalLabel">Edit Downtime Entry</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <form id="edit-entry-form" method="POST">
          {% csrf_token %}
          <div class="modal-body">
            <input type="hidden" id="edit-entry-id" name="entry_id">
            <div class="row g-3">
              <div class="col-md-6">
                <label for="edit-start-date" class="form-label">Date</label>
                <input type="date" id="edit-start-date" name="start_date"
                      class="form-control form-control-sm" required>
              </div>
              <div class="col-md-6">
                <label for="edit-start-time" class="form-label">Time</label>
                <input type="time" id="edit-start-time" name="start_time"
                      class="form-control form-control-sm" required>
              </div>
              <div class="col-md-4">
                <label for="edit-line-select" class="form-label">Line</label>
                <select id="edit-line-select" name="line"
                        class="form-select form-select-sm" required>
                  <option value="">Select Line</option>
                </select>
              </div>
              <div class="col-md-4">
                <label for="edit-machine-select" class="form-label">Machine</label>
                <select id="edit-machine-select" name="machine"
                        class="form-select form-select-sm" required disabled>
                  <option value="">Select Machine</option>
                </select>
              </div>
              <div class="col-md-4">
                <label for="edit-category-select" class="form-label">Category</label>
                <select id="edit-category-select" name="category"
                        class="form-select form-select-sm" required disabled>
                  <option value="">Select Category</option>
                </select>
              </div>
              <div class="col-md-6">
                <label for="edit-subcategory-select" class="form-label">Sub-category</label>
                <select id="edit-subcategory-select" name="subcategory"
                        class="form-select form-select-sm" required disabled>
                  <option value="">Select Subcategory</option>
                </select>
              </div>
              <div class="col-md-6">
                <label for="edit-description" class="form-label">Comment</label>
                <textarea id="edit-description" name="description"
                          class="form-control form-control-sm" rows="2"
                          maxlength="5000" required></textarea>
              </div>
            </div>
          </div>
          <div class="modal-footer">
            <!-- left -->
            <button type="button"
                    id="delete-button"
                    class="btn btn-danger">
              Delete
            </button>
          
            <!-- center -->
            <button type="button"
                    id="closeout-open-button"
                    class="btn btn-info mx-3">
              Close Out
            </button>
          
            <!-- right -->
            <div class="ms-auto">
              <button type="button"
                      class="btn btn-secondary"
                      data-bs-dismiss="modal">
                Cancel
              </button>
              <button type="submit"
                      id="save-button"
                      class="btn btn-warning ms-2">
                Save changes
              </button>
            </div>
          </div>
          
        </form>
      </div>
    </div>
  </div>

  <!-- CLOSE-OUT MODAL -->
  <div class="modal fade" id="closeoutModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-sm">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Close Out Downtime</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <form id="closeout-form">
            {% csrf_token %}
            <input type="hidden" id="closeout-entry-id">
            <div class="mb-3">
              <label for="closeout-date" class="form-label">Date</label>
              <input type="date" id="closeout-date" class="form-control" required>
            </div>
            <div class="mb-3">
              <label for="closeout-time" class="form-label">Time</label>
              <input type="time" id="closeout-time" class="form-control" required>
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button"
                  id="closeout-cancel"
                  class="btn btn-secondary"
                  data-bs-dismiss="modal">
            Cancel
          </button>
          <button type="button"
                  id="closeout-confirm"
                  class="btn btn-info">
            Confirm
          </button>
        </div>
      </div>
    </div>
  </div>


</div>

<style>

  #downtime-table tbody tr:hover {
    cursor: pointer;
  }
  
  .table-responsive { overflow-x: auto; }
  #downtime-table thead th {
    position: sticky;
    top: 0;
    background: white;
    z-index: 2;
  }
  #downtime-table-wrapper { min-height: 800px; }
</style>

<script>
  (function () {
    // ─── JSON DATA ────────────────────────────────────────────────────────
    const prodLines     = JSON.parse('{{ lines_json|escapejs }}');
    const downtimeCodes = JSON.parse('{{ downtime_codes_json|escapejs }}');
  
    // ─── DOM ELEMENTS ─────────────────────────────────────────────────────
    const tbody      = document.getElementById('entries-body');
    const loadBtn    = document.getElementById('load-more');
    const entriesUrl = "{% url 'maintenance_entries' %}";
    let   offset     = {{ entries|length }};
  
    // ADD-FORM ELEMENTS
    const add = {
      dateInput:     document.getElementById('start-date'),
      timeInput:     document.getElementById('start-time'),
      lineSelect:    document.getElementById('line-select'),
      machineSelect: document.getElementById('machine-select'),
      catSelect:     document.getElementById('category-select'),
      subSelect:     document.getElementById('subcategory-select'),
      descInput:     document.getElementById('description'),
      submitBtn:     document.getElementById('add-button')
    };
  
    // EDIT-MODAL ELEMENTS
    const edit = {
      modal:         document.getElementById('editEntryModal'),
      form:          document.getElementById('edit-entry-form'),
      idInput:       document.getElementById('edit-entry-id'),
      dateInput:     document.getElementById('edit-start-date'),
      timeInput:     document.getElementById('edit-start-time'),
      lineSelect:    document.getElementById('edit-line-select'),
      machineSelect: document.getElementById('edit-machine-select'),
      catSelect:     document.getElementById('edit-category-select'),
      subSelect:     document.getElementById('edit-subcategory-select'),
      descInput:     document.getElementById('edit-description'),
      saveBtn:       document.getElementById('save-button'),
      deleteBtn:     document.getElementById('delete-button')
    };
  
    // CLOSEOUT-MODAL ELEMENTS
    const closeoutOpenBtn = document.getElementById('closeout-open-button');
    const closeoutModalEl = document.getElementById('closeoutModal');
    const closeoutDate    = document.getElementById('closeout-date');
    const closeoutTime    = document.getElementById('closeout-time');
    const closeoutEntryId = document.getElementById('closeout-entry-id');
    const closeoutConfirm = document.getElementById('closeout-confirm');
  
    // ─── Choices.js SETUP ─────────────────────────────────────────────────
    function makeChoices(el, opts={ searchEnabled:false, itemSelectText:'' }) {
      return new Choices(el, opts);
    }
    const choices = {
      addLine:     makeChoices(add.lineSelect),
      addMachine:  makeChoices(add.machineSelect),
      addCat:      makeChoices(add.catSelect),
      addSub:      makeChoices(add.subSelect),
      editLine:    makeChoices(edit.lineSelect),
      editMachine: makeChoices(edit.machineSelect),
      editCat:     makeChoices(edit.catSelect),
      editSub:     makeChoices(edit.subSelect)
    };
    [choices.addMachine, choices.addCat, choices.addSub,
     choices.editMachine, choices.editCat, choices.editSub]
      .forEach(c=>c.disable());
  
    // ─── option-builders ──────────────────────────────────────────────────
    const getMachines = lineVal => {
      const ops = prodLines.find(l=>l.line===lineVal)?.operations||[];
      return ops.map(op=>({
        label:   `Op ${op.op}`,
        choices: op.machines.map(m=>({value:m.number,label:m.number}))
      }));
    };
    const getCats = ()=> downtimeCodes.map(c=>({value:String(c.code),label:c.name}));
    const getSubs = catCode => {
      const cat = downtimeCodes.find(c=>c.code===catCode);
      return (cat?.subcategories||[]).map(s=>({value:String(s.code),label:s.name}));
    };
  
    // ─── cascade helper ───────────────────────────────────────────────────
    function chain(parentEl, childChoice, getOpts, showDD=false){
      parentEl.addEventListener('change',()=>{
        const v = parentEl.value;
        childChoice.clearChoices().disable();
        if (!v) return;
        childChoice.setChoices(getOpts(v),'value','label',true);
        childChoice.enable();
        if (showDD) childChoice.showDropdown();
        filterRows();
      });
    }
  
    // wire up add-form chains
    chain(add.lineSelect,    choices.addMachine,  getMachines, true);
    chain(add.machineSelect, choices.addCat,      getCats,     true);
    chain(add.catSelect,     choices.addSub,      getSubs,     true);
  
    // wire up edit-modal chains
    chain(edit.lineSelect,    choices.editMachine, getMachines);
    chain(edit.machineSelect, choices.editCat,     getCats);
    chain(edit.catSelect,     choices.editSub,     getSubs);
  
    // populate line dropdowns
    const lineOpts = prodLines.map(l=>({value:l.line,label:l.line}));
    choices.addLine.setChoices(lineOpts,'value','label',true);
    choices.editLine.setChoices(lineOpts,'value','label',true);
  
    // ─── ADD-FORM default date/time & validation ─────────────────────────
    (()=>{ const n=new Date();
      add.dateInput.value=n.toISOString().slice(0,10);
      add.timeInput.value=n.toTimeString().slice(0,5);
    })();
    function validateAdd(){
      add.submitBtn.disabled = !(
        add.lineSelect.value && add.machineSelect.value &&
        add.catSelect.value  && add.subSelect.value &&
        add.descInput.value.trim()
      );
    }
    [add.lineSelect,add.machineSelect,add.catSelect,add.subSelect]
      .forEach(el=>el.addEventListener('change', validateAdd));
    add.descInput.addEventListener('input',validateAdd);
  
    // ─── ROW FILTERING ───────────────────────────────────────────────────
    function filterRows() {
      const fL = add.lineSelect.value,
            fM = add.machineSelect.value,
            fC = add.catSelect.value,
            fS = add.subSelect.value;
      Array.from(tbody.rows).forEach(tr => {
        const [ , lineCell, machineCell, , , codeCell ] = tr.cells;
        let show = true;
        if (fL && lineCell.textContent.trim()   !== fL) show = false;
        if (fM && machineCell.textContent.trim() !== fM) show = false;
        if (fC && !codeCell.textContent.trim().startsWith(fC + '-')) show = false;
        if (fS && codeCell.textContent.trim()    !== fS) show = false;
        tr.style.display = show ? '' : 'none';
      });
    }
  
    // ─── LOAD-MORE ───────────────────────────────────────────────────────
    if(loadBtn){
      loadBtn.addEventListener('click',()=>{
        fetch(`${entriesUrl}?offset=${offset}`)
          .then(r=>r.json())
          .then(({entries,has_more})=>{
            entries.forEach(e=>{
              const tr=document.createElement('tr');
              tr.dataset.entryId=e.id;
              tr.innerHTML=`
                <td>${e.start_at}</td>
                <td>${e.line}</td>
                <td>${e.machine}</td>
                <td data-category-code="${e.category_code}">${e.category}</td>
                <td data-subcategory-code="${e.subcategory_code}">${e.subcategory}</td>
                <td>${e.code}</td>
                <td>${e.comment.substring(0,50)}${e.comment.length>50?'…':''}</td>
                <td></td>`;
              tbody.appendChild(tr);
            });
            offset += entries.length;
            if(!has_more) loadBtn.style.display='none';
            filterRows();
          })
          .catch(console.error);
      });
    }
  
    // ─── EDIT ROW CLICK ──────────────────────────────────────────────────
    tbody.addEventListener('click',ev=>{
      const tr=ev.target.closest('tr[data-entry-id]');
      if(!tr) return;
      const cells=tr.cells;
      const datetime=cells[0].textContent.trim();
      const lineVal=cells[1].textContent.trim();
      const machVal=cells[2].textContent.trim();
      const fullCode=cells[5].textContent.trim();
      const catCode=fullCode.split('-')[0];
      const subCode=fullCode;
  
      edit.idInput.value   = tr.dataset.entryId;
      edit.dateInput.value = datetime.slice(0,10);
      edit.timeInput.value = datetime.slice(11);
      edit.descInput.value = cells[6].textContent.trim();
  
      choices.editLine.setChoiceByValue(lineVal);
      edit.lineSelect.value=lineVal;
  
      const mOpts=getMachines(lineVal);
      choices.editMachine.clearChoices().setChoices(mOpts,'value','label',true).enable();
      choices.editMachine.setChoiceByValue(machVal);
      edit.machineSelect.value=machVal;
  
      choices.editCat.clearChoices().setChoices(getCats(),'value','label',true).enable();
      choices.editCat.setChoiceByValue(catCode);
      edit.catSelect.value=catCode;
  
      choices.editSub.clearChoices().setChoices(getSubs(catCode),'value','label',true).enable();
      choices.editSub.setChoiceByValue(subCode);
      edit.subSelect.value=subCode;
  
      new bootstrap.Modal(edit.modal).show();
    });
  
    // ─── DELETE ENTRY ───────────────────────────────────────────────────
    edit.deleteBtn.addEventListener('click',()=>{
      if(!confirm('Delete this downtime entry?')) return;
      const id=edit.idInput.value;
      fetch("{% url 'delete_downtime_entry' %}",{
        method:'POST',
        headers:{
          'Content-Type':'application/json',
          'X-CSRFToken':document.querySelector('[name=csrfmiddlewaretoken]').value
        },
        body:JSON.stringify({entry_id:id})
      })
      .then(r=>{ if(!r.ok) throw Error(); return r.json(); })
      .then(()=>{
        bootstrap.Modal.getInstance(edit.modal).hide();
        tbody.querySelector(`tr[data-entry-id="${id}"]`)?.remove();
      })
      .catch(()=>alert('Error deleting entry.'));
    });
  
    // ─── OPEN CLOSE-OUT MODAL ────────────────────────────────────────────
    closeoutOpenBtn.addEventListener('click',()=>{
      closeoutEntryId.value = edit.idInput.value;
      const now=new Date();
      closeoutDate.value = now.toISOString().slice(0,10);
      closeoutTime.value = now.toTimeString().slice(0,5);
      new bootstrap.Modal(closeoutModalEl).show();
    });
  
    // ─── CONFIRM CLOSE-OUT ───────────────────────────────────────────────
    closeoutConfirm.addEventListener('click',()=>{
      const id=closeoutEntryId.value,
            date=closeoutDate.value,
            time=closeoutTime.value;
      if(!date||!time) return alert('Pick date & time.');
  
      fetch("{% url 'closeout_downtime_entry' %}",{
        method:"POST",
        headers:{
          "Content-Type":"application/json",
          "X-CSRFToken":document.querySelector('[name=csrfmiddlewaretoken]').value
        },
        body:JSON.stringify({ entry_id:id, closeout:`${date} ${time}` })
      })
      .then(r=>{ if(!r.ok) throw Error(); return r.json(); })
      .then(()=>{
        bootstrap.Modal.getInstance(closeoutModalEl).hide();
        bootstrap.Modal.getInstance(edit.modal).hide();
        tbody.querySelector(`tr[data-entry-id="${id}"]`)?.remove();
      })
      .catch(()=>alert("Error closing out."));
    });
  
  })();
</script>

  

  
{% endblock %}
