{% extends "parent.html" %}

{% block content %}
<div class="container py-5">
  <form id="downtime-form" method="POST">
    {% csrf_token %}
    <div class="card shadow-sm">
      <div class="card-body">
        <h5 class="card-title mb-4 text-center">Downtime Entry</h5>

        <!-- FLEX ROW: Line, Machine, then Category submenu -->
        <div class="d-flex flex-nowrap align-items-start gap-2">
          <!-- Line select -->
          <div class="flex-shrink-0">
            <label for="line-select" class="form-label">Line</label>
            <select id="line-select" name="line"
                    class="form-select form-select-sm w-auto">
              <option value="">Select Line</option>
            </select>
          </div>

          <!-- Machine select -->
          <div class="flex-shrink-0">
            <label for="machine-select" class="form-label">Machine</label>
            <select id="machine-select" name="machine"
                    class="form-select form-select-sm w-auto" disabled>
              <option value="">Select Machine</option>
            </select>
          </div>

          <!-- Category→Subcategory dropdown -->
          <div id="category-dropdown-container" class="flex-shrink-0" style="display: none;">
            <label class="form-label d-block mb-1">Category &amp; Subcategory</label>
            <div class="dropdown">
              <button id="categoryDropdownBtn"
                      class="btn btn-sm btn-outline-secondary dropdown-toggle"
                      type="button"
                      data-bs-toggle="dropdown"
                      aria-expanded="false">
                Select…
              </button>
              <ul id="categoryDropdownMenu" class="dropdown-menu">
                <!-- JS will inject nested menus here -->
              </ul>
            </div>
          </div>
        </div>

        <!-- Comment textarea (shows after subcategory pick) -->
        <div class="mt-3" id="description-container" style="display: none;">
          <label for="description" class="form-label">Comment:</label>
          <textarea id="description" name="description"
                    class="form-control" rows="2" maxlength="5000" required></textarea>
        </div>

        <!-- Hidden inputs + Submit -->
        <div class="mt-3 text-end" id="submit-container" style="display: none;">
          <input type="hidden" id="category-hidden" name="category">
          <input type="hidden" id="subcategory-hidden" name="subcategory">
          <button type="submit" class="btn btn-dark">Submit</button>
        </div>
      </div>
    </div>
  </form>
</div>

<style>
  /* smaller labels/selects */
  .form-label { margin-bottom: .25rem; }
  .form-select-sm { padding: .25rem .5rem; font-size: .875rem; }
  .w-auto { width: auto !important; }

  /* nested dropdown submenu styling */
  .dropdown-submenu { position: relative; }
  .dropdown-submenu > .dropdown-menu {
    top: 0; left: 100%;
    margin-left: .125rem;
  }
</style>

<script>
  const downtimeCodes     = JSON.parse('{{ downtime_codes_json|escapejs }}');
  const prodLines         = JSON.parse('{{ lines_json|escapejs }}');
  const lineSelect        = document.getElementById('line-select');
  const machineSelect     = document.getElementById('machine-select');
  const catContainer      = document.getElementById('category-dropdown-container');
  const catBtn            = document.getElementById('categoryDropdownBtn');
  const catMenu           = document.getElementById('categoryDropdownMenu');
  const descCtr           = document.getElementById('description-container');
  const submitCtr         = document.getElementById('submit-container');
  const catHidden         = document.getElementById('category-hidden');
  const subHidden         = document.getElementById('subcategory-hidden');

  // Populate Line select
  prodLines.forEach(line => {
    const o = document.createElement('option');
    o.value = line.line;
    o.textContent = line.line;
    lineSelect.appendChild(o);
  });

  // Reset machine dropdown
  function resetMachine() {
    machineSelect.innerHTML = '<option value="">Select Machine</option>';
    machineSelect.disabled  = true;
  }

  // Reset category dropdown
  function resetCategoryDropdown() {
    catMenu.innerHTML    = '';
    catBtn.textContent   = 'Select…';
    catHidden.value      = '';
    subHidden.value      = '';
  }

  // Hide utility
  function hide(...els) { els.forEach(e => e.style.display = 'none'); }
  function show(...els) { els.forEach(e => e.style.display = 'block'); }

  // Line → Machine
  lineSelect.addEventListener('change', () => {
    resetMachine();
    resetCategoryDropdown();
    hide(descCtr, submitCtr, catContainer);

    if (!lineSelect.value) return;
    const ops = prodLines.find(l => l.line === lineSelect.value).operations;
    ops.forEach(op => {
      op.machines.forEach(m => {
        const o = document.createElement('option');
        o.value       = m.number;
        o.textContent = `${m.number} (Op ${op.op})`;
        machineSelect.appendChild(o);
      });
    });
    machineSelect.disabled = false;
  });

  // Machine → build nested dropdown
  machineSelect.addEventListener('change', () => {
    resetCategoryDropdown();
    hide(descCtr, submitCtr);

    if (!machineSelect.value) {
      hide(catContainer);
      return;
    }

    // build menu
    downtimeCodes.forEach(cat => {
      const liCat = document.createElement('li');
      liCat.classList.add('dropdown-submenu');

      const aCat = document.createElement('a');
      aCat.classList.add('dropdown-item', 'dropdown-toggle');
      aCat.href = '#';
      aCat.textContent = cat.name;
      liCat.appendChild(aCat);

      const subUL = document.createElement('ul');
      subUL.classList.add('dropdown-menu');
      cat.subcategories.forEach(sc => {
        const liSub = document.createElement('li');
        const aSub  = document.createElement('a');
        aSub.classList.add('dropdown-item', 'subcategory-item');
        aSub.href = '#';
        aSub.textContent = sc.name;
        aSub.dataset.catCode = cat.code;
        aSub.dataset.subCode = sc.code;
        liSub.appendChild(aSub);
        subUL.appendChild(liSub);
      });
      liCat.appendChild(subUL);
      catMenu.appendChild(liCat);
    });

    show(catContainer);
  });

  // Toggle submenu on click
  catMenu.addEventListener('click', e => {
    // click on a category toggle
    if (e.target.matches('.dropdown-submenu > .dropdown-toggle')) {
      e.preventDefault();
      e.stopPropagation();
      const sub = e.target.nextElementSibling;
      sub.classList.toggle('show');
    }
    // click on a subcategory
    if (e.target.matches('.subcategory-item')) {
      e.preventDefault();
      const li = e.target;
      catHidden.value = li.dataset.catCode;
      subHidden.value = li.dataset.subCode;
      catBtn.textContent = li.textContent;
      // hide dropdown & any open submenus
      Bootstrap.Dropdown.getInstance(catBtn).hide();
      catMenu.querySelectorAll('.dropdown-menu.show')
             .forEach(m => m.classList.remove('show'));
      show(descCtr, submitCtr);
    }
  });

  // Clean up open submenus when main menu closes
  catBtn.addEventListener('hidden.bs.dropdown', () => {
    catMenu.querySelectorAll('.dropdown-menu.show')
           .forEach(m => m.classList.remove('show'));
  });
</script>
{% endblock %}
