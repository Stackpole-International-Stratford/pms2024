{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Manage TPM - {{ asset.asset_number }}</title>
    <link href="{% static 'bootstrap/css/bootstrap.min.css' %}" rel="stylesheet">
    <script src="{% static 'bootstrap/js/bootstrap.bundle.min.js' %}"></script>
</head>
<style>
    .accordion-button:not(.collapsed) {
        background-color: rgba(51, 51, 51, 0.1) !important;
        color: #333333 !important;
        box-shadow: none !important;
    }
    .accordion-button {
        border-color: rgba(51, 51, 51, 0.2) !important;
        box-shadow: none !important;
    }
    .accordion-button:focus {
        outline: none !important;
        box-shadow: none !important;
    }
    .accordion-button:hover {
        background-color: rgba(51, 51, 51, 0.2) !important;
        color: #333333 !important;
    }
    .list-group-item {
        position: relative;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    
    .list-group-item:hover .edit-btn,
    .list-group-item:hover .delete-btn {
        display: inline-block !important; /* Ensure this takes precedence */
    }
    
    
    .delete-btn {
        display: none;
        transition: opacity 0.3s ease;
    }    
    .edit-btn {
        display: none;
        margin-right: 5px;
        transition: opacity 0.3s ease;
    }
</style>
<body>
    <div class="container mt-5">
        <h1 class="mb-4">
            {% if asset %}
                Manage TPM for Asset: 
            {% else %}
                Select an Asset to Manage TPM:
            {% endif %}
            <select id="assetSelector" class="form-select d-inline-block w-auto">
                <option value="" disabled selected>-- Select an Asset --</option>
                {% for asset in all_assets %}
                    <option 
                        value="{% url 'plant:manage_page' asset.asset_number %}" 
                        {% if asset.asset_number == asset_number %}selected{% endif %}>
                        {{ asset.asset_number }}
                    </option>
                {% endfor %}
            </select>            
        </h1>       

        {% if asset %}
            <div class="accordion" id="questionsAccordion">
                {% for group, questions in questions_by_group.items %}
                    <div class="accordion-item">
                        <h2 class="accordion-header" id="heading{{ group|slugify }}">
                            <button 
                                class="accordion-button {% if expanded_group and expanded_group != group %}collapsed{% elif not expanded_group and not forloop.first %}collapsed{% endif %}" 
                                type="button" 
                                data-bs-toggle="collapse" 
                                data-bs-target="#collapse{{ group|slugify }}" 
                                aria-expanded="{% if expanded_group == group %}true{% elif not expanded_group and forloop.first %}true{% else %}false{% endif %}" 
                                aria-controls="collapse{{ group|slugify }}">
                                {{ group }}
                            </button>
                        </h2>
                        <div 
                            id="collapse{{ group|slugify }}" 
                            class="accordion-collapse collapse {% if expanded_group == group %}show{% elif not expanded_group and forloop.first %}show{% endif %}" 
                            aria-labelledby="heading{{ group|slugify }}" 
                            data-bs-parent="#questionsAccordion">
                            <div class="accordion-body">
                                {% if questions %}
                                <ul class="list-group">
                                    {% for question in questions %}
                                    <li class="list-group-item d-flex justify-content-between align-items-center">
                                        <span>{{ question.question }}</span>
                                        <div>
                                            <button 
                                                class="btn btn-dark btn-sm edit-btn d-none"
                                                data-bs-toggle="modal" 
                                                data-bs-target="#editQuestionModal"
                                                data-question-id="{{ question.id }}"
                                                data-question-text="{{ question.question }}"
                                                data-question-type="{{ question.type }}">
                                                Edit
                                            </button>
                                            <button 
                                                class="btn btn-warning btn-sm delete-btn d-none"
                                                data-bs-toggle="modal" 
                                                data-bs-target="#removeQuestionModal"
                                                data-question-id="{{ question.id }}">
                                                Remove
                                            </button>
                                        </div>
                                    </li>                                    
                                    {% endfor %}
                                </ul>                                
                                {% else %}
                                    <p class="text-muted">No questions for {{ group }}</p>
                                {% endif %}
                                <div class="mt-3">
                                    <button 
                                        class="btn btn-dark" 
                                        data-bs-toggle="modal" 
                                        data-bs-target="#addQuestionModal" 
                                        data-group="{{ group }}">
                                        Add Question
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                {% endfor %}
            </div>    
        {% else %}
            <p class="text-muted">No asset selected. Please select an asset to view and manage its TPM questions.</p>
        {% endif %}    
    </div>
    
    <script>
        document.getElementById('assetSelector').addEventListener('change', function () {
            window.location.href = this.value;
        });
    </script>

    <!-- Remove Question Modal -->
    <div class="modal fade" id="removeQuestionModal" tabindex="-1" aria-labelledby="removeQuestionModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                {% if asset %}
                <form method="POST" action="{% url 'plant:remove_question' asset.asset_number %}">
                    {% csrf_token %}
                    <input type="hidden" name="question_id" id="removeQuestionIdInput">
                    <div class="modal-header">
                        <h5 class="modal-title" id="removeQuestionModalLabel">Remove Question</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <p>Are you sure you want to remove this question from the asset?</p>
                    </div>
                    <div class="modal-footer">
                        <button type="submit" class="btn btn-warning">Yes, Remove</button>
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    </div>
                </form>
                {% else %}
                <div class="modal-body">
                    <p class="text-muted">No asset selected. Please select an asset to remove questions.</p>
                </div>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Add Question Modal -->
    <div class="modal fade" id="addQuestionModal" tabindex="-1" aria-labelledby="addQuestionModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                {% if asset %}
                <form method="POST" action="{% url 'plant:add_question' asset.asset_number %}">
                    {% csrf_token %}
                    <input type="hidden" name="question_group" id="questionGroupInput">
                    <div class="modal-header">
                        <h5 class="modal-title" id="addQuestionModalLabel">Add Question</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <div id="existingQuestionContainer" class="mb-3">
                            <label for="existingQuestionDropdown" class="form-label">Select Existing Question</label>
                            <select id="existingQuestionDropdown" class="form-select" name="existing_question">
                                <option value="">-- Select a Question --</option>
                            </select>
                        </div>
                        <div class="text-center">or</div>
                        <div id="newQuestionContainer">
                            <div class="mb-3">
                                <label for="newQuestionInput" class="form-label">New Question</label>
                                <textarea id="newQuestionInput" class="form-control" name="new_question"></textarea>
                            </div>
                            <div class="mb-3">
                                <label for="questionTypeDropdown" class="form-label">Question Type</label>
                                <select id="questionTypeDropdown" class="form-select" name="question_type">
                                    <option value="YN">Yes/No</option>
                                    <option value="NUM">Numeric Input</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="orderInput" class="form-label">Order</label>
                        <input 
                            type="number" 
                            step="0.01" 
                            id="orderInput" 
                            class="form-control" 
                            name="order" 
                            placeholder="Enter order (e.g., 1.0, 1.5, etc.)">
                    </div>                    
                    <div class="modal-footer">
                        <button type="submit" class="btn btn-warning">Save</button>
                        <button type="button" class="btn btn-dark" data-bs-dismiss="modal">Cancel</button>
                    </div>
                </form>
                {% else %}
                <div class="modal-body">
                    <p class="text-muted">No asset selected. Please select an asset to add questions.</p>
                </div>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Edit Question Modal -->
    <div class="modal fade" id="editQuestionModal" tabindex="-1" aria-labelledby="editQuestionModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <form method="POST" action="{% url 'plant:edit_question' asset.asset_number %}">
                    {% csrf_token %}
                    <input type="hidden" name="question_id" id="editQuestionIdInput">
                    <div class="modal-header">
                        <h5 class="modal-title" id="editQuestionModalLabel">Edit Question</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <div class="mb-3">
                            <label for="editQuestionInput" class="form-label">Question Text</label>
                            <textarea id="editQuestionInput" class="form-control" name="question_text"></textarea>
                        </div>
                        <div class="mb-3">
                            <label for="editQuestionTypeDropdown" class="form-label">Question Type</label>
                            <select id="editQuestionTypeDropdown" class="form-select" name="question_type">
                                <option value="YN">Yes/No</option>
                                <option value="NUM">Numeric Input</option>
                            </select>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="submit" class="btn btn-dark">Save Changes</button>
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    

    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const editQuestionModal = document.getElementById('editQuestionModal');
            const editQuestionInput = document.getElementById('editQuestionInput');
        
            if (editQuestionModal) {
                editQuestionModal.addEventListener('show.bs.modal', function (event) {
                    const button = event.relatedTarget;
                    const questionId = button.getAttribute('data-question-id');
                    const questionText = button.getAttribute('data-question-text');
                    const questionType = button.getAttribute('data-question-type');
        
                    // Populate modal fields
                    document.getElementById('editQuestionIdInput').value = questionId;
                    editQuestionInput.value = questionText;
                    document.getElementById('editQuestionTypeDropdown').value = questionType;
        
                    // Automatically focus the question input box when the modal opens
                    setTimeout(() => editQuestionInput.focus(), 600);
                });
            }
        });             
    </script>

    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const listItems = document.querySelectorAll('.list-group-item');
        
            listItems.forEach(item => {
                item.addEventListener('mouseenter', () => {
                    const deleteBtn = item.querySelector('.delete-btn');
                    if (deleteBtn) {
                        deleteBtn.classList.remove('d-none');
                    }
                });
        
                item.addEventListener('mouseleave', () => {
                    const deleteBtn = item.querySelector('.delete-btn');
                    if (deleteBtn) {
                        deleteBtn.classList.add('d-none');
                    }
                });
            });
        });        
    </script>

    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const removeQuestionModal = document.getElementById('removeQuestionModal');
            const removeQuestionIdInput = document.getElementById('removeQuestionIdInput');
            const addQuestionModal = document.getElementById('addQuestionModal');
            const orderInput = document.getElementById('orderInput');
            const existingQuestionDropdown = document.getElementById('existingQuestionDropdown');
            const newQuestionInput = document.getElementById('newQuestionInput');
            const questionGroupInput = document.getElementById('questionGroupInput');
            const existingQuestionContainer = document.getElementById('existingQuestionContainer');
            const newQuestionContainer = document.getElementById('newQuestionContainer');
            const allQuestionsByGroup = JSON.parse('{{ all_questions_by_group|escapejs }}');
            let activeAccordionGroup = null; // Variable to track the active accordion group

            // Handle Remove Question Modal
            if (removeQuestionModal) {
                removeQuestionModal.addEventListener('show.bs.modal', function (event) {
                    const button = event.relatedTarget;
                    const questionId = button.getAttribute('data-question-id');
                    removeQuestionIdInput.value = questionId || '';
                });
            }

            // Handle Add Question Modal
            if (addQuestionModal) {
                addQuestionModal.addEventListener('show.bs.modal', function (event) {
                    const button = event.relatedTarget;
                    const group = button.getAttribute('data-group');
                    orderInput.value = '';  // Optional: Prepopulate with a default order
                    activeAccordionGroup = group; // Set the active accordion group
                    questionGroupInput.value = group;

                    // Populate the dropdown with existing questions for the group
                    existingQuestionDropdown.innerHTML = '<option value="">-- Select a Question --</option>';
                    if (allQuestionsByGroup[group]) {
                        allQuestionsByGroup[group].forEach(question => {
                            const option = document.createElement('option');
                            option.value = question.id;
                            option.textContent = question.question;
                            existingQuestionDropdown.appendChild(option);
                        });
                    }

                    // Reset fields
                    existingQuestionDropdown.value = '';
                    newQuestionInput.value = '';
                    toggleFields();
                });
            }

            // Toggle fields based on selection
            function toggleFields() {
                if (existingQuestionDropdown.value) {
                    newQuestionContainer.style.display = 'none';
                } else {
                    newQuestionContainer.style.display = 'block';
                }

                if (newQuestionInput.value.trim()) {
                    existingQuestionContainer.style.display = 'none';
                } else {
                    existingQuestionContainer.style.display = 'block';
                }
            }

            existingQuestionDropdown.addEventListener('change', toggleFields);
            newQuestionInput.addEventListener('input', toggleFields);

            if (addQuestionModal) {
                addQuestionModal.addEventListener('hide.bs.modal', function () {
                    if (activeAccordionGroup) {
                        // Collapse all accordion items
                        document.querySelectorAll('.accordion-collapse').forEach(item => {
                            item.classList.remove('show');
                        });

                        // Expand the active accordion
                        const activeAccordion = document.getElementById(`collapse${activeAccordionGroup|slugify}`);
                        if (activeAccordion) {
                            activeAccordion.classList.add('show');
                        }
                    }
                });
            }
        });
    </script>    
</body>
</html>
