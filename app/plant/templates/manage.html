{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Manage</title>
    <link href="{% static 'bootstrap/css/bootstrap.min.css' %}" rel="stylesheet">
    <script src="{% static 'bootstrap/js/bootstrap.bundle.min.js' %}"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
</head>
<body class="container mt-4">
    <h1 class="mb-4">Manage Page</h1>

    <!-- Asset Dropdown -->
    <div class="mb-3">
        <label for="asset" class="form-label">Select an Asset:</label>
        <select name="asset" id="asset" class="form-select">
            <option value="">------</option>
            {% for asset in assets %}
                <option value="{{ asset.id }}">{{ asset.asset_number }}</option>
            {% endfor %}
        </select>
    </div>

    <!-- Questions Section -->
    <div id="questions-section" class="mt-4">
        <h2>Questions</h2>
        <form id="questions-form">
            <input type="hidden" id="asset-id" name="asset_id">
            <div id="questions-list" class="list-group">
                <!-- Questions will be dynamically loaded here -->
            </div>
            <button type="submit" class="btn btn-primary mt-3">Save</button>
        </form>
    </div>

    <script>
        // Fetch and display questions when an asset is selected
        $('#asset').change(function () {
            const assetId = $(this).val();
            $('#asset-id').val(assetId); // Set the hidden input value for saving
            if (assetId) {
                $.ajax({
                    url: "{% url 'fetch_questions_for_asset' %}",
                    data: { asset_id: assetId },
                    success: function (data) {
                        const questionsList = $('#questions-list');
                        questionsList.empty(); // Clear previous questions
                        data.questions.forEach(q => {
                            const checked = q.associated ? 'checked' : '';
                            const questionHTML = `
                                <div class="list-group-item">
                                    <input type="checkbox" id="question-${q.id}" name="question_ids[]" value="${q.id}" ${checked}>
                                    <label for="question-${q.id}">${q.question} (${q.question_group})</label>
                                </div>`;
                            questionsList.append(questionHTML);
                        });
                    },
                    error: function () {
                        alert('Error fetching questions.');
                    }
                });
            } else {
                $('#questions-list').empty(); // Clear questions if no asset is selected
            }
        });
    
        // Handle form submission
        $('#questions-form').submit(function (e) {
            e.preventDefault();
            const formData = $(this).serialize();
            $.ajax({
                url: "{% url 'save_questionaire' %}",
                method: 'POST',
                data: formData,
                headers: { 'X-CSRFToken': '{{ csrf_token }}' }, // Include CSRF token
                success: function (response) {
                    alert('Questionaire saved successfully!');
                },
                error: function (xhr) {
                    alert('Error saving questionaire: ' + xhr.responseJSON.error);
                }
            });
        });
    </script>
</body>
</html>
