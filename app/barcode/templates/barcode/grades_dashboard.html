{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Grades Dashboard</title>
    <!-- Chart.js -->
    <script src="{% static 'chart.js/chart.umd.js' %}"></script>
    <!-- Bootstrap CSS -->
    <link href="{% static 'bootstrap/css/bootstrap.min.css' %}" rel="stylesheet">
    <script src="{% static 'bootstrap/js/bootstrap.bundle.min.js' %}"></script>

    <style>
        html, body {
            font-family: Arial, sans-serif;
            background-color: #121212;
            color: #ffffff;
            margin: 0;
            padding: 0;
            height: 100%;
        }
        .container-fluid {
            display: flex;
            flex-direction: column;
            width: 100%;
            height: 100vh;
            margin: 0;
            padding: 0;
        }
        .row-part {
            display: flex;
            width: 100%;
            margin: 0;
            padding: 0;
            overflow: hidden; /* Hide any chart overflow beyond row */
        }
        .col-chart {
            flex: 1;
            padding: 5px;
            display: flex;        
            flex-direction: column;
        }
        .card {
            background-color: #1e1e1e;
            border: none;
            display: flex;
            flex-direction: column;
            flex: 1;
            margin: 0;
        }
        .card-header {
            background-color: #252525;
            color: #ffffff;
            text-align: center;
            padding: 10px;
            font-size: 1rem;
            flex: 0 0 auto;
        }
        .card-body {
            flex: 1;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 5px;
            max-height: 100%;
        }
        /* Important to constrain the canvas so it fits inside the card body */
        canvas {
            max-height: 100%;
            width: auto;
        }
    </style>
</head>
<body>
    <div class="container-fluid" id="charts-container">
        <!-- Rows for each part number will be dynamically inserted here via JS -->
    </div>

    <script>
        document.addEventListener("DOMContentLoaded", () => {
            // Parse JSON data from Django
            const data = JSON.parse('{{ json_data|escapejs }}');
            const partNumbers = Object.keys(data);
            const chartsContainer = document.getElementById("charts-container");

            // Calculate row height so each part number gets equal space vertically
            const totalParts = partNumbers.length;
            const availableHeight = window.innerHeight;
            const rowHeight = Math.floor(availableHeight / totalParts);

            // Colors for each grade (border) and each grade (fill)
            // You can use two separate mappings or embed them in one object.
            const gradeBorderColors = {
                "A": "rgba(0, 128, 0, 0.9)",
                "B": "rgba(173, 255, 47, 0.9)",
                "C": "rgba(255, 255, 0, 0.9)",
                "D": "rgba(255, 69, 0, 0.9)",
                "E": "rgba(220, 20, 60, 0.9)",
                "F": "rgba(255, 0, 0, 0.9)"
            };
            // The fill color with ~50% opacity:
            const gradeFillColors = {
                "A": "rgba(0, 128, 0, 0.5)",
                "B": "rgba(173, 255, 47, 0.5)",
                "C": "rgba(255, 255, 0, 0.5)",
                "D": "rgba(255, 69, 0, 0.5)",
                "E": "rgba(220, 20, 60, 0.5)",
                "F": "rgba(255, 0, 0, 0.5)"
            };

            // Loop each part number and build the row with line + pie chart
            partNumbers.forEach(partNumber => {
                const partData = data[partNumber];
                const breakdownData = partData.breakdown_data || [];
                const pieData = partData.pie_chart_data || {
                    total: 0, grades: {}, failures_total: 0
                };

                // Create row
                const row = document.createElement("div");
                row.className = "row-part";
                row.style.height = `${rowHeight}px`;

                // ======================
                // Left Column: Line Chart
                // ======================
                const leftCol = document.createElement("div");
                leftCol.className = "col-chart";

                const lineCard = document.createElement("div");
                lineCard.className = "card";

                const lineHeader = document.createElement("div");
                lineHeader.className = "card-header";
                lineHeader.textContent = `Part: ${partNumber} - Line Chart`;
                lineCard.appendChild(lineHeader);

                const lineBody = document.createElement("div");
                lineBody.className = "card-body";
                const lineCanvas = document.createElement("canvas");
                lineCanvas.id = `lineChartCanvas-${partNumber}`;
                lineBody.appendChild(lineCanvas);
                lineCard.appendChild(lineBody);

                leftCol.appendChild(lineCard);

                // ======================
                // Right Column: Pie Chart
                // ======================
                const rightCol = document.createElement("div");
                rightCol.className = "col-chart";

                const pieCard = document.createElement("div");
                pieCard.className = "card";

                const pieHeader = document.createElement("div");
                pieHeader.className = "card-header";
                pieHeader.textContent = `Part: ${partNumber} | Total: ${pieData.total} | Failures: ${pieData.failures_total}`;
                pieCard.appendChild(pieHeader);

                const pieBody = document.createElement("div");
                pieBody.className = "card-body";
                const pieCanvas = document.createElement("canvas");
                pieCanvas.id = `pieChartCanvas-${partNumber}`;
                pieBody.appendChild(pieCanvas);
                pieCard.appendChild(pieBody);

                rightCol.appendChild(pieCard);

                // Add left & right columns to row, then row to container
                row.appendChild(leftCol);
                row.appendChild(rightCol);
                chartsContainer.appendChild(row);

                // ======================
                // Build the LINE CHART
                // ======================
                const lineLabels = breakdownData.map(interval => interval.interval_start);
                const grades = ["A", "B", "C", "D", "E", "F"];

                const lineDatasets = grades.map(grade => {
                    // Convert "238 (100.0%)" -> just the number 100.0
                    return {
                        label: grade,
                        data: breakdownData.map(interval => {
                            const gradeStr = interval.grade_counts[grade] || "0 (0.00%)";
                            const match = gradeStr.match(/\((.*?)%\)/);
                            return match ? parseFloat(match[1]) : 0;
                        }),
                        borderColor: gradeBorderColors[grade],
                        backgroundColor: gradeFillColors[grade],
                        tension: 0.1,
                        fill: true   // This is the key to fill under the line
                    };
                });

                const lineCtx = lineCanvas.getContext("2d");
                new Chart(lineCtx, {
                    type: "line",
                    data: {
                        labels: lineLabels,
                        datasets: lineDatasets
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: true,
                                labels: { color: '#ffffff' },
                                position: "top"
                            }
                        },
                        scales: {
                            x: {
                                title: {
                                    display: true,
                                    text: "Time Intervals",
                                    color: '#ffffff'
                                },
                                ticks: { color: '#ffffff' }
                            },
                            y: {
                                beginAtZero: true,
                                max: 100,  // If you're plotting percentages, you can keep 100
                                title: {
                                    display: true,
                                    text: "Percentage (%)",
                                    color: '#ffffff'
                                },
                                ticks: { color: '#ffffff' }
                            }
                        }
                    }
                });

                // ======================
                // Build the PIE CHART
                // ======================
                const pieLabels = grades;
                const pieCounts = grades.map(g => pieData.grades[g] || 0);
                const pieCtx = pieCanvas.getContext("2d");
                new Chart(pieCtx, {
                    type: "pie",
                    data: {
                        labels: pieLabels,
                        datasets: [{
                            data: pieCounts,
                            backgroundColor: [
                                gradeFillColors.A, // or you could define separate ones
                                gradeFillColors.B,
                                gradeFillColors.C,
                                gradeFillColors.D,
                                gradeFillColors.E,
                                gradeFillColors.F
                            ]
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: true,
                                labels: { color: '#ffffff' },
                                position: "bottom"
                            }
                        }
                    }
                });
            });
        });

        // Optional auto-refresh every 60 seconds
        setInterval(() => {
            location.reload();
        }, 60000);
    </script>
</body>
</html>
