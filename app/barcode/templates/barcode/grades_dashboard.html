{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Grades Dashboard</title>
    <!-- Chart.js -->
    <script src="{% static 'chart.js/chart.umd.js' %}"></script>
    <!-- Bootstrap CSS & JS -->
    <link href="{% static 'bootstrap/css/bootstrap.min.css' %}" rel="stylesheet">
    <script src="{% static 'bootstrap/js/bootstrap.bundle.min.js' %}"></script>

    <style>
        html, body {
            font-family: Arial, sans-serif;
            background-color: #121212;
            color: #ffffff;
            margin: 0;
            padding: 0;
            height: 100%;
            /* Removed overflow: hidden here so layout sizing is calculated correctly */
        }
        /* Container fills the entire viewport */
        .container-fluid {
            display: flex;
            flex-direction: column;
            width: 100%;
            height: 100vh;
            margin: 0;
            padding: 0;
        }
        /* Each row will be set to a fixed height in JS */
        .row-part {
            display: flex;
            width: 100%;
            margin: 0;
            padding: 0;
            overflow: hidden; /* Hide any chart overflow beyond row */
        }
        /* Two columns: line chart on the left, pie chart on the right */
        .col-chart {
            flex: 1;
            padding: 5px;
            display: flex;        /* So .card can stretch */
            flex-direction: column;
        }
        /* Card styling */
        .card {
            background-color: #1e1e1e;
            border: none;
            display: flex;
            flex-direction: column;
            flex: 1;            /* Fill entire col-chart */
            margin: 0;
        }
        .card-header {
            background-color: #252525;
            color: #ffffff;
            text-align: center;
            padding: 10px;
            font-size: 1rem;
            flex: 0 0 auto;  /* Header has fixed size */
        }
        .card-body {
            flex: 1;           /* Body grows to fill remaining card space */
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 5px;
            max-height: 100%;  /* Prevent canvas from overflowing */
        }
        /* Canvas must not exceed card-body's height */
        canvas {
            max-height: 100%;
            width: auto;
            /* or use height: 100% if you prefer, but keep maintainAspectRatio: false in Chart.js */
        }
    </style>
</head>
<body>
    <div class="container-fluid" id="charts-container">
        <!-- Rows for each part number will be dynamically inserted here via JS. -->
    </div>

    <script>
        document.addEventListener("DOMContentLoaded", () => {
            // The JSON data passed from Django, containing one or more parts.
            // Example structure:
            // {
            //   "PART-ABC": {
            //       "breakdown_data": [...],
            //       "pie_chart_data": {
            //           "total": 999,
            //           "grades": {"A": 800, "B": 100, "C": 50, "D": 30, "E": 10, "F": 9},
            //           "failures_total": 49
            //       }
            //   },
            //   "PART-XYZ": {...}
            // }
            const data = JSON.parse('{{ json_data|escapejs }}');
            const partNumbers = Object.keys(data);

            const chartsContainer = document.getElementById("charts-container");
            // Compute how much vertical space each row should take
            const totalParts = partNumbers.length;
            const availableHeight = window.innerHeight;
            // Subtract a tiny margin if you prefer, or just distribute evenly
            const rowHeight = Math.floor(availableHeight / totalParts);

            // Colors for each grade in both charts
            const gradeColors = {
                "A": "rgba(0, 128, 0, 0.8)",
                "B": "rgba(173, 255, 47, 0.8)",
                "C": "rgba(255, 255, 0, 0.8)",
                "D": "rgba(255, 69, 0, 0.8)",
                "E": "rgba(220, 20, 60, 0.8)",
                "F": "rgba(255, 0, 0, 0.8)"
            };

            // For each part number, build a row with two charts
            partNumbers.forEach(partNumber => {
                const partData = data[partNumber];
                const breakdownData = partData.breakdown_data || [];
                const pieData = partData.pie_chart_data || {
                    total: 0,
                    grades: {},
                    failures_total: 0
                };

                // Create a row for this part
                const row = document.createElement("div");
                row.className = "row-part";
                // Enforce a fixed height for the row
                row.style.height = `${rowHeight}px`;

                // ======================
                // LEFT COLUMN: Line Chart
                // ======================
                const leftCol = document.createElement("div");
                leftCol.className = "col-chart";

                const lineCard = document.createElement("div");
                lineCard.className = "card";

                // Card header
                const lineHeader = document.createElement("div");
                lineHeader.className = "card-header";
                lineHeader.textContent = `Part: ${partNumber} - Line Chart`;
                lineCard.appendChild(lineHeader);

                // Card body with canvas
                const lineBody = document.createElement("div");
                lineBody.className = "card-body";
                const lineCanvas = document.createElement("canvas");
                lineCanvas.id = `lineChartCanvas-${partNumber}`;
                lineBody.appendChild(lineCanvas);
                lineCard.appendChild(lineBody);

                leftCol.appendChild(lineCard);

                // ======================
                // RIGHT COLUMN: Pie Chart
                // ======================
                const rightCol = document.createElement("div");
                rightCol.className = "col-chart";

                const pieCard = document.createElement("div");
                pieCard.className = "card";

                // Card header (show total and failures)
                const pieHeader = document.createElement("div");
                pieHeader.className = "card-header";
                pieHeader.textContent = `Part: ${partNumber} | Total: ${pieData.total} | Failures: ${pieData.failures_total}`;
                pieCard.appendChild(pieHeader);

                // Card body with canvas
                const pieBody = document.createElement("div");
                pieBody.className = "card-body";
                const pieCanvas = document.createElement("canvas");
                pieCanvas.id = `pieChartCanvas-${partNumber}`;
                pieBody.appendChild(pieCanvas);
                pieCard.appendChild(pieBody);

                rightCol.appendChild(pieCard);

                // Append both columns to the row, row to container
                row.appendChild(leftCol);
                row.appendChild(rightCol);
                chartsContainer.appendChild(row);

                // =================================================
                // Build the LINE CHART (percentages over time)
                // =================================================
                const lineLabels = breakdownData.map(interval => interval.interval_start);

                // Grades to consider
                const grades = ["A", "B", "C", "D", "E", "F"];

                // Convert "238 (100.0%)" -> 100.0
                const lineDatasets = grades.map(grade => ({
                    label: grade,
                    data: breakdownData.map(interval => {
                        const gradeStr = interval.grade_counts[grade] || "0 (0.00%)";
                        const match = gradeStr.match(/\((.*?)%\)/);
                        return match ? parseFloat(match[1]) : 0;
                    }),
                    fill: false,
                    borderColor: gradeColors[grade],
                    tension: 0.1
                }));

                const lineCtx = lineCanvas.getContext("2d");
                new Chart(lineCtx, {
                    type: "line",
                    data: {
                        labels: lineLabels,
                        datasets: lineDatasets
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false, // This is crucial to let it fill its container
                        plugins: {
                            legend: {
                                display: true,
                                labels: { color: '#ffffff' },
                                position: "top"
                            }
                        },
                        scales: {
                            x: {
                                title: {
                                    display: true,
                                    text: "Time Intervals",
                                    color: '#ffffff'
                                },
                                ticks: {
                                    color: '#ffffff'
                                }
                            },
                            y: {
                                beginAtZero: true,
                                max: 100,
                                title: {
                                    display: true,
                                    text: "Percentage (%)",
                                    color: '#ffffff'
                                },
                                ticks: {
                                    color: '#ffffff'
                                }
                            }
                        }
                    }
                });

                // =================================================
                // Build the PIE CHART (counts of each grade)
                // =================================================
                const pieLabels = grades;
                const pieCounts = grades.map(g => pieData.grades[g] || 0);
                const pieColors = grades.map(g => gradeColors[g]);

                const pieCtx = pieCanvas.getContext("2d");
                new Chart(pieCtx, {
                    type: "pie",
                    data: {
                        labels: pieLabels,
                        datasets: [{
                            data: pieCounts,
                            backgroundColor: pieColors
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false, // fill its container
                        plugins: {
                            legend: {
                                display: true,
                                labels: { color: '#ffffff' },
                                position: "bottom"
                            }
                        }
                    }
                });
            });
        });

        // Optionally refresh every 60 seconds
        setInterval(() => {
            location.reload();
        }, 60000);
    </script>
</body>
</html>
