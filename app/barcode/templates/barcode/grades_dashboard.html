{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Grades Dashboard</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <!-- Bootstrap CSS & JS -->
    <link href="{% static 'bootstrap/css/bootstrap.min.css' %}" rel="stylesheet">
    <script src="{% static 'bootstrap/js/bootstrap.bundle.min.js' %}"></script>
    
    <!-- Chart.js -->
    <script src="{% static 'chart.js/chart.umd.js' %}"></script>
</head>
<body class="bg-black text-white">

<div class="container-fluid py-3" id="charts-container">
    <!-- Rows for each asset will be generated here by JavaScript -->
</div>

<script>
document.addEventListener("DOMContentLoaded", () => {
    const data = JSON.parse('{{ json_data|escapejs }}');
    const assets = Object.keys(data);
    const chartsContainer = document.getElementById("charts-container");

    const gradeColors = {
        "A": "rgba(0, 128, 0, 0.9)",
        "B": "rgba(173, 255, 47, 0.9)",
        "C": "rgba(255, 255, 0, 0.9)",
        "D": "rgba(255, 69, 0, 0.9)",
        "E": "rgba(220, 20, 60, 0.9)",
        "F": "rgba(255, 0, 0, 0.9)"
    };

    assets.forEach(asset => {
        const assetData = data[asset];
        const breakdownData = assetData.breakdown_data || [];
        const pieData = assetData.pie_chart_data || { total: 0, grades: {}, failures_total: 0 };

        // Row Container
        const row = document.createElement("div");
        row.className = "row g-3 mb-3"; // Responsive grid with margin

        // Line Chart Column
        const colLine = document.createElement("div");
        colLine.className = "col-12 col-md-4";
        colLine.innerHTML = `
            <div class="card bg-dark border-0 h-100">
                <div class="card-header fw-bold">Machine: ${asset} (Week)</div>
                <div class="card-body">
                    <canvas id="lineChartCanvas-${asset}"></canvas>
                </div>
            </div>
        `;
        row.appendChild(colLine);

        // Pie Chart Column
        const colPie = document.createElement("div");
        colPie.className = "col-12 col-md-4";
        colPie.innerHTML = `
            <div class="card bg-dark border-0 h-100">
                <div class="card-header fw-bold">Total: ${pieData.total} (24hr)</div>
                <div class="card-body d-flex justify-content-center">
                    <canvas id="pieChartCanvas-${asset}"></canvas>
                </div>
            </div>
        `;
        row.appendChild(colPie);

        // Failures Column
        const colFail = document.createElement("div");
        colFail.className = "col-12 col-md-4";
        colFail.innerHTML = `
            <div class="card bg-dark border-0 h-100">
                <div class="card-header text-danger fw-bold">Failures (24hr)</div>
                <div class="card-body d-flex justify-content-center align-items-center">
                    <span id="failures-${asset}" class="display-1 fw-bold">0</span>
                </div>
            </div>
        `;
        row.appendChild(colFail);
        chartsContainer.appendChild(row);

        // Set Failures Count & Color
        const failuresSpan = document.getElementById(`failures-${asset}`);
        failuresSpan.textContent = pieData.failures_total;
        failuresSpan.classList.add(
            pieData.failures_total == 0 ? "text-success" : 
            pieData.failures_total <= 5 ? "text-warning" : "text-danger"
        );

        // Line Chart Data
        const grades = ["A", "B", "C", "D", "E", "F"];
        const lineLabels = breakdownData.map(i => i.interval_start);
        const lineDatasets = grades.map(grade => ({
            label: grade,
            data: breakdownData.map(i => parseFloat((i.grade_counts[grade] || "0 (0.00%)").match(/\((.*?)%\)/)?.[1] || 0)),
            borderColor: gradeColors[grade],
            backgroundColor: gradeColors[grade].replace("0.9", "0.5"),
            fill: true,
            tension: 0.1
        }));

        new Chart(document.getElementById(`lineChartCanvas-${asset}`).getContext("2d"), {
            type: "line",
            data: { labels: lineLabels, datasets: lineDatasets },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { legend: { labels: { color: '#ffffff' } } },
                scales: {
                    x: { title: { display: true, text: "Last 7 days", color: '#ffffff' }, ticks: { color: '#ffffff' } },
                    y: { beginAtZero: true, max: 100, title: { display: true, text: "Percentage (%)", color: '#ffffff' }, ticks: { color: '#ffffff' } }
                }
            }
        });

        // Pie Chart Data
        const pieLabels = grades;
        const pieCounts = grades.map(g => pieData.grades[g] || 0);
        const totalCount = pieCounts.reduce((sum, count) => sum + count, 0);

        new Chart(document.getElementById(`pieChartCanvas-${asset}`).getContext("2d"), {
            type: "pie",
            data: {
                labels: pieLabels,
                datasets: [{ data: pieCounts, backgroundColor: Object.values(gradeColors) }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: "right",
                        labels: {
                            color: '#ffffff',
                            font: { size: 16, weight: 'bold' },
                            generateLabels: chart => chart.data.labels.map((label, i) => {
                                const count = chart.data.datasets[0].data[i];
                                const percentage = totalCount > 0 ? ((count / totalCount) * 100).toFixed(1) : 0;
                                return { text: `${label}: ${percentage}%`, fillStyle: chart.data.datasets[0].backgroundColor[i] };
                            })
                        }
                    }
                }
            }
        });
    });
});

// Auto-refresh every 60 seconds
setInterval(() => { location.reload(); }, 60000);
</script>

</body>
</html>
