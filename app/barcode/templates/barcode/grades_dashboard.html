{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Grades Dashboard</title>
    <script src="{% static 'chart.js/chart.umd.js' %}"></script>
    <link href="{% static 'bootstrap/css/bootstrap.min.css' %}" rel="stylesheet">
    <script src="{% static 'bootstrap/js/bootstrap.bundle.min.js' %}"></script>
    <style>
        html, body {
            font-family: Arial, sans-serif;
            background-color: #121212;
            color: #ffffff;
            margin: 0;
            padding: 0;
            height: 100%;
            overflow: hidden; /* Prevent scrolling */
        }
        /* Full viewport container */
        .container-fluid {
            height: 100vh;
            display: flex;
            flex-direction: column;
            padding: 0;
        }
        /* Each partâ€™s row takes an equal share of the vertical space */
        .row-part {
            flex: 1;
            display: flex;
            margin: 0;
            padding: 0;
        }
        /* Each chart column takes half the width */
        .col-chart {
            flex: 1;
            padding: 5px;
        }
        .card {
            background-color: #1e1e1e;
            border: none;
            height: 100%;
            display: flex;
            flex-direction: column;
        }
        .card-header {
            background-color: #252525;
            color: #ffffff;
            text-align: center;
            padding: 10px;
            font-size: 1rem;
        }
        .card-body {
            flex: 1;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 5px;
        }
        canvas {
            max-width: 100%;
            max-height: 100%;
        }
    </style>
</head>
<body>
    <!-- Container for all parts -->
    <div class="container-fluid" id="charts-container">
        <!-- Rows for each part will be injected via JavaScript -->
    </div>

    <script>
        document.addEventListener("DOMContentLoaded", () => {
            // Parse JSON data passed from Django.
            // Expected structure:
            // {
            //    "PART_NUMBER_1": {
            //         breakdown_data: [...],
            //         pie_chart_data: { total: ..., grades: { A: ..., B: ..., ... }, failures_total: ... }
            //    },
            //    "PART_NUMBER_2": { ... },
            //    ...
            // }
            const data = JSON.parse('{{ json_data|escapejs }}');
            const chartsContainer = document.getElementById("charts-container");
            const partNumbers = Object.keys(data);
            const totalParts = partNumbers.length;
            // Allocate full viewport height evenly among parts
            const availableHeight = window.innerHeight;
            const rowHeight = Math.floor(availableHeight / totalParts);

            // Define colors for each grade for both charts
            const gradeColors = {
                "A": "rgba(0, 128, 0, 0.8)",
                "B": "rgba(173, 255, 47, 0.8)",
                "C": "rgba(255, 255, 0, 0.8)",
                "D": "rgba(255, 69, 0, 0.8)",
                "E": "rgba(220, 20, 60, 0.8)",
                "F": "rgba(255, 0, 0, 0.8)"
            };

            // Loop through each part number and build its row with charts
            partNumbers.forEach(partNumber => {
                const partData = data[partNumber];
                const breakdownData = partData.breakdown_data;
                const pieData = partData.pie_chart_data;  // Contains total, grades, and failures_total

                // Create the row for this part
                const row = document.createElement("div");
                row.className = "row-part";
                row.style.height = `${rowHeight}px`;

                // ----------------------
                // Left Column: Line Chart
                // ----------------------
                const leftCol = document.createElement("div");
                leftCol.className = "col-chart";

                const lineCard = document.createElement("div");
                lineCard.className = "card";

                const lineCardHeader = document.createElement("div");
                lineCardHeader.className = "card-header";
                lineCardHeader.textContent = `Part: ${partNumber} - Line Chart`;
                lineCard.appendChild(lineCardHeader);

                const lineCardBody = document.createElement("div");
                lineCardBody.className = "card-body";
                const lineCanvas = document.createElement("canvas");
                lineCanvas.id = `lineChartCanvas-${partNumber}`;
                lineCardBody.appendChild(lineCanvas);
                lineCard.appendChild(lineCardBody);
                leftCol.appendChild(lineCard);

                // ----------------------
                // Right Column: Pie Chart
                // ----------------------
                const rightCol = document.createElement("div");
                rightCol.className = "col-chart";

                const pieCard = document.createElement("div");
                pieCard.className = "card";

                const pieCardHeader = document.createElement("div");
                pieCardHeader.className = "card-header";
                // Include overall total and failure count in the header
                pieCardHeader.textContent = `Part: ${partNumber} - Pie Chart | Total: ${pieData.total} | Failures: ${pieData.failures_total}`;
                pieCard.appendChild(pieCardHeader);

                const pieCardBody = document.createElement("div");
                pieCardBody.className = "card-body";
                const pieCanvas = document.createElement("canvas");
                pieCanvas.id = `pieChartCanvas-${partNumber}`;
                pieCardBody.appendChild(pieCanvas);
                pieCard.appendChild(pieCardBody);
                rightCol.appendChild(pieCard);

                // Append both columns to the row and add to the container
                row.appendChild(leftCol);
                row.appendChild(rightCol);
                chartsContainer.appendChild(row);

                // ----------------------
                // Build the Line Chart using breakdown_data
                // ----------------------
                // Use the interval start times for labels
                const lineLabels = breakdownData.map(interval => interval.interval_start);

                // Build datasets for each grade (A, B, C, D, E, F)
                const grades = ["A", "B", "C", "D", "E", "F"];
                const lineDatasets = grades.map(grade => ({
                    label: grade,
                    data: breakdownData.map(interval => {
                        // Each interval's grade count is a formatted string like "238 (100.0%)".
                        // Extract the percentage using a regex.
                        const gradeStr = interval.grade_counts[grade] || "0 (0.00%)";
                        const match = gradeStr.match(/\((.*?)%\)/);
                        return match ? parseFloat(match[1]) : 0;
                    }),
                    fill: false,
                    borderColor: gradeColors[grade],
                    tension: 0.1
                }));

                const lineCtx = lineCanvas.getContext("2d");
                new Chart(lineCtx, {
                    type: "line",
                    data: {
                        labels: lineLabels,
                        datasets: lineDatasets
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: true,
                                labels: { color: '#ffffff' },
                                position: "top"
                            }
                        },
                        scales: {
                            x: {
                                title: {
                                    display: true,
                                    text: "Time Intervals",
                                    color: '#ffffff'
                                },
                                ticks: { color: '#ffffff' }
                            },
                            y: {
                                beginAtZero: true,
                                max: 100,
                                title: {
                                    display: true,
                                    text: "Percentage (%)",
                                    color: '#ffffff'
                                },
                                ticks: { color: '#ffffff' }
                            }
                        }
                    }
                });

                // ----------------------
                // Build the Pie Chart using pie_chart_data
                // ----------------------
                // Use the raw counts for each grade
                const pieLabels = grades;
                const pieCounts = grades.map(grade => pieData.grades[grade] || 0);
                const pieColors = grades.map(grade => gradeColors[grade]);

                const pieCtx = pieCanvas.getContext("2d");
                new Chart(pieCtx, {
                    type: "pie",
                    data: {
                        labels: pieLabels,
                        datasets: [{
                            data: pieCounts,
                            backgroundColor: pieColors
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: true,
                                labels: { color: '#ffffff' },
                                position: "bottom"
                            }
                        }
                    }
                });
            });
        });
    </script>

    <!-- Auto-refresh every 60 seconds -->
    <script>
        setInterval(() => { location.reload(); }, 60000);
    </script>
</body>
</html>
