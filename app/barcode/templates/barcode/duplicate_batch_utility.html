{% extends "barcode/base.html" %}
{% load widget_tweaks %}
{% block title %}Duplicate Batch Utility{% endblock %}

{% block extra_styles %}
{% endblock %}

{% block content %}
<div class="col-12">
    <h1 class="fw-bolder text-center" id="page_title">{{ title }}</h1>
</div>
<div class="col-12">
    <hr>
</div>

<div class="row d-flex justify-content-center input-control-lg mb-2">
    <div class="col-auto">
        <div id="visible_list"></div>
    </div>
</div>
<div class="row d-flex justify-content-center input-control-lg align-items-center mb-3">
    <div class="col-8">
        <label for="scan_input">Barcode</label>
        <input type="text" inputmode="none" class="form-control" id="scan_input"/>
    </div>
    <div class="col">
        <label for="running_count">Count</label>
        <input type="text" inputmode="none" class="form-control" id="running_count"/>
    </div>
</div>

<div id="active_part_display" class="row d-flex justify-content-center input-control-lg mb-2">
    <div class="col-auto">
        <h4>Active Part: <span id="active_part_name">{{ active_part_name }}</span></h4>
    </div>
</div>

<form id="main_form" class="row d-flex justify-content-center" action="" method="POST" onsubmit="btnsubmit.disabled = true; return true;">
    {% csrf_token %}
    <div class="row d-flex justify-content-center input-control-lg mb-2">
        <div class="col-auto">
            {{ form.barcodes|add_class:"form-control"|attr:"hidden"}}
        </div>
    </div>

    <div class="row d-flex justify-content-center input-control-lg mb-3">
        <div class="col-8">
            <label for="tag_input">Tag</label>
            <input type="text" class="form-control" id="tag_input" name="tag_input" value="{{ tag }}" />
        </div>
    </div>

    <div class="row d-flex justify-content-center input-control-lg mb-2">
        <div class="col-auto">
            <button class="btn btn-primary" type="submit" id="submit_button" name="btnsubmit" value="btnsubmit">Submit</button>
            <button class="btn btn-secondary" type="button" id="clear_button" >Clear</button>
        </div>
    </div>

    <div class="row d-flex justify-content-center input-control-lg mb-2">
    <div class="col-auto">
        <h4>Current Part:</h4>
    </div>
    <div class="col-auto">
        {% if active_part_name == "Any Part" %}
            <span>Any Part</span>
        {% else %}
            <select class="form-select" name="part_select" aria-label="Part Selector" id="part_select" disabled>
                {% for option in part_select_options %}
                <option value="{{ option.id }}" {% if option.id == active_part %} selected {% endif %}>
                    {{ option.name }}
                </option>
                {% endfor %}
            </select>
        {% endif %}
    </div>
</div>

     
</form>

{% endblock %}

{% block extra_js %}
<script data-active_part_prefix="{{active_part_prefix}}" data-parts_per_tray="{{parts_per_tray}}">
    const data = document.currentScript.dataset;
    var barcode_list = new Array();

    console.log(data);

    const scanner_input_textbox = document.getElementById("scan_input");
    const barcodes_textbox = document.getElementById("id_barcodes");
    const visible_list = document.getElementById("visible_list");
    const running_count = document.getElementById("running_count");
    const form = document.getElementById("main_form");
    const submit_button = document.getElementById("submit_button");
    const clear_button = document.getElementById("clear_button");
    const activePartDisplay = document.getElementById("active_part_display");

    let invalidCodeFound = false;

    function clear(event) {
        invalidCodeFound = false;
        document.getElementById("id_barcodes").value = "";
        visible_list.innerHTML = "";
        updateCountDisplay(0);
        submit_button.setAttribute("disabled", true);
        scanner_input_textbox.removeAttribute("disabled");
        scanner_input_textbox.focus({preventScroll:true});
    }
    clear_button.addEventListener("click", clear, false);
    addEventListener("pageshow", clear, false);

    function updateCountDisplay(count) {
        running_count.value = count.toString();
    }

    function autoSubmit() {
        form.submit();
    }

    function blockmulti() {
        setTimeout(function() {
            submit_button.setAttribute("disabled", true);
        }, 1);
    }
    form.addEventListener("submit", blockmulti, false);

    function processScan(event) {
        const scanned_code = scanner_input_textbox.value;
        if (barcodes_textbox.value.split("\n").includes(scanned_code)){
            console.log("found duplicate");
            scanner_input_textbox.value = "";
            return;
        }
        barcodes_textbox.value += scanned_code + '\n';
        const contents = barcodes_textbox.value.split('\n');
        let count = contents.length - 1;
        updateCountDisplay(count);
        let entry = document.createElement("p");
        entry.setAttribute("style", "font-size: small; margin: 0;");
        entry.appendChild(document.createTextNode(scanned_code));
        visible_list.appendChild(entry);

        submit_button.removeAttribute("disabled");
        
        scanner_input_textbox.value = "";
        submit_button.scrollIntoView();
    }
    scanner_input_textbox.addEventListener("change", processScan, true);

    const tag_input = document.getElementById("tag_input");

    function saveTag() {
        localStorage.setItem('tag', tag_input.value);
    }

    function loadTag() {
        const savedTag = localStorage.getItem('tag');
        if (savedTag) {
            tag_input.value = savedTag;
        }
    }

    window.addEventListener('load', function() {
        loadTag();
    });

    tag_input.addEventListener('change', function() {
        saveTag();
    });

</script>

{% endblock %}
