{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Rejects Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <!-- Bootstrap CSS & JS -->
  <link href="{% static 'bootstrap/css/bootstrap.min.css' %}" rel="stylesheet">
  <script src="{% static 'bootstrap/js/bootstrap.bundle.min.js' %}"></script>

  <!-- Chart.js (v3+) -->
  <script src="{% static 'chart.js/chart.umd.js' %}"></script>

  <style>
    html, body {
      height: 100%;
      margin: 0;
    }
    .full-height-card { height: 100vh; }
    .charts-container { height: 100%; overflow: hidden; }
    .card-header { font-size: 1.8rem; }
    .large-number { font-size: clamp(2rem, 8vw, 10rem); }
  </style>
</head>
<body class="bg-black text-white">

  <div class="card border-0 full-height-card" style="background-color: black !important;">
    <div class="card-body p-0">
      <div class="container-fluid charts-container" id="charts-container">
        <!-- Rows will be injected by JS -->
      </div>
    </div>
  </div>

  <script>
    document.addEventListener("DOMContentLoaded", () => {
      const data = JSON.parse('{{ json_data|escapejs }}');
      const lines = Object.keys(data);
      const container = document.getElementById("charts-container");
      const rowHeight = Math.floor(container.clientHeight / lines.length);

      const COLORS = {
        Good:   "rgba(0,128,0,0.9)",
        Reject: "rgba(255,0,0,0.9)"
      };

      lines.forEach(line => {
        const { breakdown_data: breakdown = [], pie_chart_data: pie } = data[line];

        // build row
        const row = document.createElement("div");
        row.className = "row g-3";
        row.style.height = `${rowHeight}px`;

        // ── Line chart col ──
        const colLine = document.createElement("div");
        colLine.className = "col-12 col-md-7";
        colLine.innerHTML = `
          <div class="card h-100" style="background-color:black; border-bottom:1px solid white;">
            <div class="card-header fw-bold">Machine: ${line} (Week)</div>
            <div class="card-body p-0">
              <canvas id="lineChart-${line}"></canvas>
            </div>
          </div>`;
        row.appendChild(colLine);

        // ── Pie chart col ──
        const colPie = document.createElement("div");
        colPie.className = "col-12 col-md-3";
        colPie.innerHTML = `
          <div class="card border-0 h-100" style="background-color:black;">
            <div class="card-body p-0 d-flex justify-content-center align-items-center">
              <canvas id="pieChart-${line}" width="180" height="180"></canvas>
            </div>
          </div>`;
        row.appendChild(colPie);

        // ── Rejects count col ──
        const colFail = document.createElement("div");
        colFail.className = "col-12 col-md-2";
        colFail.innerHTML = `
          <div class="card border-0 h-100" style="background-color:black;">
            <div class="card-header fw-bold large-header">Rejects (24 hr)</div>
            <div class="card-body p-0 d-flex justify-content-center align-items-center" style="border-bottom:1px solid white;">
              <span id="failCount-${line}" class="display-1 fw-bold large-number">0</span>
            </div>
          </div>`;
        row.appendChild(colFail);

        container.appendChild(row);

        // update 24h rejects count & color
        const failSpan = document.getElementById(`failCount-${line}`);
        const n        = pie.failures_total || 0;
        failSpan.textContent = n;
        failSpan.classList.add(pie.reject_color || "text-success");

        // ── Prepare data arrays ──
        const labels         = breakdown.map(i => i.interval_start);
        const goodCounts     = breakdown.map(i => i.grade_counts.Good);
        const rejectPercents = breakdown.map(i => i.grade_percentages.Reject);

            // ── Render line chart with dual Y-axes ──
            new Chart(
              document.getElementById(`lineChart-${line}`).getContext("2d"),
              {
                type: "line",
                data: {
                  labels,
                  datasets: [
                    {
                      label: "Good",
                      data: goodCounts,
                      yAxisID: "count",
                      borderColor: COLORS.Good,
                      backgroundColor: COLORS.Good.replace("0.9","0.3"),
                      fill: true,
                      tension: 0.1
                    },
                    {
                      label: "Reject %",
                      data: rejectPercents,
                      yAxisID: "pct",
                      borderColor: COLORS.Reject,
                      backgroundColor: COLORS.Reject.replace("0.9","0.3"),
                      fill: true,
                      tension: 0.1
                    }
                  ]
                },
                options: {
                  responsive: true,
                  maintainAspectRatio: false,
                  plugins: {
                    legend: { labels: { color: "#ffffff" } },
                   tooltip: {
                     callbacks: {
                       label: ctx => {
                        // when hovering the Reject % line, pull both raw & pct
                         if (ctx.dataset.label === "Reject %") {
                           const idx = ctx.dataIndex;
                           const pct = ctx.dataset.data[idx];
                           const raw = breakdown[idx].grade_counts.Reject;
                           return `Reject: ${raw} (${pct}%)`;
                         }
                         // default for the Good line
                         return Chart.defaults.plugins.tooltip.callbacks.label(ctx);
                       }
                     }
                   }
                  },
                  scales: {
                    count: {
                      type: "linear",
                      position: "left",
                      title: {
                        display: true,
                        text: "Good parts (count)",
                        color: "#ffffff"
                      },
                      ticks: {
                        color: "#ffffff",
                        beginAtZero: true
                      }
                    },
                    pct: {
                      type: "linear",
                      position: "right",
                      title: {
                        display: true,
                        text: "Reject rate (%)",
                        color: "#ffffff"
                      },
                      min: 0,
                      max: 30,
                      grid: { drawOnChartArea: false },
                      ticks: {
                        color: "#ffffff",
                        callback: v => v + "%"
                      }
                    }
                  }
                }
              }
            );


        // ── Render pie chart (unchanged) ──
        const rawGood   = pie.grades?.Good   || 0;
        const rawReject = pie.grades?.Reject || 0;
        const pct       = pie.percentages   || { Good: 0, Reject: 0 };
        const pieDisplay = {
          Good:   `${rawGood} (${pct.Good}%)`,
          Reject: `${rawReject} (${pct.Reject}%)`
        };

        new Chart(
          document.getElementById(`pieChart-${line}`).getContext("2d"),
          {
            type: "pie",
            data: {
              labels: ["Good", "Reject"],
              datasets: [{
                data: [rawGood, rawReject],
                backgroundColor: [COLORS.Good, COLORS.Reject]
              }]
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              plugins: {
                legend: {
                  position: "right",
                  labels: {
                    color: "#ffffff",
                    font: { size: 14, weight: "bold" },
                    generateLabels: chart =>
                      chart.data.labels.map((lbl,i) => ({
                        text:       lbl === "Good"
                                    ? pieDisplay.Good
                                    : pieDisplay.Reject,
                        fillStyle:  chart.data.datasets[0].backgroundColor[i],
                        fontColor:  "#ffffff"
                      }))
                  }
                }
              }
            }
          }
        );
      });

      // auto-refresh every minute
      setInterval(() => location.reload(), 60000);
    });
  </script>
</body>
</html>
