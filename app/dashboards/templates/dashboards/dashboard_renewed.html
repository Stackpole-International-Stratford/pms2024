{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <title>Dashboard — {{ pages }}</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

    <!-- Bootstrap CSS (served locally via static files) -->
    <link href="{% static 'bootstrap/css/bootstrap.min.css' %}" rel="stylesheet" />

    <style>
      /* Shrink table cell padding so more cells fit on-screen */
      .table td, .table th {
        padding: 0.25rem 0.5rem;
        font-size: 0.85rem;
      }
      /* Slightly larger text for program headers */
      .program-header {
        font-size: 1.1rem;
        font-weight: bold;
      }
      /* Light border and background for each program panel */
      .program-col {
        border: 1px solid #dee2e6;
        background-color: #f8f9fa;
      }
      /* Operation-cell style (leftmost cell) */
      .op-cell {
        background-color: #e9ecef;
        font-weight: 600;
        text-align: center;
        vertical-align: middle;
        white-space: nowrap;
      }
      /* Center a single-machine cell */
      .single-machine {
        text-align: center;
        vertical-align: middle;
      }
      /* Style for “no machines” placeholder */
      .no-mach {
        text-align: center;
        vertical-align: middle;
        color: #6c757d; /* Bootstrap’s text-dark color */
      }
    </style>
</head>
<body>
  <div class="container-fluid mt-2">
    <div class="row no-gutters">
      {% for prog in programs %}
        <div class="col-sm-6 col-md-4 col-lg-3 px-1 mb-2 program-col d-flex flex-column">
          <div class="bg-secondary text-white text-center py-1 program-header">
            {{ prog.program }}
          </div>

          {% for line in prog.lines %}
            <div class="w-100 mt-1">
              <div class="table-responsive">
                <table class="table table-bordered table-sm mb-1">
                  <tbody>
                    {% for op in line.operations %}
                      <tr>
                      {# ── OP‐CELL now shows both the op label and its total ⁄ efficiency ── #}
                      <td
                        class="op-cell"
                        style="background-color: {{ op.color }}; color: #000; border: 2px solid #000;"
                      >
                        {{ op.op }}
                        <br/>
                        <span class="small text-dark">
                          {{ op.total_produced }}
                          {% if op.efficiency is not None %}
                            ({{ op.efficiency }}%)
                          {% else %}
                            (N/A)
                          {% endif %}
                        </span>
                      </td>




                      {# ── NO MACHINES: just a placeholder cell spanning all machine‐slots ── #}
                      {% if op.machines|length == 0 %}
                        <td class="no-mach" colspan="{{ line.max_machines }}">
                          &mdash;
                        </td>

                      {# ── SINGLE MACHINE: one big cell spanning all machine‐slots ── #}
                      {% elif op.machines|length == 1 %}
                        {% with single=op.machines.0 %}
                          <td
                            class="single-machine"
                            colspan="{{ line.max_machines }}"
                            style="background-color: {{ single.color }};"
                          >
                            <div><strong>{{ single.number }}</strong></div>
                            <div class="small text-dark">
                              {{ single.count }}
                              {% if single.efficiency is not None %}
                                ({{ single.efficiency }}%)
                              {% else %}
                                (N/A)
                              {% endif %}
                            </div>
                          </td>
                        {% endwith %}

                      {# ── MULTIPLE MACHINES: split into equal‐width cells ── #}
                      {% else %}
                        {% comment %}
                          Compute colspan = floor(line.max_machines / (number of machines))
                          using widthratio (widthratio a b 1 → floor(a/b)).
                        {% endcomment %}
                        {% widthratio line.max_machines op.machines|length 1 as colspan_value %}

                        {% for m in op.machines %}
                          <td
                            class="text-center align-middle"
                            colspan="{{ colspan_value }}"
                            style="background-color: {{ m.color }};"
                          >
                            <div><strong>{{ m.number }}</strong></div>
                            <div class="small text-dark">
                              {{ m.count }}
                              {% if m.efficiency is not None %}
                                ({{ m.efficiency }}%)
                              {% else %}
                                (N/A)
                              {% endif %}
                            </div>
                          </td>
                        {% endfor %}
                      {% endif %}
                    </tr>

                    {% endfor %}
                  </tbody>
                </table>
              </div>
            </div>
          {% endfor %}

          <div class="mt-auto"></div>
        </div>
      {% endfor %}
    </div>
  </div>

  <!-- Bootstrap JS Bundle (served via static files) -->
  <script src="{% static 'bootstrap/js/bootstrap.bundle.min.js' %}"></script>
</body>
</html>
